<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: BATALLA V83</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
    <div id="container-ar"></div>
    
    <div id="ui-superior-fijo" style="position:fixed; top:10px; left:10px; z-index:9000; display:none;">
        <div id="txt-turno" style="background:rgba(0,0,0,0.9); padding:10px 15px; border:3px solid gold; font-size:24px; font-weight:900; border-radius:8px;">TURNO: ---</div>
        <div id="txt-vuelta" style="background:gold; color:black; padding:5px 10px; font-weight:900; border-radius:5px; margin-top:5px; display:inline-block;">VUELTA: 1 / 3</div>
    </div>

    <div id="p-setup" class="pantalla" style="background:rgba(0,0,0,0.9); z-index:10000;">
        <h1 style="color:gold;">INSCRIPCI√ìN</h1>
        <div id="setup-selector" style="display:flex; gap:10px;">
            <button class="btn-master" onclick="window.setModo(2)">2 MAGOS</button>
            <button class="btn-master" onclick="window.setModo(4)">4 MAGOS</button>
        </div>
        <div id="registro" class="oculto">
            <input type="text" id="mago-nombre" placeholder="NOMBRE DEL MAGO" style="width:100%; padding:15px; margin-bottom:15px; text-align:center; font-size:20px;">
            <div class="grid-casas" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <button onclick="window.registrarMago('TERRA','#ff0000')" class="btn-casa" style="background:#500; color:white; padding:20px; border:2px solid gold; font-weight:bold;">üõ°Ô∏è TERRA</button>
                <button onclick="window.registrarMago('CAELUM','#00aaff')" class="btn-casa" style="background:#003; color:white; padding:20px; border:2px solid gold; font-weight:bold;">‚öîÔ∏è CAELUM</button>
                <button onclick="window.registrarMago('AQUA','#00ff88')" class="btn-casa" style="background:#030; color:white; padding:20px; border:2px solid gold; font-weight:bold;">üíß AQUA</button>
                <button onclick="window.registrarMago('DIMENSIO','#aa00ff')" class="btn-casa" style="background:#303; color:white; padding:20px; border:2px solid gold; font-weight:bold;">‚ú® DIMENSIO</button>
            </div>
        </div>
    </div>

    <div id="ui-juego" class="oculto">
        <div id="zona-superior" style="position:relative; height:50vh; pointer-events:none;">
            <div id="hud-derecho" style="position:absolute; right:15px; top:15px; display:none; flex-direction:column; align-items:center; background:rgba(0,0,0,0.8); padding:15px; border:2px solid gold; border-radius:10px;">
                <img id="hud-img-escudo" src="" style="width:70px;">
                <div id="hud-txt-arma" style="font-weight:900; color:white; font-size:16px; margin:5px 0;">ARMA</div>
                <div id="hud-txt-valor" style="font-weight:900; font-size:50px; color:gold;">00</div>
            </div>
            <div id="guia-scanner" style="border:5px solid rgba(255,255,255,0.5); width:260px; height:260px; margin:auto; position:absolute; inset:0; border-radius:25px;"></div>
            <video id="video-action" playsinline style="display:none; position:absolute; width:100%; height:100%; object-fit:cover; z-index:90;"></video>
        </div>

        <div id="zona-inferior" style="background:linear-gradient(to bottom, #111, #000); padding:20px; text-align:center; height:50vh; pointer-events:auto;">
            <div id="msg-visor" style="font-size:28px; color:gold; font-weight:900; margin-bottom:15px; text-shadow:0 0 10px gold;">ESCANEA CARTA</div>
            <p style="color:#aaa; font-weight:900;">SLOT: <span id="slot-indicator">1/3</span></p>
            
            <div class="contenedor-gemas" style="display:flex; justify-content:center; gap:15px; margin:20px 0;">
                <div class="wrapper-gema"><span id="val-i" class="valor-flotante"></span><button id="btn-i" class="btn-gema">I</button></div>
                <div class="wrapper-gema"><span id="val-a" class="valor-flotante"></span><button id="btn-a" class="btn-gema">A</button></div>
                <div class="wrapper-gema"><span id="val-t" class="valor-flotante"></span><button id="btn-t" class="btn-gema">T</button></div>
                <div class="wrapper-gema"><span id="val-m" class="valor-flotante"></span><button id="btn-m" class="btn-gema">M</button></div>
            </div>

            <div style="display:flex; gap:10px; width:100%;">
                <button id="btn-confirmar" class="btn-master" style="background:#060; flex:2; border-color:#0f0; color:white;">‚úÖ CONFIRMAR</button>
                <button id="btn-reescaneo" class="btn-master" style="background:#860; flex:1; border-color:gold;" onclick="window.forzarReescaneo()">üîÑ RESCAN</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { iniciarOjo, resetUltimoId, RUTA_BASE } from './ojo.js';

        let jugadores = [];
        let cantJugadores = 0, turnoJugadorIdx = 0, slotActual = 0, cartaActualEnPantalla = null, jugadaPendiente = null;
        const MAX_SLOTS = 3;

        // PUENTE GLOBAL PARA LOS BOTONES DEL HTML
        window.setModo = (modo) => {
            cantJugadores = modo;
            document.getElementById('setup-selector').classList.add('oculto');
            document.getElementById('registro').classList.remove('oculto');
        };

        window.registrarMago = (elemento, color) => {
            const input = document.getElementById('mago-nombre');
            const nombre = input.value.trim().toUpperCase();
            if(!nombre) return alert("Escribe nombre del mago");
            
            jugadores.push({ nombre, elemento, color, slots: [null, null, null] });
            input.value = "";
            
            if(jugadores.length === cantJugadores) {
                document.getElementById('p-setup').classList.add('oculto');
                document.getElementById('ui-juego').classList.remove('oculto');
                document.getElementById('ui-superior-fijo').style.display = 'block';
                iniciarPartida();
            } else {
                alert(`Mago ${jugadores.length} de ${cantJugadores} registrado.`);
            }
        };

        function iniciarPartida() {
            actualizarUI();
            iniciarOjo('container-ar', (carta) => {
                cartaActualEnPantalla = carta;
                document.getElementById('msg-visor').innerHTML = `<span style="font-size:32px; color:white;">${carta.nombre}</span>`;
                ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                    document.getElementById(id.replace('btn-', 'val-')).innerText = carta.botones[id].valor;
                });
            });
        }

        function actualizarUI() {
            const j = jugadores[turnoJugadorIdx];
            const t = document.getElementById('txt-turno');
            t.innerText = `TURNO: ${j.nombre}`;
            t.style.color = j.color;
            document.getElementById('slot-indicator').innerText = `${slotActual + 1}/${MAX_SLOTS}`;
        }

        window.forzarReescaneo = () => {
            cartaActualEnPantalla = null;
            resetUltimoId();
            document.getElementById('msg-visor').innerText = "ESCANEA CARTA";
            ['val-i', 'val-a', 'val-t', 'val-m'].forEach(v => document.getElementById(v).innerText = "");
        };

        ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
            document.getElementById(id).onclick = () => {
                if(!cartaActualEnPantalla) return;
                const conf = cartaActualEnPantalla.botones[id];
                jugadaPendiente = { carta: cartaActualEnPantalla, valor: conf.valor };
                
                const v = document.getElementById('video-action');
                v.style.display = 'block';
                v.src = RUTA_BASE + conf.video;
                v.play();

                const hud = document.getElementById('hud-derecho');
                hud.style.display = 'flex';
                document.getElementById('hud-img-escudo').src = RUTA_BASE + cartaActualEnPantalla.imgEscudo;
                document.getElementById('hud-txt-arma').innerText = cartaActualEnPantalla.nombre;
                document.getElementById('hud-txt-valor').innerText = conf.valor;

                v.onended = () => { v.style.display = 'none'; hud.style.display = 'none'; };
            };
        });

        document.getElementById('btn-confirmar').onclick = () => {
            if(!jugadaPendiente) return alert("Selecciona gema primero");
            jugadores[turnoJugadorIdx].slots[slotActual] = jugadaPendiente;
            jugadaPendiente = null;
            
            turnoJugadorIdx++;
            if(turnoJugadorIdx >= cantJugadores) {
                turnoJugadorIdx = 0;
                slotActual++;
                if(slotActual >= MAX_SLOTS) {
                    alert("FIN DEL DRAFT - INICIANDO BATALLA FINAL");
                    location.reload();
                    return;
                }
            }
            actualizarUI();
            window.forzarReescaneo();
        };
    </script>
</body>
</html>