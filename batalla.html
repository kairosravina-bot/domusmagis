<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: BATALLA V81</title>
    <link rel="stylesheet" href="style.css">
    
    <script type="importmap">
    { "imports": { 
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js", 
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/", 
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js" 
    } }
    </script>
</head>
<body>
    <div id="container-ar"></div>

    <!-- MODAL FASE DE DADOS -->
    <div id="modal-dados-fase" class="pantalla oculto" style="z-index:9500; background:rgba(0,0,0,0.85);">
        <h2 style="color:#aaa; margin:0;">DESTINO</h2>
        <h1 id="dados-player-name" style="font-size:36px; margin:5px 0;">JUGADOR</h1>
        <div class="dados-container">
            <video id="video-dados-batalla" class="video-dados" src="https://kairosravina-bot.github.io/domusmagis/Dados.mp4" playsinline webkit-playsinline muted></video>
            <div id="layer-valor-batalla" class="layer-valor">0</div>
        </div>
        <div class="grid-dados">
            <div class="btn-dado-sel" id="btn-batalla-2" onclick="window.ejecutarLanzamientoBatalla(2)"><strong>2</strong></div>
            <div class="btn-dado-sel" id="btn-batalla-3" onclick="window.ejecutarLanzamientoBatalla(3)"><strong>3</strong></div>
            <div class="btn-dado-sel" id="btn-batalla-4" onclick="window.ejecutarLanzamientoBatalla(4)"><strong>4</strong></div>
            <div class="btn-dado-sel" id="btn-batalla-5" onclick="window.ejecutarLanzamientoBatalla(5)"><strong>5</strong></div>
        </div>
    </div>

    <!-- UI JUEGO -->
    <div id="ui-juego" class="oculto">
        <div id="zona-superior">
            <div id="txt-turno" style="position: absolute; top: 15px; left: 15px; z-index: 15; background: rgba(0,0,0,0.8); color: gold; padding: 10px; border: 2px solid gold;">TURNO: ---</div>
            <div id="hud-derecho" style="display:none;">
                <img id="hud-img-escudo" src="">
                <div id="hud-txt-arma">ARMA</div>
                <div id="hud-txt-accion">ACCION</div>
                <div id="hud-txt-valor">00</div>
            </div>
            <div id="guia-scanner"></div>
            <video id="video-action" playsinline webkit-playsinline></video>
        </div>

        <div id="zona-inferior">
            <div id="msg-visor" style="font-size:26px; color:gold; font-weight:900;">BUSCANDO...</div>
            <div style="background:rgba(0,255,0,0.1); border:2px solid #00ff00; border-radius:5px; padding:10px; margin:5px 0; text-align:center;">
                <div id="display-codigo-carta" style="font-size:24px; font-weight:900; color:#00ff00; font-family:monospace;">---</div>
            </div>

            <div class="contenedor-gemas">
                <div class="wrapper-gema"><span id="val-i" class="valor-flotante"></span><button id="btn-i" class="btn-gema">I</button></div>
                <div class="wrapper-gema"><span id="val-a" class="valor-flotante"></span><button id="btn-a" class="btn-gema">A</button></div>
                <div class="wrapper-gema"><span id="val-t" class="valor-flotante"></span><button id="btn-t" class="btn-gema">T</button></div>
                <div class="wrapper-gema"><span id="val-m" class="valor-flotante"></span><button id="btn-m" class="btn-gema">M</button></div>
            </div>
            
            <div style="display:flex; gap:10px; width:100%; margin-top:10px;">
                <button id="btn-confirmar" class="btn-master" style="background:#050; border-color:#0f0; flex:2;">‚úÖ CONFIRMAR</button>
                <button id="btn-forzar" class="btn-master" style="background:#500;" onclick="window.forzarBatalla()">‚öîÔ∏è YA</button>
            </div>
        </div>
    </div>

    <!-- SETUP (Solo lo necesario para iniciar) -->
    <div id="p-setup" class="pantalla" style="background:rgba(0,0,0,0.85);">
        <h2>INSCRIPCI√ìN</h2>
        <button class="btn-master" onclick="window.setModo(2)">2 JUGADORES</button>
        <button class="btn-master" onclick="window.setModo(4)">4 JUGADORES</button>
        <div id="registro" class="oculto">
            <input type="text" id="mago-nombre" placeholder="NOMBRE">
            <button onclick="window.registrarMago('TERRA','#f00')" class="btn-casa">üõ°Ô∏è TERRA</button>
            <button onclick="window.registrarMago('CAELUM','#0af')" class="btn-casa">‚öîÔ∏è CAELUM</button>
            <button onclick="window.registrarMago('AQUA','#0f8')" class="btn-casa">üíß AQUA</button>
            <button onclick="window.registrarMago('DIMENSIO','#d0f')" class="btn-casa">‚ú® DIMENSIO</button>
        </div>
    </div>

    <script type="module">
        import { CARTAS, RUTA_BASE } from './biblioteca.js';
        import { iniciarOjo } from './ojo.js';

        let jugadores = []; let cantJugadores = 0; let slotActual = 0; 
        let turnoJugadorIdx = 0; let jugadaPendiente = null;
        let cartaActualEnPantalla = null;

        window.setModo = (n) => { 
            cantJugadores = n; 
            document.getElementById('registro').classList.remove('oculto'); 
        };

        window.registrarMago = (casa, color) => {
            let n = document.getElementById('mago-nombre').value || "Mago " + (jugadores.length + 1);
            jugadores.push({ nombre: n, casa, color, slots: [null, null, null], dado: 0 });
            document.getElementById('mago-nombre').value = "";
            if(jugadores.length === cantJugadores) { 
                document.getElementById('p-setup').classList.add('oculto'); 
                document.getElementById('ui-juego').classList.remove('oculto');
                iniciarOjo('container-ar', alEncontrarCarta, alPerderCarta);
            }
        };

        // EXPLICACI√ìN: El √≠ndice que viene del ojo debe ser el √≠ndice de la propiedad en CARTAS
        function alEncontrarCarta(indice) {
            const carta = CARTAS[indice];
            if(!carta) {
                console.error("√çndice de target no coincide con biblioteca:", indice);
                return;
            }

            // Evitar refrescos innecesarios si es la misma carta
            if(cartaActualEnPantalla && cartaActualEnPantalla.codTarget === carta.codTarget) return;

            cartaActualEnPantalla = carta;
            document.getElementById('msg-visor').innerText = carta.nombre;
            document.getElementById('display-codigo-carta').innerText = carta.codTarget;
            
            // Estilo visual seg√∫n tipo
            const scanner = document.getElementById('guia-scanner');
            if(carta.tipo === 'ARTEFACTO') scanner.className = 'violeta';
            else if(carta.tipo === 'BUHO') scanner.className = 'dorado';
            else scanner.className = 'verde';
            
            actualizarEstiloBotones(carta);
        }

        function alPerderCarta() {
            cartaActualEnPantalla = null;
            document.getElementById('msg-visor').innerText = "BUSCANDO..."; 
            document.getElementById('display-codigo-carta').innerText = "---";
            document.getElementById('guia-scanner').className = ''; 
            resetBotones();
        }

        function resetBotones() { 
            ['i','a','t','m'].forEach(l => { 
                const btn = document.getElementById('btn-'+l);
                btn.innerHTML = l.toUpperCase();
                btn.className = 'btn-gema';
                document.getElementById('val-'+l).innerText = "";
            }); 
        }

        function actualizarEstiloBotones(carta) {
            ['i','a','t','m'].forEach(l => {
                const id = 'btn-'+l;
                const conf = carta.botones[id];
                const btn = document.getElementById(id);
                btn.innerHTML = conf.texto;
                if(carta.tipo === 'BUHO') btn.classList.add('style-buho');
                if(carta.tipo === 'ARTEFACTO') btn.classList.add('style-artefacto');
                document.getElementById('val-'+l).innerText = conf.valor;
            });
        }

        // Click en gemas
        ['i','a','t','m'].forEach(l => {
            document.getElementById('btn-'+l).onclick = () => {
                if(!cartaActualEnPantalla) return;
                const conf = cartaActualEnPantalla.botones['btn-'+l];
                jugadaPendiente = { carta: cartaActualEnPantalla, lado: conf.label, valor: conf.valor };
                
                const vid = document.getElementById('video-action');
                vid.style.display = 'block';
                vid.src = RUTA_BASE + conf.video;
                vid.play();
                
                const hud = document.getElementById('hud-derecho');
                hud.style.display = 'flex';
                document.getElementById('hud-img-escudo').src = RUTA_BASE + cartaActualEnPantalla.imgEscudo;
                document.getElementById('hud-txt-arma').innerText = cartaActualEnPantalla.arma;
                document.getElementById('hud-txt-accion').innerText = conf.label;
                document.getElementById('hud-txt-valor').innerText = conf.valor;

                vid.onended = () => { vid.style.display = 'none'; hud.style.display = 'none'; };
            };
        });

        document.getElementById('btn-confirmar').onclick = () => {
            if(!jugadaPendiente) return alert("Escanea una carta");
            jugadores[turnoJugadorIdx].slots[slotActual] = jugadaPendiente;
            turnoJugadorIdx++;
            if(turnoJugadorIdx >= cantJugadores) { turnoJugadorIdx = 0; slotActual++; }
            if(slotActual >= 3) { alert("¬°A LOS DADOS!"); location.reload(); }
            else { alert("Turno de " + jugadores[turnoJugadorIdx].nombre); }
            jugadaPendiente = null;
        };
    </script>
</body>
</html>