<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: BATALLA V150</title>
    <link rel="stylesheet" href="style.css">
    <script type="importmap">
    { "imports": { 
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js", 
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js" 
    } }
    </script>
</head>
<body>
    <div id="container-ar"></div>

    <!-- UI JUEGO -->
    <div id="ui-juego" class="oculto">
        <div id="zona-superior">
            <!-- VISUALIZADOR DE C√ìDIGO ESCANEADO (PARTE SUPERIOR) -->
            <div id="display-cod-target" style="position: absolute; top: 15px; width: 100%; text-align: center; z-index: 100; font-family: var(--font-titulo); font-size: 22px; color: gold; text-shadow: 0 0 10px #000; font-weight: 900; letter-spacing: 2px;">ID: ---</div>

            <div id="txt-turno" style="position: absolute; top: 60px; left: 15px; z-index: 15; background: rgba(0,0,0,0.8); color: gold; padding: 10px; border: 2px solid gold;">TURNO: ---</div>
            
            <div id="hud-derecho">
                <img id="hud-img-escudo" src="" alt="Escudo">
                <div id="hud-txt-arma">ARMA</div>
                <div id="hud-txt-accion">ACCION</div>
                <div id="hud-txt-valor">00</div>
            </div>

            <div id="guia-scanner"></div>
            <!-- VIDEO FIX: Muted por defecto para asegurar carga de imagen, se desactiva al dar play -->
            <video id="video-action" playsinline webkit-playsinline muted style="position:absolute; width:100%; height:100%; display:none; background:black; z-index:50; object-fit:contain;"></video>
        </div>

        <div id="zona-inferior">
            <div id="msg-visor" style="font-size:26px; color:var(--borde-dorado); font-weight:900;">ESCANEA CARTA</div>
            <p style="color:#aaa; font-size:20px; margin:0;">SLOT: <span id="slot-indicator" style="color:gold;">1/3</span></p>
            
            <div class="contenedor-gemas">
                <div class="wrapper-gema"><span id="val-i" class="valor-flotante"></span><button id="btn-i" class="btn-gema"><span class="letra-grande">I</span></button></div>
                <div class="wrapper-gema"><span id="val-a" class="valor-flotante"></span><button id="btn-a" class="btn-gema"><span class="letra-grande">A</span></button></div>
                <div class="wrapper-gema"><span id="val-t" class="valor-flotante"></span><button id="btn-t" class="btn-gema"><span class="letra-grande">T</span></button></div>
                <div class="wrapper-gema"><span id="val-m" class="valor-flotante"></span><button id="btn-m" class="btn-gema"><span class="letra-grande">M</span></button></div>
            </div>
            
            <div style="display:flex; gap:10px; width:100%;">
                <button id="btn-confirmar" class="btn-master" style="background:#050; border-color:#0f0; flex:2;">‚úÖ CONFIRMAR</button>
                <button id="btn-forzar" class="btn-master" style="background:#500; font-size:14px;" onclick="window.forzarBatalla()">‚öîÔ∏è YA</button>
            </div>
        </div>
    </div>

    <!-- SETUP Y MODALES (Igual que V81 funcional) -->
    <div id="p-setup" class="pantalla" style="background:rgba(0,0,0,0.8);">
        <h2>INSCRIPCI√ìN</h2>
        <div id="setup-selector" style="display:flex; gap:10px; width:100%;">
            <button class="btn-master" onclick="window.setModo(2)">2 MAGOS</button>
            <button class="btn-master" onclick="window.setModo(4)">4 MAGOS</button>
        </div>
        <div id="registro" class="oculto" style="width:100%;">
            <input type="text" id="mago-nombre" placeholder="NOMBRE DEL MAGO" autocomplete="off">
            <div class="grid-casas">
                <button onclick="window.registrarMago('TERRA','#ff0000','ESCUDO_DRAGON.png')" class="btn-casa" style="background:#500; border-color:#f00;">üõ°Ô∏è TERRA</button>
                <button onclick="window.registrarMago('CAELUM','#00aaff')" class="btn-casa" style="background:#003; border-color:#0af;">‚öîÔ∏è CAELUM</button>
                <button onclick="window.registrarMago('AQUA','#00ff88')" class="btn-casa" style="background:#030; border-color:#0f8;">üíß AQUA</button>
                <button onclick="window.registrarMago('DIMENSIO','#aa00ff')" class="btn-casa" style="background:#303; border-color:#d0f;">‚ú® DIMENSIO</button>
            </div>
            <p id="reg-status" style="color:var(--borde-dorado); text-align:center; font-size:24px; margin-top:20px; font-weight:900;"></p>
        </div>
        <button class="btn-master" style="margin-top:20px; background:#333;" onclick="window.location.href='index.html'">CANCELAR</button>
    </div>

    <script type="module">
        import { CARTAS, RUTA_BASE } from './biblioteca.js';
        import { iniciarOjo } from './ojo.js';

        let jugadores = [], cantJugadores = 0, slotActual = 0, turnoJugadorIdx = 0;
        let cartaActualEnPantalla = null, jugadaPendiente = null;

        window.setModo = (n) => { 
            cantJugadores = n; 
            document.getElementById('setup-selector').classList.add('oculto'); 
            document.getElementById('registro').classList.remove('oculto'); 
            document.getElementById('reg-status').innerText = `Mago 1 de ${n}`; 
        };

        window.registrarMago = (casa, color, esc) => {
            let n = document.getElementById('mago-nombre').value || "Mago " + (jugadores.length + 1);
            jugadores.push({ nombre: n, casa, color, esc, slots: [null, null, null], dado: 0 });
            document.getElementById('mago-nombre').value = "";
            if(jugadores.length === cantJugadores) { iniciarJuego(); } 
            else { document.getElementById('reg-status').innerText = `Mago ${jugadores.length + 1} de ${cantJugadores}`; }
        };

        function iniciarJuego() { 
            document.getElementById('p-setup').classList.add('oculto'); 
            document.getElementById('ui-juego').classList.remove('oculto'); 
            iniciarOjo('container-ar', (id) => {
                cartaActualEnPantalla = CARTAS[id];
                document.getElementById('msg-visor').innerText = cartaActualEnPantalla.nombre;
                document.getElementById('display-cod-target').innerText = cartaActualEnPantalla.codTarget;
                actualizarEstiloBotones(cartaActualEnPantalla);
            }, () => {
                cartaActualEnPantalla = null;
                document.getElementById('msg-visor').innerText = "BUSCANDO...";
                document.getElementById('display-cod-target').innerText = "ID: ---";
                document.getElementById('hud-derecho').style.display = 'none';
                resetBotones();
            });
            actualizarUI(); 
        }

        function actualizarUI() {
            const j = jugadores[turnoJugadorIdx];
            const txt = document.getElementById('txt-turno'); 
            txt.innerText = `TURNO: ${j.nombre}`; 
            txt.style.color = j.color; 
            txt.style.borderColor = j.color;
            document.getElementById('slot-indicator').innerText = `${slotActual + 1} / 3`;
            jugadaPendiente = null;
        }

        function actualizarEstiloBotones(carta) {
            ['i','a','t','m'].forEach(l => {
                const id = 'btn-' + l;
                const valId = 'val-' + l;
                const conf = carta.botones[id];
                const vSpan = document.getElementById(valId);
                vSpan.innerText = conf.valor;
                vSpan.className = "valor-flotante " + (carta.tipo==='ARTEFACTO'?'neon-amarillo':carta.tipo==='BUHO'?'neon-violeta':'neon-blanco');
            });
        }

        function resetBotones() {
            ['val-i','val-a','val-t','val-m'].forEach(id => {
                document.getElementById(id).innerText = "";
                document.getElementById(id).className = "valor-flotante";
            });
        }

        // L√≥gica de Videos con Fix de Imagen
        ['i','a','t','m'].forEach(l => {
            document.getElementById('btn-'+l).onclick = () => {
                if(!cartaActualEnPantalla) return;
                const conf = cartaActualEnPantalla.botones['btn-'+l];
                const vid = document.getElementById('video-action');
                
                vid.style.display = 'block';
                vid.muted = false; // Intentamos con sonido
                vid.src = RUTA_BASE + (cartaActualEnPantalla['mp4'+l.toUpperCase()] || conf.video);
                
                vid.load(); // Vital para m√≥viles: fuerza la carga del nuevo src
                vid.play().catch(() => {
                    vid.src = RUTA_BASE + conf.video; // Fallback gen√©rico
                    vid.load();
                    vid.play();
                });

                jugadaPendiente = { carta: cartaActualEnPantalla, lado: conf.label, valor: conf.valor };
                document.getElementById('hud-derecho').style.display = 'flex';
                document.getElementById('hud-img-escudo').src = RUTA_BASE + cartaActualEnPantalla.imgEscudo;
                document.getElementById('hud-txt-accion').innerText = conf.label;
                document.getElementById('hud-txt-valor').innerText = conf.valor;
                vid.onended = () => { vid.style.display = 'none'; document.getElementById('hud-derecho').style.display = 'none'; };
            };
        });

        document.getElementById('btn-confirmar').onclick = () => {
            if(!jugadaPendiente) return;
            jugadores[turnoJugadorIdx].slots[slotActual] = jugadaPendiente;
            turnoJugadorIdx++;
            if(turnoJugadorIdx >= cantJugadores) { turnoJugadorIdx=0; slotActual++; }
            if(slotActual >= 3) { alert("¬°BATALLA FINAL!"); location.reload(); }
            else { actualizarUI(); }
        };
    </script>
</body>
</html>