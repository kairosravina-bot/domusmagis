<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: BATALLA V80</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        #container-ar { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
        #ui-juego { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; pointer-events: none; z-index: 500; }
        
        #zona-superior { height: 50%; width: 100%; position: relative; border-bottom: 4px solid var(--borde-dorado); }
        
        #zona-inferior { 
            height: 50%; width: 100%; 
            /* Fondo semitransparente para ver piedra */
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.95)); 
            pointer-events: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px;
        }

        /* GEMAS (BOTONES) CON TEXTO ADENTRO (Estilo V76 recuperado) */
        .contenedor-gemas { display: flex; gap: 15px; margin: 5px 0; justify-content: center; }
        
        .btn-gema { 
            width: 80px; height: 80px; 
            background-color: transparent; border: none; 
            background-size: contain; background-repeat: no-repeat; background-position: center;
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: transform 0.1s; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.8));
        }
        .btn-gema:active { transform: scale(0.95); filter: brightness(1.2); }

        /* IMAGENES DE FONDO DE BOTONES */
        #btn-i { background-image: url('GEMA_ROJA.png'); } 
        #btn-a { background-image: url('GEMA_VERDE.png'); } 
        #btn-t { background-image: url('GEMA_GRIS.png'); } 
        #btn-m { background-image: url('GEMA_VIOLETA.png'); }
        
        /* CLASES PARA CAMBIAR FOTO DE BOTON SI ES BUHO/ARTEFACTO */
        .btn-gema.style-buho { background-image: url('GEMA_DORADA.png') !important; }
        .btn-gema.style-artefacto { background-image: url('GEMA_VIOLETA.png') !important; }

        /* LETRA GRANDE ADENTRO DEL BOTON (I, A, T, M) */
        .letra-grande-btn {
            font-size: 32px; font-weight: 900; color: #fff; 
            text-shadow: 0 2px 5px #000, 0 0 10px rgba(255,255,255,0.5); 
            font-family: var(--font-titulo); margin-top: -2px;
        }
        /* Cambio de color de letra interna para B√∫ho (Oscuro para contraste con dorado) */
        .btn-gema.style-buho .letra-grande-btn { color: #3d2b00; text-shadow: none; }

        /* HUD Y EXTRAS */
        #guia-scanner { width: 240px; height: 240px; border: 4px solid rgba(255,255,255,0.5); border-radius: 20px; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); box-shadow: 0 0 20px #000; }
        #video-action { position:absolute; width:100%; height:100%; display:none; background:black; z-index:50; object-fit:contain; }
        
        #hud-derecho { position: absolute; top: 10px; right: 10px; display: none; flex-direction: column; align-items: flex-end; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; border: 1px solid gold; }
        #hud-img-escudo { width: 80px; height: 80px; object-fit: contain; }
        #hud-txt-accion { font-size: 20px; color: gold; font-weight: 900; }
        #hud-txt-valor { font-size: 50px; color: white; line-height: 1; font-weight: 900; }
    </style>

    <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/", "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js" } }
    </script>
</head>
<body>

    <div id="container-ar"></div>

    <!-- MODAL DADOS -->
    <div id="modal-dados-fase" class="pantalla oculto" style="z-index:9500;">
        <h2 style="color:#aaa;">DESTINO</h2>
        <h1 id="dados-player-name" style="font-size:36px; margin:5px 0; color:gold;">JUGADOR</h1>
        <div style="position:relative; width:200px; height:200px; border:4px solid gold; border-radius:50%; overflow:hidden;">
            <video id="video-dados-batalla" src="https://kairosravina-bot.github.io/domusmagis/Dados.mp4" playsinline webkit-playsinline muted style="width:100%; height:100%; object-fit:cover;"></video>
            <div id="layer-valor-batalla" style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:80px; font-weight:900; color:white; text-shadow:0 0 10px red;">0</div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-master" onclick="ejecutarLanzamientoBatalla(2)">2D</button>
            <button class="btn-master" onclick="ejecutarLanzamientoBatalla(3)">3D</button>
        </div>
    </div>
    
    <!-- MODAL BATALLA -->
    <div id="modal-batalla" class="pantalla oculto" style="z-index:9999; background:#000;">
        <h2 style="color:gold;">BATALLA</h2>
        <div id="texto-vs" style="font-size:24px; color:#fff; margin-bottom:10px;"></div>
        <video id="video-clash" playsinline webkit-playsinline style="width:100%; max-height:300px; border:2px solid gold;"></video>
    </div>

    <!-- PANTALLA CAMBIO -->
    <div id="pantalla-cambio-turno" class="pantalla oculto">
        <h1>üõë ALTO üõë</h1>
        <p>TURNO DE:</p>
        <h2 id="next-player-name" style="font-size:40px; color:gold;">JUGADOR</h2>
        <button class="btn-master" onclick="confirmarCambioTurno()">TOMAR MANDO</button>
    </div>

    <!-- SETUP -->
    <div id="p-setup" class="pantalla">
        <h2>INSCRIPCI√ìN</h2>
        <div id="registro" style="width:100%;">
            <input type="text" id="mago-nombre" placeholder="NOMBRE MAGO">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button onclick="registrarMago('TERRA','#f00','ESCUDO_DRAGON.png')" class="btn-master" style="border-color:#f00;">TERRA</button>
                <button onclick="registrarMago('CAELUM','#0af','ESCUDO_AGUILA.png')" class="btn-master" style="border-color:#0af;">CAELUM</button>
                <button onclick="registrarMago('AQUA','#0f8','ESCUDO_JABALI.png')" class="btn-master" style="border-color:#0f8;">AQUA</button>
                <button onclick="registrarMago('DIMENSIO','#d0f','ESCUDO_ESPEJO.png')" class="btn-master" style="border-color:#d0f;">DIMENSIO</button>
            </div>
            <p id="reg-status" style="text-align:center; font-size:20px; color:gold; margin-top:10px;">Mago 1</p>
        </div>
    </div>

    <!-- UI JUEGO PRINCIPAL -->
    <div id="ui-juego" class="oculto">
        <div id="zona-superior">
            <div id="txt-turno" style="position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); color: gold; padding: 5px 10px; border: 1px solid gold;">TURNO: ---</div>
            <div id="hud-derecho">
                <img id="hud-img-escudo" src="">
                <div id="hud-txt-accion"></div>
                <div id="hud-txt-valor"></div>
            </div>
            <div id="guia-scanner"></div>
            <video id="video-action" playsinline webkit-playsinline></video>
        </div>

        <div id="zona-inferior">
            <div id="msg-visor" style="font-size:24px; color:gold; font-weight:900; margin-bottom:5px;">ESCANEA CARTA</div>
            <p style="color:#aaa; margin:0; margin-bottom:10px;">SLOT: <span id="slot-indicator">1/3</span></p>
            
            <!-- AQUI APARECEN LOS VALORES NUM√âRICOS FLOTANTES -->
            <div id="fila-labels" class="fila-valores-flotantes">
                <span id="val-i" class="val-flotante"></span>
                <span id="val-a" class="val-flotante"></span>
                <span id="val-t" class="val-flotante"></span>
                <span id="val-m" class="val-flotante"></span>
            </div>

            <!-- BOTONES CON LETRAS (I, A, T, M) ADENTRO -->
            <div class="contenedor-gemas">
                <button id="btn-i" class="btn-gema"><span class="letra-grande-btn">I</span></button>
                <button id="btn-a" class="btn-gema"><span class="letra-grande-btn">A</span></button>
                <button id="btn-t" class="btn-gema"><span class="letra-grande-btn">T</span></button>
                <button id="btn-m" class="btn-gema"><span class="letra-grande-btn">M</span></button>
            </div>
            
            <button id="btn-confirmar" class="btn-master" style="background:#050; border-color:#0f0; margin-top:15px;">‚úÖ CONFIRMAR</button>
        </div>
    </div>

    <!-- RESULTADOS -->
    <div id="p-resultado" class="pantalla oculto">
        <h2>RESULTADOS</h2>
        <div id="resultado-batalla"><div id="resultado-contenido"></div></div>
        <button class="btn-master" onclick="window.location.href='index.html'">SALIR</button>
    </div>

    <script>
        const RUTA_BASE = "https://kairosravina-bot.github.io/domusmagis/";
        const CARTAS = {
            0: { id: 0, nombre: "DRAG√ìN", arma: "SICA", elemento: "TERRA", imgEscudo: "ESCUDO_DRAGON.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 7, video: "CARTA_1_ataque.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 2, video: "CARTA_1_cura.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 3, video: "CARTA_1_defensa.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 2, video: "CARTA_1_magia.mp4" } } },
            1: { id: 1, nombre: "√ÅGUILA", arma: "SICA", elemento: "CAELUM", imgEscudo: "ESCUDO_AGUILA.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 5, video: "ataque.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 4, video: "cura.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 2, video: "defensa.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 3, video: "magia.mp4" } } },
            2: { id: 2, nombre: "LE√ìN", arma: "SICA", elemento: "TERRA", imgEscudo: "ESCUDO_LEON.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 8, video: "ataque.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 1, video: "cura.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 4, video: "defensa.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 1, video: "magia.mp4" } } },
            3: { id: 3, nombre: "JABAL√ç", arma: "SICA", elemento: "AQUA", imgEscudo: "ESCUDO_JABALI.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 6, video: "ataque.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 3, video: "cura.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 3, video: "defensa.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 2, video: "magia.mp4" } } },
            4: { id: 4, nombre: "B√öHO MASTER", arma: "ACUTUM", elemento: "NEUTRO", imgEscudo: "ESCUDO_BUHO.png", tipo: "BUHO", botones: { "btn-i": { texto: "M", label: "MANDATUM", valor: 5, video: "owl_mandatum.mp4" }, "btn-a": { texto: "C", label: "CONSILIUM", valor: 5, video: "owl_consilium.mp4" }, "btn-t": { texto: "P", label: "PRAESAGIUM", valor: 5, video: "owl_praesagium.mp4" }, "btn-m": { texto: "A", label: "ARCANUM", valor: 5, video: "owl_arcanum.mp4" } } },
            5: { id: 5, nombre: "IGNIS PHIALA", arma: "IGNIS", elemento: "TERRA", imgEscudo: "ESCUDO_LLAVE.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 10, video: "ARTEFACTO_1_IMPETUS.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 8, video: "ARTEFACTO_1_AUXILIUM.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 8, video: "ARTEFACTO_1_TUTELA.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 12, video: "ARTEFACTO_1_MYSTERIUM.mp4" } } },
            6: { id: 6, nombre: "SPECULUM AEGIS", arma: "SPECULUM", elemento: "DIMENSIO", imgEscudo: "ESCUDO_LLAVE.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 6, video: "ESPEJO_GOLPE.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 9, video: "ESPEJO_EQUIPAR.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 10, video: "ESPEJO_BLOQUEO.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 7, video: "ESPEJO_ILUSION.mp4" } } },
            7: { id: 7, nombre: "TEMPUS FUGIT", arma: "CHRONOS", elemento: "DIMENSIO", imgEscudo: "ESCUDO_LLAVE.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 8, video: "RELOJ_ACELERAR.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 7, video: "RELOJ_REVERTIR.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 10, video: "RELOJ_CONGELAR.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 15, video: "RELOJ_ROMPER.mp4" } } },
            8: { id: 8, nombre: "GRIMORIUM UMBRA", arma: "GRIMORIUM", elemento: "DIMENSIO", imgEscudo: "ESCUDO_LLAVE.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 9, video: "LIBRO_ABRIR.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 8, video: "LIBRO_LEER.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 7, video: "LIBRO_CERRAR.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 12, video: "LIBRO_QUEMAR.mp4" } } },
            9: { id: 9, nombre: "LAPIS AETHER", arma: "LAPIS", elemento: "CAELUM", imgEscudo: "ESCUDO_LLAVE.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 7, video: "PIEDRA_DISPARAR.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 6, video: "PIEDRA_ABSORBER.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 9, video: "PIEDRA_CAMPO.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 11, video: "PIEDRA_ESTALLIDO.mp4" } } }
        };

        let jugadores = []; let cantJugadores = 2; let slotActual = 0; let turnoJugadorIdx = 0; const MAX_SLOTS = 3; let jugadaPendiente = null;
        let ultimaJugada = null; let dadosSeleccionadosBatalla = 2;

        function registrarMago(casa, color, esc) {
            let n = document.getElementById('mago-nombre').value || "Mago " + (jugadores.length + 1);
            jugadores.push({ nombre: n, casa, color, esc, slots: [null, null, null], dado: 0 });
            document.getElementById('mago-nombre').value = "";
            document.getElementById('reg-status').innerText = `Mago ${jugadores.length + 1}`;
            if(jugadores.length === cantJugadores) { 
                document.getElementById('p-setup').classList.add('oculto'); 
                document.getElementById('ui-juego').classList.remove('oculto'); 
                window.iniciarAR(); actualizarUI(); 
            }
        }
        function actualizarUI() {
            const j = jugadores[turnoJugadorIdx];
            document.getElementById('txt-turno').innerText = `TURNO: ${j.nombre}`;
            document.getElementById('slot-indicator').innerText = `${slotActual + 1} / ${MAX_SLOTS}`;
            document.getElementById('msg-visor').style.display = 'block';
            resetVisuals(); // Borrar valores flotantes y resetear botones
            jugadaPendiente = null;
        }
        function confirmarCambioTurno() { document.getElementById('pantalla-cambio-turno').classList.add('oculto'); actualizarUI(); }
        
        function ejecutarLanzamientoBatalla(n) { 
            let total = 0; for(let i=0; i<n; i++) total += Math.floor(Math.random()*6)+1;
            jugadores[turnoJugadorIdx].dado = total;
            document.getElementById('layer-valor-batalla').innerText = total;
            // (Simplificado para brevedad: ir√≠a l√≥gica de cambio de jugador/fase batalla final)
        }

        // --- FUNCIONES VISUALES (V80) ---

        // Resetea botones a estado inicial y limpia n√∫meros flotantes
        function resetVisuals() {
            ['btn-i','btn-a','btn-t','btn-m'].forEach(id => {
                const btn = document.getElementById(id);
                // Restaurar texto original del boton (I, A, T, M)
                const letras = {'btn-i':'I', 'btn-a':'A', 'btn-t':'T', 'btn-m':'M'};
                btn.innerHTML = `<span class="letra-grande-btn">${letras[id]}</span>`;
                btn.classList.remove('style-buho', 'style-artefacto');
            });
            // Limpiar valores flotantes
            ['val-i','val-a','val-t','val-m'].forEach(id => {
                const val = document.getElementById(id);
                val.innerText = "";
                val.className = "val-flotante"; // Quitar neones
            });
        }

        // Muestra los VALORES NUMERICOS ARRIBA y cambia estilo botones
        function mostrarValoresFlotantes(carta) {
            // 1. Botones (Solo imagen de fondo)
            ['btn-i','btn-a','btn-t','btn-m'].forEach(id => {
                const btn = document.getElementById(id);
                const conf = carta.botones[id];
                if(carta.tipo === 'BUHO') {
                    btn.classList.add('style-buho');
                    btn.innerHTML = `<span class="letra-grande-btn">${conf.texto}</span>`; // M, C, P, A para Buho
                } else if(carta.tipo === 'ARTEFACTO') {
                    btn.classList.add('style-artefacto');
                }
            });

            // 2. Valores Flotantes (Numeros)
            const map = { 'btn-i':'val-i', 'btn-a':'val-a', 'btn-t':'val-t', 'btn-m':'val-m' };
            
            for (const [btnId, valId] of Object.entries(map)) {
                const conf = carta.botones[btnId];
                const valEl = document.getElementById(valId);
                valEl.innerText = conf.valor; // <--- AQUI SE PONE EL NUMERO (7, 5, etc)

                // Aplicar Color Neon
                if (carta.tipo === 'BUHO') valEl.classList.add('neon-violeta'); 
                else if (carta.tipo === 'ARTEFACTO') valEl.classList.add('neon-amarillo');
                else valEl.classList.add('neon-blanco');
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';
        let mindarThree = null; let cartaDetectada = null;
        const ui = { msg: document.getElementById('msg-visor'), videoAction: document.getElementById('video-action') };
        
        window.iniciarAR = async function() {
            if(mindarThree) return;
            mindarThree = new MindARThree({ container: document.getElementById('container-ar'), imageTargetSrc: RUTA_BASE + 'targets1.mind' });
            const {renderer, scene, camera} = mindarThree;

            for(let i=0; i<10; i++) {
                const anchor = mindarThree.addAnchor(i);
                anchor.onTargetFound = () => { 
                    cartaDetectada = CARTAS[i]; if(!cartaDetectada) return;
                    ui.msg.innerText = cartaDetectada.nombre;
                    mostrarValoresFlotantes(cartaDetectada); // ACTIVAR VALORES FLOTANTES
                };
                anchor.onTargetLost = () => { 
                    cartaDetectada = null; ui.msg.innerText = "BUSCANDO..."; 
                    resetVisuals(); // LIMPIAR
                };
            }

            // Eventos Click
            ['btn-i','btn-a','btn-t','btn-m'].forEach(id => {
                document.getElementById(id).onclick = () => {
                    if(!cartaDetectada) return;
                    const conf = cartaDetectada.botones[id];
                    jugadaPendiente = { carta: cartaDetectada, lado: conf.label, valor: conf.valor };
                    // Video logic...
                };
            });

            await mindarThree.start();
            renderer.setAnimationLoop(() => { renderer.render(scene, camera); });
        };
        
        document.getElementById('btn-confirmar').onclick = () => {
            if(!jugadaPendiente) { alert("Escanea primero"); return; }
            jugadores[turnoJugadorIdx].slots[slotActual] = jugadaPendiente;
            turnoJugadorIdx++; if(turnoJugadorIdx >= cantJugadores) { turnoJugadorIdx=0; slotActual++; }
            if(slotActual >= MAX_SLOTS) { /* Fin */ } 
            else { document.getElementById('pantalla-cambio-turno').classList.remove('oculto'); document.getElementById('next-player-name').innerText = jugadores[turnoJugadorIdx].nombre; }
        };
    </script>
</body>
</html>