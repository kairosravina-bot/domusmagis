<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: REVELATIONS V101</title>
    <link rel="stylesheet" href="style.css">
    <script type="importmap">
    { "imports": { 
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js", 
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js" 
    } }
    </script>
</head>
<body>
    <div id="container-ar"></div>

    <!-- PANTALLA SETUP (RECUPERADA) -->
    <div id="p-setup" class="pantalla" style="background:rgba(0,0,0,0.85);">
        <h2 style="color:var(--color-oro);">INSCRIPCI√ìN V101</h2>
        <div id="setup-selector" style="display:flex; gap:10px; width:100%;">
            <button class="btn-master" onclick="window.setModo(2)">2 MAGOS</button>
            <button class="btn-master" onclick="window.setModo(4)">4 MAGOS</button>
        </div>
        <div id="registro" class="oculto" style="width:100%;">
            <input type="text" id="mago-nombre" placeholder="NOMBRE DEL MAGO">
            <div class="grid-casas">
                <button onclick="window.registrarMago('TERRA','#ff4444','ESCUDO_DRAGON.png')" class="btn-casa" style="background:#500;">üõ°Ô∏è TERRA</button>
                <button onclick="window.registrarMago('CAELUM','#44aaff','ESCUDO_AGUILA.png')" class="btn-casa" style="background:#003;">‚öîÔ∏è CAELUM</button>
                <button onclick="window.registrarMago('AQUA','#44ffaa','ESCUDO_JABALI.png')" class="btn-casa" style="background:#030;">üíß AQUA</button>
                <button onclick="window.registrarMago('DIMENSIO','#aa44ff','ESCUDO_ESPEJO.png')" class="btn-casa" style="background:#303;">‚ú® DIMENSIO</button>
            </div>
            <p id="reg-status" style="color:var(--color-oro); text-align:center; font-size:24px; margin-top:20px;"></p>
        </div>
    </div>

    <!-- UI JUEGO (EST√âTICA ORIGINAL) -->
    <div id="ui-juego" class="oculto">
        <div id="zona-superior">
            <div id="txt-turno" style="position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); color: gold; padding: 10px; border: 2px solid gold; font-family:'Cinzel';">TURNO</div>
            
            <div id="hud-derecho" style="display:none; position: absolute; top: 10px; right: 10px; flex-direction: column; align-items: flex-end; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 10px;">
                <img id="hud-img-escudo" src="" width="80">
                <div id="hud-txt-valor" style="font-size:60px; color:white; font-weight:900;">00</div>
            </div>

            <div id="guia-scanner"></div>
            <video id="video-action" playsinline webkit-playsinline></video>
        </div>

        <div id="zona-inferior">
            <div id="msg-visor" style="font-size:26px; color:var(--borde-dorado); font-weight:900;">ESCANEA CARTA</div>
            <p style="color:#aaa; font-size:18px; margin:0;">SLOT: <span id="slot-indicator" style="color:gold;">1/3</span></p>
            
            <div class="contenedor-gemas">
                <div class="wrapper-gema">
                    <span id="val-i" class="valor-flotante"></span>
                    <button id="btn-i" class="btn-gema"><span class="letra-grande">I</span></button>
                </div>
                <div class="wrapper-gema">
                    <span id="val-a" class="valor-flotante"></span>
                    <button id="btn-a" class="btn-gema"><span class="letra-grande">A</span></button>
                </div>
                <div class="wrapper-gema">
                    <span id="val-t" class="valor-flotante"></span>
                    <button id="btn-t" class="btn-gema"><span class="letra-grande">T</span></button>
                </div>
                <div class="wrapper-gema">
                    <span id="val-m" class="valor-flotante"></span>
                    <button id="btn-m" class="btn-gema"><span class="letra-grande">M</span></button>
                </div>
            </div>
            
            <button id="btn-confirmar" class="btn-master" style="background:#050; border-color:#0f0;">‚úÖ CONFIRMAR SLOT</button>
        </div>
    </div>

    <!-- PANTALLA CAMBIO TURNO -->
    <div id="pantalla-cambio-turno" class="pantalla oculto" style="background:rgba(0,0,0,0.95); z-index:9000;">
        <h1 style="color:red; font-size:40px;">üõë ALTO üõë</h1>
        <p style="font-size:20px;">ENTREGAR DISPOSITIVO A:</p>
        <h2 id="next-player-name" style="font-size:50px; color:gold;">---</h2>
        <button class="btn-master" onclick="window.confirmarCambioTurno()">TOMAR EL MANDO</button>
    </div>

    <script type="module">
        import { CARTAS, RUTA_BASE } from './biblioteca.js';
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        let jugadores = []; let cantJugadores = 0; let turnoIdx = 0; let slotIdx = 0;
        let cartaActiva = null; let jugadaActual = null; let mindarThree = null;

        // VINCULACI√ìN DE FUNCIONES AL WINDOW (PARA QUE LOS BOTONES FUNCIONEN)
        window.setModo = (n) => {
            cantJugadores = n;
            document.getElementById('setup-selector').classList.add('oculto');
            document.getElementById('registro').classList.remove('oculto');
            document.getElementById('reg-status').innerText = `Mago 1 de ${n}`;
        };

        window.registrarMago = (casa, color, esc) => {
            const nom = document.getElementById('mago-nombre').value || "MAGO " + (jugadores.length + 1);
            jugadores.push({ nombre: nom, color, casa, esc, slots: [null,null,null] });
            document.getElementById('mago-nombre').value = "";
            if(jugadores.length == cantJugadores) iniciarJuego();
            else document.getElementById('reg-status').innerText = `Mago ${jugadores.length + 1} de ${cantJugadores}`;
        };

        async function iniciarJuego() {
            document.getElementById('p-setup').classList.add('oculto');
            document.getElementById('ui-juego').classList.remove('oculto');
            
            mindarThree = new MindARThree({
                container: document.getElementById('container-ar'),
                imageTargetSrc: RUTA_BASE + 'targets1.mind',
                maxTrack: 1, uiLoading: "no", uiScanning: "no"
            });

            const { renderer, scene, camera } = mindarThree;

            // Escuchamos del 0 al 100 para cubrir todos tus c√≥digos
            for (let i = 0; i <= 100; i++) {
                const anchor = mindarThree.addAnchor(i);
                anchor.onTargetFound = () => { detectado(i); };
                anchor.onTargetLost = () => { perdido(); };
            }

            await mindarThree.start();
            renderer.setAnimationLoop(() => { renderer.render(scene, camera); });
            actualizarUI();
        }

        function detectado(id) {
            const c = CARTAS[id];
            if(!c) return;
            cartaActiva = c;
            document.getElementById('msg-visor').innerText = c.nombre;
            document.getElementById('guia-scanner').className = (id >= 81) ? 'violeta' : 'verde';
            
            ['i','a','t','m'].forEach(l => {
                const val = c.botones['btn-'+l].valor;
                const el = document.getElementById('val-'+l);
                el.innerText = val;
                el.className = "valor-flotante " + (id >= 81 ? "neon-amarillo" : "neon-blanco");
            });
        }

        function perdido() {
            cartaActiva = null;
            document.getElementById('msg-visor').innerText = "ESCANEA CARTA";
            document.getElementById('guia-scanner').className = "";
            ['i','a','t','m'].forEach(l => document.getElementById('val-'+l).innerText = "");
            document.getElementById('hud-derecho').style.display = 'none';
        }

        function actualizarUI() {
            const j = jugadores[turnoIdx];
            const el = document.getElementById('txt-turno');
            el.innerText = "MAGO: " + j.nombre; 
            el.style.color = j.color; 
            el.style.borderColor = j.color;
            document.getElementById('slot-indicator').innerText = `${slotIdx + 1} / 3`;
        }

        ['i','a','t','m'].forEach(l => {
            document.getElementById('btn-'+l).onclick = () => {
                if(!cartaActiva) return;
                const b = cartaActiva.botones['btn-'+l];
                jugadaActual = { carta: cartaActiva, valor: b.valor, accion: b.label };
                
                const vid = document.getElementById('video-action');
                vid.src = RUTA_BASE + b.video;
                vid.style.display = 'block'; vid.play();
                vid.onended = () => vid.style.display = 'none';

                const hud = document.getElementById('hud-derecho');
                hud.style.display = 'flex';
                document.getElementById('hud-img-escudo').src = RUTA_BASE + cartaActiva.imgEscudo;
                document.getElementById('hud-txt-valor').innerText = b.valor;
            };
        });

        document.getElementById('btn-confirmar').onclick = () => {
            if(!jugadaActual) { alert("Elige una acci√≥n (I,A,T,M)"); return; }
            jugadores[turnoIdx].slots[slotIdx] = jugadaActual;
            
            turnoIdx++;
            if(turnoIdx >= cantJugadores) { 
                turnoIdx = 0; 
                slotIdx++; 
            }
            
            if(slotIdx >= 3) { 
                alert("CONTIENDA FINALIZADA - REINICIANDO"); 
                location.reload(); 
            } else {
                document.getElementById('pantalla-cambio-turno').classList.remove('oculto');
                document.getElementById('next-player-name').innerText = jugadores[turnoIdx].nombre;
                document.getElementById('next-player-name').style.color = jugadores[turnoIdx].color;
            }
        };

        window.confirmarCambioTurno = () => {
            document.getElementById('pantalla-cambio-turno').classList.add('oculto');
            jugadaActual = null;
            actualizarUI();
        };
    </script>
</body>
</html>