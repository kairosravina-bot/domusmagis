<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: BATALLA V112</title>
    <link rel="stylesheet" href="style.css">
    <script type="importmap">
    { "imports": { 
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js", 
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js" 
    } }
    </script>
</head>
<body>
    <div id="container-ar"></div>

    <!-- DEBUG TARGET -->
    <div id="debug-target" style="position: absolute; top: 70px; left: 15px; z-index: 9999; background: rgba(255,0,0,0.8); color: white; padding: 5px 15px; border: 2px solid white; font-size: 24px; font-weight: 900; display: none; pointer-events: none; font-family: 'Cinzel', serif;">ID: ---</div>

    <!-- SETUP CON ANIMACION -->
    <div id="p-setup" class="pantalla pantalla-setup" style="background:rgba(0,0,0,0.95); z-index: 10000;">
        <div class="contenedor-setup">
            <h2 style="color: gold; font-size: 48px; margin-bottom: 10px; text-shadow: 0 0 20px gold;">INSCRIPCION</h2>
            <p style="color: #aaa; font-size: 14px; margin-bottom: 30px; letter-spacing: 2px;">ELIGE MODO DE JUEGO</p>
            
            <div id="setup-selector" style="display:flex; gap:15px; width:100%; max-width: 350px; margin-bottom: 30px;">
                <button class="btn-master btn-modo" onclick="window.setModo(2)" style="flex: 1;">
                    <span style="font-size: 24px;">‚öîÔ∏è</span><br>2 MAGOS
                </button>
                <button class="btn-master btn-modo" onclick="window.setModo(4)" style="flex: 1;">
                    <span style="font-size: 24px;">üë•</span><br>4 MAGOS
                </button>
            </div>

            <div id="registro" class="oculto" style="width:100%; max-width: 350px;">
                <div style="background: rgba(212, 175, 55, 0.1); border-left: 3px solid gold; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
                    <p id="contador-magos" style="color: gold; font-size: 14px; margin: 0; text-transform: uppercase; letter-spacing: 2px;">MAGO 1 DE 2</p>
                </div>

                <input type="text" id="mago-nombre" placeholder="NOMBRE DEL MAGO" maxlength="20">
                
                <p style="color: #aaa; font-size: 12px; margin: 15px 0 10px 0; text-transform: uppercase; letter-spacing: 1px;">SELECCIONA TU CASA</p>
                <div class="grid-casas">
                    <button onclick="window.registrarMago('TERRA','#ff0000')" class="btn-casa btn-casa-tierra">
                        <span style="font-size: 32px;">‚öîÔ∏è</span> TERRA
                    </button>
                    <button onclick="window.registrarMago('CAELUM','#00aaff')" class="btn-casa btn-casa-cielo">
                        <span style="font-size: 32px;">‚ö°</span> CAELUM
                    </button>
                    <button onclick="window.registrarMago('AQUA','#00ff88')" class="btn-casa btn-casa-agua">
                        <span style="font-size: 32px;">üíß</span> AQUA
                    </button>
                    <button onclick="window.registrarMago('DIMENSIO','#aa00ff')" class="btn-casa btn-casa-magia">
                        <span style="font-size: 32px;">‚ú®</span> DIMENSIO
                    </button>
                </div>
                
                <p id="reg-status" style="color:gold; text-align:center; margin-top:20px; font-weight:bold; font-size: 16px; letter-spacing: 1px;"></p>
            </div>

            <button class="btn-master" style="margin-top:30px; background:#333; border-color: #777; width:100%; max-width: 350px;" onclick="window.location.href='index.html'">‚¨ÖÔ∏è VOLVER</button>
        </div>
    </div>

    <!-- UI JUEGO MEJORADA -->
    <div id="ui-juego" class="oculto">
        <div id="zona-superior">
            <div id="txt-turno" style="position: absolute; top: 15px; left: 15px; z-index: 15; background: rgba(0,0,0,0.8); color: gold; padding: 10px; border: 2px solid gold; border-radius: 5px;">TURNO: ---</div>
            
            <div id="info-jugadores" style="position: absolute; top: 15px; right: 15px; z-index: 15; background: rgba(0,0,0,0.8); color: #aaa; padding: 10px; border: 2px solid #555; border-radius: 5px; font-size: 12px; max-width: 150px; text-align: right;"></div>
            
            <div id="hud-derecho">
                <img id="hud-img-escudo" src="">
                <div id="hud-txt-arma">ARMA</div>
                <div id="hud-txt-accion">ACCION</div>
                <div id="hud-txt-valor">00</div>
            </div>
            <div id="guia-scanner"></div>
            <video id="video-action" playsinline></video>
        </div>

        <div id="zona-inferior">
            <div id="msg-visor" style="font-size:26px; color:var(--borde-dorado); font-weight:900;">ESCANEA CARTA</div>
            <p style="color:#aaa; margin:0; font-size: 12px;">SLOT: <span id="slot-indicator" style="color:gold;">1/3</span> | JUGADOR: <span id="jugador-actual" style="color:gold;">---</span></p>
            
            <div class="contenedor-gemas">
                <div class="wrapper-gema">
                    <span id="val-i" class="valor-flotante"></span>
                    <button id="btn-i" class="btn-gema" title="IMPETUS">
                        <span class="letra-grande">I</span>
                    </button>
                </div>
                <div class="wrapper-gema">
                    <span id="val-a" class="valor-flotante"></span>
                    <button id="btn-a" class="btn-gema" title="AUXILIUM">
                        <span class="letra-grande">A</span>
                    </button>
                </div>
                <div class="wrapper-gema">
                    <span id="val-t" class="valor-flotante"></span>
                    <button id="btn-t" class="btn-gema" title="TUTELA">
                        <span class="letra-grande">T</span>
                    </button>
                </div>
                <div class="wrapper-gema">
                    <span id="val-m" class="valor-flotante"></span>
                    <button id="btn-m" class="btn-gema" title="MYSTERIUM">
                        <span class="letra-grande">M</span>
                    </button>
                </div>
            </div>
            <button id="btn-confirmar" class="btn-master" style="background:#050; border-color:#0f0; width:100%; max-width: 350px;">‚úî CONFIRMAR</button>
        </div>
    </div>

    <script type="module">
        import { CARTAS, RUTA_BASE } from './biblioteca.js';
        import { iniciarOjo } from './ojo.js';

        let jugadores = [], cantJugadores = 0, slotActual = 0, turnoJugadorIdx = 0;
        let cartaActual = null, jugadaPendiente = null;

        window.setModo = function(n) {
            console.log("üéÆ setModo llamado con:", n, "jugadores");
            cantJugadores = n;
            const selector = document.getElementById('setup-selector');
            const registro = document.getElementById('registro');
            const contador = document.getElementById('contador-magos');
            
            if (selector) selector.classList.add('oculto');
            if (registro) {
                registro.classList.remove('oculto');
                registro.style.animation = 'fadeIn 0.5s ease-in';
            }
            if (contador) contador.innerText = `MAGO 1 DE ${n}`;
            
            console.log("‚úÖ Modo establecido a", n, "jugadores");
        };

        window.registrarMago = function(casa, col) {
            console.log("üë§ registrarMago llamado:", casa, col);
            const nombreInput = document.getElementById('mago-nombre');
            let n = nombreInput.value.trim() || "MAGO " + (jugadores.length + 1);
            
            jugadores.push({ 
                nombre: n, 
                casa: casa,
                color: col, 
                slots: [null, null, null], 
                dado: 0 
            });
            
            nombreInput.value = "";
            
            console.log(`‚úÖ Jugador registrado: ${n} (${casa})`);
            console.log(`üìä Total jugadores: ${jugadores.length}/${cantJugadores}`);
            
            if(jugadores.length === cantJugadores) { 
                console.log("üéÆ Todos los jugadores registrados, iniciando juego...");
                setTimeout(() => iniciarJuego(), 300);
            } else { 
                const contador = document.getElementById('contador-magos');
                if (contador) contador.innerText = `MAGO ${jugadores.length + 1} DE ${cantJugadores}`;
                nombreInput.focus();
            }
        };

        function iniciarJuego() {
            console.log("üöÄ iniciarJuego llamado");
            const pSetup = document.getElementById('p-setup');
            const uiJuego = document.getElementById('ui-juego');
            
            if (pSetup) pSetup.classList.add('oculto');
            if (uiJuego) uiJuego.classList.remove('oculto');
            
            console.log("üì° Iniciando detecci√≥n AR...");
            
            iniciarOjo('container-ar', (id) => {
                cartaActual = CARTAS[id];
                const visor = document.getElementById('msg-visor');
                if (visor) {
                    visor.innerText = cartaActual.nombre;
                    visor.style.animation = 'pulse 0.3s ease-out';
                }
                
                const dbg = document.getElementById('debug-target');
                if (dbg) {
                    dbg.innerText = "TARGET: " + cartaActual.codTarget;
                    dbg.style.display = 'block';
                }
                
                console.log("üé¥ Carta encontrada:", cartaActual.nombre);
                actualizarEstiloBotones(cartaActual);
            }, () => {
                cartaActual = null;
                const visor = document.getElementById('msg-visor');
                if (visor) visor.innerText = "BUSCANDO...";
                
                const dbg = document.getElementById('debug-target');
                if (dbg) dbg.style.display = 'none';
                
                const hud = document.getElementById('hud-derecho');
                if (hud) hud.style.display = 'none';
            });
            
            actualizarTurnoUI();
        }

        function actualizarTurnoUI() {
            if (jugadores.length === 0) return;
            
            const j = jugadores[turnoJugadorIdx];
            const txt = document.getElementById('txt-turno');
            const jugadorActual = document.getElementById('jugador-actual');
            
            if (txt) {
                txt.innerText = "TURNO: " + j.nombre;
                txt.style.color = j.color;
                txt.style.borderColor = j.color;
            }

            if (jugadorActual) {
                jugadorActual.innerText = j.nombre;
                jugadorActual.style.color = j.color;
            }

            const infoJugadores = document.getElementById('info-jugadores');
            if (infoJugadores) {
                let info = `<strong>JUGADORES:</strong><br>`;
                jugadores.forEach((jug, idx) => {
                    let slots = (jug.slots[slotActual] ? '‚úî' : '‚óã');
                    info += `${slots} ${jug.nombre}<br>`;
                });
                infoJugadores.innerHTML = info;
            }
            
            const indicator = document.getElementById('slot-indicator');
            if (indicator) indicator.innerText = `${slotActual + 1} / 3`;
        }

        function actualizarEstiloBotones(carta) {
            ['i','a','t','m'].forEach(l => {
                const id = 'btn-' + l;
                const valId = 'val-' + l;
                const conf = carta.botones[id];
                const vSpan = document.getElementById(valId);
                
                if (vSpan) {
                    vSpan.innerText = conf.valor;
                    vSpan.className = "valor-flotante " + (
                        carta.tipo === 'ARTEFACTO' ? 'neon-amarillo' : 
                        carta.tipo === 'BUHO' ? 'neon-violeta' : 
                        'neon-blanco'
                    );
                }
            });
        }

        ['i','a','t','m'].forEach(l => {
            const btn = document.getElementById('btn-'+l);
            if (btn) {
                btn.onclick = function() {
                    if(!cartaActual) {
                        console.log("‚ö†Ô∏è No hay carta seleccionada");
                        return;
                    }
                    
                    const conf = cartaActual.botones['btn-'+l];
                    const vid = document.getElementById('video-action');
                    let vidEspecifico = cartaActual['mp4'+l.toUpperCase()];
                    
                    console.log(`üé¨ Reproduciendo video para: ${conf.label}`);

                    if (vid) {
                        vid.style.display = 'block';
                        vid.src = RUTA_BASE + vidEspecifico;
                        vid.play().catch(() => {
                            console.log("‚ÑπÔ∏è Video espec√≠fico no disponible, usando video gen√©rico");
                            vid.src = RUTA_BASE + conf.video;
                            vid.play();
                        });
                    }

                    jugadaPendiente = { 
                        carta: cartaActual, 
                        valor: conf.valor, 
                        lado: conf.label 
                    };
                    
                    const hud = document.getElementById('hud-derecho');
                    if (hud) {
                        hud.style.display = 'flex';
                        const escudo = document.getElementById('hud-img-escudo');
                        const accion = document.getElementById('hud-txt-accion');
                        const valor = document.getElementById('hud-txt-valor');
                        
                        if (escudo) escudo.src = RUTA_BASE + cartaActual.imgEscudo;
                        if (accion) accion.innerText = conf.label;
                        if (valor) valor.innerText = conf.valor;
                    }
                    
                    if (vid) {
                        vid.onended = () => { 
                            vid.style.display = 'none'; 
                            if (hud) hud.style.display = 'none'; 
                        };
                    }
                };
            }
        });

        const btnConfirmar = document.getElementById('btn-confirmar');
        if (btnConfirmar) {
            btnConfirmar.onclick = function() {
                if(!jugadaPendiente) {
                    console.log("‚ö†Ô∏è No hay jugada pendiente");
                    return;
                }
                
                const jug = jugadores[turnoJugadorIdx];
                console.log(`üíæ Guardando jugada de ${jug.nombre}: ${jugadaPendiente.lado} (${jugadaPendiente.valor})`);
                
                jug.slots[slotActual] = jugadaPendiente;
                jugadaPendiente = null;
                turnoJugadorIdx++;
                
                if(turnoJugadorIdx >= cantJugadores) { 
                    turnoJugadorIdx = 0; 
                    slotActual++;
                    console.log(`üìà Slot completado. Avanzando a slot ${slotActual + 1}`);
                }
                
                if(slotActual >= 3) { 
                    console.log("üéä ¬°BATALLA COMPLETADA!");
                    mostrarResumenBatalla();
                } else { 
                    actualizarTurnoUI(); 
                }
            };
        }

        function mostrarResumenBatalla() {
            let resumen = "üéä BATALLA FINAL üéä\n\n";
            jugadores.forEach((jug, idx) => {
                resumen += `${jug.nombre} (${jug.casa})\n`;
                jug.slots.forEach((slot, s) => {
                    if (slot) {
                        resumen += `  Slot ${s + 1}: ${slot.lado} (${slot.valor})\n`;
                    }
                });
                resumen += "\n";
            });
            alert(resumen);
            location.reload();
        }

        window.addEventListener('load', () => {
            const input = document.getElementById('mago-nombre');
            if (input) input.focus();
        });
    </script>
</body>
</html>