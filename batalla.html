<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: BATALLA V83</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
    <div id="container-ar"></div>

    <div id="ui-superior-fijo" style="position:fixed; top:10px; left:10px; z-index:9000; display:none;">
        <div id="txt-turno" style="background:rgba(0,0,0,0.9); padding:10px 15px; border:3px solid gold; font-size:24px; font-weight:900; border-radius:8px;">TURNO: ---</div>
        <div id="txt-vuelta" style="background:gold; color:black; padding:5px 10px; font-weight:900; border-radius:5px; margin-top:5px; display:inline-block;">VUELTA: 1 / 7</div>
    </div>

    <!-- MODAL DADOS -->
    <div id="modal-dados-fase" class="pantalla oculto" style="z-index:9500; background:rgba(0,0,0,0.9);">
        <h1 id="dados-player-name" style="font-size:36px; font-weight:900; color:white;">JUGADOR</h1>
        <div class="dados-container">
            <video id="video-dados-batalla" class="video-dados" src="https://kairosravina-bot.github.io/domusmagis/Dados.mp4" playsinline muted></video>
            <div id="layer-valor-batalla" class="layer-valor" style="font-weight:900;">0</div>
        </div>
        <div class="grid-dados">
            <div class="btn-dado-sel" onclick="window.ejecutarLanzamientoBatalla(2)"><strong>2</strong></div>
            <div class="btn-dado-sel" onclick="window.ejecutarLanzamientoBatalla(3)"><strong>3</strong></div>
            <div class="btn-dado-sel" onclick="window.ejecutarLanzamientoBatalla(4)"><strong>4</strong></div>
            <div class="btn-dado-sel" onclick="window.ejecutarLanzamientoBatalla(5)"><strong>5</strong></div>
        </div>
    </div>

    <!-- MODAL BATALLA FINAL -->
    <div id="modal-batalla" class="pantalla oculto" style="z-index:9999; background:rgba(0,0,0,0.95);">
        <h2 style="color:gold; font-weight:900;">BATALLA FINAL</h2>
        <div id="texto-vs" style="font-size:30px; font-weight:900; color:white;"></div>
        <video id="video-clash" playsinline style="width:100%; border-top:4px solid gold; border-bottom:4px solid gold;"></video>
    </div>

    <!-- CAMBIO TURNO -->
    <div id="pantalla-cambio-turno" class="pantalla oculto" style="z-index:8000; background: rgba(0,0,0,0.9);">
        <h1 style="font-size:50px; color: #f44; font-weight:900;">üõë ALTO üõë</h1>
        <h2 style="color:gold; font-size:40px; font-weight:900;" id="next-player-name">JUGADOR</h2>
        <button class="btn-master" onclick="window.confirmarCambioTurno()">TOMAR EL MANDO</button>
    </div>

    <!-- SETUP -->
    <div id="p-setup" class="pantalla" style="background:rgba(0,0,0,0.8);">
        <h2>INSCRIPCI√ìN</h2>
        <div id="setup-selector" style="display:flex; gap:10px;">
            <button class="btn-master" onclick="window.setModo(2)">2 MAGOS</button>
            <button class="btn-master" onclick="window.setModo(4)">4 MAGOS</button>
        </div>
        <div id="registro" class="oculto">
            <input type="text" id="mago-nombre" placeholder="NOMBRE DEL MAGO">
            <div class="grid-casas">
                <button onclick="window.registrarMago('TERRA','#ff0000')" class="btn-casa" style="background:#500;">üõ°Ô∏è TERRA</button>
                <button onclick="window.registrarMago('CAELUM','#00aaff')" class="btn-casa" style="background:#003;">‚öîÔ∏è CAELUM</button>
                <button onclick="window.registrarMago('AQUA','#00ff88')" class="btn-casa" style="background:#030;">üíß AQUA</button>
                <button onclick="window.registrarMago('DIMENSIO','#aa00ff')" class="btn-casa" style="background:#303;">‚ú® DIMENSIO</button>
            </div>
            <p id="reg-status" style="color:gold; font-weight:900;"></p>
        </div>
    </div>

    <!-- UI JUEGO -->
    <div id="ui-juego" class="oculto">
        <div id="zona-superior">
            <div id="hud-derecho">
                <img id="hud-img-escudo" src="">
                <div id="hud-txt-arma" style="font-weight:900; color:white;">ARMA</div>
                <div id="hud-txt-valor" style="font-weight:900; font-size:60px; color:gold;">00</div>
            </div>
            <div id="guia-scanner"></div>
            <video id="video-action" playsinline style="display:none;"></video>
        </div>
        <div id="zona-inferior">
            <div id="msg-visor" style="font-size:26px; color:gold; font-weight:900;">ESCANEA CARTA</div>
            <p style="color:#aaa; font-weight:900;">SLOT: <span id="slot-indicator">1/3</span></p>
            <div class="contenedor-gemas">
                <div class="wrapper-gema"><span id="val-i" class="valor-flotante"></span><button id="btn-i" class="btn-gema"><span class="letra-grande">I</span></button></div>
                <div class="wrapper-gema"><span id="val-a" class="valor-flotante"></span><button id="btn-a" class="btn-gema"><span class="letra-grande">A</span></button></div>
                <div class="wrapper-gema"><span id="val-t" class="valor-flotante"></span><button id="btn-t" class="btn-gema"><span class="letra-grande">T</span></button></div>
                <div class="wrapper-gema"><span id="val-m" class="valor-flotante"></span><button id="btn-m" class="btn-gema"><span class="letra-grande">M</span></button></div>
            </div>
            <div style="display:flex; gap:10px; width:100%;">
                <button id="btn-confirmar" class="btn-master" style="background:#050; flex:2;">‚úÖ CONFIRMAR</button>
                <button id="btn-forzar" class="btn-master" style="background:#500; flex:1;" onclick="window.iniciarFaseFinal()">‚öîÔ∏è YA</button>
                <button id="btn-reescaneo" class="btn-master" style="background:#aa8800; flex:1;">üîÑ RESCAN</button>
            </div>
        </div>
    </div>

    <!-- RESULTADOS (LETRAS EN NEGRITA RESTAURADAS) -->
    <div id="p-resultado" class="pantalla oculto" style="background:rgba(0,0,0,0.95); z-index:10000;">
        <h2 style="color:black; background:gold; width:100%; padding:15px; font-weight:900; text-align:center;">DECRETO DE LA VUELTA</h2>
        <div id="resultado-batalla" style="background:white; color:black; width:100%; padding:20px; border-radius:10px; overflow-y:auto; flex-grow:1;">
            <div id="resultado-contenido"></div>
        </div>
        <div style="width:100%; display:flex; gap:10px; margin-top:15px;">
            <button id="btn-repetir-accion" class="btn-master" onclick="window.continuarContienda()" style="font-weight:900; background:green; font-size:24px;">‚öîÔ∏è REPETIR (SIG. VUELTA)</button>
            <button class="btn-master" style="background:#111; flex:0.4;" onclick="location.href='index.html'">SALIR</button>
        </div>
    </div>

    <script type="module">
        import { iniciarOjo, resetUltimoId, RUTA_BASE, VIDEOS_BATALLA } from './ojo.js';

        const MAX_SLOTS = 3;
        const MAX_VUELTAS = 7;
        let vueltaActual = 1;
        let jugadores = [];
        let cantJugadores = 0, turnoJugadorIdx = 0, slotActual = 0, cartaActualEnPantalla = null, jugadaPendiente = null;
        let indiceJugadorDados = 0;

        window.setModo = (modo) => {
            cantJugadores = modo;
            document.getElementById('setup-selector').classList.add('oculto');
            document.getElementById('registro').classList.remove('oculto');
        };

        window.registrarMago = (elemento, color) => {
            const nombre = document.getElementById('mago-nombre').value.trim().toUpperCase();
            if (!nombre) return alert("Nombre vac√≠o");
            jugadores.push({ nombre, elemento, color, slots: [null, null, null], dado: 0, puntosTotales: 0 });
            document.getElementById('mago-nombre').value = '';
            if (jugadores.length === cantJugadores) iniciarPartida();
        };

        function iniciarPartida() {
            document.getElementById('p-setup').classList.add('oculto');
            document.getElementById('ui-juego').classList.remove('oculto');
            document.getElementById('ui-superior-fijo').style.display = 'block';
            iniciarOjo('container-ar', onCartaDetectada);
            actualizarUI();
        }

        function onCartaDetectada(carta) {
            cartaActualEnPantalla = carta;
            document.getElementById('msg-visor').innerText = `‚úì ${carta.nombre}`;
            actualizarEstiloBotones(carta);
            console.log("Carta detectada:", carta.nombre);
        }

        function actualizarUI() {
            document.getElementById('txt-turno').innerText = `TURNO: ${jugadores[turnoJugadorIdx].nombre}`;
            document.getElementById('txt-vuelta').innerText = `VUELTA: ${vueltaActual} / ${MAX_VUELTAS}`;
            document.getElementById('slot-indicator').innerText = `${slotActual + 1}/3`;
            resetBotones();
        }

        window.iniciarFaseFinal = () => {
            document.getElementById('ui-juego').classList.add('oculto');
            document.getElementById('modal-dados-fase').classList.remove('oculto');
            indiceJugadorDados = 0;
            prepararDadosParaJugador();
        };

        function prepararDadosParaJugador() {
            if (indiceJugadorDados >= cantJugadores) {
                lanzarVideoBatalla();
                return;
            }
            const j = jugadores[indiceJugadorDados];
            document.getElementById('dados-player-name').innerText = j.nombre;
            document.getElementById('layer-valor-batalla').innerText = "0";
        }

        window.ejecutarLanzamientoBatalla = (n) => {
            const video = document.getElementById('video-dados-batalla');
            video.currentTime = 0; video.play();
            video.onended = () => {
                let total = 0; for (let i = 0; i < n; i++) total += Math.floor(Math.random() * 6) + 1;
                jugadores[indiceJugadorDados].dado = total;
                document.getElementById('layer-valor-batalla').innerText = total;
                setTimeout(() => { document.getElementById('modal-dados-fase').classList.add('oculto'); indiceJugadorDados++; prepararDadosParaJugador(); }, 1200);
            };
        };

        function lanzarVideoBatalla() {
            document.getElementById('modal-batalla').classList.remove('oculto');
            const video = document.getElementById('video-clash');
            video.src = RUTA_BASE + VIDEOS_BATALLA[Math.floor(Math.random() * VIDEOS_BATALLA.length)];
            video.play();
            video.onended = () => { document.getElementById('modal-batalla').classList.add('oculto'); mostrarResultados(); };
        }

        function mostrarResultados() {
            document.getElementById('p-resultado').classList.remove('oculto');
            const cont = document.getElementById('resultado-contenido'); cont.innerHTML = '';
            
            jugadores.forEach(j => {
                let ronda = j.dado;
                j.slots.forEach(s => { if (s) ronda += s.valor; });
                j.puntosTotales += ronda;
                j.ultimoRondaVal = ronda;
            });

            let resSorted = [...jugadores].sort((a, b) => b.ultimoRondaVal - a.ultimoRondaVal);
            
            resSorted.forEach((r, i) => {
                let slotsHtml = "";
                r.slots.forEach(s => {
                    if(s) slotsHtml += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding:5px 0;">
                        <span style="font-weight:900;">${s.carta.nombre}</span><span style="font-weight:900; color:blue;">+${s.valor}</span></div>`;
                });

                cont.innerHTML += `
                    <div style="border:4px solid ${i===0?'gold':'#000'}; padding:15px; margin-bottom:15px; background:${i===0?'#fff9e6':'#fff'};">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h1 style="margin:0; font-weight:900; color:${r.color}; font-size:32px;">${i===0?'üèÜ ':''}${r.nombre}</h1>
                            <span style="font-size:45px; font-weight:900; color:red;">${r.ultimoRondaVal}</span>
                        </div>
                        ${slotsHtml}
                        <div style="font-weight:900; color:green; margin-top:5px;">DADO: +${r.dado}</div>
                        <div style="font-weight:900; color:#555; font-size:14px; text-align:right;">PUNTOS TOTALES: ${r.puntosTotales}</div>
                    </div>`;
            });

            if(vueltaActual >= MAX_VUELTAS) {
                document.getElementById('btn-repetir-accion').innerText = "üëë VER GRAN CAMPE√ìN";
                document.getElementById('btn-repetir-accion').onclick = mostrarGanadorFinal;
            }
        }

        function mostrarGanadorFinal() {
            const cont = document.getElementById('resultado-contenido');
            jugadores.sort((a,b) => b.puntosTotales - a.puntosTotales);
            cont.innerHTML = `<h1 style="text-align:center; font-weight:900; color:gold; background:black; padding:20px;">EL GRAN MAGO</h1>`;
            jugadores.forEach((j, i) => {
                cont.innerHTML += `
                    <div style="padding:25px; border:6px solid gold; margin-top:15px; text-align:center; background:${i===0?'#fff9e6':'#fff'};">
                        <h1 style="font-weight:900; color:${j.color}">${i===0?'ü•á ':''}${j.nombre}</h1>
                        <p style="font-size:60px; font-weight:900; color:red;">${j.puntosTotales} PTS</p>
                    </div>`;
            });
            document.getElementById('btn-repetir-accion').style.display = 'none';
        }

        window.continuarContienda = () => {
            vueltaActual++; slotActual = 0; turnoJugadorIdx = 0;
            jugadores.forEach(j => { j.slots = [null, null, null]; j.dado = 0; });
            document.getElementById('p-resultado').classList.add('oculto');
            document.getElementById('ui-juego').classList.remove('oculto');
            resetUltimoId(); actualizarUI();
        };

        window.confirmarCambioTurno = () => {
            jugadaPendiente = null; resetBotones(); resetUltimoId();
            document.getElementById('pantalla-cambio-turno').classList.add('oculto');
            document.getElementById('ui-juego').classList.remove('oculto');
            actualizarUI();
        };

        function resetBotones() {
            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                document.getElementById(id).className = 'btn-gema';
                document.getElementById(id.replace('btn-', 'val-')).innerText = "";
            });
        }

        function actualizarEstiloBotones(carta) {
            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                const btn = document.getElementById(id); const val = carta.botones[id].valor;
                if (carta.tipo === 'BUHO') btn.classList.add('style-buho');
                const vSpan = document.getElementById(id.replace('btn-', 'val-')); vSpan.innerText = val;
                vSpan.className = "valor-flotante " + (carta.tipo === 'CASA' ? 'neon-blanco' : 'neon-violeta');
            });
        }

        ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
            document.getElementById(id).onclick = () => {
                if (!cartaActualEnPantalla) return;
                const conf = cartaActualEnPantalla.botones[id];
                jugadaPendiente = { carta: JSON.parse(JSON.stringify(cartaActualEnPantalla)), valor: conf.valor };
                const v = document.getElementById('video-action'); v.style.display = 'block'; v.src = RUTA_BASE + conf.video; v.play();
                document.getElementById('hud-derecho').style.display = 'flex';
                document.getElementById('hud-img-escudo').src = RUTA_BASE + cartaActualEnPantalla.imgEscudo;
                document.getElementById('hud-txt-arma').innerText = cartaActualEnPantalla.nombre;
                document.getElementById('hud-txt-valor').innerText = conf.valor;
                v.onended = () => { v.style.display = 'none'; document.getElementById('hud-derecho').style.display = 'none'; };
            };
        });

        document.getElementById('btn-confirmar').onclick = () => {
            if (!jugadaPendiente) return alert("Selecciona gema");
            jugadores[turnoJugadorIdx].slots[slotActual] = jugadaPendiente;
            turnoJugadorIdx++; if (turnoJugadorIdx >= cantJugadores) { turnoJugadorIdx = 0; slotActual++; }
            if (slotActual >= MAX_SLOTS) window.iniciarFaseFinal();
            else { 
                document.getElementById('pantalla-cambio-turno').classList.remove('oculto'); 
                document.getElementById('next-player-name').innerText = jugadores[turnoJugadorIdx].nombre; 
                document.getElementById('ui-juego').classList.add('oculto'); 
            }
        };
    </script>
</body>
</html>