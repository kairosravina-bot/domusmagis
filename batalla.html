<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: BATALLA</title>
    <link rel="stylesheet" href="style.css">
    <script type="importmap">
    { "imports": { 
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js", 
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js" 
    } }
    </script>
</head>
<body>
    <div id="container-ar"></div>

    <!-- SETUP ORIGINAL CON BOTON VOLVER -->
    <div id="p-setup" class="pantalla" style="background:rgba(0,0,0,0.85); z-index: 10000;">
        <h2 style="color: gold; font-size: 30px;">INSCRIPCION</h2>
        <div id="setup-selector" style="display:flex; gap:10px; width:100%; max-width: 350px;">
            <button class="btn-master" id="btn-2magos">2 MAGOS</button>
            <button class="btn-master" id="btn-4magos">4 MAGOS</button>
        </div>
        <div id="registro" class="oculto" style="width:100%; max-width: 350px;">
            <input type="text" id="mago-nombre" placeholder="NOMBRE DEL MAGO">
            <div class="grid-casas">
                <button id="btn-terra" class="btn-casa" style="background:#500; border-color:#f00;">‚öîÔ∏è TERRA</button>
                <button id="btn-caelum" class="btn-casa" style="background:#003; border-color:#0af;">‚ö° CAELUM</button>
                <button id="btn-aqua" class="btn-casa" style="background:#030; border-color:#0f8;">üíß AQUA</button>
                <button id="btn-dimensio" class="btn-casa" style="background:#303; border-color:#d0f;">‚ú® DIMENSIO</button>
            </div>
            <p id="reg-status" style="color:gold; text-align:center; margin-top:10px; font-weight:bold;"></p>
        </div>
        <button class="btn-master" style="margin-top:20px; background:#333; border-color: #777;" id="btn-volver">VOLVER</button>
    </div>

    <!-- UI JUEGO MEJORADA -->
    <div id="ui-juego" class="oculto">
        <div id="zona-superior">
            <!-- CODIGO TARGET EN CENTRO SUPERIOR - LETRAS BLANCAS GRANDES -->
            <div id="codigo-target" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 15; background: rgba(0,0,0,0.95); color: #ffffff; padding: 20px 40px; border: 4px solid #ffffff; border-radius: 10px; font-size: 32px; font-weight: 900; font-family: 'Courier New', monospace; letter-spacing: 3px; text-shadow: 0 0 20px rgba(255, 255, 255, 0.6); min-width: 500px; text-align: center; box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);">
                BUSCANDO...
            </div>

            <!-- TURNO ARRIBA IZQUIERDA -->
            <div id="txt-turno" style="position: absolute; top: 15px; left: 15px; z-index: 14; background: rgba(0,0,0,0.8); color: gold; padding: 10px; border: 2px solid gold;">TURNO: ---</div>

            <!-- HUD DERECHA -->
            <div id="hud-derecho">
                <img id="hud-img-escudo" src="">
                <div id="hud-txt-arma">ARMA</div>
                <div id="hud-txt-accion">ACCION</div>
                <div id="hud-txt-valor">00</div>
            </div>

            <div id="guia-scanner"></div>
            <video id="video-action" playsinline></video>
        </div>

        <div id="zona-inferior">
            <div id="msg-visor" style="font-size:26px; color:var(--borde-dorado); font-weight:900;">ESCANEA CARTA</div>
            <p style="color:#aaa; margin:0;">SLOT: <span id="slot-indicator" style="color:gold;">1/3</span></p>
            
            <div class="contenedor-gemas">
                <div class="wrapper-gema"><span id="val-i" class="valor-flotante"></span><button id="btn-i" class="btn-gema"><span class="letra-grande">I</span></button></div>
                <div class="wrapper-gema"><span id="val-a" class="valor-flotante"></span><button id="btn-a" class="btn-gema"><span class="letra-grande">A</span></button></div>
                <div class="wrapper-gema"><span id="val-t" class="valor-flotante"></span><button id="btn-t" class="btn-gema"><span class="letra-grande">T</span></button></div>
                <div class="wrapper-gema"><span id="val-m" class="valor-flotante"></span><button id="btn-m" class="btn-gema"><span class="letra-grande">M</span></button></div>
            </div>
            <button id="btn-confirmar" class="btn-master" style="background:#050; border-color:#0f0;">‚úî CONFIRMAR</button>
        </div>
    </div>

    <script type="module">
        import { CARTAS, RUTA_BASE } from './biblioteca.js';
        import { iniciarOjo } from './ojo.js';

        // VARIABLES GLOBALES
        let jugadores = [];
        let cantJugadores = 0;
        let slotActual = 0;
        let turnoJugadorIdx = 0;
        let cartaActual = null;
        let jugadaPendiente = null;

        // ===== SETUP HANDLERS =====
        document.getElementById('btn-2magos').addEventListener('click', function() {
            cantJugadores = 2;
            document.getElementById('setup-selector').classList.add('oculto');
            document.getElementById('registro').classList.remove('oculto');
            document.getElementById('reg-status').innerText = 'Mago 1 de 2';
            document.getElementById('mago-nombre').focus();
            console.log('‚úÖ Modo 2 magos seleccionado');
        });

        document.getElementById('btn-4magos').addEventListener('click', function() {
            cantJugadores = 4;
            document.getElementById('setup-selector').classList.add('oculto');
            document.getElementById('registro').classList.remove('oculto');
            document.getElementById('reg-status').innerText = 'Mago 1 de 4';
            document.getElementById('mago-nombre').focus();
            console.log('‚úÖ Modo 4 magos seleccionado');
        });

        // ===== BOTONES CASAS =====
        document.getElementById('btn-terra').addEventListener('click', () => registrarMago('TERRA', '#ff0000'));
        document.getElementById('btn-caelum').addEventListener('click', () => registrarMago('CAELUM', '#00aaff'));
        document.getElementById('btn-aqua').addEventListener('click', () => registrarMago('AQUA', '#00ff88'));
        document.getElementById('btn-dimensio').addEventListener('click', () => registrarMago('DIMENSIO', '#aa00ff'));

        // ===== BOTON VOLVER =====
        document.getElementById('btn-volver').addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        // ===== FUNCIONES PRINCIPALES =====
        function registrarMago(casa, col) {
            if (cantJugadores === 0) {
                console.log('‚ùå Selecciona primero 2 o 4 magos');
                return;
            }

            const nombreInput = document.getElementById('mago-nombre');
            let nombre = nombreInput.value.trim() || `MAGO ${jugadores.length + 1}`;
            
            jugadores.push({
                nombre: nombre,
                casa: casa,
                color: col,
                slots: [null, null, null],
                dado: 0
            });

            nombreInput.value = '';
            nombreInput.focus();
            
            console.log(`‚úÖ Mago registrado: ${nombre} (${casa}) - Total: ${jugadores.length}/${cantJugadores}`);

            if (jugadores.length === cantJugadores) {
                console.log('‚úÖ‚úÖ‚úÖ Todos los magos registrados - INICIANDO JUEGO');
                iniciarJuego();
            } else {
                document.getElementById('reg-status').innerText = `Mago ${jugadores.length + 1} de ${cantJugadores}`;
            }
        }

        function iniciarJuego() {
            document.getElementById('p-setup').classList.add('oculto');
            document.getElementById('ui-juego').classList.remove('oculto');

            iniciarOjo('container-ar', (id) => {
                cartaActual = CARTAS[id];
                document.getElementById('msg-visor').innerText = cartaActual.nombre;
                
                // MOSTRAR CODIGO TARGET EN BLANCO GRANDE EN CENTRO SUPERIOR
                const codigoDiv = document.getElementById('codigo-target');
                codigoDiv.innerText = cartaActual.codTarget;
                codigoDiv.style.color = '#ffffff';
                codigoDiv.style.textShadow = '0 0 20px rgba(255, 255, 255, 0.6), 0 0 40px rgba(0, 215, 255, 0.3)';
                codigoDiv.style.borderColor = '#00d7ff';
                codigoDiv.style.boxShadow = '0 0 30px rgba(0, 215, 255, 0.5)';
                
                actualizarEstiloBotones(cartaActual);
            }, () => {
                cartaActual = null;
                document.getElementById('msg-visor').innerText = "BUSCANDO...";
                document.getElementById('codigo-target').innerText = "BUSCANDO...";
                document.getElementById('codigo-target').style.color = '#ffffff';
                document.getElementById('codigo-target').style.borderColor = '#ffffff';
                document.getElementById('hud-derecho').style.display = 'none';
            });

            actualizarTurnoUI();
        }

        function actualizarTurnoUI() {
            const j = jugadores[turnoJugadorIdx];
            const txt = document.getElementById('txt-turno');
            txt.innerText = "TURNO: " + j.nombre;
            txt.style.color = j.color;
            txt.style.borderColor = j.color;
            document.getElementById('slot-indicator').innerText = `${slotActual + 1} / 3`;
        }

        function actualizarEstiloBotones(carta) {
            ['i','a','t','m'].forEach(l => {
                const conf = carta.botones['btn-'+l];
                const vSpan = document.getElementById('val-'+l);
                vSpan.innerText = conf.valor;
                vSpan.className = "valor-flotante " + (
                    carta.tipo === 'ARTEFACTO' ? 'neon-amarillo' :
                    carta.tipo === 'BUHO' ? 'neon-violeta' :
                    'neon-blanco'
                );
            });
        }

        // ===== BOTONES GEMAS =====
        ['i','a','t','m'].forEach(l => {
            document.getElementById('btn-'+l).addEventListener('click', function() {
                if (!cartaActual) return;

                const conf = cartaActual.botones['btn-'+l];
                const vid = document.getElementById('video-action');
                let vidEspecifico = cartaActual['mp4'+l.toUpperCase()];
                
                vid.style.display = 'block';
                vid.src = RUTA_BASE + vidEspecifico;
                vid.play().catch(() => {
                    vid.src = RUTA_BASE + conf.video;
                    vid.play();
                });

                jugadaPendiente = {
                    carta: cartaActual,
                    valor: conf.valor,
                    lado: conf.label
                };

                const hud = document.getElementById('hud-derecho');
                hud.style.display = 'flex';
                document.getElementById('hud-img-escudo').src = RUTA_BASE + cartaActual.imgEscudo;
                document.getElementById('hud-txt-accion').innerText = conf.label;
                document.getElementById('hud-txt-valor').innerText = conf.valor;
                
                vid.onended = () => {
                    vid.style.display = 'none';
                    hud.style.display = 'none';
                };
            });
        });

        // ===== BOTON CONFIRMAR =====
        document.getElementById('btn-confirmar').addEventListener('click', function() {
            if (!jugadaPendiente) {
                alert('Primero selecciona una acci√≥n (I, A, T o M)');
                return;
            }

            jugadores[turnoJugadorIdx].slots[slotActual] = jugadaPendiente;
            jugadaPendiente = null;
            turnoJugadorIdx++;

            if (turnoJugadorIdx >= cantJugadores) {
                turnoJugadorIdx = 0;
                slotActual++;
            }

            if (slotActual >= 3) {
                alert("BATALLA COMPLETADA - GANADOR DEFINIDO");
                location.reload();
            } else {
                actualizarTurnoUI();
            }
        });

        console.log('‚úÖ BATALLA CARGADA Y LISTA');
    </script>
</body>
</html>