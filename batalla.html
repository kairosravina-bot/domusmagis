import { CARTAS, VIDEOS_BATALLA, RUTA_BASE } from './biblioteca.js';
import { iniciarOjo } from './ojo.js';

let jugadores = []; 
let cantJugadores = 0; 
let slotActual = 0; 
let turnoJugadorIdx = 0; 
let jugadaPendiente = null; 
let ultimaJugada = null; 
let cartaActualEnPantalla = null;
const MAX_SLOTS = 3;

const ui = { 
    scanner: document.getElementById('guia-scanner'), 
    msg: document.getElementById('msg-visor'), 
    videoAction: document.getElementById('video-action') 
};

window.setModo = (n) => { 
    cantJugadores = n; 
    document.getElementById('setup-selector').classList.add('oculto'); 
    document.getElementById('registro').classList.remove('oculto'); 
    document.getElementById('reg-status').innerText = `Mago 1 de ${n}`; 
};

window.registrarMago = (casa, color, esc) => {
    let n = document.getElementById('mago-nombre').value || "Mago " + (jugadores.length + 1);
    jugadores.push({ nombre: n, casa, color, esc, slots: [null, null, null], dado: 0 });
    document.getElementById('mago-nombre').value = "";
    if(jugadores.length === cantJugadores) iniciarJuego(); 
    else document.getElementById('reg-status').innerText = `Mago ${jugadores.length + 1} de ${cantJugadores}`; 
};

function iniciarJuego() { 
    document.getElementById('p-setup').classList.add('oculto'); 
    document.getElementById('ui-juego').classList.remove('oculto'); 
    iniciarOjo('container-ar', alEncontrarCarta, alPerderCarta);
    actualizarUI(); 
}

// ESTA FUNCIÓN ES LA QUE CORRIGE EL ERROR DEL "DRAGON"
function alEncontrarCarta(idMindAR) {
    // Sincronización: El ID de la imagen en el compilador debe ser igual al ID en biblioteca.js
    const carta = CARTAS[idMindAR];
    
    if(!carta) {
        ui.msg.innerText = "CARTA NO REGISTRADA";
        return;
    }
    
    cartaActualEnPantalla = carta;
    ui.msg.innerText = carta.nombre;

    // Estética Neón V101
    if(idMindAR >= 81) ui.scanner.className = 'violeta';
    else ui.scanner.className = 'verde';

    actualizarEstiloBotones(carta);
}

function alPerderCarta() {
    cartaActualEnPantalla = null;
    ui.msg.innerText = "ESCANEA CARTA"; 
    ui.scanner.className = ''; 
    document.getElementById('hud-derecho').style.display = 'none';
    resetBotones();
}

function actualizarEstiloBotones(carta) {
    ['btn-i','btn-a','btn-t','btn-m'].forEach(id => {
        const btn = document.getElementById(id);
        const conf = carta.botones[id];
        btn.innerHTML = `<span class="letra-grande">${conf.texto}</span>`;
        const valSpan = document.getElementById(id.replace('btn-','val-'));
        valSpan.innerText = conf.valor; 
        valSpan.className = "valor-flotante " + (carta.id >= 81 ? "neon-amarillo" : "neon-blanco");
    });
}

function actualizarUI() {
    const j = jugadores[turnoJugadorIdx];
    const txt = document.getElementById('txt-turno'); 
    txt.innerText = `TURNO: ${j.nombre}`; 
    txt.style.color = j.color; 
    txt.style.borderColor = j.color;
    document.getElementById('slot-indicator').innerText = `${slotActual + 1} / ${MAX_SLOTS}`;
    resetBotones();
}

// Vinculación de botones de gemas
['btn-i','btn-a','btn-t','btn-m'].forEach(id => {
    document.getElementById(id).onclick = () => {
        if(!cartaActualEnPantalla) return;
        const conf = cartaActualEnPantalla.botones[id];
        jugadaPendiente = { carta: cartaActualEnPantalla, lado: conf.label, valor: conf.valor };
        
        ui.videoAction.style.display = 'block'; 
        ui.videoAction.src = RUTA_BASE + conf.video;
        ui.videoAction.play();

        const hud = document.getElementById('hud-derecho');
        hud.style.display = 'flex';
        document.getElementById('hud-img-escudo').src = RUTA_BASE + cartaActualEnPantalla.imgEscudo;
        document.getElementById('hud-txt-arma').innerText = cartaActualEnPantalla.arma;
        document.getElementById('hud-txt-accion').innerText = conf.label;
        document.getElementById('hud-txt-valor').innerText = conf.valor;

        ui.videoAction.onended = () => { 
            ui.videoAction.style.display = 'none'; 
            hud.style.display = 'none'; 
        };
    };
});

document.getElementById('btn-confirmar').onclick = () => {
    if(!jugadaPendiente) return;
    jugadores[turnoJugadorIdx].slots[slotActual] = jugadaPendiente;
    turnoJugadorIdx++; 
    if(turnoJugadorIdx >= cantJugadores) { turnoJugadorIdx=0; slotActual++; }
    if(slotActual >= MAX_SLOTS) { window.location.reload(); } // Simulación fin
    else { 
        document.getElementById('pantalla-cambio-turno').classList.remove('oculto'); 
        document.getElementById('next-player-name').innerText = jugadores[turnoJugadorIdx].nombre; 
    }
    jugadaPendiente = null;
};

function resetBotones() {
    ['val-i','val-a','val-t','val-m'].forEach(id => document.getElementById(id).innerText = "");
}

window.confirmarCambioTurno = () => {
    document.getElementById('pantalla-cambio-turno').classList.add('oculto');
    actualizarUI();
};