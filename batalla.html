<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: BATALLA V62</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* =========================================
           CORRECCI√ìN 1: SETUP ARRIBA (NO CENTRADO)
           ========================================= */
        #p-setup { 
            justify-content: flex-start !important; 
            padding-top: 60px; /* Espacio para que no pegue al borde */
        }

        /* ESTILOS ESPEC√çFICOS BATALLA */
        #container-ar { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
        #ui-juego { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-start; z-index: 500; pointer-events: none; }
        
        #zona-superior { height: 55%; width: 100%; position: relative; display: flex; justify-content: center; align-items: center; border-bottom: 4px solid var(--borde-dorado); }
        #zona-inferior { height: 45%; width: 100%; background: linear-gradient(to bottom, #1a1a1a, #000); pointer-events: auto; display: flex; flex-direction: column; align-items: center; justify-content: space-around; padding: 10px 15px; }
        
        #guia-scanner { 
            width: 240px; height: 240px; 
            border: 6px solid rgba(255, 255, 255, 0.6); 
            border-radius: 20px; z-index: 10; position: relative; 
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
            transition: border-color 0.2s;
        }
        #guia-scanner::after { content: "+"; position: absolute; top:50%; left:50%; transform:translate(-50%, -50%); color: rgba(255,255,255,0.8); font-size: 50px; font-weight: 100; }
        #guia-scanner.verde { border-color: #00ff00; box-shadow: 0 0 30px #00ff00; }
        #guia-scanner.dorado { border-color: #ffd700; box-shadow: 0 0 30px #ffd700; }
        #guia-scanner.violeta { border-color: #bd00ff; box-shadow: 0 0 30px #bd00ff; }

        /* =========================================
           CORRECCI√ìN 2: HUD DERECHO VERTICAL
           ========================================= */
        #hud-derecho {
            position: absolute; top: 20px; right: 20px; z-index: 50;
            display: none; /* Se activa con JS */
            flex-direction: column; 
            align-items: flex-end; /* Alineado a la derecha */
            text-align: right; pointer-events: none;
            gap: 5px;
        }
        #hud-img-escudo { width: 70px; height: 70px; object-fit: contain; filter: drop-shadow(0 0 5px gold); margin-bottom: 5px; }
        #hud-txt-nombre { font-size: 14px; color: #ddd; text-transform: uppercase; letter-spacing: 1px; }
        #hud-txt-accion { font-size: 24px; color: gold; font-family: var(--font-titulo); font-weight: 900; text-transform: uppercase; }
        #hud-txt-valor { font-size: 50px; color: white; font-family: var(--font-titulo); line-height: 1; text-shadow: 0 0 10px black; font-weight: 900; }

        .contenedor-gemas { display: flex; gap: 15px; margin: 5px 0; justify-content: center; }
        .btn-gema { width: 70px; height: 70px; border-radius: 15px; border: 2px solid #555; background-color: #222; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        #btn-i { background: var(--gema-roja); } #btn-a { background: var(--gema-verde); } #btn-t { background: var(--gema-gris); } #btn-m { background: var(--gema-violeta); }
        .btn-gema.activo { border-color: white; transform: translateY(4px); filter: brightness(1.2); }
        .letra-grande { font-size: 28px; font-weight: 900; color: rgba(255,255,255,0.9); text-shadow: 0 2px 4px #000; font-family: var(--font-titulo); }
        #info-rival { width: 100%; background: rgba(50,0,0,0.8); padding: 8px; border: 1px solid red; display: none; font-size: 16px; text-align: center; margin-bottom: 5px; font-family: var(--font-titulo); color: #ffaaaa; font-weight: 900; }
    </style>

    <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/", "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js" } }
    </script>
</head>
<body>

    <div id="container-ar"></div>

    <!-- MODAL FASE DE DADOS EN BATALLA (CON SELECCI√ìN COMPLETA) -->
    <div id="modal-dados-fase" class="pantalla oculto" style="z-index:9500; background:rgba(0,0,0,0.96);">
        <h2 style="color:#aaa; margin:0;">DESTINO</h2>
        <h1 id="dados-player-name" style="font-size:36px; margin:5px 0;">JUGADOR</h1>
        
        <div class="dados-container">
            <video id="video-dados-batalla" class="video-dados" src="https://kairosravina-bot.github.io/domusmagis/Dados.mp4" playsinline webkit-playsinline muted></video>
            <div id="layer-valor-batalla" class="layer-valor">0</div>
        </div>

        <h3 style="margin: 0; margin-top:5px; color:#888; font-size:14px;">SELECCIONA TUS DADOS:</h3>
        <div class="grid-dados">
            <div class="btn-dado-sel" id="btn-batalla-2" onclick="ejecutarLanzamientoBatalla(2)"><strong>2</strong><span>(12)</span></div>
            <div class="btn-dado-sel" id="btn-batalla-3" onclick="ejecutarLanzamientoBatalla(3)"><strong>3</strong><span>(18)</span></div>
            <div class="btn-dado-sel" id="btn-batalla-4" onclick="ejecutarLanzamientoBatalla(4)"><strong>4</strong><span>(24)</span></div>
            <div class="btn-dado-sel" id="btn-batalla-5" onclick="ejecutarLanzamientoBatalla(5)"><strong>5</strong><span>(30)</span></div>
        </div>
    </div>
    
    <!-- MODAL BATALLA FINAL -->
    <div id="modal-batalla" class="pantalla oculto" style="z-index:9999; background:#000;">
        <div id="texto-vs" style="font-size:30px; color:gold;">BATALLA FINAL</div>
        <video id="video-clash" playsinline webkit-playsinline style="width:100%; border-top:4px solid gold; border-bottom:4px solid gold;"></video>
    </div>

    <!-- PANTALLA CAMBIO TURNO -->
    <div id="pantalla-cambio-turno" class="pantalla oculto" style="z-index:8000; background: var(--bg-piedra);">
        <h1 style="font-size:50px; color: #ff4444;">üõë ALTO üõë</h1>
        <p style="font-size:22px; color:#aaa;">ES EL TURNO DE:</p>
        <h2 style="color:var(--borde-dorado); font-size:50px;" id="next-player-name">JUGADOR</h2>
        <button class="btn-master" style="margin-top:30px; width:80%;" onclick="confirmarCambioTurno()">TOMAR EL MANDO</button>
    </div>

    <!-- SETUP (AHORA ALINEADO ARRIBA) -->
    <div id="p-setup" class="pantalla">
        <h2>INSCRIPCI√ìN</h2>
        
        <!-- SELECTOR MAGOS -->
        <div id="setup-selector" style="display:flex; gap:10px; width:100%;">
            <button class="btn-master" onclick="setModo(2)">2 MAGOS</button>
            <button class="btn-master" onclick="setModo(4)">4 MAGOS</button>
        </div>
        
        <!-- INPUTS -->
        <div id="registro" class="oculto" style="width:100%;">
            <input type="text" id="mago-nombre" placeholder="NOMBRE DEL MAGO" autocomplete="off">
            
            <div class="grid-casas">
                <button onclick="registrarMago('TERRA','#ff0000','ESCUDO_DRAGON.png')" class="btn-casa" style="background:#500; border-color:#f00;">üõ°Ô∏è TERRA</button>
                <button onclick="registrarMago('CAELUM','#00aaff','ESCUDO_AGUILA.png')" class="btn-casa" style="background:#003; border-color:#0af;">‚öîÔ∏è CAELUM</button>
                <button onclick="registrarMago('AQUA','#00ff88','ESCUDO_JABALI.png')" class="btn-casa" style="background:#030; border-color:#0f8;">üíß AQUA</button>
                <button onclick="registrarMago('DIMENSIO','#aa00ff','ESCUDO_ESPEJO.png')" class="btn-casa" style="background:#303; border-color:#d0f;">‚ú® DIMENSIO</button>
            </div>
            <p id="reg-status" style="color:var(--borde-dorado); text-align:center; font-size:24px; margin-top:20px; font-weight:900;"></p>
        </div>
        <button class="btn-master" style="margin-top:20px; background:#333;" onclick="window.location.href='index.html'">CANCELAR</button>
    </div>

    <!-- UI JUEGO -->
    <div id="ui-juego" class="oculto">
        <div id="zona-superior">
            <div id="txt-turno" style="position: absolute; top: 15px; left: 15px; z-index: 15; background: rgba(0,0,0,0.8); color: gold; padding: 10px; border: 2px solid gold;">TURNO: ---</div>
            
            <!-- HUD DERECHO (CORREGIDO) -->
            <div id="hud-derecho">
                <img id="hud-img-escudo" src="" alt="Escudo">
                <div id="hud-txt-nombre">ARMA</div>
                <div id="hud-txt-accion">LADO</div>
                <div id="hud-txt-valor">00</div>
            </div>

            <div id="guia-scanner"></div>
            <video id="video-action" playsinline webkit-playsinline style="position:absolute; width:100%; height:100%; display:none; background:black; z-index:20; object-fit:contain;"></video>
        </div>

        <div id="zona-inferior">
            <div id="info-rival">RIVAL JUG√ì: <span id="rival-last-move">???</span></div>
            <div id="msg-visor" style="font-size:26px; color:var(--borde-dorado); font-weight:900;">ESCANEA CARTA</div>
            <p style="color:#aaa; font-size:20px; margin:0;">SLOT: <span id="slot-indicator" style="color:gold;">1/3</span></p>
            
            <div class="contenedor-gemas">
                <button id="btn-i" class="btn-gema"><span class="letra-grande">I</span></button>
                <button id="btn-a" class="btn-gema"><span class="letra-grande">A</span></button>
                <button id="btn-t" class="btn-gema"><span class="letra-grande">T</span></button>
                <button id="btn-m" class="btn-gema"><span class="letra-grande">M</span></button>
            </div>
            
            <div style="display:flex; gap:10px; width:100%;">
                <button id="btn-confirmar" class="btn-master" style="background:#050; border-color:#0f0; flex:2;">‚úÖ CONFIRMAR</button>
                <button id="btn-forzar" class="btn-master" style="background:#500; font-size:14px;" onclick="forzarBatalla()">‚öîÔ∏è YA</button>
            </div>
        </div>
    </div>

    <!-- RESULTADOS -->
    <div id="p-resultado" class="pantalla oculto">
        <h2 style="color:#331a00; border-bottom:2px solid #8b4513; width:100%;">DECRETO FINAL</h2>
        <div id="resultado-batalla" style="width:100%; background:var(--bg-pergamino); color:#331a00; padding:20px; flex-grow:1; overflow-y:auto; border-radius:5px;">
            <div id="resultado-contenido"></div>
        </div>
        <div style="width:100%; display:flex; gap:10px; margin:20px 0;">
            <button class="btn-master" onclick="continuarContienda()">‚öîÔ∏è REPETIR</button>
            <button class="btn-master" style="background:#111; border-color:#f00;" onclick="window.location.href='index.html'">üö™ SALIR</button>
        </div>
    </div>

    <!-- JAVASCRIPT L√ìGICA V62 -->
    <script>
        const RUTA_BASE = "https://kairosravina-bot.github.io/domusmagis/";
        const VIDEOS_BATALLA = ["Explosi√≥n_Elemental.mp4", "El_B√∫ho_Juez.mp4", "Invocaciones_Et√©reas.mp4"];
        
        const CARTAS = {
            0: { id: 0, nombre: "DRAG√ìN", elemento: "TERRA", imgEscudo: "ESCUDO_DRAGON.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 7, video: "CARTA_1_ataque.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 2, video: "CARTA_1_cura.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 3, video: "CARTA_1_defensa.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 2, video: "CARTA_1_magia.mp4" } } },
            1: { id: 1, nombre: "√ÅGUILA", elemento: "CAELUM", imgEscudo: "ESCUDO_AGUILA.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 5, video: "ataque.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 4, video: "cura.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 2, video: "defensa.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 3, video: "magia.mp4" } } },
            2: { id: 2, nombre: "LE√ìN", elemento: "TERRA", imgEscudo: "ESCUDO_LEON.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 8, video: "ataque.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 1, video: "cura.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 4, video: "defensa.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 1, video: "magia.mp4" } } },
            3: { id: 3, nombre: "JABAL√ç", elemento: "AQUA", imgEscudo: "ESCUDO_JABALI.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 6, video: "ataque.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 3, video: "cura.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 3, video: "defensa.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 2, video: "magia.mp4" } } },
            4: { id: 4, nombre: "B√öHO MASTER", elemento: "NEUTRO", imgEscudo: "ESCUDO_BUHO.png", tipo: "BUHO", botones: { "btn-i": { texto: "I", label: "MANDATUM", valor: 5, video: "owl_mandatum.mp4" }, "btn-a": { texto: "A", label: "CONSILIUM", valor: 5, video: "owl_consilium.mp4" }, "btn-t": { texto: "T", label: "PRAESAGIUM", valor: 5, video: "owl_praesagium.mp4" }, "btn-m": { texto: "M", label: "ARCANUM", valor: 5, video: "owl_arcanum.mp4" } } },
            5: { id: 5, nombre: "IGNIS PHIALA", elemento: "TERRA", imgEscudo: "ESCUDO_IGNIS.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 10, video: "ARTEFACTO_1_IMPETUS.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 8, video: "ARTEFACTO_1_AUXILIUM.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 8, video: "ARTEFACTO_1_TUTELA.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 12, video: "ARTEFACTO_1_MYSTERIUM.mp4" } } },
            6: { id: 6, nombre: "SPECULUM AEGIS", elemento: "DIMENSIO", imgEscudo: "ESCUDO_ESPEJO.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 6, video: "ESPEJO_GOLPE.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 9, video: "ESPEJO_EQUIPAR.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 10, video: "ESPEJO_BLOQUEO.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 7, video: "ESPEJO_ILUSION.mp4" } } },
            7: { id: 7, nombre: "TEMPUS FUGIT", elemento: "DIMENSIO", imgEscudo: "ESCUDO_RELOJ.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 8, video: "RELOJ_ACELERAR.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 7, video: "RELOJ_REVERTIR.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 10, video: "RELOJ_CONGELAR.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 15, video: "RELOJ_ROMPER.mp4" } } },
            8: { id: 8, nombre: "GRIMORIUM UMBRA", elemento: "DIMENSIO", imgEscudo: "ESCUDO_LIBRO.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 9, video: "LIBRO_ABRIR.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 8, video: "LIBRO_LEER.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 7, video: "LIBRO_CERRAR.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 12, video: "LIBRO_QUEMAR.mp4" } } },
            9: { id: 9, nombre: "LAPIS AETHER", elemento: "CAELUM", imgEscudo: "ESCUDO_PIEDRA.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 7, video: "PIEDRA_DISPARAR.mp4" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 6, video: "PIEDRA_ABSORBER.mp4" }, "btn-t": { texto: "T", label: "TUTELA", valor: 9, video: "PIEDRA_CAMPO.mp4" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 11, video: "PIEDRA_ESTALLIDO.mp4" } } }
        };

        let jugadores = []; let cantJugadores = 0; let slotActual = 0; let turnoJugadorIdx = 0; const MAX_SLOTS = 3; let jugadaPendiente = null;
        let ultimaJugada = null; let dadosSeleccionadosBatalla = 2;

        function setModo(n) { cantJugadores = n; document.getElementById('setup-selector').classList.add('oculto'); document.getElementById('registro').classList.remove('oculto'); document.getElementById('reg-status').innerText = `Mago 1 de ${n}`; }
        function registrarMago(casa, color, esc) {
            let n = document.getElementById('mago-nombre').value || "Mago " + (jugadores.length + 1);
            jugadores.push({ nombre: n, casa, color, esc, slots: [null, null, null], dado: 0 });
            document.getElementById('mago-nombre').value = "";
            if(jugadores.length === cantJugadores) { iniciarJuego(); } else { document.getElementById('reg-status').innerText = `Mago ${jugadores.length + 1} de ${cantJugadores}`; }
        }
        function iniciarJuego() { 
            document.getElementById('p-setup').classList.add('oculto'); 
            document.getElementById('ui-juego').classList.remove('oculto'); 
            window.iniciarAR(); actualizarUI(); 
        }

        function actualizarUI() {
            const j = jugadores[turnoJugadorIdx];
            const txt = document.getElementById('txt-turno'); txt.innerText = `TURNO: ${j.nombre}`; txt.style.color = j.color; txt.style.borderColor = j.color;
            document.getElementById('slot-indicator').innerText = `${slotActual + 1} / ${MAX_SLOTS}`;
            
            const infoRival = document.getElementById('info-rival');
            if (ultimaJugada) { infoRival.style.display = 'block'; document.getElementById('rival-last-move').innerText = `${ultimaJugada.nombre} (${ultimaJugada.accion})`; } 
            else { infoRival.style.display = 'none'; }

            document.getElementById('msg-visor').style.display = 'block'; document.getElementById('guia-scanner').className = '';
            document.getElementById('hud-derecho').style.display = 'none'; // Se oculta al inicio
            resetBotones(); jugadaPendiente = null;
        }

        function confirmarCambioTurno() { document.getElementById('pantalla-cambio-turno').classList.add('oculto'); actualizarUI(); }
        function forzarBatalla() { if(confirm("¬øForzar Batalla?")) iniciarFaseDadosBatalla(); }

        let idxDado = 0;
        function iniciarFaseDadosBatalla() {
            idxDado = 0; document.getElementById('modal-dados-fase').classList.remove('oculto'); prepararDadoJugador();
        }
        function prepararDadoJugador() {
            if(idxDado >= cantJugadores) { document.getElementById('modal-dados-fase').classList.add('oculto'); iniciarClashFinal(); return; }
            const jug = jugadores[idxDado];
            const nameEl = document.getElementById('dados-player-name'); nameEl.innerText = jug.nombre; nameEl.style.color = jug.color;
            document.getElementById('layer-valor-batalla').style.display = 'none';
            actualizarBotonesDadosVisual();
        }
        function actualizarBotonesDadosVisual() {
            for(let i=2; i<=5; i++) document.getElementById('btn-batalla-'+i).classList.remove('tageado');
            document.getElementById('btn-batalla-'+dadosSeleccionadosBatalla).classList.add('tageado');
        }
        function ejecutarLanzamientoBatalla(cantidad) {
            dadosSeleccionadosBatalla = cantidad; actualizarBotonesDadosVisual();
            const vid = document.getElementById('video-dados-batalla');
            vid.currentTime = 0; vid.play();
            vid.onended = () => {
                let total = 0; for(let i=0; i<cantidad; i++) total += Math.floor(Math.random()*6)+1;
                jugadores[idxDado].dado = total;
                document.getElementById('layer-valor-batalla').innerText = total;
                document.getElementById('layer-valor-batalla').style.display = 'flex';
                setTimeout(() => { idxDado++; prepararDadoJugador(); }, 2000);
            };
        }

        function iniciarClashFinal() {
            document.getElementById('modal-batalla').classList.remove('oculto');
            const vid = document.getElementById('video-clash');
            vid.src = RUTA_BASE + VIDEOS_BATALLA[Math.floor(Math.random()*VIDEOS_BATALLA.length)];
            vid.play();
            vid.onended = () => { document.getElementById('modal-batalla').classList.add('oculto'); mostrarResultados(); };
        }

        function mostrarResultados() {
            document.getElementById('ui-juego').classList.add('oculto');
            document.getElementById('p-resultado').classList.remove('oculto');
            const cont = document.getElementById('resultado-contenido'); cont.innerHTML = '';
            let res = jugadores.map(j => { let t=0; j.slots.forEach(s=>{if(s)t+=s.valor}); return {...j, total:t+j.dado}; }).sort((a,b)=>b.total-a.total);
            res.forEach((r,i) => {
                cont.innerHTML += `<div class="resultado-jugador ${i===0?'ganador':''}"><h3 style="color:${r.color}">${r.nombre}</h3><div style="font-size:50px; text-align:right;">${r.total}</div></div>`;
            });
        }
        function continuarContienda() {
            jugadores.forEach(j=>{j.slots=[null,null,null];j.dado=0;}); slotActual=0; turnoJugadorIdx=0; ultimaJugada=null;
            document.getElementById('p-resultado').classList.add('oculto');
            document.getElementById('ui-juego').classList.remove('oculto'); actualizarUI();
        }

        function resetBotones() { ['btn-i','btn-a','btn-t','btn-m'].forEach(id=>{ document.getElementById(id).innerHTML=`<span class="letra-grande">${id.split('-')[1].toUpperCase()}</span>`; document.getElementById(id).classList.remove('activo'); }); }
    </script>

    <!-- AR LOGIC V62 -->
    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';
        let mindarThree = null; let cartaDetectada = null;
        const ui = { scanner: document.getElementById('guia-scanner'), msg: document.getElementById('msg-visor'), videoAction: document.getElementById('video-action') };
        
        window.iniciarAR = async function() {
            if(mindarThree) return;
            mindarThree = new MindARThree({ container: document.getElementById('container-ar'), imageTargetSrc: RUTA_BASE + 'targets1.mind', maxTrack:1, uiLoading:"no", uiScanning:"no", uiError:"no" });
            const {renderer, scene, camera} = mindarThree;

            for(let i=0; i<10; i++) {
                const anchor = mindarThree.addAnchor(i);
                anchor.group.add(new THREE.Mesh(new THREE.PlaneGeometry(1,1), new THREE.MeshBasicMaterial({transparent:true, opacity:0})));
                
                anchor.onTargetFound = () => { 
                    cartaDetectada = CARTAS[i]; 
                    if(!cartaDetectada) return;
                    ui.msg.innerText = cartaDetectada.nombre; 
                    if(cartaDetectada.tipo === 'ARTEFACTO') ui.scanner.className = 'violeta';
                    else if(cartaDetectada.tipo === 'BUHO') ui.scanner.className = 'dorado';
                    else ui.scanner.className = 'verde';
                };
                anchor.onTargetLost = () => { 
                    cartaDetectada = null; ui.msg.innerText = "BUSCANDO..."; ui.scanner.className = ''; 
                    document.getElementById('hud-derecho').style.display = 'none';
                    resetBotones(); 
                };
            }

            // EVENTOS BOTONES (CON NUEVO HUD)
            ['btn-i','btn-a','btn-t','btn-m'].forEach(id => {
                document.getElementById(id).onclick = () => {
                    if(!cartaDetectada) return;
                    const conf = cartaDetectada.botones[id];
                    jugadaPendiente = { carta: cartaDetectada, lado: conf.label, valor: conf.valor };
                    
                    // MOSTRAR VIDEO
                    ui.videoAction.style.display = 'block'; 
                    ui.videoAction.src = RUTA_BASE + conf.video; 
                    ui.videoAction.play();

                    // MOSTRAR HUD (CORREGIDO)
                    const hud = document.getElementById('hud-derecho');
                    hud.style.display = 'flex';
                    document.getElementById('hud-img-escudo').src = RUTA_BASE + cartaDetectada.imgEscudo;
                    document.getElementById('hud-txt-nombre').innerText = cartaDetectada.nombre;
                    document.getElementById('hud-txt-accion').innerText = conf.label;
                    document.getElementById('hud-txt-valor').innerText = conf.valor;

                    // FIN VIDEO
                    ui.videoAction.onended = () => { 
                        ui.videoAction.style.display = 'none'; 
                        hud.style.display = 'none'; // Ocultar HUD
                        ui.msg.innerText = "CONFIRMA ABAJO"; 
                    };
                };
            });

            await mindarThree.start();
            renderer.setAnimationLoop(() => { renderer.render(scene, camera); });
        };

        document.getElementById('btn-confirmar').onclick = () => {
            if(!jugadaPendiente) { alert("Escanea primero"); return; }
            ultimaJugada = { nombre: jugadaPendiente.carta.nombre, accion: jugadaPendiente.lado }; 
            jugadores[turnoJugadorIdx].slots[slotActual] = jugadaPendiente;
            turnoJugadorIdx++; if(turnoJugadorIdx >= cantJugadores) { turnoJugadorIdx=0; slotActual++; }
            if(slotActual >= MAX_SLOTS) { forzarBatalla(); }
            else { document.getElementById('pantalla-cambio-turno').classList.remove('oculto'); document.getElementById('next-player-name').innerText = jugadores[turnoJugadorIdx].nombre; }
        };
    </script>
</body>
</html>