<script type="module">
    import { iniciarOjo, resetUltimoId, RUTA_BASE } from './ojo.js';

    let jugadores = [];
    let cantJugadores = 0;
    let turnoJugadorIdx = 0;
    let slotActual = 0;
    let cartaActualEnPantalla = null;
    let jugadaPendiente = null;
    const MAX_SLOTS = 3;

    // --- REPARACIÓN DE BOTONES (EXPORTAR A WINDOW) ---
    window.setModo = (modo) => {
        cantJugadores = modo;
        document.getElementById('setup-selector').style.display = 'none';
        document.getElementById('registro').classList.remove('oculto');
    };

    window.registrarMago = (elemento, color) => {
        const nombreInput = document.getElementById('mago-nombre');
        const nombre = nombreInput.value.trim().toUpperCase();
        if(!nombre) return alert("Escribe nombre");
        
        jugadores.push({ nombre, elemento, color, slots: [null, null, null] });
        nombreInput.value = "";
        
        if(jugadores.length === cantJugadores) {
            document.getElementById('p-setup').style.display = 'none';
            document.getElementById('ui-juego').classList.remove('oculto');
            document.getElementById('ui-superior-fijo').style.display = 'block';
            iniciarPartida();
        } else {
            alert(`Mago ${jugadores.length}/${cantJugadores} listo`);
        }
    };

    function iniciarPartida() {
        actualizarUI();
        iniciarOjo('container-ar', (carta) => {
            cartaActualEnPantalla = carta;
            document.getElementById('msg-visor').innerHTML = `<span style="font-size:30px;">${carta.nombre}</span>`;
            // Cargar valores en gemas
            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                document.getElementById(id.replace('btn-', 'val-')).innerText = carta.botones[id].valor;
            });
        });
    }

    function actualizarUI() {
        const j = jugadores[turnoJugadorIdx];
        const turnoTxt = document.getElementById('txt-turno');
        turnoTxt.innerText = `TURNO: ${j.nombre}`;
        turnoTxt.style.color = j.color;
        document.getElementById('slot-indicator').innerText = `${slotActual + 1}/${MAX_SLOTS}`;
    }

    window.forzarReescaneo = () => {
        cartaActualEnPantalla = null;
        resetUltimoId();
        document.getElementById('msg-visor').innerText = "ESCANEA CARTA";
        ['val-i', 'val-a', 'val-t', 'val-m'].forEach(v => document.getElementById(v).innerText = "");
    };

    // Configurar gemas
    ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
        document.getElementById(id).onclick = () => {
            if(!cartaActualEnPantalla) return;
            const conf = cartaActualEnPantalla.botones[id];
            jugadaPendiente = { carta: cartaActualEnPantalla, valor: conf.valor };
            
            const v = document.getElementById('video-action');
            v.style.display = 'block';
            v.src = RUTA_BASE + conf.video;
            v.play();

            const hud = document.getElementById('hud-derecho');
            hud.style.display = 'flex';
            document.getElementById('hud-img-escudo').src = RUTA_BASE + cartaActualEnPantalla.imgEscudo;
            document.getElementById('hud-txt-arma').innerText = cartaActualEnPantalla.nombre;
            document.getElementById('hud-txt-valor').innerText = conf.valor;

            v.onended = () => { v.style.display = 'none'; hud.style.display = 'none'; };
        };
    });

    document.getElementById('btn-confirmar').onclick = () => {
        if(!jugadaPendiente) return alert("Selecciona gema");
        jugadores[turnoJugadorIdx].slots[slotActual] = jugadaPendiente;
        jugadaPendiente = null;
        
        turnoJugadorIdx++;
        if(turnoJugadorIdx >= cantJugadores) {
            turnoJugadorIdx = 0;
            slotActual++;
            if(slotActual >= MAX_SLOTS) {
                alert("FIN DE SELECCIÓN - BATALLA FINAL");
                location.reload();
                return;
            }
        }
        actualizarUI();
        window.forzarReescaneo();
    };
</script>