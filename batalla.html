<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: BATALLA V84</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        .papiro-ronda {
            display: inline-block;
            width: 45px;
            height: 50px;
            background: linear-gradient(135deg, #f5deb3 0%, #ffe8b6 100%);
            border: 2px solid #8b7355;
            border-radius: 5px;
            margin: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 18px;
            color: #000;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
        }
    </style>
</head>
<body>
    <div id="container-ar"></div>
    
    <div id="ui-superior-fijo" style="position:fixed; top:10px; left:10px; z-index:9000; display:none;">
        <div id="txt-turno" style="background:rgba(0,0,0,0.9); padding:10px 15px; border:3px solid gold; font-size:24px; font-weight:900; border-radius:8px;">TURNO: ---</div>
        <div id="txt-vuelta" style="background:gold; color:black; padding:5px 10px; font-weight:900; border-radius:5px; margin-top:5px; display:inline-block;">VUELTA: 1 / 7</div>
    </div>

    <!-- MODAL DADOS -->
    <div id="modal-dados-fase" class="pantalla oculto" style="z-index:9500; background:rgba(0,0,0,0.95);">
        <h1 id="dados-player-name" style="font-size:36px; font-weight:900; color:white;">JUGADOR</h1>
        <div class="dados-container">
            <video id="video-dados-batalla" class="video-dados" src="https://kairosravina-bot.github.io/domusmagis/Dados.mp4" playsinline muted></video>
            <div id="layer-valor-batalla" class="layer-valor" style="font-weight:900;">0</div>
        </div>
        <div class="grid-dados">
            <div class="btn-dado-sel" onclick="window.ejecutarLanzamientoBatalla(2)"><strong>2</strong></div>
            <div class="btn-dado-sel" onclick="window.ejecutarLanzamientoBatalla(3)"><strong>3</strong></div>
            <div class="btn-dado-sel" onclick="window.ejecutarLanzamientoBatalla(4)"><strong>4</strong></div>
            <div class="btn-dado-sel" onclick="window.ejecutarLanzamientoBatalla(5)"><strong>5</strong></div>
        </div>
    </div>

    <!-- MODAL BATALLA FINAL (VIDEO) -->
    <div id="modal-batalla" class="pantalla oculto" style="z-index:9999; background:black; display:none; align-items:center; justify-content:center; width:100%; height:100vh; position:fixed; top:0; left:0;">
        <video id="video-clash" playsinline webkit-playsinline muted autoplay style="width:100%; height:100%; object-fit:contain; background:black;"></video>
        <div id="overlay-batalla" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:9998; pointer-events:none; text-align:center; width:100%;">
            <div style="font-size:52px; font-weight:900; color:#FFD700; text-shadow:4px 4px 15px rgba(0,0,0,0.95), 0 0 30px rgba(255,215,0,0.7); letter-spacing:4px; margin-bottom:30px; text-transform:uppercase;">‚öîÔ∏è BATALLA FINAL ‚öîÔ∏è</div>
            <div style="display:flex; align-items:center; justify-content:center; gap:40px; font-size:40px; font-weight:900; text-shadow:4px 4px 15px rgba(0,0,0,0.95);">
                <div id="nombre-j1" style="color:#ff0000; text-transform:uppercase;">JUGADOR 1</div>
                <div style="color:#FFD700; font-size:52px;">‚öîÔ∏è</div>
                <div id="nombre-j2" style="color:#00aaff; text-transform:uppercase;">JUGADOR 2</div>
            </div>
        </div>
    </div>

    <!-- INSCRIPCION -->
    <div id="p-setup" class="pantalla" style="background:rgba(0,0,0,0.8); z-index:10000;">
        <h2>INSCRIPCI√ìN</h2>
        <div id="setup-selector" style="display:flex; gap:10px;">
            <button class="btn-master" onclick="window.setModo(2)">2 MAGOS</button>
            <button class="btn-master" onclick="window.setModo(4)">4 MAGOS</button>
        </div>
        <div id="registro" class="oculto">
            <input type="text" id="mago-nombre" placeholder="NOMBRE DEL MAGO">
            <div class="grid-casas">
                <button onclick="window.registrarMago('TERRA','#ff0000')" class="btn-casa" style="background:#500;">üõ°Ô∏è TERRA</button>
                <button onclick="window.registrarMago('CAELUM','#00aaff')" class="btn-casa" style="background:#003;">‚öîÔ∏è CAELUM</button>
                <button onclick="window.registrarMago('AQUA','#00ff88')" class="btn-casa" style="background:#030;">üíß AQUA</button>
                <button onclick="window.registrarMago('DIMENSIO','#aa00ff')" class="btn-casa" style="background:#303;">‚ú® DIMENSIO</button>
            </div>
        </div>
    </div>

    <!-- UI JUEGO -->
    <div id="ui-juego" class="oculto">
        <div id="zona-superior">
            <div id="hud-derecho">
                <img id="hud-img-escudo" src="">
                <div id="hud-txt-arma" style="font-weight:900; color:white;">ARMA</div>
                <div id="hud-txt-valor" style="font-weight:900; font-size:60px; color:gold;">00</div>
            </div>
            <div id="guia-scanner"></div>
            <video id="video-action" playsinline style="display:none;"></video>
        </div>
        <div id="zona-inferior">
            <div id="msg-visor" style="font-size:26px; color:gold; font-weight:900;">ESCANEA CARTA</div>
            <p style="color:#aaa; font-weight:900;">SLOT: <span id="slot-indicator">1/3</span></p>
            <div class="contenedor-gemas">
                <div class="wrapper-gema"><span id="val-i" class="valor-flotante"></span><button id="btn-i" class="btn-gema"><span class="letra-grande">I</span></button></div>
                <div class="wrapper-gema"><span id="val-a" class="valor-flotante"></span><button id="btn-a" class="btn-gema"><span class="letra-grande">A</span></button></div>
                <div class="wrapper-gema"><span id="val-t" class="valor-flotante"></span><button id="btn-t" class="btn-gema"><span class="letra-grande">T</span></button></div>
                <div class="wrapper-gema"><span id="val-m" class="valor-flotante"></span><button id="btn-m" class="btn-gema"><span class="letra-grande">M</span></button></div>
            </div>
            <div style="display:flex; gap:10px; width:100%;">
                <button id="btn-confirmar" class="btn-master" style="background:#050; flex:2;">‚úÖ CONFIRMAR</button>
                <button id="btn-forzar" class="btn-master" style="background:#500; flex:1;" onclick="window.iniciarFaseDados()">‚öîÔ∏è YA</button>
                <button id="btn-reescaneo" class="btn-master" style="background:#aa8800; flex:1;" onclick="window.forzarReescaneo()">üîÑ RESCAN</button>
            </div>
        </div>
    </div>

    <!-- PANTALLA RESULTADOS (PERGAMINO) -->
    <div id="p-resultado" class="pantalla oculto" style="z-index:11000; background:rgba(0,0,0,0.9);">
        <div id="resultado-batalla" style="max-height:85vh; overflow-y:auto; padding:20px;">
            <h2 style="text-align:center; color:#FFD700; font-size:32px; margin-bottom:30px;">‚öîÔ∏è CR√ìNICAS DE GUERRA ‚öîÔ∏è</h2>
            <div id="resultado-contenido"></div>
            <div id="resultado-ganador" style="display:none; text-align:center; margin-top:40px; padding:30px; background:rgba(255,215,0,0.15); border:3px solid gold; border-radius:10px;">
                <div style="font-size:48px; font-weight:900; color:#FFD700; text-shadow:3px 3px 10px rgba(0,0,0,0.9); margin-bottom:20px;">üëë CAMPE√ìN üëë</div>
                <div id="txt-ganador-final" style="font-size:42px; font-weight:900; text-shadow:3px 3px 10px rgba(0,0,0,0.9);"></div>
            </div>
        </div>
        <button id="btn-repetir-accion" class="btn-master" onclick="window.continuarContienda()">‚öîÔ∏è SIGUIENTE RONDA</button>
    </div>

    <script type="module">
        import { iniciarOjo, resetUltimoId, RUTA_BASE, VIDEOS_BATALLA } from './ojo.js';

        let jugadores = [], cantJugadores = 0, turnoIdx = 0, slotActual = 0, vueltaActual = 1;
        let cartaActual = null, jugadaPendiente = null, diceIdx = 0;
        const MAX_SLOTS = 3, MAX_VUELTAS = 7;
        const MIS_VIDEOS = ["Escudos_vs_Espadas.mp4", "Explosion_Elemental.mp4", "Invocaciones_Etereas.mp4"];

        window.setModo = (m) => { 
            cantJugadores = m; 
            document.getElementById('setup-selector').style.display='none'; 
            document.getElementById('registro').classList.remove('oculto'); 
        };

        window.registrarMago = (elem, col) => {
            const nom = document.getElementById('mago-nombre').value.trim().toUpperCase();
            if(!nom) return alert("Nombre vac√≠o");
            jugadores.push({ 
                nombre: nom, 
                elemento: elem, 
                color: col, 
                slotsPuntos: 0, 
                dadoRonda: 0, 
                puntosTotales: 0,
                historico: [] // Guardar puntos de cada ronda
            });
            document.getElementById('mago-nombre').value = "";
            if(jugadores.length === cantJugadores) { 
                document.getElementById('p-setup').classList.add('oculto'); 
                document.getElementById('ui-juego').classList.remove('oculto'); 
                document.getElementById('ui-superior-fijo').style.display = 'block'; 
                iniciarPartida(); 
            }
        };

        function iniciarPartida() {
            actualizarUI();
            iniciarOjo('container-ar', (carta) => {
                cartaActual = carta;
                document.getElementById('guia-scanner').className = "verde";
                setTimeout(() => document.getElementById('guia-scanner').className = "", 600);
                document.getElementById('msg-visor').innerHTML = `<span>${carta.nombre}</span>`;
                ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                    const v = document.getElementById(id.replace('btn-', 'val-'));
                    v.innerText = carta.botones[id].valor;
                    v.className = "valor-flotante " + (carta.tipo==='CASA'?'neon-blanco':'neon-violeta');
                });
            });
        }

        function actualizarUI() {
            const j = jugadores[turnoIdx];
            document.getElementById('txt-turno').innerText = `TURNO: ${j.nombre}`;
            document.getElementById('txt-turno').style.color = j.color;
            document.getElementById('slot-indicator').innerText = `${slotActual + 1}/${MAX_SLOTS}`;
            document.getElementById('txt-vuelta').innerText = `VUELTA: ${vueltaActual} / ${MAX_VUELTAS}`;
        }

        window.forzarReescaneo = () => { 
            cartaActual = null; 
            resetUltimoId(); 
            document.getElementById('msg-visor').innerText = "ESCANEA CARTA"; 
            ['val-i', 'val-a', 'val-t', 'val-m'].forEach(v => { 
                const e=document.getElementById(v); 
                e.innerText=""; 
                e.className="valor-flotante";
            }); 
        };

        ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
            document.getElementById(id).onclick = () => {
                if(!cartaActual) return;
                const conf = cartaActual.botones[id];
                jugadaPendiente = { val: conf.valor };
                const v = document.getElementById('video-action'); 
                v.style.display='block'; 
                v.src=RUTA_BASE+conf.video; 
                v.play();
                document.getElementById('hud-derecho').style.display='flex';
                document.getElementById('hud-img-escudo').src = RUTA_BASE + cartaActual.imgEscudo;
                document.getElementById('hud-txt-arma').innerText = cartaActual.nombre;
                document.getElementById('hud-txt-valor').innerText = conf.valor;
                v.onended = () => { 
                    v.style.display='none'; 
                    document.getElementById('hud-derecho').style.display='none'; 
                };
            };
        });

        document.getElementById('btn-confirmar').onclick = () => {
            if(!jugadaPendiente) return alert("Selecciona gema");
            jugadores[turnoIdx].slotsPuntos += jugadaPendiente.val;
            jugadaPendiente = null; 
            turnoIdx++;
            if(turnoIdx >= cantJugadores) { 
                turnoIdx = 0; 
                slotActual++; 
                if(slotActual >= MAX_SLOTS) {
                    window.iniciarFaseDados();
                    return;
                }
            }
            actualizarUI(); 
            window.forzarReescaneo();
        };

        window.iniciarFaseDados = () => {
            document.getElementById('ui-juego').classList.add('oculto');
            document.getElementById('ui-superior-fijo').style.display = 'none';
            const modal = document.getElementById('modal-dados-fase');
            modal.classList.remove('oculto');
            document.getElementById('dados-player-name').innerText = jugadores[diceIdx].nombre;
            document.getElementById('dados-player-name').style.color = jugadores[diceIdx].color;
            document.getElementById('layer-valor-batalla').innerText = "0";
        };

        window.ejecutarLanzamientoBatalla = (n) => {
            const vid = document.getElementById('video-dados-batalla');
            const res = document.getElementById('layer-valor-batalla');
            res.innerText = "..."; 
            vid.currentTime = 0; 
            vid.play();
            vid.onended = () => {
                let suma = 0; 
                for(let i=0; i<n; i++) suma += Math.floor(Math.random()*6)+1;
                res.innerText = suma;
                jugadores[diceIdx].dadoRonda = suma;
                setTimeout(() => {
                    diceIdx++;
                    if(diceIdx < cantJugadores) {
                        window.iniciarFaseDados();
                    } else {
                        document.getElementById('modal-dados-fase').classList.add('oculto');
                        window.iniciarFaseFinal();
                    }
                }, 1200);
            };
        };

        window.iniciarFaseFinal = () => {
            const modal = document.getElementById('modal-batalla');
            const vid = document.getElementById('video-clash');
            
            // Determinar los 2 jugadores principales
            const jugadoresOrdenados = [...jugadores].sort((a, b) => b.slotsPuntos + b.dadoRonda - (a.slotsPuntos + a.dadoRonda));
            const j1 = jugadoresOrdenados[0];
            const j2 = jugadoresOrdenados[1] || jugadoresOrdenados[0];
            
            // Actualizar nombres en overlay
            document.getElementById('nombre-j1').innerText = j1.nombre;
            document.getElementById('nombre-j1').style.color = j1.color;
            document.getElementById('nombre-j2').innerText = j2.nombre;
            document.getElementById('nombre-j2').style.color = j2.color;
            
            modal.style.display = 'flex';
            
            const videoAleatorio = MIS_VIDEOS[Math.floor(Math.random() * MIS_VIDEOS.length)];
            const rutaVideo = RUTA_BASE + videoAleatorio;
            
            vid.src = rutaVideo;
            vid.load();
            
            setTimeout(() => {
                vid.play().catch(e => console.error("Error:", e));
            }, 100);
            
            // Timeout a 6 segundos
            let inicioVideo = Date.now();
            vid.ontimeupdate = () => {
                if((Date.now() - inicioVideo) > 6000) {
                    finalizarBatalla();
                }
            };
            
            vid.onended = () => finalizarBatalla();
            
            function finalizarBatalla() {
                vid.ontimeupdate = null;
                vid.onended = null;
                vid.pause();
                modal.style.display = 'none';
                mostrarResultados();
            }
        };

        function mostrarResultados() {
            const cont = document.getElementById('resultado-contenido');
            cont.innerHTML = "";
            
            jugadores.forEach(j => {
                const totalRonda = j.slotsPuntos + j.dadoRonda;
                j.puntosTotales += totalRonda;
                j.historico.push(totalRonda); // Guardar en hist√≥rico
                
                // Generar papiros con puntos hist√≥ricos
                let papiros = '';
                for(let i = 0; i < MAX_VUELTAS; i++) {
                    const pta√±o = j.historico[i] || '-';
                    papiros += `<div class="papiro-ronda">${pta√±o}</div>`;
                }
                
                cont.innerHTML += `
                    <div class="resultado-jugador" style="margin-bottom:30px; padding:20px; background:rgba(255,255,255,0.05); border-left:5px solid ${j.color}; border-radius:5px;">
                        <div class="res-nombre" style="color:${j.color}; font-size:24px; font-weight:900; margin-bottom:10px;">${j.nombre}</div>
                        <div class="fila-res" style="margin:10px 0;"><span style="color:#aaa;">CARTAS:</span> <span style="color:${j.color}; font-weight:900;">${j.slotsPuntos}</span></div>
                        <div class="fila-res" style="margin:10px 0;"><span style="color:#aaa;">DADOS:</span> <span style="color:${j.color}; font-weight:900;">${j.dadoRonda}</span></div>
                        <div class="total-score" style="font-size:28px; color:gold; font-weight:900; margin:15px 0;">${j.puntosTotales} PUNTOS</div>
                        <div style="font-size:12px; color:#aaa; margin-bottom:10px;">HIST√ìRICO (7 RONDAS):</div>
                        <div style="text-align:center;">${papiros}</div>
                    </div>
                `;
            });
            
            // Si es la √∫ltima vuelta, mostrar ganador
            if(vueltaActual >= MAX_VUELTAS) {
                const ganador = jugadores.reduce((a, b) => a.puntosTotales > b.puntosTotales ? a : b);
                document.getElementById('resultado-ganador').style.display = 'block';
                document.getElementById('txt-ganador-final').innerText = ganador.nombre;
                document.getElementById('txt-ganador-final').style.color = ganador.color;
            } else {
                document.getElementById('resultado-ganador').style.display = 'none';
            }
            
            document.getElementById('p-resultado').classList.remove('oculto');
            
            if(vueltaActual >= MAX_VUELTAS) {
                document.getElementById('btn-repetir-accion').innerText = "üèÜ FINALIZAR GRAN CONTIENDA";
            } else {
                document.getElementById('btn-repetir-accion').innerText = "‚öîÔ∏è SIGUIENTE RONDA";
            }
        }

        window.continuarContienda = () => {
            if(vueltaActual >= MAX_VUELTAS) return location.reload();
            vueltaActual++;
            slotActual = 0; 
            turnoIdx = 0; 
            diceIdx = 0;
            jugadores.forEach(j => { 
                j.slotsPuntos = 0; 
                j.dadoRonda = 0; 
            });
            document.getElementById('p-resultado').classList.add('oculto');
            document.getElementById('ui-juego').classList.remove('oculto');
            document.getElementById('ui-superior-fijo').style.display = 'block';
            window.forzarReescaneo();
            actualizarUI();
        };
    </script>
</body>
</html>