<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: BATALLA V110</title>
    <link rel="stylesheet" href="style.css">
    <script type="importmap">
    { "imports": { 
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js", 
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js" 
    } }
    </script>
</head>
<body>
    <div id="container-ar"></div>

    <!-- DEBUG BADGE TEMPORAL -->
    <div id="debug-target">ID: ---</div>

    <!-- MODALES Y UI (Se mantienen igual que V81 pero actualizados) -->
    <div id="modal-dados-fase" class="pantalla oculto" style="z-index:9500; background:rgba(0,0,0,0.85);">
        <h1 id="dados-player-name">JUGADOR</h1>
        <div class="dados-container">
            <video id="video-dados-batalla" class="video-dados" src="https://kairosravina-bot.github.io/domusmagis/Dados.mp4" playsinline muted></video>
            <div id="layer-valor-batalla" class="layer-valor">0</div>
        </div>
        <div class="grid-dados">
            <div class="btn-dado-sel" id="btn-batalla-2" onclick="window.ejecutarLanzamientoBatalla(2)">2D</div>
            <div class="btn-dado-sel" id="btn-batalla-3" onclick="window.ejecutarLanzamientoBatalla(3)">3D</div>
            <div class="btn-dado-sel" id="btn-batalla-4" onclick="window.ejecutarLanzamientoBatalla(4)">4D</div>
            <div class="btn-dado-sel" id="btn-batalla-5" onclick="window.ejecutarLanzamientoBatalla(5)">5D</div>
        </div>
    </div>

    <div id="p-setup" class="pantalla" style="background:rgba(0,0,0,0.9);">
        <h2>INSCRIPCIÓN V110</h2>
        <div id="setup-selector" style="display:flex; gap:10px;">
            <button class="btn-master" onclick="window.setModo(2)">2 MAGOS</button>
            <button class="btn-master" onclick="window.setModo(4)">4 MAGOS</button>
        </div>
        <div id="registro" class="oculto">
            <input type="text" id="mago-nombre" placeholder="NOMBRE">
            <div class="grid-casas">
                <button onclick="window.registrarMago('TERRA','#f00')" class="btn-casa" style="background:#500;">TERRA</button>
                <button onclick="window.registrarMago('CAELUM','#0af')" class="btn-casa" style="background:#003;">CAELUM</button>
                <button onclick="window.registrarMago('AQUA','#0f8')" class="btn-casa" style="background:#030;">AQUA</button>
                <button onclick="window.registrarMago('DIMENSIO','#d0f')" class="btn-casa" style="background:#303;">DIMENSIO</button>
            </div>
            <p id="reg-status"></p>
        </div>
    </div>

    <div id="ui-juego" class="oculto">
        <div id="zona-superior">
            <div id="txt-turno">TURNO: ---</div>
            <div id="hud-derecho">
                <img id="hud-img-escudo" src="">
                <div id="hud-txt-accion">ACCION</div>
                <div id="hud-txt-valor">00</div>
            </div>
            <div id="guia-scanner"></div>
            <video id="video-action" playsinline></video>
        </div>
        <div id="zona-inferior">
            <div id="msg-visor">ESCANEA CARTA</div>
            <div class="contenedor-gemas">
                <div class="wrapper-gema"><span id="val-i" class="valor-flotante"></span><button id="btn-i" class="btn-gema">I</button></div>
                <div class="wrapper-gema"><span id="val-a" class="valor-flotante"></span><button id="btn-a" class="btn-gema">A</button></div>
                <div class="wrapper-gema"><span id="val-t" class="valor-flotante"></span><button id="btn-t" class="btn-gema">T</button></div>
                <div class="wrapper-gema"><span id="val-m" class="valor-flotante"></span><button id="btn-m" class="btn-gema">M</button></div>
            </div>
            <button id="btn-confirmar" class="btn-master">✅ CONFIRMAR</button>
        </div>
    </div>

    <script type="module">
        import { CARTAS, RUTA_BASE, VIDEOS_BATALLA } from './biblioteca.js';
        import { iniciarOjo } from './ojo.js';

        let jugadores = [], cantJugadores = 0, slotActual = 0, turnoJugadorIdx = 0;
        let cartaActual = null, jugadaPendiente = null, idxDado = 0;

        const ui = { 
            msg: document.getElementById('msg-visor'), 
            debug: document.getElementById('debug-target'),
            vid: document.getElementById('video-action') 
        };

        window.setModo = (n) => { 
            cantJugadores = n; 
            document.getElementById('setup-selector').classList.add('oculto'); 
            document.getElementById('registro').classList.remove('oculto'); 
        };

        window.registrarMago = (casa, col) => {
            let n = document.getElementById('mago-nombre').value || "Mago " + (jugadores.length + 1);
            jugadores.push({ nombre: n, color: col, slots: [null, null, null], dado: 0 });
            if(jugadores.length === cantJugadores) iniciarJuego();
        };

        function iniciarJuego() {
            document.getElementById('p-setup').classList.add('oculto');
            document.getElementById('ui-juego').classList.remove('oculto');
            iniciarOjo('container-ar', (id) => {
                cartaActual = CARTAS[id];
                ui.msg.innerText = cartaActual.nombre;
                ui.debug.innerText = "TARGET: " + cartaActual.codTarget;
                ui.debug.style.display = 'block';
                actualizarGemas(cartaActual);
            }, () => {
                cartaActual = null;
                ui.debug.style.display = 'none';
                ui.msg.innerText = "BUSCANDO...";
            });
            actualizarTurnoUI();
        }

        function actualizarTurnoUI() {
            const j = jugadores[turnoJugadorIdx];
            document.getElementById('txt-turno').innerText = j.nombre;
            document.getElementById('txt-turno').style.color = j.color;
        }

        function actualizarGemas(c) {
            ['i','a','t','m'].forEach(l => {
                const id = 'btn-' + l;
                const valId = 'val-' + l;
                const conf = c.botones[id];
                document.getElementById(valId).innerText = conf.valor;
                // Colores neon segun tipo
                const vSpan = document.getElementById(valId);
                vSpan.className = "valor-flotante " + (c.tipo==='ARTEFACTO'?'neon-amarillo':c.tipo==='BUHO'?'neon-violeta':'neon-blanco');
            });
        }

        ['i','a','t','m'].forEach(l => {
            document.getElementById('btn-'+l).onclick = () => {
                if(!cartaActual) return;
                const conf = cartaActual.botones['btn-'+l];
                let vidFile = cartaActual['mp4'+l.toUpperCase()];
                
                ui.vid.style.display = 'block';
                ui.vid.src = RUTA_BASE + vidFile;
                ui.vid.play().catch(() => {
                    ui.vid.src = RUTA_BASE + conf.video;
                    ui.vid.play();
                });

                jugadaPendiente = { carta: cartaActual, valor: conf.valor, lado: conf.label };
                
                const hud = document.getElementById('hud-derecho');
                hud.style.display = 'flex';
                document.getElementById('hud-img-escudo').src = RUTA_BASE + cartaActual.imgEscudo;
                document.getElementById('hud-txt-valor').innerText = conf.valor;

                ui.vid.onended = () => { ui.vid.style.display = 'none'; hud.style.display='none'; };
            };
        });

        document.getElementById('btn-confirmar').onclick = () => {
            if(!jugadaPendiente) return;
            jugadores[turnoJugadorIdx].slots[slotActual] = jugadaPendiente;
            jugadaPendiente = null;
            turnoJugadorIdx++;
            if(turnoJugadorIdx >= cantJugadores) { turnoJugadorIdx=0; slotActual++; }
            if(slotActual >= 3) iniciarFaseDados();
            else actualizarTurnoUI();
        };

        function iniciarFaseDados() { 
            document.getElementById('modal-dados-fase').classList.remove('oculto'); 
            idxDado = 0;
            actualizarDadoJugador();
        }

        function actualizarDadoJugador() {
            if(idxDado >= cantJugadores) location.reload(); // Por ahora reinicio para ver resultados
            document.getElementById('dados-player-name').innerText = jugadores[idxDado].nombre;
        }

        window.ejecutarLanzamientoBatalla = (n) => {
            const v = document.getElementById('video-dados-batalla');
            v.play();
            v.onended = () => {
                let total = 0; for(let i=0;i<n;i++) total += Math.floor(Math.random()*6)+1;
                document.getElementById('layer-valor-batalla').innerText = total;
                document.getElementById('layer-valor-batalla').style.display = 'flex';
                setTimeout(() => { 
                    idxDado++; 
                    document.getElementById('layer-valor-batalla').style.display='none';
                    actualizarDadoJugador(); 
                }, 2000);
            };
        };
    </script>
</body>
</html>