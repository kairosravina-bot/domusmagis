<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: REVELATIONS V108</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="container-ar"></div>

    <!-- MODAL DADOS -->
    <div id="modal-dados-fase" class="pantalla oculto" style="z-index:9500; background:rgba(0,0,0,0.85);">
        <h2 style="color:#aaa; margin:0;">DESTINO</h2>
        <h1 id="dados-player-name" style="font-size:36px; margin:5px 0;">JUGADOR</h1>
        
        <div class="dados-container">
            <video id="video-dados-batalla" class="video-dados" src="https://kairosravina-bot.github.io/domusmagis/Dados.mp4" playsinline webkit-playsinline muted></video>
            <div id="layer-valor-batalla" class="layer-valor">0</div>
        </div>

        <h3 style="margin: 0; margin-top:5px; color:#888; font-size:14px;">SELECCIONA TUS DADOS:</h3>
        <div class="grid-dados">
            <div class="btn-dado-sel" id="btn-batalla-2" onclick="window.ejecutarLanzamientoBatalla(2)"><strong>2</strong><span>(12)</span></div>
            <div class="btn-dado-sel" id="btn-batalla-3" onclick="window.ejecutarLanzamientoBatalla(3)"><strong>3</strong><span>(18)</span></div>
            <div class="btn-dado-sel" id="btn-batalla-4" onclick="window.ejecutarLanzamientoBatalla(4)"><strong>4</strong><span>(24)</span></div>
            <div class="btn-dado-sel" id="btn-batalla-5" onclick="window.ejecutarLanzamientoBatalla(5)"><strong>5</strong><span>(30)</span></div>
        </div>
    </div>

    <!-- MODAL BATALLA FINAL -->
    <div id="modal-batalla" class="pantalla oculto" style="z-index:9999; background:rgba(0,0,0,0.9);">
        <h2 style="color:gold; margin-bottom:5px;">BATALLA FINAL</h2>
        <div id="texto-vs" style="font-size:26px; font-weight:900; margin-bottom:10px; font-family:var(--font-titulo); text-transform:uppercase;"></div>
        <video id="video-clash" playsinline webkit-playsinline style="width:100%; border-top:4px solid gold; border-bottom:4px solid gold;"></video>
    </div>

    <!-- CAMBIO TURNO -->
    <div id="pantalla-cambio-turno" class="pantalla oculto" style="z-index:8000; background: rgba(0,0,0,0.6);">
        <div style="background:rgba(20,20,20,0.95); padding:20px; border-radius:10px; border:2px solid gold; box-shadow: 0 0 20px #000;">
            <h1 style="font-size:50px; color: #ff4444; margin:0;">üõë ALTO üõë</h1>
            <p style="font-size:22px; color:#aaa;">ES EL TURNO DE:</p>
            <h2 style="color:var(--borde-dorado); font-size:50px;" id="next-player-name">JUGADOR</h2>
            <button class="btn-master" style="margin-top:30px; width:100%;" onclick="window.confirmarCambioTurno()">TOMAR EL MANDO</button>
        </div>
    </div>

    <!-- SETUP -->
    <div id="p-setup" class="pantalla" style="background:rgba(0,0,0,0.8);">
        <h2>INSCRIPCI√ìN</h2>
        <div id="setup-selector" style="display:flex; gap:10px; width:100%;">
            <button class="btn-master" onclick="window.setModo(2)">2 MAGOS</button>
            <button class="btn-master" onclick="window.setModo(4)">4 MAGOS</button>
        </div>
        <div id="registro" class="oculto" style="width:100%;">
            <input type="text" id="mago-nombre" placeholder="NOMBRE DEL MAGO" autocomplete="off">
            <div class="grid-casas">
                <button onclick="window.registrarMago('TERRA','#ff0000','ESCUDO_DRAGON.png')" class="btn-casa" style="background:#500; border-color:#f00;">üõ°Ô∏è TERRA</button>
                <button onclick="window.registrarMago('COELI','#00aaff','ESCUDO_AGUILA.png')" class="btn-casa" style="background:#003; border-color:#0af;">‚öîÔ∏è COELI</button>
                <button onclick="window.registrarMago('AQUA','#00ff88','ESCUDO_JABALI.png')" class="btn-casa" style="background:#030; border-color:#0f8;">üíß AQUA</button>
                <button onclick="window.registrarMago('MAGIA','#aa00ff','ESCUDO_ESPEJO.png')" class="btn-casa" style="background:#303; border-color:#d0f;">‚ú® MAGIA</button>
            </div>
            <p id="reg-status" style="color:var(--borde-dorado); text-align:center; font-size:24px; margin-top:20px; font-weight:900;"></p>
        </div>
        <button class="btn-master" style="margin-top:20px; background:#333;" onclick="window.location.href='index.html'">CANCELAR</button>
    </div>

    <!-- UI JUEGO -->
    <div id="ui-juego" class="oculto">
        <div id="zona-superior">
            <!-- TURNO 1/3 M√ÅS CHICO -->
            <div id="txt-turno">TURNO: ---</div>
            
            <!-- HUD DERECHO CON BOT√ìN REESCANEO -->
            <div id="hud-derecho">
                <img id="hud-img-escudo" src="" alt="Escudo">
                <div id="hud-txt-arma">ARMA</div>
                <div id="hud-txt-accion">ACCION</div>
                <div id="hud-txt-valor">00</div>
                <button class="btn-reescaneo" onclick="window.reescanear()">üîÑ CORREGIR</button>
            </div>

            <div id="guia-scanner"></div>
            <!-- VIDEO ACTION CON Z-INDEX PARA QUE EL TURNO QUEDE ARRIBA -->
            <video id="video-action" playsinline webkit-playsinline></video>
        </div>

        <div id="zona-inferior">
            <div id="msg-visor" style="font-size:26px; color:var(--borde-dorado); font-weight:900;">ESCANEA CARTA</div>
            <p style="color:#aaa; font-size:20px; margin:0;">SLOT: <span id="slot-indicator" style="color:gold;">1/3</span></p>
            
            <div class="contenedor-gemas">
                <div class="wrapper-gema"><span id="val-i" class="valor-flotante"></span><button id="btn-i" class="btn-gema"><span class="letra-grande">I</span></button></div>
                <div class="wrapper-gema"><span id="val-a" class="valor-flotante"></span><button id="btn-a" class="btn-gema"><span class="letra-grande">A</span></button></div>
                <div class="wrapper-gema"><span id="val-t" class="valor-flotante"></span><button id="btn-t" class="btn-gema"><span class="letra-grande">T</span></button></div>
                <div class="wrapper-gema"><span id="val-m" class="valor-flotante"></span><button id="btn-m" class="btn-gema"><span class="letra-grande">M</span></button></div>
            </div>
            
            <div style="display:flex; gap:10px; width:100%;">
                <button id="btn-confirmar" class="btn-master" style="background:#050; border-color:#0f0; flex:2;">‚úÖ CONFIRMAR</button>
                <button id="btn-forzar" class="btn-master" style="background:#500; font-size:14px;" onclick="window.iniciarFaseFinal()">‚öîÔ∏è YA</button>
            </div>
        </div>
    </div>

    <!-- RESULTADOS -->
    <div id="p-resultado" class="pantalla oculto" style="background:rgba(0,0,0,0.8);">
        <h2 style="color:#331a00; border-bottom:2px solid #8b4513; width:100%; text-shadow:none; background:rgba(255,255,255,0.8); padding:5px;">DECRETO FINAL</h2>
        <div id="resultado-batalla"><div id="resultado-contenido"></div></div>
        <div style="width:100%; display:flex; gap:10px; margin:20px 0;">
            <button class="btn-master" onclick="window.continuarContienda()">‚öîÔ∏è REPETIR</button>
            <button class="btn-master" style="background:#111; border-color:#f00;" onclick="window.location.href='index.html'">üö™ SALIR</button>
        </div>
    </div>

    <script type="module">
        import { CARTAS, VIDEOS_BATALLA, RUTA_BASE } from './biblioteca.js';
        import { iniciarOjo } from './ojo.js';

        const MAX_SLOTS = 3;
        let jugadores = [];
        let cantJugadores = 0;
        let turnoJugadorIdx = 0;
        let slotActual = 0;
        let cartaActualCargada = null;
        let jugadaPendiente = null;
        let indiceJugadorDados = 0; 

        // --- SETUP ---
        window.setModo = (modo) => {
            cantJugadores = modo;
            document.getElementById('setup-selector').classList.add('oculto');
            document.getElementById('registro').classList.remove('oculto');
            document.getElementById('reg-status').innerText = `JUGADOR 1 DE ${modo}`;
        };

        window.registrarMago = (elemento, color, escudo) => {
            const nombre = document.getElementById('mago-nombre').value.trim().toUpperCase();
            if (!nombre) { alert("Escribe tu nombre"); return; }
            jugadores.push({ nombre, elemento, color, escudo, slots: [null, null, null], dado: 0 });
            document.getElementById('mago-nombre').value = '';
            if (jugadores.length < cantJugadores) {
                document.getElementById('reg-status').innerText = `JUGADOR ${jugadores.length + 1} DE ${cantJugadores}`;
            } else {
                iniciarPartida();
            }
        };

        function iniciarPartida() {
            document.getElementById('p-setup').classList.add('oculto');
            document.getElementById('ui-juego').classList.remove('oculto');
            iniciarOjo('container-ar', onCartaDetectada);
            actualizarUI();
        }

        // --- L√ìGICA DE ESCANEO QR ---
        function onCartaDetectada(carta) {
            // "Sticky logic": Solo actualiza si no hay jugada en curso o es carta nueva
            cartaActualCargada = carta;
            document.getElementById('msg-visor').innerHTML = `${carta.nombre} <span style="font-size:14px; color:gold;">(#${Object.keys(CARTAS).find(key => CARTAS[key] === carta)})</span>`;
            document.getElementById('guia-scanner').style.borderColor = '#00ff00';
            document.getElementById('guia-scanner').style.boxShadow = '0 0 30px #00ff00';
            actualizarEstiloBotones(carta);
        }

        window.reescanear = () => {
            cartaActualCargada = null;
            jugadaPendiente = null;
            document.getElementById('hud-derecho').style.display = 'none';
            document.getElementById('msg-visor').innerText = "ESCANEA CARTA";
            document.getElementById('guia-scanner').style.borderColor = 'rgba(255,255,255,0.6)';
            resetBotones();
        };

        function actualizarUI() {
            const jugador = jugadores[turnoJugadorIdx];
            const divTurno = document.getElementById('txt-turno');
            divTurno.innerText = `${jugador.nombre}`;
            divTurno.style.color = jugador.color;
            divTurno.style.borderColor = jugador.color;
            document.getElementById('slot-indicator').innerText = `${slotActual + 1}/${MAX_SLOTS}`;
        }

        // --- INTERACCI√ìN GEMAS ---
        ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
            document.getElementById(id).onclick = () => {
                if (!cartaActualCargada) return;
                const conf = cartaActualCargada.botones[id];
                jugadaPendiente = { carta: cartaActualCargada, lado: conf.label, valor: conf.valor };

                const vAction = document.getElementById('video-action');
                vAction.style.display = 'block';
                vAction.src = RUTA_BASE + conf.video;
                vAction.play();

                const hud = document.getElementById('hud-derecho');
                hud.style.display = 'flex';
                document.getElementById('hud-img-escudo').src = RUTA_BASE + cartaActualCargada.imgEscudo;
                document.getElementById('hud-txt-arma').innerText = cartaActualCargada.nombre;
                document.getElementById('hud-txt-accion').innerText = conf.label;
                document.getElementById('hud-txt-valor').innerText = conf.valor;

                vAction.onended = () => { vAction.style.display = 'none'; };
            };
        });

        document.getElementById('btn-confirmar').onclick = () => {
            if (!jugadaPendiente) return;
            jugadores[turnoJugadorIdx].slots[slotActual] = jugadaPendiente;
            turnoJugadorIdx++;
            if (turnoJugadorIdx >= cantJugadores) { turnoJugadorIdx = 0; slotActual++; }
            
            if (slotActual >= MAX_SLOTS) {
                window.iniciarFaseFinal();
            } else {
                document.getElementById('pantalla-cambio-turno').classList.remove('oculto');
                document.getElementById('next-player-name').innerText = jugadores[turnoJugadorIdx].nombre;
                document.getElementById('ui-juego').classList.add('oculto');
            }
        };

        window.confirmarCambioTurno = () => {
            window.reescanear();
            document.getElementById('pantalla-cambio-turno').classList.add('oculto');
            document.getElementById('ui-juego').classList.remove('oculto');
            actualizarUI();
        };

        // --- FASE FINAL DADOS (Simplificado) ---
        window.iniciarFaseFinal = () => {
            document.getElementById('ui-juego').classList.add('oculto');
            indiceJugadorDados = 0;
            prepararDadosParaJugador();
        };

        function prepararDadosParaJugador() {
            if (indiceJugadorDados >= jugadores.length) { lanzarVideoBatalla(); return; }
            document.getElementById('modal-dados-fase').classList.remove('oculto');
            document.getElementById('dados-player-name').innerText = jugadores[indiceJugadorDados].nombre;
            document.getElementById('layer-valor-batalla').innerText = "0";
            const video = document.getElementById('video-dados-batalla');
            video.currentTime = 0; video.pause();
        }

        window.ejecutarLanzamientoBatalla = (n) => {
            const video = document.getElementById('video-dados-batalla');
            video.play();
            video.onended = () => {
                let total = 0; for (let i = 0; i < n; i++) total += Math.floor(Math.random() * 6) + 1;
                jugadores[indiceJugadorDados].dado = total;
                document.getElementById('layer-valor-batalla').innerText = total;
                setTimeout(() => {
                    document.getElementById('modal-dados-fase').classList.add('oculto');
                    indiceJugadorDados++; prepararDadosParaJugador();
                }, 1500);
            };
        };

        function lanzarVideoBatalla() {
            document.getElementById('modal-batalla').classList.remove('oculto');
            document.getElementById('texto-vs').innerText = `${jugadores[0].nombre} VS ${jugadores[1].nombre}`;
            const video = document.getElementById('video-clash');
            video.src = RUTA_BASE + VIDEOS_BATALLA[Math.floor(Math.random() * VIDEOS_BATALLA.length)];
            video.play();
            video.onended = () => {
                document.getElementById('modal-batalla').classList.add('oculto');
                mostrarResultados();
            };
        }

        function mostrarResultados() {
            document.getElementById('p-resultado').classList.remove('oculto');
            const cont = document.getElementById('resultado-contenido');
            cont.innerHTML = '';
            let resultados = jugadores.map(j => {
                let total = 0; j.slots.forEach(s => { if (s) total += s.valor; });
                return { ...j, total: total + j.dado };
            });
            resultados.sort((a, b) => b.total - a.total);
            resultados.forEach((r, i) => {
                cont.innerHTML += `
                <div class="resultado-jugador ${i === 0 ? 'ganador' : ''}">
                    <h3 style="color:${r.color}; margin:0;">${r.nombre}</h3>
                    <div style="font-size:50px; color:#8b0000; font-weight:900; text-align:right;">${r.total}</div>
                </div>`;
            });
        }

        window.continuarContienda = () => location.reload();

        function resetBotones() {
            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                document.getElementById(id).className = 'btn-gema';
                document.getElementById(id.replace('btn-', 'val-')).innerText = "";
            });
        }

        function actualizarEstiloBotones(carta) {
            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                const conf = carta.botones[id];
                const valSpan = document.getElementById(id.replace('btn-', 'val-'));
                valSpan.innerText = conf.valor;
                valSpan.className = "valor-flotante neon-blanco";
            });
        }
    </script>
</body>
</html>