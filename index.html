<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI - TEST DETECCI√ìN</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; width: 100vw; height: 100vh; overflow: hidden; background: #000; }
        #container-ar { width: 100%; height: 100%; }
        #resultado {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.95);
            color: #0f0;
            padding: 30px;
            border: 3px solid #0f0;
            font-size: 48px;
            font-weight: bold;
            font-family: monospace;
            z-index: 1000;
            min-width: 250px;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0 0 20px #0f0;
        }
        #info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.95);
            color: #aaa;
            padding: 20px;
            border: 2px solid #555;
            font-size: 14px;
            font-family: monospace;
            z-index: 1000;
            border-radius: 5px;
            max-width: 300px;
        }
    </style>
    
    <script type="importmap">
    { "imports": { 
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js", 
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/", 
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js" 
    } }
    </script>
</head>
<body>
    <div id="container-ar"></div>
    <div id="resultado">ESPERANDO...</div>
    <div id="info">
        <strong>üîÆ TEST DETECCI√ìN</strong><br>
        Apunta las cartas a la c√°mara<br>
        <br>
        <span id="estado">Inicializando...</span>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        const RUTA_BASE = "https://kairosravina-bot.github.io/domusmagis/";
        const resultDiv = document.getElementById('resultado');
        const estadoDiv = document.getElementById('estado');
        let targetActual = null;

        async function iniciar() {
            console.log("üîÆ Iniciando detecci√≥n...");
            estadoDiv.textContent = "Inicializando c√°mara...";

            try {
                const mindarThree = new MindARThree({
                    container: document.getElementById('container-ar'),
                    imageTargetSrc: RUTA_BASE + 'targets1.mind',
                    maxTrack: 1,
                    uiLoading: "no",
                    uiScanning: "no",
                    uiError: "no"
                });

                const { renderer, scene, camera } = mindarThree;

                console.log("üìå Creando 58 anchors...");
                
                for (let i = 0; i < 58; i++) {
                    const anchor = mindarThree.addAnchor(i);

                    const geometry = new THREE.PlaneGeometry(1, 1);
                    const material = new THREE.MeshBasicMaterial({ transparent: true, opacity: 0 });
                    const plane = new THREE.Mesh(geometry, material);
                    anchor.group.add(plane);

                    anchor.onTargetFound = () => {
                        console.log(`‚úÖ TARGET ${i} DETECTADO`);
                        targetActual = i;
                        resultDiv.textContent = `TARGET: ${i}`;
                        resultDiv.style.borderColor = '#0f0';
                        resultDiv.style.color = '#0f0';
                        resultDiv.style.boxShadow = '0 0 30px #0f0';
                        estadoDiv.innerHTML = `<strong>‚úÖ Detectado</strong><br>Target: ${i}<br><br>Cambia de carta`;
                    };

                    anchor.onTargetLost = () => {
                        console.log(`‚ùå TARGET ${i} PERDIDO`);
                        if (targetActual === i) {
                            targetActual = null;
                            resultDiv.textContent = 'ESPERANDO...';
                            resultDiv.style.borderColor = '#ff0000';
                            resultDiv.style.color = '#ff0000';
                            resultDiv.style.boxShadow = '0 0 30px #ff0000';
                            estadoDiv.innerHTML = `<strong>‚ùå Perdido</strong><br>Vuelve a apuntar`;
                        }
                    };
                }

                console.log("‚úÖ Anchors creados");
                estadoDiv.textContent = "C√°mara lista";

                await mindarThree.start();
                console.log("‚úÖ AR INICIADO");
                estadoDiv.innerHTML = `<strong>‚úÖ Listo</strong><br>Apunta una carta`;

                renderer.setAnimationLoop(() => {
                    renderer.render(scene, camera);
                });

            } catch (error) {
                console.error("‚ùå Error:", error);
                resultDiv.textContent = 'ERROR';
                resultDiv.style.color = '#f00';
                resultDiv.style.borderColor = '#f00';
                estadoDiv.innerHTML = `<strong>‚ùå ERROR</strong><br>${error.message}`;
            }
        }

        window.addEventListener('load', iniciar);

    </script>
</body>
</html>
