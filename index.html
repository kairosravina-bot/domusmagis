<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: REVELATIONS - VERSIÓN 6.0</title>

    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }

        /* SPLASH SCREEN */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: radial-gradient(circle, #1a001a, #000);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity 0.5s;
        }
        #splash-screen.oculto { opacity: 0; pointer-events: none; }

        /* BOTÓN INICIO */
        #btn-inicio {
            padding: 25px 50px; font-size: 24px; font-weight: bold; color: #000;
            background: #bf00ff; border: none; border-radius: 15px; cursor: pointer;
            text-transform: uppercase; box-shadow: 0 0 30px #bf00ff;
            animation: pulso 2s infinite; z-index: 10;
        }
        @keyframes pulso { 50% { box-shadow: 0 0 60px #bf00ff; } }
        
        /* TEXTO DE VERSIÓN (BAJO EL BOTÓN) */
        #version-display {
            margin-top: 20px;
            color: #00ff00;
            font-family: monospace;
            font-size: 14px;
            text-shadow: 0 0 5px #00ff00;
            z-index: 11;
        }

        /* CAPA VIDEO INTRO */
        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center;
        }
        #intro-layer.oculto { display: none; }
        #intro-video { width: 100%; height: 100%; object-fit: contain; }

        /* LAYOUT PRINCIPAL */
        #container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 0; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; display: flex; flex-direction: column; }

        /* VISOR */
        #video-visor {
            width: 100%; height: 100vw; max-height: 65vh; background: rgba(0,0,0,0.9);
            border-bottom: 2px solid #555; pointer-events: auto; display: flex;
            align-items: center; justify-content: center; position: relative;
        }
        #video-player { width: 100%; height: 100%; object-fit: contain; display: none; z-index: 10; }
        #msg-visor { color: white; text-align: center; font-weight: bold; letter-spacing: 1px; z-index: 20; }

        /* OVERLAY DATOS */
        #video-overlay {
            position: absolute; top: 20px; right: 20px; display: none;
            flex-direction: column; align-items: center; z-index: 500; pointer-events: none;
        }
        #overlay-img { width: 75px; height: auto; filter: drop-shadow(0 0 8px rgba(255,255,255,0.9)); margin-bottom: 5px; }
        #overlay-text {
            color: #fff; font-weight: 800; font-size: 22px; background: rgba(0,0,0,0.7);
            padding: 4px 10px; border-radius: 8px; border: 2px solid #aaa; text-align: center; min-width: 45px;
        }

        /* SCANNER & BOTONES */
        #zona-ar { flex-grow: 1; position: relative; display: flex; align-items: center; justify-content: center; }
        #guia-scanner {
            width: 60vw; height: 60vw; max-width: 250px; max-height: 250px;
            border: 4px solid red; border-radius: 15px; box-shadow: 0 0 20px rgba(255,0,0,0.5); transition: 0.3s;
        }
        #guia-scanner.verde { border-color: #0f0; box-shadow: 0 0 50px #0f0; background: rgba(0,255,0,0.1); }

        #panel-inferior {
            background: #111; border-top: 2px solid #fff; padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom)); pointer-events: auto;
            display: flex; flex-direction: column; gap: 10px;
        }
        #selectores { display: flex; justify-content: space-around; padding-top: 5px; gap: 15px; }
        
        .btn-selector {
            width: 75px; height: 75px; border-radius: 50%; background: #222; border: 3px solid #555;
            color: #555; font-size: 26px; font-weight: bold; display: flex; align-items: center; justify-content: center;
            opacity: 0.4; transition: 0.3s; cursor: not-allowed;
        }
        .btn-selector.activo { opacity: 1; cursor: pointer; color: white; border-color: white; transform: scale(1.1); }
        
        #btn-i.activo { background: #900; box-shadow: 0 0 25px #f00; }
        #btn-a.activo { background: #090; box-shadow: 0 0 25px #0f0; }
        #btn-t.activo { background: #555; box-shadow: 0 0 25px #aaa; }
        #btn-m.activo { background: #609; box-shadow: 0 0 25px #d0f; }
    </style>
</head>
<body>

    <!-- CAPAS -->
    <div id="intro-layer" class="oculto"><video id="intro-video" playsinline webkit-playsinline></video></div>
    
    <div id="splash-screen">
        <button id="btn-inicio">⚡ INICIAR SISTEMA ⚡</button>
        <!-- VERSIÓN SINCRONIZADA -->
        <div id="version-display">Cargando versión...</div>
    </div>

    <div id="container"></div>

    <div id="ui-layer">
        <div id="video-visor">
            <div id="msg-visor">INICIANDO...</div>
            <video id="video-player" playsinline webkit-playsinline></video>
            <div id="video-overlay">
                <img id="overlay-img" src="" alt="Escudo">
                <div id="overlay-text"></div>
            </div>
        </div>
        <div id="zona-ar"><div id="guia-scanner"></div></div>
        <div id="panel-inferior">
            <div id="selectores">
                <button id="btn-i" class="btn-selector" data-lado="IMPETUS">I</button>
                <button id="btn-a" class="btn-selector" data-lado="AUXILIUM">A</button>
                <button id="btn-t" class="btn-selector" data-lado="TUTELA">T</button>
                <button id="btn-m" class="btn-selector" data-lado="MYSTERIUM">M</button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        // ==========================================
        // 1. CONTROL DE VERSIÓN (Sincronizado)
        // ==========================================
        const VERSION_CODIGO = "VERSIÓN 6.0 - BÚHO FUNCIONAL + SISTEMA MODULAR";
        
        // Imprimir en consola
        console.log("╔════════════════════════════════════════╗");
        console.log("║  DOMUS MAGI: REVELATIONS               ║");
        console.log("║  " + VERSION_CODIGO.padEnd(37) + "║");
        console.log("╚════════════════════════════════════════╝");
        
        // Imprimir bajo el botón
        const displayVersion = document.getElementById('version-display');
        if(displayVersion) {
            displayVersion.innerText = VERSION_CODIGO;
        }

        // ==========================================
        // 2. CONFIGURACIÓN Y DATOS
        // ==========================================
        const RUTA_BASE = "https://kairosravina-bot.github.io/domusmagis/";
        
        const CARTAS = {
            0: { // Dragón
                tipo: 'ESTANDAR',
                imgEscudo: "ESCUDO_DRAGON.png",
                valores: { IMPETUS: 7, AUXILIUM: 2, TUTELA: 3, MYSTERIUM: 2 },
                videos: { 
                    IMPETUS: RUTA_BASE+"ataque.mp4", 
                    AUXILIUM: RUTA_BASE+"cura.mp4", 
                    TUTELA: RUTA_BASE+"defensa.mp4", 
                    MYSTERIUM: RUTA_BASE+"magia.mp4" 
                },
                letras: { IMPETUS: "I", AUXILIUM: "A", TUTELA: "T", MYSTERIUM: "M" }
            },
            1: { // Águila
                tipo: 'ESTANDAR',
                imgEscudo: "ESCUDO_AGUILA.png", 
                valores: { IMPETUS: 5, AUXILIUM: 4, TUTELA: 2, MYSTERIUM: 3 },
                videos: { 
                    IMPETUS: RUTA_BASE+"ataque.mp4", 
                    AUXILIUM: RUTA_BASE+"cura.mp4", 
                    TUTELA: RUTA_BASE+"defensa.mp4", 
                    MYSTERIUM: RUTA_BASE+"magia.mp4" 
                },
                letras: { IMPETUS: "I", AUXILIUM: "A", TUTELA: "T", MYSTERIUM: "M" }
            },
            2: { // León
                tipo: 'ESTANDAR',
                imgEscudo: "ESCUDO_LEON.png",
                valores: { IMPETUS: 8, AUXILIUM: 1, TUTELA: 4, MYSTERIUM: 1 },
                videos: { 
                    IMPETUS: RUTA_BASE+"ataque.mp4", 
                    AUXILIUM: RUTA_BASE+"cura.mp4", 
                    TUTELA: RUTA_BASE+"defensa.mp4", 
                    MYSTERIUM: RUTA_BASE+"magia.mp4" 
                },
                letras: { IMPETUS: "I", AUXILIUM: "A", TUTELA: "T", MYSTERIUM: "M" }
            },
            3: { // Jabalí
                tipo: 'ESTANDAR',
                imgEscudo: "ESCUDO_JABALI.png",
                valores: { IMPETUS: 6, AUXILIUM: 3, TUTELA: 3, MYSTERIUM: 2 },
                videos: { 
                    IMPETUS: RUTA_BASE+"ataque.mp4", 
                    AUXILIUM: RUTA_BASE+"cura.mp4", 
                    TUTELA: RUTA_BASE+"defensa.mp4", 
                    MYSTERIUM: RUTA_BASE+"magia.mp4" 
                },
                letras: { IMPETUS: "I", AUXILIUM: "A", TUTELA: "T", MYSTERIUM: "M" }
            },
            4: { // BÚHO (CARTA ESPECIAL)
                tipo: 'ESPECIAL',
                imgEscudo: "ESCUDO_BUHO.png",
                valores: { 
                    IMPETUS: "MANDATUM", 
                    AUXILIUM: "PRAESAGIUM", 
                    TUTELA: "CONSILIUM", 
                    MYSTERIUM: "ARCANUM" 
                },
                videos: { 
                    IMPETUS: RUTA_BASE + "owl_mandatum.mp4",
                    AUXILIUM: RUTA_BASE + "owl_praesagium.mp4",
                    TUTELA: RUTA_BASE + "owl_consilium.mp4",
                    MYSTERIUM: RUTA_BASE + "owl_arcanum.mp4"
                },
                letras: { IMPETUS: "M", AUXILIUM: "P", TUTELA: "C", MYSTERIUM: "S" }
            }
        };

        // Variables Globales
        let cartaActualIndex = null;
        
        // Elementos UI
        const ui = {
            btnI: document.getElementById('btn-i'),
            btnA: document.getElementById('btn-a'),
            btnT: document.getElementById('btn-t'),
            btnM: document.getElementById('btn-m'),
            scanner: document.getElementById('guia-scanner'),
            msg: document.getElementById('msg-visor'),
            overlay: document.getElementById('video-overlay'),
            ovImg: document.getElementById('overlay-img'),
            ovTxt: document.getElementById('overlay-text'),
            videoPlayer: document.getElementById('video-player'),
            botones: document.querySelectorAll('.btn-selector')
        };

        // ==========================================
        // 3. INICIO DE APP
        // ==========================================
        document.getElementById('btn-inicio').addEventListener('click', () => {
            const splash = document.getElementById('splash-screen');
            const intro = document.getElementById('intro-layer');
            const vid = document.getElementById('intro-video');

            splash.classList.add('oculto');
            intro.classList.remove('oculto');
            
            vid.src = RUTA_BASE + "presentacion.mp4";
            vid.play().catch(() => {
                intro.classList.add('oculto');
                iniciarAR();
            });

            vid.addEventListener('ended', () => {
                intro.classList.add('oculto');
                iniciarAR();
            });
        });

        // ==========================================
        // 4. MOTOR AR (MindAR)
        // ==========================================
        async function iniciarAR() {
            const mindarThree = new MindARThree({
                container: document.querySelector("#container"),
                imageTargetSrc: RUTA_BASE + "targets1.mind"
            });

            const {renderer, scene, camera} = mindarThree;

            // Loop para detectar 5 cartas (0 al 4)
            for(let i = 0; i < 5; i++) {
                const anchor = mindarThree.addAnchor(i);
                
                // Objeto invisible para tracking
                const geometry = new THREE.PlaneGeometry(1, 1);
                const material = new THREE.MeshBasicMaterial({transparent: true, opacity: 0});
                const plane = new THREE.Mesh(geometry, material);
                anchor.group.add(plane);

                // --- AL ENCONTRAR CARTA ---
                anchor.onTargetFound = () => {
                    console.log(`╔════════════════════════════════════════╗`);
                    console.log(`║ CARTA DETECTADA: ${i} (${CARTAS[i].tipo})             ║`);
                    console.log(`╚════════════════════════════════════════╝`);
                    
                    cartaActualIndex = i;
                    const cartaInfo = CARTAS[i];
                    
                    // ACTUALIZAR BOTONES SEGÚN TIPO (SISTEMA MODULAR)
                    ui.btnI.innerText = cartaInfo.letras.IMPETUS;
                    ui.btnA.innerText = cartaInfo.letras.AUXILIUM;
                    ui.btnT.innerText = cartaInfo.letras.TUTELA;
                    ui.btnM.innerText = cartaInfo.letras.MYSTERIUM;
                    
                    console.log(`→ Botones actualizados:`);
                    console.log(`  I="${ui.btnI.innerText}" A="${ui.btnA.innerText}" T="${ui.btnT.innerText}" M="${ui.btnM.innerText}"`);

                    // UI Feedback
                    ui.scanner.classList.add('verde');
                    ui.msg.innerText = "CONECTADO";
                    ui.msg.style.color = "#0f0";
                    
                    ui.botones.forEach(b => b.classList.add('activo'));
                };

                // --- AL PERDER CARTA ---
                anchor.onTargetLost = () => {
                    console.log(`⚠ CARTA PERDIDA: ${i}`);
                    if(cartaActualIndex === i) {
                        cartaActualIndex = null;
                        ui.scanner.classList.remove('verde');
                        ui.msg.innerText = "ESCANEAR...";
                        ui.msg.style.color = "#fff";
                        ui.overlay.style.display = 'none';
                        ui.videoPlayer.style.display = 'none';
                        ui.botones.forEach(b => b.classList.remove('activo'));
                    }
                };
            }

            await mindarThree.start();
            renderer.setAnimationLoop(() => {
                renderer.render(scene, camera);
            });
        }

        // ==========================================
        // 5. INTERACCIÓN (CLICS)
        // ==========================================
        ui.botones.forEach(btn => {
            btn.addEventListener('click', () => {
                if(!btn.classList.contains('activo') || cartaActualIndex === null) {
                    console.warn("⚠ Click ignorado: Botón inactivo o sin carta");
                    return;
                }

                const lado = btn.getAttribute('data-lado');
                const info = CARTAS[cartaActualIndex];

                console.log(`╔════════════════════════════════════════╗`);
                console.log(`║ CLIC EN: ${lado.padEnd(30)}║`);
                console.log(`║ Carta: ${cartaActualIndex} (${info.tipo.padEnd(25)})║`);
                console.log(`╚════════════════════════════════════════╝`);

                // 1. Obtener Video y Valor
                const vidSrc = info.videos[lado];
                const valor = info.valores[lado];
                
                console.log(`→ Video: ${vidSrc}`);
                console.log(`→ Valor: ${valor}`);
                
                // 2. Configurar Overlay
                ui.ovImg.src = RUTA_BASE + info.imgEscudo;
                ui.ovTxt.innerText = valor;

                // 3. Colores Overlay según lado
                if(lado === 'IMPETUS') ui.ovTxt.style.borderColor = "#f55";
                else if(lado === 'AUXILIUM') ui.ovTxt.style.borderColor = "#5f5";
                else if(lado === 'MYSTERIUM') ui.ovTxt.style.borderColor = "#d5f";
                else ui.ovTxt.style.borderColor = "#aaa";

                ui.overlay.style.display = 'flex';

                // 4. Reproducir Video
                ui.msg.style.display = 'none';
                ui.videoPlayer.style.display = 'block';
                ui.videoPlayer.src = vidSrc;
                ui.videoPlayer.muted = false;
                ui.videoPlayer.volume = 1.0;
                ui.videoPlayer.play();
                
                console.log("✓ Video iniciado correctamente");
            });
        });

        // Evento de fin de video
        ui.videoPlayer.addEventListener('ended', () => {
            ui.videoPlayer.style.display = 'none';
            ui.overlay.style.display = 'none';
            ui.msg.style.display = 'block';
            ui.msg.innerText = "LISTO";
            console.log("✓ Video finalizado");
        });

    </script>
</body>
</html>