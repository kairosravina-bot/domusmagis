<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: REVELATIONS</title>
    
    <!-- LIBRERÍAS ESTABLES -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        /* IMPORTANTE: Fondo transparente para no tapar la cámara */
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: transparent; 
            font-family: 'Segoe UI', sans-serif; 
        }

        /* CAPA DE CARGA (Fondo Negro inicial) */
        #pantalla-inicio {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }

        /* BOTÓN DE ACTIVACIÓN MANUAL */
        #btn-activar {
            margin-top: 30px;
            padding: 20px 40px;
            font-size: 20px; font-weight: bold; color: #fff;
            background: linear-gradient(45deg, #0066ff, #00ccff);
            border: 2px solid #fff; border-radius: 50px;
            cursor: pointer; box-shadow: 0 0 20px rgba(0, 200, 255, 0.5);
            text-transform: uppercase; letter-spacing: 2px;
        }
        #btn-activar:active { transform: scale(0.95); }

        #mensaje-debug {
            color: #ff3333; margin-top: 20px; font-family: monospace; font-size: 12px; text-align: center; padding: 0 20px;
        }

        /* GUÍA DE ESCANEO (VERDE/ROJO) */
        #guia-scan {
            position: absolute; top: 50%; left: 50%;
            width: 70vw; height: 95vw; max-width: 280px; max-height: 400px;
            transform: translate(-50%, -20%); /* Centrado ajustado */
            border: 4px solid rgba(255, 0, 0, 0.5);
            border-radius: 15px; pointer-events: none; z-index: 5;
            transition: all 0.3s;
        }
        #guia-scan.detectado {
            border-color: #00ff00;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.5);
            background: rgba(0, 255, 0, 0.1);
        }

        /* INTERFAZ DE JUEGO */
        #ui-juego {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: none; /* Se oculta hasta que arranca la cámara */
            flex-direction: column;
        }

        /* VISOR VIDEO */
        #zona-video {
            width: 100%; height: 35%; background: rgba(0,0,0,0.8);
            border-bottom: 2px solid #555; pointer-events: auto;
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        #video-player { width: 100%; height: 100%; object-fit: contain; display: none; }
        #txt-estado { color: #fff; text-align: center; }

        /* ZONA CENTRAL VACÍA */
        #zona-ar { flex-grow: 1; }

        /* PANEL INFERIOR */
        #panel-control {
            background: #111; border-top: 2px solid #fff;
            padding-bottom: env(safe-area-inset-bottom); pointer-events: auto;
        }

        /* TABLA DE DATOS */
        #tabla-datos {
            padding: 10px; display: flex; flex-direction: column; gap: 5px;
            border-bottom: 1px solid #333;
        }
        .fila { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .fila-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        
        .dato { background: #222; padding: 5px; border-radius: 5px; text-align: center; border: 1px solid #444; }
        .titulo { font-size: 9px; color: #888; display: block; }
        .valor { font-size: 14px; color: #fff; font-weight: bold; }

        /* BOTONES */
        #botonera { display: flex; justify-content: center; gap: 15px; padding: 15px; }
        .btn-poder {
            width: 60px; height: 60px; border-radius: 50%;
            background: #333; border: 2px solid #555; color: #777;
            font-size: 20px; font-weight: bold; display: flex; 
            flex-direction: column; align-items: center; justify-content: center;
            opacity: 0.5; transition: 0.2s;
        }
        .btn-poder.activo {
            opacity: 1; cursor: pointer; color: #fff; border-color: #fff; transform: scale(1.1);
        }
        
        /* Colores activos */
        #btn-i.activo { background: #900; box-shadow: 0 0 15px #f00; }
        #btn-a.activo { background: #090; box-shadow: 0 0 15px #0f0; }
        #btn-t.activo { background: #555; box-shadow: 0 0 15px #aaa; }
        #btn-m.activo { background: #609; box-shadow: 0 0 15px #d0f; }

    </style>
</head>
<body>

    <!-- 1. PANTALLA DE INICIO (ESTO SOLUCIONA LA PANTALLA NEGRA) -->
    <div id="pantalla-inicio">
        <h1 style="color:white; letter-spacing: 5px;">DOMUS MAGI</h1>
        <p style="color:#aaa;">SISTEMA DE REALIDAD AUMENTADA</p>
        
        <!-- EL BOTÓN MÁGICO -->
        <button id="btn-activar">ACTIVAR CÁMARA</button>
        
        <div id="mensaje-debug">Esperando confirmación de usuario...</div>
    </div>

    <!-- 2. GUÍA VISUAL -->
    <div id="guia-scan"></div>

    <!-- 3. INTERFAZ DE JUEGO (Se muestra al activar) -->
    <div id="ui-juego">
        <div id="zona-video">
            <div id="txt-estado">
                SISTEMA LISTO<br>
                <span style="font-size:12px; color:#f55" id="lbl-tracking">BUSCANDO CARTA...</span>
            </div>
            <video id="video-player" playsinline webkit-playsinline></video>
        </div>

        <div id="zona-ar"></div>

        <div id="panel-control">
            <div id="tabla-datos">
                <div class="fila">
                    <div class="dato"><span class="titulo">CASA</span><span id="d-casa" class="valor">---</span></div>
                    <div class="dato"><span class="titulo">ESCUDO</span><span id="d-escudo" class="valor">---</span></div>
                    <div class="dato"><span class="titulo">ARMA</span><span id="d-arma" class="valor">---</span></div>
                </div>
                <div class="fila-2">
                    <div class="dato"><span class="titulo">POSICIÓN</span><span id="d-pos" class="valor" style="color:#ff0">---</span></div>
                    <div class="dato"><span class="titulo">VALOR</span><span id="d-val" class="valor" style="color:#0f0">0</span></div>
                </div>
            </div>

            <div id="botonera">
                <button id="btn-i" class="btn-poder" data-tipo="IMPETUS">I <span style="font-size:10px">0</span></button>
                <button id="btn-a" class="btn-poder" data-tipo="AUXILIUM">A <span style="font-size:10px">0</span></button>
                <button id="btn-t" class="btn-poder" data-tipo="TUTELA">T <span style="font-size:10px">0</span></button>
                <button id="btn-m" class="btn-poder" data-tipo="MYSTERIUM">M <span style="font-size:10px">0</span></button>
            </div>
        </div>
    </div>

    <!-- 4. ESCENA AR -->
    <!-- Nota: autoStart: false es clave. Nosotros lo iniciamos manualmente. -->
    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiLoading: no; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false"
        renderer="colorManagement: true; alpha: true"
        embedded>
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity id="target-carta" mindar-image-target="targetIndex: 0"></a-entity>
    </a-scene>

    <script>
        // DATOS
        const INFO = {
            casa: "DOMUS DRACO", escudo: "DRAGÓN", arma: "SICA",
            valores: {
                IMPETUS:   { v: 6, mp4: "ataque.mp4" },
                AUXILIUM:  { v: 1, mp4: "cura.mp4" },
                TUTELA:    { v: 2, mp4: "defensa.mp4" },
                MYSTERIUM: { v: 1, mp4: "magia.mp4" }
            }
        };

        // REFERENCIAS DOM
        const btnActivar = document.getElementById('btn-activar');
        const pantallaInicio = document.getElementById('pantalla-inicio');
        const debugMsg = document.getElementById('mensaje-debug');
        const uiJuego = document.getElementById('ui-juego');
        
        const guia = document.getElementById('guia-scan');
        const lblTracking = document.getElementById('lbl-tracking');
        const video = document.getElementById('video-player');
        const txtEstado = document.getElementById('txt-estado');

        // BOTÓN: INICIAR TODO
        btnActivar.addEventListener('click', async () => {
            btnActivar.disabled = true;
            btnActivar.innerText = "INICIANDO...";
            debugMsg.innerText = "Solicitando cámara al navegador...";

            const sceneEl = document.querySelector('a-scene');
            const arSystem = sceneEl.systems['mindar-image-system'];

            try {
                // Paso 1: Intentar arrancar
                await arSystem.start(); 
                
                // Si pasa de aquí, es éxito
                debugMsg.innerText = "¡Cámara activa!";
                pantallaInicio.style.display = 'none'; // Quitar pantalla negra
                uiJuego.style.display = 'flex';        // Mostrar juego
                
            } catch (error) {
                console.error(error);
                debugMsg.innerText = "ERROR FATAL: " + error;
                btnActivar.disabled = false;
                btnActivar.innerText = "REINTENTAR";
                alert("No se pudo acceder a la cámara. Revisa permisos o HTTPS.");
            }
        });

        // LÓGICA DE DETECCIÓN
        const target = document.getElementById('target-carta');
        const botones = document.querySelectorAll('.btn-poder');

        // VALORES UI
        const uCasa = document.getElementById('d-casa');
        const uEscudo = document.getElementById('d-escudo');
        const uArma = document.getElementById('d-arma');
        const uPos = document.getElementById('d-pos');
        const uVal = document.getElementById('d-val');

        target.addEventListener('targetFound', () => {
            guia.classList.add('detectado');
            lblTracking.innerText = "ENFOCADA";
            lblTracking.style.color = "#0f0";

            // Llenar datos
            uCasa.innerText = INFO.casa;
            uEscudo.innerText = INFO.escudo;
            uArma.innerText = INFO.arma;

            // Activar botones
            botones.forEach(btn => {
                const tipo = btn.getAttribute('data-tipo');
                btn.querySelector('span').innerText = INFO.valores[tipo].v;
                btn.classList.add('activo');
            });
        });

        target.addEventListener('targetLost', () => {
            guia.classList.remove('detectado');
            lblTracking.innerText = "BUSCANDO...";
            lblTracking.style.color = "#f55";

            // Limpiar
            uCasa.innerText = "---";
            uEscudo.innerText = "---";
            uArma.innerText = "---";
            uPos.innerText = "---";
            uVal.innerText = "0";
            
            video.pause();
            video.style.display = 'none';
            txtEstado.style.display = 'block';

            // Desactivar botones
            botones.forEach(btn => btn.classList.remove('activo'));
        });

        // CLIC EN BOTONES
        botones.forEach(btn => {
            btn.addEventListener('click', () => {
                if(!btn.classList.contains('activo')) return;

                const tipo = btn.getAttribute('data-tipo');
                const datos = INFO.valores[tipo];

                // Mostrar en pantalla
                uPos.innerText = tipo;
                uVal.innerText = datos.v;

                if(tipo === 'IMPETUS') uPos.style.color = "#f55";
                if(tipo === 'AUXILIUM') uPos.style.color = "#5f5";
                if(tipo === 'MYSTERIUM') uPos.style.color = "#d5f";

                // Play Video
                txtEstado.style.display = 'none';
                video.style.display = 'block';
                video.src = datos.mp4;
                video.play();
            });
        });

        video.addEventListener('ended', () => {
            video.style.display = 'none';
            txtEstado.style.display = 'block';
        });

    </script>
</body>
</html>