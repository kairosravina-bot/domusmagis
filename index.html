<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI V9.5</title>
    
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.147.0/build/three.module.js",
        "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background: #000; color: white; }
        .pantalla { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; background: radial-gradient(circle, #1a0033, #000); }
        .oculto { display: none !important; }
        
        /* BOT√ìN DE INICIO GIGANTE */
        .btn-inicio-master {
            padding: 40px 60px;
            font-size: 28px;
            background: #ff00ff;
            color: white;
            border: 5px solid white;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 50px #ff00ff;
            text-transform: uppercase;
            animation: latido 1.5s infinite;
        }

        .btn-mystic { padding: 20px 30px; font-size: 16px; background: #bf00ff; border: 2px solid #fff; border-radius: 12px; color: #fff; font-weight: bold; cursor: pointer; margin: 5px; }

        @keyframes latido {
            0% { transform: scale(1); box-shadow: 0 0 20px #ff00ff; }
            50% { transform: scale(1.05); box-shadow: 0 0 60px #ff00ff; }
            100% { transform: scale(1); box-shadow: 0 0 20px #ff00ff; }
        }

        .version-label {
            margin-top: 20px;
            font-size: 24px;
            color: #0f0;
            font-weight: bold;
            text-shadow: 0 0 10px #0f0;
        }

        /* HUD JUEGO */
        #ui-juego { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; pointer-events: none; z-index: 500; }
        #visor-mistico { height: 33vh; background: rgba(0,0,0,0.8); border-bottom: 2px solid #bf00ff; pointer-events: auto; position: relative; display: flex; align-items: center; justify-content: center; }
        #zona-ar { height: 40vh; position: relative; display: flex; align-items: center; justify-content: center; }
        #panel-mando { height: 27vh; background: #111; border-top: 2px solid #fff; pointer-events: auto; display: flex; flex-direction: column; align-items: center; justify-content: space-around; }

        #guia-scanner { width: 220px; height: 220px; border: 4px solid red; border-radius: 20px; }
        #guia-scanner.detectado { border-color: #0f0; box-shadow: 0 0 40px #0f0; }
        
        .btn-gema { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #444; background: #222; color: #444; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; }
        .btn-gema.activo { border-color: #fff; color: #fff; box-shadow: 0 0 15px currentColor; }
        
        #container-ar { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="p-inicio" class="pantalla">
        <button class="btn-inicio-master" onclick="sistemaNavegacion('p-inicio', 'p-setup')">
            ENTRAR AL DUELO
        </button>
        <div class="version-label">DOMUS MAGI V9.5</div>
    </div>

    <div id="p-setup" class="pantalla oculto">
        <h2>¬øCU√ÅNTOS MAGOS?</h2>
        <div id="setup-controles">
            <button class="btn-mystic" onclick="definirModo(2)">2 JUGADORES</button>
            <button class="btn-mystic" onclick="definirModo(4)">4 JUGADORES</button>
        </div>
        <div id="registro-mago" class="oculto">
            <input type="text" id="nombre-input" placeholder="TU NOMBRE" style="padding:15px; font-size:20px; text-align:center;">
            <div style="margin-top:20px; display: grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="registrar('TERRA','#ff0000','üõ°Ô∏è')" class="btn-mystic" style="background:red">üõ°Ô∏è TERRA</button>
                <button onclick="registrar('CAELUM','#00aaff','‚öîÔ∏è')" class="btn-mystic" style="background:blue">‚öîÔ∏è CAELUM</button>
                <button onclick="registrar('AQUA','#00ff88','üíß')" class="btn-mystic" style="background:green">üíß AQUA</button>
                <button onclick="registrar('DIMENSIO','#aa00ff','‚ú®')" class="btn-mystic" style="background:purple">‚ú® DIMENSIO</button>
            </div>
        </div>
    </div>

    <div id="p-resumen" class="pantalla oculto">
        <h2 style="color:gold">EQUIPOS LISTOS</h2>
        <div id="lista-magos" style="font-size:22px; margin-bottom:30px;"></div>
        <button id="btn-arranque-ar" class="btn-inicio-master" style="font-size:20px; padding:20px;">
            üîÆ DESPERTAR VISOR AR
        </button>
    </div>

    <div id="ui-juego" class="oculto">
        <div id="visor-mistico">
            <div id="txt-turno" style="position:absolute; top:10px; left:20px; font-size:20px; font-weight:bold;">TURNO</div>
            <div id="status-ar" style="background:white; color:black; padding:5px 15px; border-radius:20px; font-weight:bold;">BUSCANDO CARTA...</div>
        </div>
        <div id="zona-ar">
            <div id="guia-scanner"></div>
        </div>
        <div id="panel-mando">
            <div style="display:flex; gap:20px;">
                <div id="gema-I" class="btn-gema">I</div>
                <div id="gema-A" class="btn-gema">A</div>
                <div id="gema-T" class="btn-gema">T</div>
                <div id="gema-M" class="btn-gema">M</div>
            </div>
            <p id="instruccion">ENFOCA TU CARTA F√çSICA</p>
        </div>
    </div>

    <div id="container-ar"></div>

    <div id="modal-dados" class="modal oculto">
        <h2 style="color:gold">DADOS DEL DESTINO</h2>
        <div style="display:flex; gap:20px;">
            <div id="d1" style="width:80px; height:80px; background:white; color:black; font-size:40px; display:flex; align-items:center; justify-content:center; border-radius:10px;">?</div>
            <div id="d2" style="width:80px; height:80px; background:white; color:black; font-size:40px; display:flex; align-items:center; justify-content:center; border-radius:10px;">?</div>
        </div>
    </div>

    <script>
        // L√ìGICA DE INTERFAZ (FUERA DEL M√ìDULO PARA QUE NO FALLE)
        let magos = [];
        let maxJugadores = 0;

        function sistemaNavegacion(ocultar, mostrar) {
            document.getElementById(ocultar).classList.add('oculto');
            document.getElementById(mostrar).classList.remove('oculto');
        }

        function definirModo(n) {
            maxJugadores = n;
            document.getElementById('setup-controles').classList.add('oculto');
            document.getElementById('registro-mago').classList.remove('oculto');
        }

        function registrar(casa, color, escudo) {
            let nombre = document.getElementById('nombre-input').value || "Mago " + (magos.length + 1);
            magos.push({nombre, casa, color, escudo});
            document.getElementById('nombre-input').value = "";
            
            if(magos.length === maxJugadores) {
                sistemaNavegacion('p-setup', 'p-resumen');
                let lista = document.getElementById('lista-magos');
                magos.forEach(m => {
                    lista.innerHTML += `<div style="color:${m.color}">${m.escudo} ${m.nombre} (${m.casa})</div>`;
                });
            } else {
                alert("¬°Mago registrado! Siguiente jugador...");
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        let tIndex = 0;

        document.getElementById('btn-arranque-ar').onclick = async () => {
            const btn = document.getElementById('btn-arranque-ar');
            btn.innerText = "CARGANDO C√ÅMARA...";
            
            try {
                const mindarThree = new MindARThree({
                    container: document.querySelector("#container-ar"),
                    imageTargetSrc: "https://kairosravina-bot.github.io/domusmagis/targets1.mind",
                    maxTrack: 1, uiLoading: "no", uiScanning: "no", uiError: "no"
                });

                const {renderer, scene, camera} = mindarThree;

                for(let i=0; i<5; i++) {
                    const anchor = mindarThree.addAnchor(i);
                    anchor.onTargetFound = () => {
                        document.getElementById('guia-scanner').classList.add('detectado');
                        document.getElementById('status-ar').innerText = "CARTA DETECTADA";
                        activarGemas(true);
                    };
                    anchor.onTargetLost = () => {
                        document.getElementById('guia-scanner').classList.remove('detectado');
                        document.getElementById('status-ar').innerText = "BUSCANDO CARTA...";
                        activarGemas(false);
                    };
                }

                await mindarThree.start();
                sistemaNavegacion('p-resumen', 'ui-juego');
                document.getElementById('container-ar').style.background = "transparent";
                actualizarHUD();

                renderer.setAnimationLoop(() => renderer.render(scene, camera));

            } catch (e) {
                alert("Error cr√≠tico: No se pudo acceder a la c√°mara.");
                btn.innerText = "REINTENTAR";
            }
        };

        function actualizarHUD() {
            const m = magos[tIndex];
            const div = document.getElementById('txt-turno');
            div.innerText = `${m.escudo} TURNO: ${m.nombre}`;
            div.style.color = m.color;
        }

        function activarGemas(estado) {
            ["I","A","T","M"].forEach(g => {
                const el = document.getElementById("gema-"+g);
                if(estado) {
                    el.classList.add('activo');
                    el.style.borderColor = magos[tIndex].color;
                    el.style.color = magos[tIndex].color;
                    el.onclick = () => {
                        if(confirm(`¬øConfirmas ${g}?`)) sigTurno();
                    };
                } else {
                    el.classList.remove('activo');
                    el.style.borderColor = "#444";
                    el.onclick = null;
                }
            });
        }

        function sigTurno() {
            if(tIndex < magos.length - 1) {
                tIndex++;
                alert("Pasa el celular al siguiente mago");
                actualizarHUD();
                activarGemas(false);
            } else {
                tirarDados();
            }
        }

        function tirarDados() {
            document.getElementById('modal-dados').classList.remove('oculto');
            let c = 0;
            let iv = setInterval(() => {
                let v1 = Math.floor(Math.random()*6)+1;
                let v2 = Math.floor(Math.random()*6)+1;
                document.getElementById('d1').innerText = v1;
                document.getElementById('d2').innerText = v2;
                if(c++ > 20) {
                    clearInterval(iv);
                    alert("¬°COMBATE TERMINADO! PODER: " + (v1+v2));
                    location.reload();
                }
            }, 100);
        }
    </script>
</body>
</html>