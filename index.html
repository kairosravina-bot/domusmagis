<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI FINAL</title>
    
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: monospace; background: black; }

        /* INTERFAZ (HUD) */
        #hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* BOTÓN DE INICIO */
        #start-btn {
            pointer-events: auto;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px 40px; background: #609; color: white; border: 2px solid gold;
            font-size: 20px; font-weight: bold; cursor: pointer; z-index: 1000;
        }

        /* PANELES */
        .panel { background: rgba(0,0,0,0.8); padding: 10px; pointer-events: auto; }

        /* ARRIBA: HP Y VIDEO */
        #top-panel { border-bottom: 2px solid white; text-align: center; }
        
        #hp-display { color: white; display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
        .hp-val { font-weight: bold; color: yellow; }

        #video-container {
            width: 100%; height: 220px; background: #000; 
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #555; position: relative;
        }
        /* El video ocupará el espacio correctamente */
        video { width: 100%; height: 100%; object-fit: contain; z-index: 20; display: none; }
        #vid-text { color: gray; position: absolute; z-index: 10; }

        /* ABAJO: INFO Y BOTONES */
        #bottom-panel { border-top: 2px solid white; }

        #info-box { color: cyan; margin-bottom: 10px; text-align: center; }
        #text-action { font-size: 20px; font-weight: bold; color: gold; text-transform: uppercase; margin: 5px 0; }
        #text-value { font-size: 16px; color: white; }

        #buttons-row { display: flex; justify-content: space-around; }
        .game-btn {
            width: 60px; height: 60px; border-radius: 50%; border: 3px solid white;
            font-size: 24px; font-weight: bold; color: white; cursor: pointer;
            text-shadow: 2px 2px 0 black;
        }
        .game-btn:active { transform: scale(0.9); border-color: gold; }
        
    </style>
</head>
<body>

    <button id="start-btn">INICIAR SISTEMA</button>

    <div id="hud-layer" style="display:none;">
        
        <!-- PANEL SUPERIOR -->
        <div id="top-panel" class="panel">
            <div id="hp-display">
                <span>TU VIDA: <span id="hp-player" class="hp-val">100</span></span>
                <span>RIVAL: <span id="hp-enemy" class="hp-val">100</span></span>
            </div>
            <div id="video-container">
                <span id="vid-text">ESCANEA CARTA...</span>
                <video id="main-video" playsinline muted></video>
            </div>
        </div>

        <!-- PANEL INFERIOR -->
        <div id="bottom-panel" class="panel">
            <div id="info-box">
                <div id="text-status">ESPERANDO OBJETIVO</div>
                <div id="text-action">--</div>
                <div id="text-value">VALOR: 0</div>
            </div>

            <div id="buttons-row">
                <!-- BOTONES QUE DISPARAN EL VIDEO -->
                <button id="btn-I" class="game-btn" style="background:#b00;">I</button>
                <button id="btn-T" class="game-btn" style="background:#555;">T</button>
                <button id="btn-A" class="game-btn" style="background:#080;">A</button>
                <button id="btn-M" class="game-btn" style="background:#608;">M</button>
            </div>
        </div>
    </div>

    <!-- ESCENA MINDAR -->
    <a-scene mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
             color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity id="marker-generator"></a-entity>
    </a-scene>

    <script>
        // --- ESTADO DEL JUEGO ---
        let playerHP = 100;
        let enemyHP = 100;
        let isActionBlocked = false; // Para esperar los 2 segundos

        // Datos de la carta actual
        let activeCard = {
            found: false,
            house: "",      // DRACO
            type: "",       // I, T, A, M
            typeName: "",   // IMPETUS...
            val: 0          // 6
        };

        // --- TUS MARCADORES ---
        const markers = [
            "DRACO_SICA_1_I_6", 
            "DRACO_SICA_1_A_1", 
            "DRACO_SICA_1_T_2", 
            "DRACO_SICA_1_M_1"
        ];

        // --- ARRANQUE ---
        document.getElementById('start-btn').addEventListener('click', function() {
            this.style.display = 'none';
            document.getElementById('hud-layer').style.display = 'flex';
            
            const scene = document.querySelector('a-scene');
            scene.systems["mindar-image-system"].start();
            setupMarkers();
        });

        function setupMarkers() {
            const container = document.getElementById('marker-generator');
            
            markers.forEach((name, idx) => {
                const el = document.createElement('a-entity');
                el.setAttribute('mindar-image-target', 'targetIndex: ' + idx);
                
                // AL DETECTAR
                el.addEventListener('targetFound', () => {
                    handleDetection(name);
                });

                container.appendChild(el);
            });
        }

        // --- PROCESAR DETECCIÓN ---
        function handleDetection(nameStr) {
            if (isActionBlocked) return; // Si estamos en medio de un ataque, ignorar cambios

            const parts = nameStr.split('_');
            if(parts.length >= 5) {
                activeCard.found = true;
                activeCard.house = parts[0];
                activeCard.type = parts[3];
                activeCard.val = parseInt(parts[4]);

                // Traducción de nombres
                if(activeCard.type === 'I') activeCard.typeName = "IMPETUS";
                else if(activeCard.type === 'T') activeCard.typeName = "TUTELA";
                else if(activeCard.type === 'A') activeCard.typeName = "AUXILIUM";
                else if(activeCard.type === 'M') activeCard.typeName = "MYSTERIUM";
                
                // Actualizar interfaz visual
                document.getElementById('text-status').innerText = activeCard.house + " DETECTADO";
                document.getElementById('text-status').style.color = "#0f0";
                document.getElementById('text-action').innerText = activeCard.typeName;
                document.getElementById('text-value').innerText = "POTENCIA: " + activeCard.val;
            }
        }

        // --- LÓGICA DE BOTONES: DISPARAN VIDEO + DAÑO ---
        document.getElementById('btn-I').addEventListener('click', () => triggerAction('I'));
        document.getElementById('btn-T').addEventListener('click', () => triggerAction('T'));
        document.getElementById('btn-A').addEventListener('click', () => triggerAction('A'));
        document.getElementById('btn-M').addEventListener('click', () => triggerAction('M'));

        function triggerAction(btnType) {
            // 1. Validaciones
            if (!activeCard.found) {
                alert("Primero escanea una carta.");
                return;
            }
            if (isActionBlocked) return; // Evitar doble click rapido

            // 2. Comprobar si el botón coincide con la carta
            if (activeCard.type === btnType) {
                
                // BLOQUEAR SISTEMA TEMPORALMENTE
                isActionBlocked = true;

                // 3. DISPARAR VIDEO (Aquí es donde ocurre)
                playVideo(activeCard.house, btnType);

                // 4. APLICAR MATEMÁTICAS
                if(btnType === 'I') enemyHP -= activeCard.val;
                if(btnType === 'M') enemyHP -= (activeCard.val * 2);
                if(btnType === 'A') playerHP += (activeCard.val * 5);
                if(btnType === 'T') alert("Escudos arriba: " + activeCard.val);
                
                updateHP();

                // 5. ESPERAR 2 SEGUNDOS Y REINICIAR
                setTimeout(() => {
                    resetCycle();
                }, 2000);

            } else {
                alert("Botón incorrecto. La carta es " + activeCard.typeName);
            }
        }

        // --- REPRODUCTOR ---
        function playVideo(house, type) {
            const v = document.getElementById('main-video');
            const t = document.getElementById('vid-text');

            t.style.display = 'none';
            v.style.display = 'block';
            
            // Simulación visual (Fondo de color según tipo)
            // Cuando tengas tus videos: v.src = "videos/" + house + "_" + type + ".mp4"; v.play();
            if(type === 'I') v.style.background = '#900';
            else if(type === 'A') v.style.background = '#090';
            else if(type === 'M') v.style.background = '#609';
            else v.style.background = '#555';
            
            console.log("REPRODUCIENDO VIDEO DE: " + house + " TIPO: " + type);
        }

        // --- REINICIAR CICLO ---
        function resetCycle() {
            const v = document.getElementById('main-video');
            const t = document.getElementById('vid-text');

            // Ocultar video, mostrar texto
            v.style.display = 'none';
            v.style.background = 'black';
            t.style.display = 'block';
            t.innerText = "LISTO PARA SIGUIENTE TURNO";

            // Limpiar datos
            isActionBlocked = false;
            document.getElementById('text-status').innerText = "ESPERANDO CARTA...";
            document.getElementById('text-status').style.color = "cyan";
        }

        function updateHP() {
            if(enemyHP < 0) enemyHP = 0;
            if(playerHP > 100) playerHP = 100;
            document.getElementById('hp-player').innerText = playerHP;
            document.getElementById('hp-enemy').innerText = enemyHP;
        }

    </script>
</body>
</html>