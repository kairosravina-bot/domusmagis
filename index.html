<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI V9.0</title>
    
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.147.0/build/three.module.js",
        "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <style>
        /* ESTILOS BASE */
        body { margin: 0; overflow: hidden; font-family: 'Courier New', serif; background: #000; color: white; }
        
        .pantalla { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; background: radial-gradient(circle, #220022, #000); transition: opacity 0.5s; }
        .oculto { display: none !important; }
        .fondo-transparente { background: rgba(0,0,0,0.85); } /* Fondo para modales */

        /* BOTONES */
        .btn-mystic { padding: 20px 30px; font-size: 18px; background: #bf00ff; border: 2px solid #fff; border-radius: 10px; color: #fff; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px #bf00ff; margin: 10px; text-transform: uppercase; }
        .btn-rojo { background: #d32f2f; box-shadow: 0 0 20px #d32f2f; }
        .btn-verde { background: #388e3c; box-shadow: 0 0 20px #388e3c; }

        /* PANTALLA RESUMEN */
        #lista-equipos { width: 80%; background: #111; padding: 20px; border: 1px solid #bf00ff; border-radius: 10px; margin-bottom: 20px; max-height: 40vh; overflow-y: auto; }
        .item-jugador { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 10px 0; font-size: 18px; }

        /* HUD JUEGO (CORREGIDO VISIBILIDAD) */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: flex; flex-direction: column; pointer-events: none; }
        
        /* El visor ahora es transparente para ver la c√°mara */
        #visor-mistico { height: 35vh; background: rgba(0,0,0,0); border-bottom: 2px solid #bf00ff; pointer-events: auto; position: relative; display: flex; align-items: center; justify-content: center; }
        #zona-ar { height: 35vh; position: relative; pointer-events: none; } 
        #panel-mando { height: 30vh; background: #111; border-top: 2px solid #fff; pointer-events: auto; display: flex; flex-direction: column; align-items: center; justify-content: space-around; padding: 10px; }

        /* UI ELEMENTS */
        #video-player { width: 100%; height: 100%; object-fit: cover; display: none; position: absolute; z-index: 5; }
        #guia-scanner { width: 200px; height: 200px; border: 4px solid rgba(255,0,0,0.7); border-radius: 15px; transition: 0.3s; }
        #guia-scanner.detectado { border-color: #0f0; box-shadow: 0 0 50px #0f0; background: rgba(0,255,0,0.2); }
        
        .controles { display: flex; gap: 15px; }
        .btn-gema { width: 60px; height: 60px; border-radius: 50%; border: 3px solid #666; background: #222; color: #666; font-weight: bold; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-gema.activo { color: white; transform: scale(1.1); }
        
        #btn-combate { width: 90%; padding: 15px; background: #333; color: #777; border-radius: 30px; border: 1px solid #555; font-weight: bold; text-transform: uppercase; }
        #btn-combate.listo { background: gold; color: black; box-shadow: 0 0 40px gold; animation: pulso 1s infinite; }

        @keyframes pulso { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* MODALES (CONFIRMACION Y DADOS) */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        
        .dado-container { display: flex; gap: 20px; margin: 20px; }
        .dado { width: 80px; height: 80px; background: white; color: black; font-size: 40px; font-weight: bold; display: flex; align-items: center; justify-content: center; border-radius: 10px; border: 4px solid #bf00ff; }
        
        #info-ronda { position: absolute; top: 10px; right: 10px; font-size: 14px; color: gold; border: 1px solid gold; padding: 5px; }
        #info-turno { position: absolute; top: 10px; left: 10px; font-size: 18px; font-weight: bold; text-shadow: 2px 2px 0px black; }
    </style>
</head>
<body>

    <div id="splash" class="pantalla">
        <h1>DOMUS MAGI V9.0</h1>
        <button id="btn-inicio" class="btn-mystic">INICIAR SISTEMA</button>
    </div>

    <div id="setup" class="pantalla oculto">
        <h2>FORJA TU ALIANZA</h2>
        <div id="setup-botones">
            <button onclick="configModo(2)" class="btn-mystic">DUELO [ II ]</button>
            <button onclick="configModo(4)" class="btn-mystic">DUELO [ IIII ]</button>
        </div>
        <div id="form-jugador" class="oculto" style="text-align:center;">
            <input type="text" id="input-nombre" placeholder="NOMBRE DEL MAGO" style="padding:10px; font-size:18px; text-align:center;">
            <br><br>
            <div id="casa-selector">
                <button class="btn-mystic" style="background:#d32f2f" onclick="setCasa('TERRA', '#d32f2f')">üî¥</button>
                <button class="btn-mystic" style="background:#1976d2" onclick="setCasa('CAELUM', '#1976d2')">üîµ</button>
                <button class="btn-mystic" style="background:#388e3c" onclick="setCasa('AQUA', '#388e3c')">üü¢</button>
                <button class="btn-mystic" style="background:#7b1fa2" onclick="setCasa('DIMENSIO', '#7b1fa2')">üü£</button>
            </div>
        </div>
    </div>

    <div id="resumen-equipos" class="pantalla oculto">
        <h2 style="color:gold;">ORDEN DE BATALLA</h2>
        <div id="lista-equipos"></div>
        <button id="btn-arrancar-ar" class="btn-mystic btn-verde">üîÆ INICIAR VISOR AR üîÆ</button>
    </div>

    <div id="ui-layer" class="oculto">
        <div id="visor-mistico">
            <div id="info-turno">TURNO: ???</div>
            <div id="info-ronda">RONDA 1</div>
            <div id="msg-central" style="color:#0f0; font-weight:bold; background:rgba(0,0,0,0.6); padding:5px;">ENFOQUE CARTA</div>
            <video id="video-player" playsinline webkit-playsinline muted></video>
        </div>
        <div id="zona-ar"><div id="guia-scanner"></div></div>
        <div id="panel-mando">
            <div class="controles">
                <div class="btn-gema" id="btn-i" onclick="preSeleccion('I')">I</div>
                <div class="btn-gema" id="btn-a" onclick="preSeleccion('A')">A</div>
                <div class="btn-gema" id="btn-t" onclick="preSeleccion('T')">T</div>
                <div class="btn-gema" id="btn-m" onclick="preSeleccion('M')">M</div>
            </div>
            <button id="btn-combate" disabled>ESPERANDO A TODOS...</button>
        </div>
    </div>

    <div id="modal-confirmacion" class="modal-overlay oculto">
        <h2 id="txt-confirmacion">¬øELEGIR ATAQUE?</h2>
        <p>Verifica tu carta f√≠sica.</p>
        <div>
            <button class="btn-mystic btn-rojo" onclick="cerrarModal()">CANCELAR</button>
            <button class="btn-mystic btn-verde" onclick="confirmarJugada()">CONFIRMAR</button>
        </div>
    </div>

    <div id="modal-paso" class="modal-overlay oculto">
        <h2 style="color:cyan">‚è≥ CAMBIO DE MAGO ‚è≥</h2>
        <h3 id="txt-paso-nombre">ENTREGA EL CELULAR A: ???</h3>
        <button class="btn-mystic" onclick="iniciarSiguienteTurno()">ESTOY LISTO</button>
    </div>

    <div id="modal-dados" class="modal-overlay oculto">
        <h2 style="color:gold">üé≤ LA SUERTE DEL DESTINO üé≤</h2>
        <div class="dado-container">
            <div id="dado1" class="dado">1</div>
            <div id="dado2" class="dado">6</div>
        </div>
        <h3 id="resultado-dados">LANZANDO...</h3>
    </div>

    <div id="container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        // === ESTADO DEL JUEGO ===
        let jugadores = [];
        let numJugadores = 0;
        let turnoIndex = 0;
        let ronda = 1;
        let seleccionTemp = null;
        let cartaDetectada = null;

        const RUTA_BASE = "https://kairosravina-bot.github.io/domusmagis/";

        // === INICIO ===
        document.getElementById('btn-inicio').addEventListener('click', () => {
            cambiarPantalla('splash', 'setup');
        });

        window.configModo = (n) => {
            numJugadores = n;
            document.getElementById('setup-botones').classList.add('oculto');
            document.getElementById('form-jugador').classList.remove('oculto');
        };

        window.setCasa = (casa, color) => {
            const nombre = document.getElementById('input-nombre').value;
            if(!nombre) { alert("¬°Escribe un nombre!"); return; }
            
            jugadores.push({ nombre, casa, color, eleccion: null });
            document.getElementById('input-nombre').value = "";

            if(jugadores.length < numJugadores) {
                alert(`Mago ${jugadores.length} registrado. Siguiente...`);
            } else {
                mostrarResumen();
            }
        };

        function mostrarResumen() {
            cambiarPantalla('setup', 'resumen-equipos');
            const lista = document.getElementById('lista-equipos');
            lista.innerHTML = "";
            jugadores.forEach((j, i) => {
                lista.innerHTML += `
                    <div class="item-jugador" style="color:${j.color}">
                        <span>${i+1}. ${j.nombre}</span>
                        <span>[${j.casa}]</span>
                    </div>`;
            });
            document.getElementById('btn-arrancar-ar').onclick = iniciarAR;
        }

        // === LOGICA AR ===
        async function iniciarAR() {
            cambiarPantalla('resumen-equipos', 'ui-layer');
            actualizarHUD();

            const mindarThree = new MindARThree({
                container: document.querySelector("#container"),
                imageTargetSrc: RUTA_BASE + "targets1.mind",
                maxTrack: 1,
                uiLoading: "no", uiScanning: "no", uiError: "no"
            });

            const {renderer, scene, camera} = mindarThree;

            // Anclas 0-4
            for(let i=0; i<5; i++) {
                const anchor = mindarThree.addAnchor(i);
                // Plano invisible para detectar
                const plane = new THREE.Mesh(
                    new THREE.PlaneGeometry(1, 1),
                    new THREE.MeshBasicMaterial({transparent: true, opacity: 0})
                );
                anchor.group.add(plane);

                anchor.onTargetFound = () => {
                    cartaDetectada = i;
                    document.getElementById('guia-scanner').classList.add('detectado');
                    document.getElementById('msg-central').innerText = "CARTA DETECTADA - ELIGE ACCI√ìN";
                    activarGemas(true);
                };
                anchor.onTargetLost = () => {
                    cartaDetectada = null;
                    document.getElementById('guia-scanner').classList.remove('detectado');
                    document.getElementById('msg-central').innerText = "ENFOQUE CARTA";
                    activarGemas(false);
                };
            }

            await mindarThree.start();
            renderer.setAnimationLoop(() => renderer.render(scene, camera));
        }

        // === JUGABILIDAD ===
        window.preSeleccion = (tipo) => {
            if(!cartaDetectada && cartaDetectada !== 0) return; // Solo funciona si escanea
            seleccionTemp = tipo;
            document.getElementById('txt-confirmacion').innerText = `¬øELEGIR ${tipo}?`;
            document.getElementById('modal-confirmacion').classList.remove('oculto');
        };

        window.cerrarModal = () => {
            document.getElementById('modal-confirmacion').classList.add('oculto');
        };

        window.confirmarJugada = () => {
            cerrarModal();
            jugadores[turnoIndex].eleccion = seleccionTemp;
            
            // Si falta gente
            if(turnoIndex < numJugadores - 1) {
                turnoIndex++;
                document.getElementById('txt-paso-nombre').innerText = `ENTREGA EL CELULAR A: ${jugadores[turnoIndex].nombre}`;
                document.getElementById('modal-paso').classList.remove('oculto');
            } else {
                // Todos listos -> Dados
                lanzarDados();
            }
        };

        window.iniciarSiguienteTurno = () => {
            document.getElementById('modal-paso').classList.add('oculto');
            actualizarHUD();
            // Reset visual
            activarGemas(false);
        };

        function lanzarDados() {
            document.getElementById('modal-dados').classList.remove('oculto');
            const d1 = document.getElementById('dado1');
            const d2 = document.getElementById('dado2');
            const res = document.getElementById('resultado-dados');
            
            let count = 0;
            let intervalo = setInterval(() => {
                let v1 = Math.floor(Math.random()*6)+1;
                let v2 = Math.floor(Math.random()*6)+1;
                d1.innerText = v1;
                d2.innerText = v2;
                count++;
                if(count > 20) { // Parar animaci√≥n
                    clearInterval(intervalo);
                    let total = v1 + v2;
                    let efecto = (total > 7) ? "¬°BONUS DE PODER X2!" : "¬°ENERG√çA INESTABLE!";
                    res.innerText = `TOTAL: ${total}\n${efecto}`;
                    res.style.color = (total > 7) ? "#0f0" : "#f00";
                    
                    setTimeout(() => {
                        document.getElementById('modal-dados').classList.add('oculto');
                        ejecutarBatallaVideo();
                    }, 3000);
                }
            }, 100);
        }

        function ejecutarBatallaVideo() {
            const vid = document.getElementById('video-player');
            const btn = document.getElementById('btn-combate');
            
            btn.innerText = "‚öîÔ∏è EJECUTANDO BATALLA ‚öîÔ∏è";
            btn.classList.add('listo');
            
            vid.style.display = 'block';
            vid.src = RUTA_BASE + "ataque.mp4"; 
            vid.play();

            vid.onended = () => {
                vid.style.display = 'none';
                ronda++;
                turnoIndex = 0;
                document.getElementById('info-ronda').innerText = `RONDA ${ronda}`;
                btn.classList.remove('listo');
                btn.innerText = "ESPERANDO A TODOS...";
                actualizarHUD();
            };
        }

        // === UTILIDADES ===
        function actualizarHUD() {
            const j = jugadores[turnoIndex];
            document.getElementById('info-turno').innerText = `TURNO: ${j.nombre}`;
            document.getElementById('info-turno').style.color = j.color;
        }

        function activarGemas(estado) {
            const j = jugadores[turnoIndex];
            const color = j ? j.color : "#fff";
            document.querySelectorAll('.btn-gema').forEach(b => {
                if(estado) {
                    b.classList.add('activo');
                    b.style.borderColor = color;
                    b.style.color = color;
                    b.style.boxShadow = `0 0 15px ${color}`;
                } else {
                    b.classList.remove('activo');
                    b.style.borderColor = "#666";
                    b.style.color = "#666";
                    b.style.boxShadow = "none";
                }
            });
        }

        function cambiarPantalla(idOcultar, idMostrar) {
            document.getElementById(idOcultar).classList.add('oculto');
            document.getElementById(idMostrar).classList.remove('oculto');
        }
    </script>
</body>
</html>