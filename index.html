<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: REVELATIONS V8.0</title>
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Cinzel', serif; background: #000; color: white; }
        /* Pantallas de Interfaz */
        .pantalla { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; background: radial-gradient(circle, #1a001a, #000); transition: 0.5s; }
        .oculto { display: none !important; }
        .btn-mystic { padding: 20px 40px; font-size: 20px; background: #bf00ff; border: none; border-radius: 10px; color: black; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px #bf00ff; margin: 10px; }
        
        /* Layout 33/40/27 */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: flex; flex-direction: column; pointer-events: none; }
        #visor-mistico { height: 33vh; background: rgba(0,0,0,0.8); border-bottom: 2px solid #bf00ff; pointer-events: auto; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #zona-ar { height: 40vh; position: relative; display: flex; align-items: center; justify-content: center; }
        #panel-mando { height: 27vh; background: #111; border-top: 2px solid #fff; pointer-events: auto; display: flex; flex-direction: column; align-items: center; justify-content: space-around; }
        
        /* Elementos del Juego */
        #video-player { width: 100%; height: 100%; object-fit: cover; }
        #guia-scanner { width: 200px; height: 200px; border: 3px solid red; border-radius: 15px; }
        #guia-scanner.detectado { border-color: #0f0; box-shadow: 0 0 30px #0f0; }
        .controles { display: flex; gap: 10px; }
        .btn-gema { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #555; background: #222; color: #555; font-weight: bold; font-size: 20px; display: flex; align-items: center; justify-content: center; opacity: 0.5; }
        .btn-gema.activo { opacity: 1; color: white; border-color: white; transform: scale(1.1); box-shadow: 0 0 15px currentColor; }
        #btn-combate { width: 80%; padding: 15px; background: #444; color: #888; border-radius: 30px; border: none; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; }
        #btn-combate.listo { background: gold; color: black; box-shadow: 0 0 25px gold; cursor: pointer; }
        #info-turno { position: absolute; top: 10px; left: 10px; font-size: 14px; color: #0f0; }
    </style>
</head>
<body>

    <div id="splash" class="pantalla">
        <h1>DOMUS MAGI</h1>
        <button class="btn-mystic" onclick="mostrarSetup()">INICIAR SISTEMA</button>
    </div>

    <div id="setup" class="pantalla oculto">
        <h2>REGISTRO DE MAGOS</h2>
        <div id="setup-players">
            <button class="btn-mystic" onclick="configurarPartida(2)">DUELO [II]</button>
            <button class="btn-mystic" onclick="configurarPartida(4)">DUELO [IIII]</button>
        </div>
        <div id="player-form" class="oculto">
            <input type="text" id="p-name" placeholder="NOMBRE DEL MAGO" style="padding:10px; width:200px; margin-bottom:10px;">
            <div id="casa-selector">
                <button onclick="regPlayer('TERRA','#900')">ðŸ”´</button>
                <button onclick="regPlayer('CAELUM','#090')">ðŸ”µ</button>
                <button onclick="regPlayer('AQUA','#009')">ðŸŸ¢</button>
                <button onclick="regPlayer('DIMENSIO','#609')">ðŸŸ£</button>
            </div>
            <p id="reg-status"></p>
        </div>
    </div>

    <div id="ui-layer" class="oculto">
        <div id="visor-mistico">
            <div id="info-turno">ESPERANDO ESCANEO...</div>
            <video id="video-player" playsinline></video>
            <div id="msg-central" style="position:absolute; text-align:center;">ENFOQUE CARTA</div>
        </div>
        <div id="zona-ar"><div id="guia-scanner"></div></div>
        <div id="panel-mando">
            <div class="controles">
                <div id="btn-i" class="btn-gema">I</div>
                <div id="btn-a" class="btn-gema">A</div>
                <div id="btn-t" class="btn-gema">T</div>
                <div id="btn-m" class="btn-gema">M</div>
            </div>
            <button id="btn-combate" disabled>CONSENSO REQUERIDO</button>
        </div>
    </div>

    <div id="container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        let jugadores = [];
        let turnoActual = 0;
        let numJugadores = 0;
        let cartaDetectada = null;
        const RUTA = "https://kairosravina-bot.github.io/domusmagis/";

        window.mostrarSetup = () => {
            document.getElementById('splash').classList.add('oculto');
            document.getElementById('setup').classList.remove('oculto');
        };

        window.configurarPartida = (n) => {
            numJugadores = n;
            document.getElementById('setup-players').classList.add('oculto');
            document.getElementById('player-form').classList.remove('oculto');
        };

        window.regPlayer = (casa, color) => {
            let name = document.getElementById('p-name').value || "Mago " + (jugadores.length + 1);
            jugadores.push({ nombre: name, casa: casa, color: color, accion: null });
            document.getElementById('p-name').value = "";
            if(jugadores.length < numJugadores) {
                document.getElementById('reg-status').innerText = `Registrado ${name}. Siguiente...`;
            } else {
                iniciarDuelo();
            }
        };

        async function iniciarDuelo() {
            document.getElementById('setup').classList.add('oculto');
            document.getElementById('ui-layer').classList.remove('oculto');
            actualizarHUD();

            const mindarThree = new MindARThree({
                container: document.querySelector("#container"),
                imageTargetSrc: RUTA + "targets1.mind",
                maxTrack: 1
            });

            const {renderer, scene, camera} = mindarThree;
            for(let i=0; i<5; i++) {
                const anchor = mindarThree.addAnchor(i);
                anchor.onTargetFound = () => {
                    cartaDetectada = i;
                    document.getElementById('guia-scanner').classList.add('detectado');
                    document.getElementById('msg-central').innerText = (i === 4) ? "BÃšHO DETECTADO" : "CARTA DETECTADA";
                    activarBotones(i);
                };
                anchor.onTargetLost = () => {
                    cartaDetectada = null;
                    document.getElementById('guia-scanner').classList.remove('detectado');
                    desactivarBotones();
                };
            }

            await mindarThree.start();
            renderer.setAnimationLoop(() => renderer.render(scene, camera));
        }

        function actualizarHUD() {
            const p = jugadores[turnoActual];
            document.getElementById('info-turno').innerText = `TURNO: ${p.nombre} (${p.casa})`;
            document.getElementById('info-turno').style.color = p.color;
        }

        function activarBotones(id) {
            const btns = ['btn-i', 'btn-a', 'btn-t', 'btn-m'];
            btns.forEach(b => {
                const el = document.getElementById(b);
                el.classList.add('activo');
                el.style.color = jugadores[turnoActual].color;
                el.onclick = () => registrarAccion(b);
            });
        }

        function desactivarBotones() {
            const btns = ['btn-i', 'btn-a', 'btn-t', 'btn-m'];
            btns.forEach(b => {
                const el = document.getElementById(b);
                el.classList.remove('activo');
                el.onclick = null;
            });
        }

        function registrarAccion(tipo) {
            jugadores[turnoActual].accion = tipo;
            if(turnoActual < numJugadores - 1) {
                turnoActual++;
                alert("Pasa el celular a " + jugadores[turnoActual].nombre);
                actualizarHUD();
            } else {
                document.getElementById('btn-combate').classList.add('listo');
                document.getElementById('btn-combate').innerText = "Â¡CONSENSO LOGRADO! COMBATIR";
                document.getElementById('btn-combate').disabled = false;
                document.getElementById('btn-combate').onclick = ejecutarCombate;
            }
        }

        function ejecutarCombate() {
            const v = document.getElementById('video-player');
            v.src = RUTA + "ataque.mp4"; // Ejemplo, se puede ramificar
            v.play();
            document.getElementById('msg-central').innerText = "RESOLVIENDO DUELO...";
            // Reinicio tras video
            v.onended = () => {
                turnoActual = 0;
                jugadores.forEach(j => j.accion = null);
                document.getElementById('btn-combate').classList.remove('listo');
                document.getElementById('btn-combate').disabled = true;
                actualizarHUD();
            };
        }
    </script>
</body>
</html>