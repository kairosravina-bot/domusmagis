<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOMUS MAGI - BASE MAESTRA</title>
    <!-- 1. MAPEO DE LIBRERÍAS (Estable) -->
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>
    <script type="module">
      import * as THREE from 'three';
      import { MindARThree } from 'mindar-image-three';

      let mindarThree = null;

      const init = async () => {
        const container = document.querySelector("#container");
        const status = document.querySelector("#status");

        try {
          // Inicializar motor con tu archivo de 2.7MB
          mindarThree = new MindARThree({
            container: container,
            imageTargetSrc: "./targets1.mind", 
            filterMinCF: 0.0001, 
            filterBeta: 0.001
          });

          const {renderer, scene, camera} = mindarThree;

          // CONFIGURACIÓN DE LAS 4 CASAS (0-3)
          const colors = [0x00ffff, 0x5fd4ff, 0xff9900, 0xff5500]; 
          const names = ["DRACO", "AQUILA", "LEO", "APER"];

          for (let i = 0; i < 4; i++) {
            const anchor = mindarThree.addAnchor(i);
            
            // Plano de color semi-transparente sobre la carta
            const geometry = new THREE.PlaneGeometry(1, 1);
            const material = new THREE.MeshBasicMaterial({color: colors[i], transparent: true, opacity: 0.5});
            const plane = new THREE.Mesh(geometry, material);
            anchor.group.add(plane);

            anchor.onTargetFound = () => {
              status.innerHTML = `<span style="color: #0f0">DETECTADO: ${names[i]}</span>`;
            };

            anchor.onTargetLost = () => {
              status.innerHTML = "BUSCANDO CARTA...";
            };
          }

          await mindarThree.start();
          status.innerHTML = "CÁMARA ACTIVA - BUSCANDO...";

          renderer.setAnimationLoop(() => {
            renderer.render(scene, camera);
          });

        } catch (err) {
          status.innerHTML = `<span style="color: red">ERROR: ${err.message}</span>`;
        }
      }

      // Manejo del botón de inicio (Obligatorio para cámara)
      document.querySelector("#startButton").addEventListener("click", () => {
        document.querySelector("#ui-inicio").style.display = "none";
        init();
      });
    </script>
    <style>
      body { margin: 0; background: #000; font-family: monospace; overflow: hidden; }
      #container { width: 100vw; height: 100vh; }
      
      /* Interfaz de bienvenida */
      #ui-inicio {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center;
      }
      #startButton {
        padding: 20px 40px; font-size: 20px; background: #0f0; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;
      }

      /* Barra de estado de detección */
      #status {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.8); color: white; padding: 15px;
        border: 1px solid white; z-index: 50; text-align: center; min-width: 250px;
      }
    </style>
  </head>
  <body>
    <div id="status">SISTEMA APAGADO</div>
    <div id="ui-inicio">
      <h2 style="color: white">DOMUS MAGI</h2>
      <button id="startButton">ACTIVAR ESCÁNER</button>
    </div>
    <div id="container"></div>
  </body>
</html>