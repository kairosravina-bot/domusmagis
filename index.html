<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI - TEST DETECCI√ìN</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; width: 100vw; height: 100vh; overflow: hidden; background: #000; }
        #container-ar { width: 100%; height: 100%; }
        
        /* MARCO DE ESCANEO GRANDE */
        #marco-scanner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            border: 5px solid #ff0000;
            border-radius: 20px;
            z-index: 100;
            box-shadow: 0 0 50px #ff0000, inset 0 0 50px rgba(255,0,0,0.2);
            background: rgba(0,0,0,0.1);
        }
        
        #marco-scanner.detectado {
            border-color: #00ff00;
            box-shadow: 0 0 100px #00ff00, inset 0 0 50px rgba(0,255,0,0.3);
        }
        
        /* PANEL DE INFORMACI√ìN */
        #panel-info {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #ffff00;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            box-shadow: 0 0 30px #ffff00;
        }
        
        #titulo-info {
            font-size: 24px;
            font-weight: bold;
            color: #ffff00;
            text-align: center;
            margin-bottom: 15px;
            font-family: monospace;
        }
        
        #target-display {
            font-size: 60px;
            font-weight: bold;
            text-align: center;
            font-family: monospace;
            color: #00ff00;
            margin: 20px 0;
            text-shadow: 0 0 20px #00ff00;
            min-height: 80px;
        }
        
        #status-display {
            font-size: 18px;
            color: #aaaaaa;
            text-align: center;
            font-family: monospace;
            margin: 10px 0;
        }
        
        #lista-detectados {
            background: rgba(0,0,0,0.8);
            border: 1px solid #555;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 12px;
            color: #0f0;
            font-family: monospace;
        }
        
        .item-detectado {
            padding: 5px;
            border-bottom: 1px dashed #555;
        }
        
        /* INDICADORES */
        .barra-estado {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #00aaff;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            color: #00aaff;
            text-align: center;
            font-family: monospace;
        }
    </style>
    
    <script type="importmap">
    { "imports": { 
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js", 
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/", 
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js" 
    } }
    </script>
</head>
<body>
    <div id="container-ar"></div>
    
    <!-- MARCO DE SCANNER GRANDE -->
    <div id="marco-scanner"></div>
    
    <!-- PANEL DE INFORMACI√ìN -->
    <div id="panel-info">
        <div id="titulo-info">üîÆ DETECTOR DE CARTAS</div>
        <div id="target-display">---</div>
        <div id="status-display">Apunta la c√°mara a una carta</div>
        <div id="lista-detectados"></div>
    </div>
    
    <!-- BARRA DE ESTADO -->
    <div class="barra-estado">
        <span id="barra-texto">Inicializando...</span>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        const RUTA_BASE = "https://kairosravina-bot.github.io/domusmagis/";
        const resultDiv = document.getElementById('target-display');
        const statusDiv = document.getElementById('status-display');
        const marcoScanner = document.getElementById('marco-scanner');
        const listaDiv = document.getElementById('lista-detectados');
        const barraTexto = document.getElementById('barra-texto');
        
        let targetActual = null;
        let historialDetecciones = [];
        let mindarThree = null;

        // Mapeo de targets a c√≥digos (basado en biblioteca.js)
        const codigosPorTarget = [
            "001-TI-BE-ID1",    // 0
            "002-TI-BE-ID3",    // 1
            "003-TI-BE-ID5",    // 2
            "004-TI-BE-ID7",    // 3
            "005-TI-BE-ID9",    // 4
            "006-TI-HU-ID2",    // 5
            "007-TI-HU-ID4",    // 6
            "008-TI-HU-ID6",    // 7
            "009-TI-HU-ID8",    // 8
            "010-TI-HU-ID10",   // 9
            "021-CI-BE-ID1",    // 10
            "022-CI-BE-ID3",    // 11
            "023-CI-BE-ID5",    // 12
            "024-CI-BE-ID7",    // 13
            "025-CI-BE-ID9",    // 14
            "026-CI-HU-ID2",    // 15
            "027-CI-HU-ID4",    // 16
            "028-CI-HU-ID6",    // 17
            "029-CI-HU-ID8",    // 18
            "030-CI-HU-ID10",   // 19
            "041-AG-BE-ID1",    // 20
            "042-AG-BE-ID3",    // 21
            "043-AG-BE-ID5",    // 22
            "044-AG-BE-ID7",    // 23
            "045-AG-BE-ID9",    // 24
            "046-AG-HU-ID2",    // 25
            "047-AG-HU-ID4",    // 26
            "048-AG-HU-ID6",    // 27
            "049-AG-HU-ID8",    // 28
            "050-AG-HU-ID10",   // 29
            "061-MA-BE-ID1",    // 30
            "062-MA-BE-ID3",    // 31
            "063-MA-BE-ID5",    // 32
            "064-MA-BE-ID7",    // 33
            "065-MA-BE-ID9",    // 34
            "066-MA-HU-ID2",    // 35
            "067-MA-HU-ID4",    // 36
            "068-MA-HU-ID6",    // 37
            "069-MA-HU-ID8",    // 38
            "070-MA-HU-ID10",   // 39
            "081-AR-ID1",       // 40
            "082-AR-ID3",       // 41
            "083-AR-ID5",       // 42
            "084-AR-ID7",       // 43
            "085-AR-ID9",       // 44
            "086-AR-ID11",      // 45
            "087-AR-ID13",      // 46
            "088-AR-ID15",      // 47
            "089-AR-ID17",      // 48
            "090-PO-ID2",       // 49
            "091-PO-ID4",       // 50
            "092-PO-ID6",       // 51
            "093-PO-ID8",       // 52
            "094-PO-ID10",      // 53
            "095-PO-ID12",      // 54
            "096-PO-ID14",      // 55
            "097-PO-ID16",      // 56
            "098-PO-ID18"       // 57
        ];

        function actualizarLista() {
            listaDiv.innerHTML = "<strong>DETECTADAS:</strong><br>";
            historialDetecciones.slice(-10).reverse().forEach((item, idx) => {
                listaDiv.innerHTML += `<div class="item-detectado">${item.codigo} [Target ${item.target}]</div>`;
            });
        }

        async function iniciar() {
            console.log("üîÆ Iniciando sistema de detecci√≥n...");
            barraTexto.textContent = "üì° Inicializando c√°mara...";

            try {
                mindarThree = new MindARThree({
                    container: document.getElementById('container-ar'),
                    imageTargetSrc: RUTA_BASE + 'targets1.mind',
                    maxTrack: 1,
                    uiLoading: "no",
                    uiScanning: "no",
                    uiError: "no"
                });

                const { renderer, scene, camera } = mindarThree;

                console.log("üìå Creando 58 anchors...");
                
                for (let i = 0; i < 58; i++) {
                    const anchor = mindarThree.addAnchor(i);

                    const geometry = new THREE.PlaneGeometry(1, 1);
                    const material = new THREE.MeshBasicMaterial({ transparent: true, opacity: 0 });
                    const plane = new THREE.Mesh(geometry, material);
                    anchor.group.add(plane);

                    anchor.onTargetFound = () => {
                        const codigo = codigosPorTarget[i] || `UNKNOWN-${i}`;
                        console.log(`‚úÖ DETECTADO: ${codigo} (Target ${i})`);
                        
                        targetActual = i;
                        resultDiv.textContent = codigo;
                        resultDiv.style.color = '#00ff00';
                        
                        statusDiv.innerHTML = `<strong style="color:#00ff00;">‚úÖ DETECTADO</strong><br>Target: ${i}`;
                        marcoScanner.classList.add('detectado');
                        barraTexto.textContent = `‚úÖ Detectado: ${codigo}`;
                        
                        // Agregar al historial
                        historialDetecciones.push({ target: i, codigo: codigo, timestamp: new Date().toLocaleTimeString() });
                        actualizarLista();
                    };

                    anchor.onTargetLost = () => {
                        if (targetActual === i) {
                            console.log(`‚ùå PERDIDO: Target ${i}`);
                            targetActual = null;
                            resultDiv.textContent = '---';
                            resultDiv.style.color = '#ffff00';
                            statusDiv.innerHTML = `<strong style="color:#ff0000;">‚ùå PERDIDO</strong><br>Apunta la c√°mara a una carta`;
                            marcoScanner.classList.remove('detectado');
                            barraTexto.textContent = '‚è≥ Esperando detecci√≥n...';
                        }
                    };
                }

                console.log("‚úÖ Sistema listo");
                barraTexto.textContent = '‚úÖ LISTO - Apunta una carta al marco';
                statusDiv.textContent = 'Listo para detectar...';

                await mindarThree.start();
                console.log("‚úÖ AR INICIADO CORRECTAMENTE");

                renderer.setAnimationLoop(() => {
                    renderer.render(scene, camera);
                });

            } catch (error) {
                console.error("‚ùå Error:", error);
                resultDiv.textContent = 'ERROR';
                resultDiv.style.color = '#ff0000';
                statusDiv.innerHTML = `<strong style="color:#ff0000;">‚ùå ERROR</strong><br>${error.message}`;
                barraTexto.textContent = `‚ùå ERROR: ${error.message}`;
            }
        }

        window.addEventListener('load', iniciar);

    </script>
</body>
</html>
