<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI V15</title>
    
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', Courier, monospace; background: #000; color: white; }
        .pantalla { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; z-index: 1000; background: #000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .oculto { display: none !important; }
        
        .btn-master {
            padding: 30px 50px; font-size: 24px; background: #bf00ff; color: white;
            border: 4px solid #fff; border-radius: 15px; cursor: pointer;
            box-shadow: 0 0 30px #bf00ff; text-transform: uppercase; font-weight: bold;
            margin: 10px; min-width: 300px;
        }

        .btn-modo-juego {
            padding: 25px 40px; font-size: 20px; margin: 15px;
            border-radius: 15px; cursor: pointer; font-weight: bold;
            border: 3px solid #fff; transition: all 0.3s; min-width: 350px;
        }
        .btn-batalla-directa {
            background: linear-gradient(135deg, #ff0000, #ff6600);
            box-shadow: 0 0 25px #ff0000;
        }
        .btn-modo-juego:hover { transform: scale(1.05); }

        #intro-video {
            width: 90%; max-width: 800px; border-radius: 15px;
            box-shadow: 0 0 50px rgba(191,0,255,0.5); margin-bottom: 30px;
        }

        #ui-juego { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; pointer-events: none; z-index: 500; }
        #visor-top { 
            height: 40vh; background: rgba(0,0,0,0.9); border-bottom: 2px solid #bf00ff; 
            pointer-events: auto; position: relative; display: flex; align-items: center; 
            justify-content: center; overflow: hidden;
        }
        #zona-ar { height: 35vh; position: relative; background: transparent; }
        #panel-mando { 
            height: 25vh; background: #111; border-top: 2px solid #fff; 
            pointer-events: auto; display: flex; flex-direction: column; 
            align-items: center; justify-content: space-around; padding: 10px;
            overflow-y: auto;
        }

        #guia-scanner { width: 220px; height: 220px; border: 4px solid red; border-radius: 20px; margin: auto; position: absolute; top:0; bottom:0; left:0; right:0; transition: 0.3s; }
        #guia-scanner.verde { border-color: #0f0; box-shadow: 0 0 50px #0f0; }

        .btn-gema {
            width: 70px; height: 70px; border-radius: 50%; border: 3px solid #555;
            background: #222; color: #555; display: flex; align-items: center;
            justify-content: center; font-size: 24px; font-weight: bold;
            cursor: not-allowed; transition: all 0.3s; opacity: 0.4;
        }
        .btn-gema.activo {
            opacity: 1; cursor: pointer; border-color: white; color: white; transform: scale(1.1);
        }
        #btn-i.activo { box-shadow: 0 0 25px #f00; }
        #btn-a.activo { box-shadow: 0 0 25px #0f0; }
        #btn-t.activo { box-shadow: 0 0 25px #aaa; }
        #btn-m.activo { box-shadow: 0 0 25px #d0f; }

        #container-ar { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        #video-player { 
            width: 100%; height: 100%; object-fit: contain; 
            display: none; position: absolute; top: 0; left: 0; z-index: 10; 
        }
        #msg-visor {
            color: white; text-align: center; font-weight: bold; 
            font-size: 20px; z-index: 5; padding: 20px;
        }

        #txt-turno {
            position: absolute; top: 10px; left: 10px; 
            font-weight: bold; z-index: 20; font-size: 18px;
            background: rgba(0,0,0,0.7); padding: 10px; border-radius: 10px;
        }

        #cartas-jugadas {
            background: rgba(0,0,0,0.8); padding: 10px;
            border-radius: 10px; margin: 5px 0; max-height: 60px;
            overflow-y: auto; width: 90%;
        }
        .carta-chip {
            display: inline-block; background: #333; padding: 5px 10px;
            margin: 3px; border-radius: 8px; font-size: 12px;
            border: 2px solid #555;
        }

        .btn-accion {
            padding: 15px 25px; font-size: 16px; margin: 5px;
            border-radius: 10px; cursor: pointer; font-weight: bold;
            border: 2px solid #fff; transition: all 0.3s;
        }
        .btn-agregar { background: #0a0; color: white; box-shadow: 0 0 15px #0a0; }
        .btn-finalizar { background: #f90; color: white; box-shadow: 0 0 15px #f90; }
        
        #video-overlay {
            position: absolute; top: 20px; right: 20px; display: none;
            flex-direction: column; align-items: center; z-index: 500; pointer-events: none;
        }
        #overlay-img { width: 75px; height: auto; filter: drop-shadow(0 0 8px rgba(255,255,255,0.9)); margin-bottom: 5px; }
        #overlay-text {
            color: #fff; font-weight: 800; font-size: 22px; background: rgba(0,0,0,0.7);
            padding: 4px 10px; border-radius: 8px; border: 2px solid #aaa; text-align: center; min-width: 45px;
        }
    </style>
</head>
<body>

    <!-- PANTALLA INICIAL -->
    <div id="p-inicio" class="pantalla">
        <button class="btn-master" onclick="irMenuPrincipal()">‚ö° INICIAR SISTEMA ‚ö°</button>
        <h2 style="color:#0f0; margin-top:20px;">DOMUS MAGI V15</h2>
        <p style="color:#bf00ff; font-size:14px;">Core V7.1 + UI V15</p>
    </div>

    <!-- MEN√ö PRINCIPAL -->
    <div id="p-menu-principal" class="pantalla oculto">
        <video id="intro-video" playsinline webkit-playsinline muted></video>
        <h1 style="color:#bf00ff; text-shadow: 0 0 20px #bf00ff; margin: 20px 0;">‚öîÔ∏è DOMUS MAGI ‚öîÔ∏è</h1>
        <button class="btn-modo-juego btn-batalla-directa" onclick="seleccionarModo()">‚öîÔ∏è BATALLA DIRECTA</button>
    </div>

    <!-- SETUP JUGADORES -->
    <div id="p-setup" class="pantalla oculto">
        <h2 style="margin-top: 20px;">REGISTRO DE MAGOS</h2>
        <div id="setup-selector">
            <button class="btn-master" style="font-size:16px;" onclick="setModo(2)">DUELO 2 JUGADORES</button>
        </div>
        <div id="registro" class="oculto" style="text-align:center; width: 80%; max-width: 400px;">
            <input type="text" id="mago-nombre" placeholder="TU NOMBRE" style="padding:15px; font-size:20px; width:100%; margin-bottom: 15px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; width: 100%;">
                <button onclick="registrarMago('TERRA','#ff0000','üõ°Ô∏è')" class="btn-master" style="background:#800; font-size:13px; padding: 18px 8px; min-width: auto;">üõ°Ô∏è TERRA</button>
                <button onclick="registrarMago('CAELUM','#00aaff','‚öîÔ∏è')" class="btn-master" style="background:#005; font-size:13px; padding: 18px 8px; min-width: auto;">‚öîÔ∏è CAELUM</button>
            </div>
            <p id="reg-status" style="color:gold; margin-top:15px;"></p>
        </div>
    </div>

    <!-- UI BATALLA AR -->
    <div id="ui-juego" class="oculto">
        <div id="visor-top">
            <div id="txt-turno">MAGO: ---</div>
            <div id="msg-visor">INICIANDO...</div>
            <video id="video-player" playsinline webkit-playsinline></video>
            <div id="video-overlay">
                <img id="overlay-img" src="" alt="Escudo">
                <div id="overlay-text"></div>
            </div>
        </div>
        <div id="zona-ar"><div id="guia-scanner"></div></div>
        <div id="panel-mando">
            <div id="cartas-jugadas">
                <strong>Cartas jugadas:</strong>
                <div id="lista-cartas-chips"></div>
            </div>
            
            <div style="display:flex; gap:15px; margin: 10px 0;">
                <button id="btn-i" class="btn-gema">I</button>
                <button id="btn-a" class="btn-gema">A</button>
                <button id="btn-t" class="btn-gema">T</button>
                <button id="btn-m" class="btn-gema">M</button>
            </div>
            
            <p id="hint" style="margin: 5px 0; text-align: center; font-size: 14px;">ESCANEA TU CARTA</p>
            
            <div style="display:flex; gap:10px; flex-wrap: wrap; justify-content: center;">
                <button id="btn-agregar" class="btn-accion btn-agregar">‚ûï OTRA CARTA</button>
                <button id="btn-finalizar" class="btn-accion btn-finalizar">‚úÖ FIN TURNO</button>
            </div>
        </div>
    </div>

    <div id="container-ar"></div>

    <!-- LOGICA JUEGO UI (VANILLA JS) -->
    <script>
        let jugadores = [];
        let cant = 0;
        let videoMostrado = false;
        
        function navegar(oc, mo) {
            document.getElementById(oc).classList.add('oculto');
            document.getElementById(mo).classList.remove('oculto');
        }

        function irMenuPrincipal() {
            navegar('p-inicio', 'p-menu-principal');
            if(!videoMostrado) {
                const video = document.getElementById('intro-video');
                video.src = 'https://kairosravina-bot.github.io/domusmagis/presentacion.mp4';
                video.muted = false;
                video.play().catch(e => console.log('Autoplay bloqueado'));
                videoMostrado = true;
            }
        }

        function seleccionarModo() { navegar('p-menu-principal', 'p-setup'); }

        function setModo(n) {
            cant = n;
            document.getElementById('setup-selector').classList.add('oculto');
            document.getElementById('registro').classList.remove('oculto');
            document.getElementById('reg-status').innerText = `Mago 1 de ${n}`;
        }

        function registrarMago(casa, color, esc) {
            let n = document.getElementById('mago-nombre').value || "Mago " + (jugadores.length + 1);
            jugadores.push({nombre: n, casa, color, esc, cartas: []});
            document.getElementById('mago-nombre').value = "";
            
            if(jugadores.length === cant) {
                navegar('p-setup', 'ui-juego');
                window.iniciarARDesdeBoton(); // Llamada al m√≥dulo AR
                actualizarHUD();
            } else {
                document.getElementById('reg-status').innerText = `Mago ${jugadores.length + 1} de ${cant}`;
            }
        }
    </script>

    <!-- LOGICA AR (MODULE) -->
    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        const RUTA_BASE = "https://kairosravina-bot.github.io/domusmagis/";
        
        // ESTRUCTURA DE DATOS V7.1 (LA QUE FUNCIONA)
        const CARTAS = {
            0: {
                nombre: "DRAG√ìN", imgEscudo: "ESCUDO_DRAGON.png",
                botones: {
                    "btn-i": { texto: "I", valor: 7, video: "ataque.mp4", color: "#900" },
                    "btn-a": { texto: "A", valor: 2, video: "cura.mp4", color: "#090" },
                    "btn-t": { texto: "T", valor: 3, video: "defensa.mp4", color: "#555" },
                    "btn-m": { texto: "M", valor: 2, video: "magia.mp4", color: "#609" }
                }
            },
            1: {
                nombre: "√ÅGUILA", imgEscudo: "ESCUDO_AGUILA.png",
                botones: {
                    "btn-i": { texto: "I", valor: 5, video: "ataque.mp4", color: "#900" },
                    "btn-a": { texto: "A", valor: 4, video: "cura.mp4", color: "#090" },
                    "btn-t": { texto: "T", valor: 2, video: "defensa.mp4", color: "#555" },
                    "btn-m": { texto: "M", valor: 3, video: "magia.mp4", color: "#609" }
                }
            },
            2: {
                nombre: "LE√ìN", imgEscudo: "ESCUDO_LEON.png",
                botones: {
                    "btn-i": { texto: "I", valor: 8, video: "ataque.mp4", color: "#900" },
                    "btn-a": { texto: "A", valor: 1, video: "cura.mp4", color: "#090" },
                    "btn-t": { texto: "T", valor: 4, video: "defensa.mp4", color: "#555" },
                    "btn-m": { texto: "M", valor: 1, video: "magia.mp4", color: "#609" }
                }
            },
            3: {
                nombre: "JABAL√ç", imgEscudo: "ESCUDO_JABALI.png",
                botones: {
                    "btn-i": { texto: "I", valor: 6, video: "ataque.mp4", color: "#900" },
                    "btn-a": { texto: "A", valor: 3, video: "cura.mp4", color: "#090" },
                    "btn-t": { texto: "T", valor: 3, video: "defensa.mp4", color: "#555" },
                    "btn-m": { texto: "M", valor: 2, video: "magia.mp4", color: "#609" }
                }
            },
            4: {
                nombre: "B√öHO", imgEscudo: "ESCUDO_BUHO.png",
                botones: {
                    "btn-i": { texto: "M", valor: "MANDATUM", video: "owl_mandatum.mp4", color: "#4a148c" },
                    "btn-a": { texto: "P", valor: "PRAESAGIUM", video: "owl_praesagium.mp4", color: "#6a1b9a" },
                    "btn-t": { texto: "C", valor: "CONSILIUM", video: "owl_consilium.mp4", color: "#7b1fa2" },
                    "btn-m": { texto: "S", valor: "ARCANUM", video: "owl_arcanum.mp4", color: "#8e24aa" }
                }
            }
        };

        let tIdx = 0;
        let cartaActual = null;
        let reproduciendo = false;
        let mindarThree = null;

        const ui = {
            btnI: document.getElementById('btn-i'),
            btnA: document.getElementById('btn-a'),
            btnT: document.getElementById('btn-t'),
            btnM: document.getElementById('btn-m'),
            scanner: document.getElementById('guia-scanner'),
            msg: document.getElementById('msg-visor'),
            txtTurno: document.getElementById('txt-turno'),
            videoPlayer: document.getElementById('video-player'),
            overlay: document.getElementById('video-overlay'),
            ovImg: document.getElementById('overlay-img'),
            ovTxt: document.getElementById('overlay-text'),
            listaChips: document.getElementById('lista-cartas-chips'),
            btnAgregar: document.getElementById('btn-agregar'),
            btnFinalizar: document.getElementById('btn-finalizar')
        };

        window.actualizarHUD = function() {
            const j = jugadores[tIdx];
            ui.txtTurno.innerText = `${j.esc} ${j.nombre}`;
            ui.txtTurno.style.color = j.color;
            ui.msg.innerText = `${j.nombre}, escanea...`;
            
            ui.listaChips.innerHTML = '';
            j.cartas.forEach(c => {
                const chip = document.createElement('span');
                chip.className = 'carta-chip';
                chip.style.borderColor = j.color;
                chip.innerText = `${c.carta} [${c.lado}]`;
                ui.listaChips.appendChild(chip);
            });
        }

        function actualizarBotones(carta) {
            console.log("Detectado:", carta.nombre);
            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                const btn = document.getElementById(id);
                const conf = carta.botones[id];
                btn.innerText = conf.texto;
                btn.style.backgroundColor = conf.color;
                btn.classList.add('activo');
            });
        }

        function resetBotones() {
            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                const btn = document.getElementById(id);
                btn.innerText = id.split('-')[1].toUpperCase();
                btn.style.backgroundColor = '#222';
                btn.classList.remove('activo');
            });
        }

        window.iniciarARDesdeBoton = async function() {
            if(mindarThree) return;
            
            console.log("üöÄ Iniciando AR Core V7.1...");
            mindarThree = new MindARThree({
                container: document.getElementById('container-ar'),
                imageTargetSrc: RUTA_BASE + 'targets1.mind', // EL QUE FUNCIONA
                maxTrack: 1,
                filterMinCF: 0.0001, // RESTAURADO V7.1
                filterBeta: 0.001,   // RESTAURADO V7.1
                warmupTolerance: 5,
                missTolerance: 5,
                uiLoading: "no", uiScanning: "no", uiError: "no"
            });

            const { renderer, scene, camera } = mindarThree;

            for(let i = 0; i < 5; i++) {
                const anchor = mindarThree.addAnchor(i);
                
                const geometry = new THREE.PlaneGeometry(1, 1);
                const material = new THREE.MeshBasicMaterial({transparent: true, opacity: 0});
                const plane = new THREE.Mesh(geometry, material);
                anchor.group.add(plane);

                anchor.onTargetFound = () => {
                    cartaActual = CARTAS[i];
                    ui.scanner.classList.add('verde');
                    ui.msg.innerText = "¬°" + cartaActual.nombre + "!";
                    ui.msg.style.color = "#0f0";
                    actualizarBotones(cartaActual);
                };

                anchor.onTargetLost = () => {
                    if(cartaActual === CARTAS[i] && !reproduciendo) {
                        cartaActual = null;
                        ui.scanner.classList.remove('verde');
                        ui.msg.innerText = "Buscando...";
                        ui.msg.style.color = "#fff";
                        resetBotones();
                    }
                };
            }

            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                document.getElementById(id).onclick = () => {
                    if(!cartaActual || reproduciendo) return;
                    
                    const lado = id;
                    const config = cartaActual.botones[lado];
                    
                    // Registrar jugada
                    jugadores[tIdx].cartas.push({
                        carta: cartaActual.nombre,
                        lado: config.texto,
                        valor: config.valor
                    });
                    
                    reproducirVideo(config, cartaActual);
                };
            });

            await mindarThree.start();
            renderer.setAnimationLoop(() => {
                renderer.render(scene, camera);
            });
        };

        function reproducirVideo(config, carta) {
            reproduciendo = true;
            ui.videoPlayer.style.display = 'block';
            ui.videoPlayer.src = RUTA_BASE + config.video;
            
            // Overlay V7.1 style
            ui.ovImg.src = RUTA_BASE + carta.imgEscudo;
            ui.ovTxt.innerText = config.valor;
            ui.ovTxt.style.borderColor = config.color;
            ui.overlay.style.display = 'flex';
            
            ui.videoPlayer.play();
            
            ui.videoPlayer.onended = () => {
                reproduciendo = false;
                ui.videoPlayer.style.display = 'none';
                ui.overlay.style.display = 'none';
                actualizarHUD();
            };
        }

        ui.btnAgregar.onclick = () => {
            cartaActual = null;
            reproduciendo = false;
            ui.scanner.classList.remove('verde');
            resetBotones();
            ui.msg.innerText = "Siguiente carta...";
        };

        ui.btnFinalizar.onclick = () => {
            if(jugadores[tIdx].cartas.length === 0) return alert("Juega algo primero");
            tIdx = (tIdx + 1) % jugadores.length;
            
            // Reset visual
            cartaActual = null;
            reproduciendo = false;
            ui.scanner.classList.remove('verde');
            resetBotones();
            
            if(tIdx === 0) alert("Ronda finalizada (L√≥gica de batalla aqu√≠)");
            actualizarHUD();
        };
    </script>
</body>
</html>