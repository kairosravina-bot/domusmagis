<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI V9.1</title>
    
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.147.0/build/three.module.js",
        "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', serif; background: #000; color: white; }
        .pantalla { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; background: radial-gradient(circle, #220022, #000); }
        .oculto { display: none !important; }
        .btn-mystic { padding: 20px 30px; font-size: 18px; background: #bf00ff; border: 2px solid #fff; border-radius: 10px; color: #fff; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px #bf00ff; margin: 10px; text-transform: uppercase; }
        
        /* HUD 33/40/27 */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: flex; flex-direction: column; pointer-events: none; }
        #visor-mistico { height: 33vh; background: rgba(0,0,0,0.4); border-bottom: 2px solid #bf00ff; pointer-events: auto; position: relative; display: flex; align-items: center; justify-content: center; }
        #zona-ar { height: 40vh; position: relative; }
        #panel-mando { height: 27vh; background: #111; border-top: 2px solid #fff; pointer-events: auto; display: flex; flex-direction: column; align-items: center; justify-content: space-around; }

        #guia-scanner { width: 220px; height: 220px; border: 4px solid red; border-radius: 15px; }
        #guia-scanner.detectado { border-color: #0f0; box-shadow: 0 0 50px #0f0; }
        
        .btn-gema { width: 55px; height: 55px; border-radius: 50%; border: 3px solid #444; background: #222; color: #444; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .btn-gema.activo { border-color: #fff; color: #fff; box-shadow: 0 0 15px #fff; }
        
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .dado { width: 60px; height: 60px; background: white; color: black; display: flex; align-items: center; justify-content: center; font-size: 30px; border-radius: 8px; margin: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="pantalla-inicio" class="pantalla">
        <h1 style="letter-spacing: 5px;">DOMUS MAGI</h1>
        <p style="color: #bf00ff;">VERSI√ìN 9.1 STABLE</p>
        <button id="btn-comenzar" class="btn-mystic">‚ö° ENTRAR AL GRIMORIO ‚ö°</button>
    </div>

    <div id="pantalla-setup" class="pantalla oculto">
        <h2>MODO DE DUELO</h2>
        <div id="botones-modo">
            <button onclick="iniciarConfig(2)" class="btn-mystic">[ II ] MAGOS</button>
            <button onclick="iniciarConfig(4)" class="btn-mystic">[ IIII ] MAGOS</button>
        </div>
        <div id="form-mago" class="oculto">
            <input type="text" id="nombre-mago" placeholder="TU NOMBRE" style="padding:15px; font-size:18px; text-align:center;">
            <div style="margin-top:20px;">
                <button onclick="registrarMago('#ff0000', 'TERRA')" class="btn-mystic" style="background:red">üî¥</button>
                <button onclick="registrarMago('#0088ff', 'CAELUM')" class="btn-mystic" style="background:blue">üîµ</button>
                <button onclick="registrarMago('#00ff44', 'AQUA')" class="btn-mystic" style="background:green">üü¢</button>
                <button onclick="registrarMago('#aa00ff', 'DIMENSIO')" class="btn-mystic" style="background:purple">üü£</button>
            </div>
        </div>
    </div>

    <div id="pantalla-resumen" class="pantalla oculto">
        <h2 style="color:gold">EQUIPOS FORMADOS</h2>
        <div id="lista-magos" style="text-align:left; margin-bottom:30px;"></div>
        <button id="btn-activar-ar" class="btn-mystic" style="background: gold; color: black;">üîÆ ABRIR VISOR M√çSTICO</button>
    </div>

    <div id="ui-juego" class="oculto">
        <div id="ui-layer">
            <div id="visor-mistico">
                <div id="txt-turno" style="position:absolute; top:10px; left:10px; font-weight:bold;">TURNO</div>
                <div id="txt-ronda" style="position:absolute; top:10px; right:10px; color:gold;">RONDA 1</div>
                <div id="status-ar" style="background:rgba(0,0,0,0.7); padding:5px 15px; border-radius:20px;">BUSCANDO CARTA...</div>
            </div>
            <div id="zona-ar">
                <center style="margin-top:20vh;"><div id="guia-scanner"></div></center>
            </div>
            <div id="panel-mando">
                <div style="display:flex; gap:15px;">
                    <div id="gema-I" class="btn-gema">I</div>
                    <div id="gema-A" class="btn-gema">A</div>
                    <div id="gema-T" class="btn-gema">T</div>
                    <div id="gema-M" class="btn-gema">M</div>
                </div>
                <button id="btn-finalizar" class="btn-mystic" style="width:80%; opacity:0.5;" disabled>RECOLECTANDO PODER...</button>
            </div>
        </div>
    </div>

    <div id="modal-dados" class="modal oculto">
        <h2 style="color:gold">Lanzando Dados del Destino...</h2>
        <div style="display:flex;">
            <div id="d-1" class="dado">?</div>
            <div id="d-2" class="dado">?</div>
        </div>
        <h3 id="res-dado">Sincronizando...</h3>
    </div>

    <div id="container-ar"></div>

    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        let jugadores = [];
        let limit = 0;
        let index = 0;
        let scanActivo = false;

        // --- NAVEGACI√ìN ---
        document.getElementById('btn-comenzar').onclick = () => {
            document.getElementById('pantalla-inicio').classList.add('oculto');
            document.getElementById('pantalla-setup').classList.remove('oculto');
        };

        window.iniciarConfig = (n) => {
            limit = n;
            document.getElementById('botones-modo').classList.add('oculto');
            document.getElementById('form-mago').classList.remove('oculto');
        };

        window.registrarMago = (col, casa) => {
            const nom = document.getElementById('nombre-mago').value || "Mago " + (jugadores.length + 1);
            jugadores.push({ nombre: nom, color: col, casa: casa });
            document.getElementById('nombre-mago').value = "";
            
            if(jugadores.length === limit) {
                mostrarResumen();
            } else {
                alert("Mago registrado. ¬°Siguiente!");
            }
        };

        function mostrarResumen() {
            document.getElementById('pantalla-setup').classList.add('oculto');
            document.getElementById('pantalla-resumen').classList.remove('oculto');
            const lista = document.getElementById('lista-magos');
            jugadores.forEach(j => {
                lista.innerHTML += `<div style="color:${j.color}; font-size:20px;">‚óè ${j.nombre} [${j.casa}]</div>`;
            });
        }

        document.getElementById('btn-activar-ar').onclick = () => {
            document.getElementById('pantalla-resumen').classList.add('oculto');
            document.getElementById('ui-juego').classList.remove('oculto');
            initAR();
        };

        // --- AR Y L√ìGICA ---
        async function initAR() {
            actualizarInterfaz();
            const mindarThree = new MindARThree({
                container: document.querySelector("#container-ar"),
                imageTargetSrc: "https://kairosravina-bot.github.io/domusmagis/targets1.mind"
            });
            const {renderer, scene, camera} = mindarThree;

            for(let i=0; i<5; i++) {
                const anchor = mindarThree.addAnchor(i);
                anchor.onTargetFound = () => {
                    scanActivo = true;
                    document.getElementById('guia-scanner').classList.add('detectado');
                    document.getElementById('status-ar').innerText = "CARTA VINCULADA";
                    activarGemas(true);
                };
                anchor.onTargetLost = () => {
                    scanActivo = false;
                    document.getElementById('guia-scanner').classList.remove('detectado');
                    document.getElementById('status-ar').innerText = "BUSCANDO CARTA...";
                    activarGemas(false);
                };
            }
            await mindarThree.start();
            renderer.setAnimationLoop(() => renderer.render(scene, camera));
        }

        function actualizarInterfaz() {
            const j = jugadores[index];
            const txt = document.getElementById('txt-turno');
            txt.innerText = "MAGO: " + j.nombre;
            txt.style.color = j.color;
        }

        function activarGemas(bol) {
            const gemas = ["I","A","T","M"];
            gemas.forEach(g => {
                const el = document.getElementById("gema-"+g);
                if(bol) {
                    el.classList.add('activo');
                    el.style.backgroundColor = jugadores[index].color;
                    el.onclick = () => confirmarAccion(g);
                } else {
                    el.classList.remove('activo');
                    el.style.backgroundColor = "#222";
                    el.onclick = null;
                }
            });
        }

        function confirmarAccion(tipo) {
            if(!confirm(`¬øConfirmas usar ${tipo}?`)) return;
            
            if(index < jugadores.length - 1) {
                index++;
                alert("Pasa el celular al siguiente mago.");
                actualizarInterfaz();
                activarGemas(false);
            } else {
                lanzarDados();
            }
        }

        function lanzarDados() {
            document.getElementById('modal-dados').classList.remove('oculto');
            let c = 0;
            let iv = setInterval(() => {
                let v1 = Math.floor(Math.random()*6)+1;
                let v2 = Math.floor(Math.random()*6)+1;
                document.getElementById('d-1').innerText = v1;
                document.getElementById('d-2').innerText = v2;
                if(c++ > 15) {
                    clearInterval(iv);
                    document.getElementById('res-dado').innerText = "RESULTADO: " + (v1+v2);
                    setTimeout(() => {
                        document.getElementById('modal-dados').classList.add('oculto');
                        alert("¬°BATALLA FINAL INICIADA!");
                        location.reload(); // Reinicio para nueva ronda
                    }, 3000);
                }
            }, 100);
        }
    </script>
</body>
</html>