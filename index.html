<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DOMUS MAGI: REVELATIONS</title>

<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

<style>
body, html {
    margin: 0; padding: 0; width: 100%; height: 100%;
    background-color: #000;
    overflow: hidden; font-family: sans-serif;
}
#ui-layer {
    position: absolute; inset: 0;
    z-index: 999;
    display: flex; flex-direction: column;
    pointer-events: none;
}
#top-visor {
    height: 35%;
    background: #000;
    border-bottom: 2px solid #555;
    display: flex; align-items: center; justify-content: center;
    pointer-events: auto;
}
#video-player {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: none;
}
#msg-visor { color: white; text-align: center; }
#middle-cam {
    flex-grow: 1;
    display: flex; align-items: center; justify-content: center;
}
#guia-box {
    width: 250px; height: 350px;
    border: 4px solid red;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(255,0,0,0.5);
}
#guia-box.ok {
    border-color: #0f0;
    box-shadow: 0 0 50px #0f0;
}
#bottom-panel {
    background: #111;
    border-top: 2px solid #fff;
    pointer-events: auto;
    display: flex; flex-direction: column;
    gap: 10px;
    padding: 10px 10px 30px;
}
#btn-scan {
    background: #ffcc00;
    color: #000;
    border: none;
    padding: 15px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 8px;
}
#info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 5px;
}
.info-box {
    background: #222;
    border: 1px solid #444;
    text-align: center;
    padding: 5px;
}
.lbl { font-size: 10px; color: #aaa; }
.val { font-size: 12px; color: #fff; font-weight: bold; }
#powers-grid {
    display: flex;
    justify-content: center;
    gap: 15px;
}
.pwr-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #333;
    border: 2px solid #555;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.5;
    color: #777;
    font-size: 20px;
    font-weight: bold;
}
.pwr-btn.active {
    opacity: 1;
    color: #fff;
    border-color: #fff;
}
</style>
</head>

<body>

<div id="ui-layer">
    <div id="top-visor">
        <div id="msg-visor">
            SISTEMA APAGADO<br>
            <span style="font-size:10px;color:#f90">Dale al bot√≥n amarillo</span>
        </div>
        <video id="video-player" playsinline webkit-playsinline></video>
    </div>

    <div id="middle-cam">
        <div id="guia-box"></div>
    </div>

    <div id="bottom-panel">
        <button id="btn-scan">ACTIVAR C√ÅMARA</button>

        <div id="info-grid">
            <div class="info-box"><span class="lbl">CASA</span><span id="txt-casa" class="val">---</span></div>
            <div class="info-box"><span class="lbl">ARMA</span><span id="txt-arma" class="val">---</span></div>
            <div class="info-box"><span class="lbl">ACCI√ìN</span><span id="txt-accion" class="val">---</span></div>
        </div>

        <div id="powers-grid">
            <div class="pwr-btn" data-id="IMPETUS">I</div>
            <div class="pwr-btn" data-id="AUXILIUM">A</div>
            <div class="pwr-btn" data-id="TUTELA">T</div>
            <div class="pwr-btn" data-id="MYSTERIUM">M</div>
        </div>
    </div>
</div>

<!-- ESCENA ORIGINAL ‚Äì SOLO SE AGREGA embedded -->
<a-scene
    embedded
    mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiLoading: no; uiScanning: no;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="alpha: true">

    <a-camera look-controls="enabled: false"></a-camera>
    <a-entity id="target-carta" mindar-image-target="targetIndex: 0"></a-entity>
</a-scene>

<script>
/* === TUS DATOS ‚Äì INTACTOS === */
const DB = {
    casa: "DOMUS DRACO",
    arma: "SICA",
    movs: {
        IMPETUS: { v: 6, mp4: "ataque.mp4" },
        AUXILIUM: { v: 1, mp4: "cura.mp4" },
        TUTELA: { v: 2, mp4: "defensa.mp4" },
        MYSTERIUM: { v: 1, mp4: "magia.mp4" }
    }
};

const btnScan = document.getElementById("btn-scan");
const msgVisor = document.getElementById("msg-visor");
const guiaBox = document.getElementById("guia-box");
const video = document.getElementById("video-player");
const scene = document.querySelector("a-scene");
const target = document.getElementById("target-carta");
const buttons = document.querySelectorAll(".pwr-btn");

let arReady = false;
let started = false;

/* üî• FIX REAL 1: esperar a que MindAR est√© listo */
scene.addEventListener("arReady", () => {
    arReady = true;
});

/* BOT√ìN */
btnScan.addEventListener("click", async () => {
    if (started || !arReady) return;

    started = true;
    btnScan.disabled = true;
    msgVisor.innerText = "INICIANDO C√ÅMARA...";

    /* üî• FIX REAL 2: desbloqueo de audio m√≥vil */
    try {
        await video.play();
        video.pause();
    } catch(e){}

    await scene.systems["mindar-image-system"].start();
    msgVisor.innerText = "ESCANE√Å LA CARTA";
});

/* TARGET */
target.addEventListener("targetFound", () => {
    guiaBox.classList.add("ok");
    document.getElementById("txt-casa").innerText = DB.casa;
    document.getElementById("txt-arma").innerText = DB.arma;
    buttons.forEach(b => b.classList.add("active"));
});

target.addEventListener("targetLost", () => {
    guiaBox.classList.remove("ok");
    buttons.forEach(b => b.classList.remove("active"));
    video.pause();
    video.style.display = "none";
    msgVisor.style.display = "block";
});

/* VIDEOS */
buttons.forEach(btn => {
    btn.addEventListener("click", async () => {
        if (!btn.classList.contains("active")) return;

        const data = DB.movs[btn.dataset.id];
        document.getElementById("txt-accion").innerText = `${btn.dataset.id} [${data.v}]`;

        msgVisor.style.display = "none";
        video.style.display = "block";
        video.src = data.mp4;
        video.currentTime = 0;
        video.muted = false;
        video.volume = 1;

        try { await video.play(); } catch(e){}
    });
});
</script>

</body>
</html>
