<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>DOMUS MAGI - 4 Casas v2.0</title>
    
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Arial Black', Arial, sans-serif; 
            background: #000; 
        }

        /* VERSION INDICATOR */
        #version {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 255, 0, 0.8);
            color: #000;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 9999;
            letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        /* PANEL SUPERIOR - INFO CARTA */
        #info-panel {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 20px 40px;
            border-radius: 15px;
            border: 3px solid #fff;
            z-index: 100;
            display: none;
            min-width: 350px;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
        }

        #info-panel.visible {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-30px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        #nombre-casa {
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            letter-spacing: 3px;
            text-shadow: 0 0 15px currentColor;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 18px;
            color: #fff;
        }

        .stat-label {
            color: #888;
            text-transform: uppercase;
            font-size: 14px;
        }

        .stat-value {
            font-weight: bold;
            font-size: 20px;
        }

        /* BOTONES DE ACCI√ìN */
        #botones {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: none;
            gap: 15px;
        }

        #botones.visible {
            display: flex;
        }

        .btn-accion {
            width: 70px;
            height: 70px;
            border-radius: 15px;
            border: none;
            font-size: 28px;
            font-weight: bold;
            color: white;
            cursor: not-allowed;
            opacity: 0.4;
            transition: all 0.3s;
        }

        .btn-accion.activo {
            cursor: pointer;
            opacity: 1;
            animation: pulso 1.5s infinite;
        }

        .btn-accion.activo:active {
            transform: scale(0.9);
        }

        @keyframes pulso {
            0%, 100% { box-shadow: 0 0 10px rgba(255,255,255,0.3); }
            50% { box-shadow: 0 0 30px rgba(255,255,255,0.8); }
        }

        #btn-i { background: linear-gradient(135deg, #c0392b, #e74c3c); }
        #btn-a { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        #btn-t { background: linear-gradient(135deg, #555555, #777777); }
        #btn-m { background: linear-gradient(135deg, #8e44ad, #9b59b6); }

        /* MENSAJE CENTRAL */
        #mensaje {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #ff0;
            text-shadow: 0 0 20px #000;
            text-align: center;
            z-index: 50;
            pointer-events: none;
            max-width: 80%;
        }

        /* BOT√ìN INICIAR */
        #btn-iniciar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 50px;
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            color: #000;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 5px 20px rgba(0, 255, 0, 0.4);
        }

        #btn-iniciar:hover {
            background: linear-gradient(135deg, #00cc00, #009900);
        }

        #btn-iniciar:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* COLORES POR CASA */
        .draco { color: #00d4ff !important; }
        .aquila { color: #5fd4ff !important; }
        .leo { color: #ff9900 !important; }
        .aper { color: #ff5500 !important; }
    </style>
</head>
<body>

    <!-- INDICADOR DE VERSI√ìN -->
    <div id="version">v2.0 ACTIVO</div>

    <!-- MENSAJE CENTRAL -->
    <div id="mensaje">Presiona Iniciar</div>

    <!-- PANEL INFO -->
    <div id="info-panel">
        <div id="nombre-casa">---</div>
        <div class="stat">
            <span class="stat-label">ESCUDO:</span>
            <span id="val-escudo" class="stat-value">---</span>
        </div>
        <div class="stat">
            <span class="stat-label">ARMA:</span>
            <span id="val-arma" class="stat-value">SICA</span>
        </div>
        <div class="stat">
            <span class="stat-label">ACCION:</span>
            <span id="val-accion" class="stat-value">---</span>
        </div>
        <div class="stat">
            <span class="stat-label">VALOR:</span>
            <span id="val-valor" class="stat-value">0</span>
        </div>
    </div>

    <!-- BOTONES -->
    <div id="botones">
        <button id="btn-i" class="btn-accion" data-accion="IMPETUS">I</button>
        <button id="btn-a" class="btn-accion" data-accion="AUXILIUM">A</button>
        <button id="btn-t" class="btn-accion" data-accion="TUTELA">T</button>
        <button id="btn-m" class="btn-accion" data-accion="MYSTERIUM">M</button>
    </div>

    <!-- BOT√ìN INICIAR -->
    <button id="btn-iniciar">INICIAR SISTEMA</button>

    <!-- ESCENA AR CON CACHE BUSTER -->
    <a-scene
        mindar-image="imageTargetSrc: ./targets.mind?v=20250101; autoStart: false; filterMinCF: 0.0001; filterBeta: 0.001; warmupTolerance: 5; missTolerance: 5; uiLoading: no; uiScanning: no;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        renderer="colorManagement: true; physicallyCorrectLights: true; logarithmicDepthBuffer: true;">
        
        <a-camera position="0 0 0" look-controls="enabled: false" camera="active: true"></a-camera>

        <!-- TARGET 0: DRACO (Azul claro) -->
        <a-entity id="target0" mindar-image-target="targetIndex: 0">
            <a-plane color="#00d4ff" opacity="0.5" width="1" height="1"></a-plane>
        </a-entity>

        <!-- TARGET 1: AQUILA (Azul m√°s claro) -->
        <a-entity id="target1" mindar-image-target="targetIndex: 1">
            <a-plane color="#5fd4ff" opacity="0.5" width="1" height="1"></a-plane>
        </a-entity>

        <!-- TARGET 2: LEO (Naranja) -->
        <a-entity id="target2" mindar-image-target="targetIndex: 2">
            <a-plane color="#ff9900" opacity="0.5" width="1" height="1"></a-plane>
        </a-entity>

        <!-- TARGET 3: APER (Rojo naranja) -->
        <a-entity id="target3" mindar-image-target="targetIndex: 3">
            <a-plane color="#ff5500" opacity="0.5" width="1" height="1"></a-plane>
        </a-entity>
    </a-scene>

    <script>
        // ==========================================
        // VERSI√ìN DEL SISTEMA
        // ==========================================
        const VERSION = "2.0.0";
        const BUILD_DATE = "2025-01-01";
        
        console.log(`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   DOMUS MAGI - SISTEMA DE DETECCI√ìN   ‚ïë
‚ïë   Versi√≥n: ${VERSION}                    ‚ïë
‚ïë   Build: ${BUILD_DATE}                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        `);

        // ==========================================
        // DATOS DE LAS 4 CASAS
        // ==========================================
        const CASAS = {
            0: { nombre: "DRACO", color: "draco", impetus: 6, auxilium: 1, tutela: 2, mysterium: 1 },
            1: { nombre: "AQUILA", color: "aquila", impetus: 4, auxilium: 1, tutela: 2, mysterium: 3 },
            2: { nombre: "LEO", color: "leo", impetus: 4, auxilium: 1, tutela: 4, mysterium: 1 },
            3: { nombre: "APER", color: "aper", impetus: 3, auxilium: 1, tutela: 5, mysterium: 1 }
        };

        // ELEMENTOS DOM
        const mensaje = document.getElementById('mensaje');
        const infoPanel = document.getElementById('info-panel');
        const nombreCasa = document.getElementById('nombre-casa');
        const valEscudo = document.getElementById('val-escudo');
        const valArma = document.getElementById('val-arma');
        const valAccion = document.getElementById('val-accion');
        const valValor = document.getElementById('val-valor');
        const botones = document.getElementById('botones');
        const btnIniciar = document.getElementById('btn-iniciar');

        const btnI = document.getElementById('btn-i');
        const btnA = document.getElementById('btn-a');
        const btnT = document.getElementById('btn-t');
        const btnM = document.getElementById('btn-m');

        // VARIABLES
        let casaActual = null;
        let sistemaIniciado = false;

        // ==========================================
        // FUNCIONES DE DETECCI√ìN
        // ==========================================
        
        function activarCasa(casa) {
            casaActual = casa;
            
            mensaje.innerText = '‚úì DETECTADA';
            mensaje.style.color = '#0f0';
            
            infoPanel.classList.add('visible');
            botones.classList.add('visible');
            
            nombreCasa.innerText = `DOMUS ${casa.nombre}`;
            nombreCasa.className = casa.color;
            
            valEscudo.innerText = casa.nombre;
            valEscudo.className = `stat-value ${casa.color}`;
            
            // Activar botones
            btnI.classList.add('activo');
            btnA.classList.add('activo');
            btnT.classList.add('activo');
            btnM.classList.add('activo');
            
            btnI.style.cursor = 'pointer';
            btnA.style.cursor = 'pointer';
            btnT.style.cursor = 'pointer';
            btnM.style.cursor = 'pointer';
            
            console.log(`‚úÖ Casa detectada: ${casa.nombre}`);
            console.log(`üìä Valores: I=${casa.impetus} A=${casa.auxilium} T=${casa.tutela} M=${casa.mysterium}`);
        }

        function desactivarCasa() {
            casaActual = null;
            
            mensaje.innerText = 'Buscando carta...';
            mensaje.style.color = '#ff0';
            
            infoPanel.classList.remove('visible');
            botones.classList.remove('visible');
            
            valAccion.innerText = '---';
            valValor.innerText = '0';
            
            btnI.classList.remove('activo');
            btnA.classList.remove('activo');
            btnT.classList.remove('activo');
            btnM.classList.remove('activo');
            
            console.log('‚ùå Carta perdida');
        }

        // ==========================================
        // BOT√ìN INICIAR CON DIAGN√ìSTICO
        // ==========================================
        
        btnIniciar.addEventListener('click', async () => {
            if (sistemaIniciado) return;

            btnIniciar.disabled = true;
            btnIniciar.innerText = 'Cargando...';
            mensaje.innerText = 'Iniciando c√°mara...';
            mensaje.style.fontSize = '36px';

            try {
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log('üöÄ INICIANDO SISTEMA AR');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                
                // PASO 1: Permisos de c√°mara
                console.log('üìπ [1/4] Solicitando permisos de c√°mara...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                stream.getTracks().forEach(track => track.stop());
                console.log('‚úÖ [1/4] Permisos concedidos');
                
                // PASO 2: Cargar escena
                mensaje.innerText = 'Cargando escena AR...';
                console.log('üé¨ [2/4] Cargando escena A-Frame...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const sceneEl = document.querySelector('a-scene');
                
                await new Promise((resolve) => {
                    if (sceneEl.hasLoaded) {
                        console.log('‚úÖ [2/4] Escena A-Frame lista');
                        resolve();
                    } else {
                        sceneEl.addEventListener('loaded', () => {
                            console.log('‚úÖ [2/4] Escena A-Frame lista');
                            resolve();
                        }, { once: true });
                    }
                });

                // PASO 3: Cargar targets.mind
                mensaje.innerText = 'Cargando detectores...';
                console.log('üéØ [3/4] Cargando targets.mind...');
                console.log('üìÅ Archivo: ./targets.mind?v=20250101');

                // PASO 4: Iniciar MindAR
                console.log('üöÄ [4/4] Iniciando MindAR...');
                const timeout = setTimeout(() => {
                    throw new Error('Timeout: MindAR no responde despu√©s de 15 segundos');
                }, 15000);

                await sceneEl.systems["mindar-image-system"].start();
                clearTimeout(timeout);
                
                console.log('‚úÖ [4/4] MindAR iniciado correctamente');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log('‚úÖ SISTEMA COMPLETAMENTE ACTIVO');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.log('üìç Apunta a cualquiera de las 4 cartas');
                console.log('üí° Consejos:');
                console.log('   ‚Ä¢ Buena iluminaci√≥n');
                console.log('   ‚Ä¢ Mant√©n la carta estable');
                console.log('   ‚Ä¢ Distancia: 20-40 cm de la c√°mara');
                console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                
                sistemaIniciado = true;
                btnIniciar.style.display = 'none';
                mensaje.innerText = 'Buscando carta...';
                mensaje.style.color = '#ff0';
                mensaje.style.fontSize = '48px';

            } catch (error) {
                console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.error('‚ùå ERROR AL INICIAR SISTEMA');
                console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                console.error('Detalles:', error);
                console.error('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                
                mensaje.innerText = error.message;
                mensaje.style.color = '#f00';
                mensaje.style.fontSize = '20px';
                btnIniciar.disabled = false;
                btnIniciar.innerText = 'REINTENTAR';
                
                alert(`‚ö†Ô∏è ERROR AL INICIAR\n\n${error.message}\n\n‚úì Verifica permisos de c√°mara\n‚úì Archivo targets.mind existe\n‚úì Targets.mind tiene 4 im√°genes\n‚úì Presiona F12 y revisa la consola`);
            }
        });

        // ==========================================
        // DETECTAR TARGETS
        // ==========================================
        
        const sceneEl = document.querySelector('a-scene');
        sceneEl.addEventListener('loaded', () => {
            console.log('üîß Configurando listeners de detecci√≥n...');
            
            for (let i = 0; i < 4; i++) {
                const target = document.getElementById(`target${i}`);
                
                target.addEventListener('targetFound', () => {
                    console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
                    console.log(`‚úÖ TARGET ${i} ENCONTRADO`);
                    activarCasa(CASAS[i]);
                    console.log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`);
                });
                
                target.addEventListener('targetLost', () => {
                    console.log(`‚ö†Ô∏è Target ${i} perdido (${CASAS[i].nombre})`);
                    if (casaActual === CASAS[i]) {
                        setTimeout(() => desactivarCasa(), 500);
                    }
                });
            }
            
            console.log('‚úÖ 4 Targets configurados correctamente');
            console.log('   ‚Ä¢ Target 0: DRACO');
            console.log('   ‚Ä¢ Target 1: AQUILA');
            console.log('   ‚Ä¢ Target 2: LEO');
            console.log('   ‚Ä¢ Target 3: APER');
        });

        // ==========================================
        // BOTONES DE ACCI√ìN
        // ==========================================
        
        document.querySelectorAll('.btn-accion').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!casaActual) {
                    console.log('‚ö†Ô∏è No hay casa detectada');
                    return;
                }

                const accion = btn.getAttribute('data-accion');
                let valor = 0;

                switch(btn.id) {
                    case 'btn-i': valor = casaActual.impetus; break;
                    case 'btn-a': valor = casaActual.auxilium; break;
                    case 'btn-t': valor = casaActual.tutela; break;
                    case 'btn-m': valor = casaActual.mysterium; break;
                }

                valAccion.innerText = accion;
                valValor.innerText = valor;

                console.log(`üéØ ACCI√ìN EJECUTADA: ${accion} = ${valor} puntos`);
            });
        });

        // ==========================================
        // LOG INICIAL
        // ==========================================
        
        console.log('üì± Aplicaci√≥n cargada correctamente');
        console.log('üìä Casas configuradas:', CASAS);
        console.log('');
        console.log('üí° Para iniciar: Presiona el bot√≥n "INICIAR SISTEMA"');
        console.log('');
    </script>
</body>
</html>