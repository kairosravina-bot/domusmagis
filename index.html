<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI V25 - ARTIFACTS EXPANSION</title>
    
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', Courier, monospace; background: #000; color: white; }
        
        #container-ar { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
        video { z-index: -2 !important; display: block !important; }

        .pantalla { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; z-index: 1000; background: #000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .oculto { display: none !important; }
        
        .btn-master {
            padding: 30px 50px; font-size: 24px; background: #bf00ff; color: white;
            border: 4px solid #fff; border-radius: 15px; cursor: pointer;
            box-shadow: 0 0 30px #bf00ff; text-transform: uppercase; font-weight: bold;
            margin: 10px; min-width: 300px;
        }

        .btn-modo-juego {
            padding: 25px 40px; font-size: 20px; margin: 15px;
            border-radius: 15px; cursor: pointer; font-weight: bold;
            border: 3px solid #fff; transition: all 0.3s; min-width: 350px;
        }
        .btn-batalla-directa { background: linear-gradient(135deg, #ff0000, #ff6600); box-shadow: 0 0 25px #ff0000; }
        .btn-juego2 { background: linear-gradient(135deg, #0066ff, #00ccff); box-shadow: 0 0 25px #0066ff; }
        
        .dado-gigante { font-size: 100px; color: #fff; text-shadow: 0 0 30px #fff; margin: 20px; font-weight: bold; }
        .suma-dados { font-size: 60px; color: gold; text-shadow: 0 0 30px gold; font-weight: bold; margin: 20px; }

        /* UI JUEGO */
        #ui-juego { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; pointer-events: none; z-index: 500; }
        
        #visor-top { 
            height: 45vh; background: rgba(0,0,0,0.85); border-bottom: 2px solid #bf00ff; 
            pointer-events: auto; position: relative; display: flex; align-items: center; 
            justify-content: center; overflow: hidden; transition: background 0.3s;
        }
        
        #zona-ar { height: 25vh; position: relative; background: transparent; }
        #panel-mando { 
            height: 30vh; background: rgba(10,10,10,0.95); border-top: 2px solid #fff; 
            pointer-events: auto; display: flex; flex-direction: column; 
            align-items: center; justify-content: space-around; padding: 10px;
            overflow-y: auto;
        }

        #guia-scanner { width: 200px; height: 200px; border: 4px solid red; border-radius: 20px; margin: auto; position: absolute; top:0; bottom:0; left:0; right:0; transition: 0.3s; }
        
        /* COLORES SCANNER */
        #guia-scanner.verde { border-color: #0f0; box-shadow: 0 0 50px #0f0; }
        #guia-scanner.dorado { border-color: gold; box-shadow: 0 0 60px gold, inset 0 0 20px gold; }
        #guia-scanner.violeta { border-color: #bf00ff; box-shadow: 0 0 60px #bf00ff, inset 0 0 20px #bf00ff; }

        .btn-gema {
            width: 75px; height: 75px; border-radius: 15px; border: 3px solid #555;
            background: #222; color: #555; display: flex; flex-direction: column; align-items: center;
            justify-content: center; font-size: 10px; font-weight: bold;
            cursor: pointer; transition: all 0.3s; opacity: 0.5;
            text-shadow: none; padding: 2px; text-align: center;
        }
        
        .letra-grande { font-size: 18px; margin-bottom: 2px; }
        
        /* Cuando est√° activo, la clase .activo se maneja en JS */
        .btn-gema.activo { opacity: 1; border-color: white; transform: scale(1.05); }
        
        #video-player { width: 100%; height: 100%; object-fit: contain; display: none; position: absolute; top: 0; left: 0; z-index: 50; }
        #intro-video { width: 100%; max-width: 600px; border-radius: 20px; }
        
        #video-overlay {
            position: absolute; top: 20px; right: 20px; display: none;
            flex-direction: column; align-items: center; z-index: 60; pointer-events: none;
        }
        #overlay-img { width: 80px; height: auto; filter: drop-shadow(0 0 10px white); margin-bottom: 5px; }
        #overlay-text {
            color: #fff; font-weight: 800; font-size: 20px; background: rgba(0,0,0,0.8);
            padding: 5px 15px; border-radius: 8px; border: 2px solid gold; margin-bottom: 5px;
        }
        #overlay-value {
            font-size: 35px; color: gold; font-weight: 900; 
            text-shadow: 2px 2px 0px #000; 
        }

        #msg-visor { color: white; text-align: center; font-weight: bold; font-size: 18px; z-index: 5; padding: 10px; }
        #txt-turno { position: absolute; top: 10px; left: 10px; font-weight: bold; z-index: 20; font-size: 16px; background: rgba(0,0,0,0.7); padding: 8px; border-radius: 8px; }
        #cartas-jugadas { background: rgba(0,0,0,0.8); padding: 5px; border-radius: 10px; width: 95%; min-height: 40px; }
        
        .carta-chip { display: inline-block; background: #333; padding: 4px 8px; margin: 2px; border-radius: 5px; font-size: 11px; border: 1px solid #777; }
        .chip-dorado { border: 1px solid gold; color: gold; box-shadow: 0 0 5px gold; }
        .chip-violeta { border: 1px solid #bf00ff; color: #bf00ff; box-shadow: 0 0 5px #bf00ff; }

        .btn-accion { padding: 15px 30px; font-size: 16px; margin: 5px; border-radius: 10px; border: 2px solid #fff; font-weight: bold; }
        .btn-agregar { background: #0a0; color: white; }
        .btn-finalizar { background: #f90; color: white; }
        
        #resultado-batalla { background: rgba(20,20,20,0.95); padding: 20px; border: 2px solid gold; border-radius: 15px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .resultado-jugador { background: #333; margin: 10px 0; padding: 10px; border-radius: 8px; border-left: 5px solid #555; }
        .ganador { border-color: gold; background: #444; box-shadow: 0 0 15px gold; }
        .detalle-item { font-size: 12px; color: #ccc; border-bottom: 1px solid #444; padding: 3px 0; display: flex; justify-content: space-between; }
        
        #historial-box { margin-top: 20px; border-top: 2px solid #555; padding-top: 10px; width: 100%; }
        .hist-row { font-size: 14px; color: #aaa; margin: 5px 0; border-bottom: 1px dashed #333; }
        .hist-win { color: gold; font-weight: bold; }
    </style>
</head>
<body>

    <div id="container-ar"></div>

    <!-- 1. PANTALLA INICIO -->
    <div id="p-inicio" class="pantalla">
        <button class="btn-master" onclick="irMenuPrincipal()">‚ö° INICIAR SISTEMA ‚ö°</button>
        <h2 style="color:#0f0; margin-top:20px;">DOMUS MAGI V25</h2>
        <p style="color:#bf00ff;">EXPANSI√ìN DE ARTEFACTOS</p>
    </div>

    <!-- 2. MEN√ö PRINCIPAL -->
    <div id="p-menu-principal" class="pantalla oculto">
        <video id="intro-video" playsinline webkit-playsinline muted></video>
        <h1 style="color:#bf00ff; text-shadow: 0 0 20px #bf00ff;">‚öîÔ∏è DOMUS MAGI ‚öîÔ∏è</h1>
        
        <button class="btn-modo-juego btn-batalla-directa" onclick="seleccionarModo('batalla')">‚öîÔ∏è BATALLA DIRECTA</button>
        <button class="btn-modo-juego btn-juego2" onclick="alert('Modo Misi√≥n Pr√≥ximamente...')">ü¶â MISIONES</button>
        
        <button class="btn-master" onclick="irDados()" style="background: #444; margin-top: 30px;">üé≤ TIRAR DADOS</button>
    </div>

    <!-- 3. DADOS -->
    <div id="p-dados" class="pantalla oculto">
        <h1 style="color:#0f0;">üé≤ DADOS üé≤</h1>
        <div style="display: flex; gap: 30px; align-items: center;">
            <div class="dado-gigante" id="dado1">?</div>
            <div style="font-size: 50px;">+</div>
            <div class="dado-gigante" id="dado2">?</div>
        </div>
        <div class="suma-dados" id="suma-dados">= ?</div>
        <button class="btn-master" onclick="tirarDados()" style="background: #0a0;">üé≤ LANZAR</button>
        <button class="btn-master" onclick="navegar('p-dados','p-menu-principal')" style="background: #a00;">‚¨ÖÔ∏è VOLVER</button>
    </div>

    <!-- 4. SETUP -->
    <div id="p-setup" class="pantalla oculto">
        <h2>REGISTRO DE MAGOS</h2>
        <div id="setup-selector">
            <button class="btn-master" onclick="setModo(2)">DUELO 2 JUGADORES</button>
            <button class="btn-master" onclick="setModo(4)">DUELO 4 JUGADORES</button>
        </div>
        <div id="registro" class="oculto" style="text-align:center; width: 90%;">
            <input type="text" id="mago-nombre" placeholder="TU NOMBRE" style="padding:15px; font-size:20px; width:100%; margin-bottom: 15px; color:black;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="registrarMago('TERRA','#ff0000','üõ°Ô∏è')" class="btn-master" style="background:#800; font-size:14px; padding:15px; min-width:auto;">üõ°Ô∏è TERRA</button>
                <button onclick="registrarMago('CAELUM','#00aaff','‚öîÔ∏è')" class="btn-master" style="background:#005; font-size:14px; padding:15px; min-width:auto;">‚öîÔ∏è CAELUM</button>
                <button onclick="registrarMago('AQUA','#00ff88','üíß')" class="btn-master" style="background:#040; font-size:14px; padding:15px; min-width:auto;">üíß AQUA</button>
                <button onclick="registrarMago('DIMENSIO','#aa00ff','‚ú®')" class="btn-master" style="background:#404; font-size:14px; padding:15px; min-width:auto;">‚ú® DIMENSIO</button>
            </div>
            <p id="reg-status" style="color:gold; margin-top:15px;"></p>
        </div>
    </div>

    <!-- 5. INTERFAZ DE JUEGO (AR) -->
    <div id="ui-juego" class="oculto">
        <div id="visor-top">
            <div id="txt-turno">MAGO: ---</div>
            <div id="msg-visor">INICIANDO...</div>
            <video id="video-player" playsinline webkit-playsinline></video>
            <div id="video-overlay">
                <img id="overlay-img" src="" alt="Escudo">
                <div id="overlay-text"></div>
                <div id="overlay-value"></div>
            </div>
        </div>
        <div id="zona-ar"><div id="guia-scanner"></div></div>
        <div id="panel-mando">
            <div id="cartas-jugadas">
                <div id="lista-cartas-chips"></div>
            </div>
            <!-- Botones con estructura para texto grande y peque√±o -->
            <div style="display:flex; gap:10px; margin: 10px 0;">
                <button id="btn-i" class="btn-gema"><span class="letra-grande">I</span><span class="label-peq"></span></button>
                <button id="btn-a" class="btn-gema"><span class="letra-grande">A</span><span class="label-peq"></span></button>
                <button id="btn-t" class="btn-gema"><span class="letra-grande">T</span><span class="label-peq"></span></button>
                <button id="btn-m" class="btn-gema"><span class="letra-grande">M</span><span class="label-peq"></span></button>
            </div>
            <p id="hint" style="margin:5px 0;">ESCANEA TU CARTA</p>
            <div>
                <button id="btn-agregar" class="btn-accion btn-agregar">‚ûï OTRA CARTA</button>
                <button id="btn-finalizar" class="btn-accion btn-finalizar">‚úÖ FIN TURNO</button>
            </div>
        </div>
    </div>

    <!-- 6. RESULTADOS -->
    <div id="p-resultado-ronda" class="pantalla oculto">
        <div id="resultado-batalla">
            <h2 id="titulo-resultados" style="color:gold; text-align:center;">‚öîÔ∏è RESULTADOS ‚öîÔ∏è</h2>
            <div id="resultado-contenido"></div>
            
            <!-- HISTORIAL -->
            <div id="historial-box">
                <h3 style="color:#aaa; text-align:center;">üìú CR√ìNICAS DEL TORNEO</h3>
                <div id="historial-lista"></div>
            </div>

            <button id="btn-next-ronda" class="btn-master" onclick="siguienteRonda()" style="margin-top:20px;">üîÑ SIGUIENTE RONDA</button>
        </div>
    </div>

    <!-- L√ìGICA DEL JUEGO (VANILLA JS) -->
    <script>
        let jugadores = [];
        let cant = 0;
        let tIdx = 0;
        let videoMostrado = false;
        
        let rondaActual = 1;
        const MAX_RONDAS = 7;
        let historialGanadores = [];
        
        function navegar(oc, mo) {
            document.getElementById(oc).classList.add('oculto');
            document.getElementById(mo).classList.remove('oculto');
        }

        function irMenuPrincipal() {
            navegar('p-inicio', 'p-menu-principal');
            if(!videoMostrado) {
                const v = document.getElementById('intro-video');
                v.src = 'https://kairosravina-bot.github.io/domusmagis/presentacion.mp4';
                v.muted = false; v.play().catch(()=>{});
                videoMostrado = true;
            }
        }

        function irDados() { navegar('p-menu-principal', 'p-dados'); }

        function tirarDados() {
            const d1 = Math.floor(Math.random()*6)+1;
            const d2 = Math.floor(Math.random()*6)+1;
            document.getElementById('dado1').innerText = d1;
            document.getElementById('dado2').innerText = d2;
            document.getElementById('suma-dados').innerText = "= "+(d1+d2);
        }

        function seleccionarModo(m) { navegar('p-menu-principal', 'p-setup'); }

        function setModo(n) {
            cant = n;
            document.getElementById('setup-selector').classList.add('oculto');
            document.getElementById('registro').classList.remove('oculto');
            document.getElementById('reg-status').innerText = `Mago 1 de ${n}`;
        }

        function registrarMago(casa, color, esc) {
            let n = document.getElementById('mago-nombre').value || "Mago " + (jugadores.length + 1);
            jugadores.push({nombre:n, casa, color, esc, cartas:[], puntos:0, victorias: 0});
            document.getElementById('mago-nombre').value = "";
            
            if(jugadores.length === cant) {
                navegar('p-setup', 'ui-juego');
                tIdx = 0;
                rondaActual = 1;
                historialGanadores = [];
                window.iniciarAR(); 
                actualizarHUD();
            } else {
                document.getElementById('reg-status').innerText = `Mago ${jugadores.length + 1} de ${cant}`;
            }
        }

        function siguienteRonda() {
            if(rondaActual >= MAX_RONDAS) {
                location.reload();
            } else {
                rondaActual++;
                tIdx = 0;
                jugadores.forEach(j => {
                    j.cartas = [];
                    j.total = 0;
                    j.dado = 0;
                });
                
                navegar('p-resultado-ronda', 'ui-juego');
                document.getElementById('guia-scanner').className = '';
                document.getElementById('msg-visor').innerText = "ESCANEA TU CARTA";
                document.getElementById('msg-visor').style.color = "white";
                actualizarHUD();
                alert(`¬°COMIENZA LA RONDA ${rondaActual} DE ${MAX_RONDAS}!`);
            }
        }
    </script>

    <!-- L√ìGICA AR + BATALLA (MODULE) -->
    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        const RUTA_BASE = "https://kairosravina-bot.github.io/domusmagis/";
        
        // --- BASE DE DATOS ACTUALIZADA V25 (ARTEFACTOS + BUHO) ---
        const CARTAS = {
            // 0-3: CASAS (Est√°ndar)
            0: { id: 0, nombre: "DRAG√ìN", imgEscudo: "ESCUDO_DRAGON.png", tipo: "CASA",
                botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 7, video: "CARTA_1_ataque.mp4", color: "#900" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 2, video: "CARTA_1_cura.mp4", color: "#090" }, "btn-t": { texto: "T", label: "TUTELA", valor: 3, video: "CARTA_1_defensa.mp4", color: "#555" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 2, video: "CARTA_1_magia.mp4", color: "#609" } }
            },
            1: { id: 1, nombre: "√ÅGUILA", imgEscudo: "ESCUDO_AGUILA.png", tipo: "CASA",
                botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 5, video: "ataque.mp4", color: "#900" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 4, video: "cura.mp4", color: "#090" }, "btn-t": { texto: "T", label: "TUTELA", valor: 2, video: "defensa.mp4", color: "#555" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 3, video: "magia.mp4", color: "#609" } }
            },
            2: { id: 2, nombre: "LE√ìN", imgEscudo: "ESCUDO_LEON.png", tipo: "CASA",
                botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 8, video: "ataque.mp4", color: "#900" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 1, video: "cura.mp4", color: "#090" }, "btn-t": { texto: "T", label: "TUTELA", valor: 4, video: "defensa.mp4", color: "#555" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 1, video: "magia.mp4", color: "#609" } }
            },
            3: { id: 3, nombre: "JABAL√ç", imgEscudo: "ESCUDO_JABALI.png", tipo: "CASA",
                botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 6, video: "ataque.mp4", color: "#900" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 3, video: "cura.mp4", color: "#090" }, "btn-t": { texto: "T", label: "TUTELA", valor: 3, video: "defensa.mp4", color: "#555" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 2, video: "magia.mp4", color: "#609" } }
            },
            
            // ID 4: B√öHO (Target 4) - NUEVOS NOMBRES
            4: {
                id: 4, nombre: "B√öHO MASTER", imgEscudo: "ESCUDO_BUHO.png", tipo: "BUHO",
                botones: {
                    "btn-i": { texto: "I", label: "MANDATUM", valor: 5, video: "BUHO_MISION.mp4", color: "gold" }, 
                    "btn-a": { texto: "A", label: "CONSILIUM", valor: 5, video: "BUHO_CONSEJO.mp4", color: "gold" },
                    "btn-t": { texto: "T", label: "PRAESAGIUM", valor: 5, video: "BUHO_PRESAGIO.mp4", color: "gold" },
                    "btn-m": { texto: "M", label: "ARCANUM", valor: 5, video: "BUHO_SECRETO.mp4", color: "gold" }
                }
            },
            
            // ID 5: FRASCO DE FUEGO (IGNIS PHIALA)
            5: {
                id: 5, nombre: "IGNIS PHIALA", imgEscudo: "ESCUDO_IGNIS.png", tipo: "ARTEFACTO",
                botones: {
                    "btn-i": { texto: "I", label: "LANZAR", valor: 10, video: "IGNIS_LANZAR.mp4", color: "#bf00ff" }, 
                    "btn-a": { texto: "A", label: "BEBER", valor: 8, video: "IGNIS_BEBER.mp4", color: "#bf00ff" },
                    "btn-t": { texto: "T", label: "MURO", valor: 8, video: "IGNIS_MURO.mp4", color: "#bf00ff" },
                    "btn-m": { texto: "M", label: "CATALIZAR", valor: 12, video: "IGNIS_CATALIZAR.mp4", color: "#bf00ff" }
                }
            },

            // ID 6: ESCUDO ESPEJO (SPECULUM AEGIS)
            6: {
                id: 6, nombre: "SPECULUM AEGIS", imgEscudo: "ESCUDO_ESPEJO.png", tipo: "ARTEFACTO",
                botones: {
                    "btn-i": { texto: "I", label: "GOLPEAR", valor: 6, video: "ESPEJO_GOLPE.mp4", color: "#bf00ff" }, 
                    "btn-a": { texto: "A", label: "EQUIPAR", valor: 9, video: "ESPEJO_EQUIPAR.mp4", color: "#bf00ff" },
                    "btn-t": { texto: "T", label: "BLOQUEAR", valor: 10, video: "ESPEJO_BLOQUEO.mp4", color: "#bf00ff" },
                    "btn-m": { texto: "M", label: "INVOCAR", valor: 7, video: "ESPEJO_ILUSION.mp4", color: "#bf00ff" }
                }
            },

            // ID 7: RELOJ DE ARENA (TEMPUS FUGIT)
            7: {
                id: 7, nombre: "TEMPUS FUGIT", imgEscudo: "ESCUDO_RELOJ.png", tipo: "ARTEFACTO",
                botones: {
                    "btn-i": { texto: "I", label: "ACELERAR", valor: 8, video: "RELOJ_ACELERAR.mp4", color: "#bf00ff" }, 
                    "btn-a": { texto: "A", label: "REVERTIR", valor: 7, video: "RELOJ_REVERTIR.mp4", color: "#bf00ff" },
                    "btn-t": { texto: "T", label: "CONGELAR", valor: 10, video: "RELOJ_CONGELAR.mp4", color: "#bf00ff" },
                    "btn-m": { texto: "M", label: "ROMPER", valor: 15, video: "RELOJ_ROMPER.mp4", color: "#bf00ff" } // Alto riesgo/recompensa
                }
            },

            // ID 8: LIBRO DE SOMBRAS (GRIMORIUM UMBRA)
            8: {
                id: 8, nombre: "GRIMORIUM UMBRA", imgEscudo: "ESCUDO_LIBRO.png", tipo: "ARTEFACTO",
                botones: {
                    "btn-i": { texto: "I", label: "ABRIR", valor: 9, video: "LIBRO_ABRIR.mp4", color: "#bf00ff" }, 
                    "btn-a": { texto: "A", label: "LEER", valor: 8, video: "LIBRO_LEER.mp4", color: "#bf00ff" },
                    "btn-t": { texto: "T", label: "CERRAR", valor: 7, video: "LIBRO_CERRAR.mp4", color: "#bf00ff" },
                    "btn-m": { texto: "M", label: "QUEMAR", valor: 12, video: "LIBRO_QUEMAR.mp4", color: "#bf00ff" }
                }
            },

            // ID 9: PIEDRA MAN√Å (LAPIS AETHER)
            9: {
                id: 9, nombre: "LAPIS AETHER", imgEscudo: "ESCUDO_PIEDRA.png", tipo: "ARTEFACTO",
                botones: {
                    "btn-i": { texto: "I", label: "DISPARAR", valor: 7, video: "PIEDRA_DISPARAR.mp4", color: "#bf00ff" }, 
                    "btn-a": { texto: "A", label: "ABSORBER", valor: 6, video: "PIEDRA_ABSORBER.mp4", color: "#bf00ff" },
                    "btn-t": { texto: "T", label: "CAMPO", valor: 9, video: "PIEDRA_CAMPO.mp4", color: "#bf00ff" },
                    "btn-m": { texto: "M", label: "ESTALLIDO", valor: 11, video: "PIEDRA_ESTALLIDO.mp4", color: "#bf00ff" }
                }
            }
        };

        let mindarThree = null;
        let cartaActual = null;
        let reproduciendo = false;

        const ui = {
            visorTop: document.getElementById('visor-top'), 
            scanner: document.getElementById('guia-scanner'),
            msg: document.getElementById('msg-visor'),
            video: document.getElementById('video-player'),
            overlay: document.getElementById('video-overlay'),
            ovImg: document.getElementById('overlay-img'),
            ovTxt: document.getElementById('overlay-text'),
            ovVal: document.getElementById('overlay-value'), 
            chips: document.getElementById('lista-cartas-chips'),
            txtTurno: document.getElementById('txt-turno'),
            hint: document.getElementById('hint')
        };

        window.actualizarHUD = function() {
            const j = jugadores[tIdx];
            ui.txtTurno.innerText = `${j.esc} ${j.nombre} [RONDA ${rondaActual}/${MAX_RONDAS}]`;
            ui.txtTurno.style.color = j.color;
            ui.msg.innerText = "ESCANEA TU CARTA";
            ui.msg.style.color = "white";
            
            ui.chips.innerHTML = '';
            j.cartas.forEach(c => {
                const s = document.createElement('span');
                s.className = 'carta-chip';
                
                if(c.tipo === "ARTEFACTO") {
                    s.classList.add('chip-violeta');
                } else if(c.tipo === "BUHO") {
                    s.classList.add('chip-dorado');
                } else {
                    if(c.esObjeto) s.classList.add('chip-dorado'); 
                    else s.style.borderColor = j.color;
                }
                s.innerText = `${c.carta} [${c.valor}]`;
                ui.chips.appendChild(s);
            });
        };

        // ACTUALIZACI√ìN VISUAL DE BOTONES
        function actualizarBotones(carta) {
            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                const b = document.getElementById(id);
                const conf = carta.botones[id];
                
                // Texto Principal (I, A, T, M) + Etiqueta peque√±a (MANDATUM, LANZAR, etc)
                b.innerHTML = `<span class="letra-grande">${conf.texto}</span><span style="font-size:8px;">${conf.label.substring(0,8)}</span>`;
                
                b.style.backgroundColor = conf.color;
                
                // Letra NEGRA para contraste m√°ximo
                b.style.color = "#000"; 
                b.style.textShadow = "0px 0px 2px #fff";
                b.style.fontWeight = "900";
                
                b.classList.add('activo');
            });
            ui.hint.innerText = `DETECTADO: ${carta.nombre}`;
        }

        function resetBotones() {
            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                const b = document.getElementById(id);
                const letra = id.split('-')[1].toUpperCase();
                b.innerHTML = `<span class="letra-grande">${letra}</span>`;
                b.style.backgroundColor = '#222';
                b.style.color = "#555";
                b.style.textShadow = "none";
                b.classList.remove('activo');
            });
        }

        window.iniciarAR = async function() {
            if(mindarThree) return;
            console.log("üöÄ INICIANDO MOTOR AR V25 (10 TARGETS)...");
            
            document.body.style.background = 'transparent';

            mindarThree = new MindARThree({
                container: document.getElementById('container-ar'),
                imageTargetSrc: RUTA_BASE + 'targets1.mind', 
                maxTrack: 1,
                filterMinCF: 0.0001, 
                filterBeta: 0.001,   
                warmupTolerance: 5, missTolerance: 5,
                uiLoading: "no", uiScanning: "no", uiError: "no"
            });

            const {renderer, scene, camera} = mindarThree;

            // BUCLE AUMENTADO A 10 (0 a 9)
            for(let i=0; i<10; i++) {
                const anchor = mindarThree.addAnchor(i);
                const plane = new THREE.Mesh(
                    new THREE.PlaneGeometry(1,1),
                    new THREE.MeshBasicMaterial({transparent:true, opacity:0})
                );
                anchor.group.add(plane);

                anchor.onTargetFound = () => {
                    console.log("üéØ TARGET ENCONTRADO: " + i);
                    cartaActual = CARTAS[i];
                    if(!cartaActual) return; 

                    if(cartaActual.tipo === "ARTEFACTO") {
                        ui.scanner.className = 'violeta';
                        ui.msg.style.color = "#bf00ff";
                    } else if(cartaActual.tipo === "BUHO") {
                        ui.scanner.className = 'dorado';
                        ui.msg.style.color = "gold";
                    } else {
                        ui.scanner.className = 'verde';
                        ui.msg.style.color = "#0f0";
                    }

                    ui.msg.innerText = "¬°" + cartaActual.nombre + "!";
                    actualizarBotones(cartaActual);
                };

                anchor.onTargetLost = () => {
                    if(cartaActual && cartaActual.id === i && !reproduciendo) {
                        cartaActual = null;
                        ui.scanner.className = '';
                        ui.msg.innerText = "BUSCANDO...";
                        ui.msg.style.color = "white";
                        resetBotones();
                    }
                };
            }

            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                document.getElementById(id).onclick = () => {
                    if(!cartaActual || reproduciendo) return;
                    
                    const conf = cartaActual.botones[id];
                    
                    let valNum = (typeof conf.valor === 'number' ? conf.valor : 10);
                    
                    jugadores[tIdx].cartas.push({
                        carta: cartaActual.nombre,
                        lado: conf.label, 
                        valor: valNum,
                        esObjeto: cartaActual.tipo === "OBJETO" || cartaActual.tipo === "BUHO" || cartaActual.tipo === "ARTEFACTO",
                        tipo: cartaActual.tipo 
                    });

                    reproduciendo = true;
                    ui.visorTop.style.background = "transparent";

                    ui.video.style.display = 'block';
                    ui.video.src = RUTA_BASE + conf.video;
                    
                    ui.ovImg.src = RUTA_BASE + cartaActual.imgEscudo;
                    ui.ovTxt.innerText = conf.label; 
                    ui.ovTxt.style.borderColor = conf.color;
                    ui.ovVal.innerText = valNum; 
                    ui.overlay.style.display = 'flex';
                    ui.msg.style.display = 'none';

                    ui.video.play();
                    ui.video.onended = () => {
                        reproduciendo = false;
                        ui.visorTop.style.background = "rgba(0,0,0,0.85)";
                        
                        ui.video.style.display = 'none';
                        ui.overlay.style.display = 'none';
                        ui.msg.style.display = 'block';
                        actualizarHUD();
                    };
                };
            });

            await mindarThree.start();
            renderer.setAnimationLoop(() => { renderer.render(scene, camera); });
        };

        document.getElementById('btn-agregar').onclick = () => {
            cartaActual = null;
            reproduciendo = false;
            ui.scanner.className = '';
            resetBotones();
            ui.msg.innerText = "ESCANEA OTRA...";
        };

        document.getElementById('btn-finalizar').onclick = () => {
            if(jugadores[tIdx].cartas.length === 0) {
                alert("¬°Juega al menos una carta!");
                return;
            }

            if(tIdx < jugadores.length - 1) {
                tIdx++;
                cartaActual = null;
                reproduciendo = false;
                ui.scanner.className = '';
                resetBotones();
                actualizarHUD();
                alert(`TURNO DE: ${jugadores[tIdx].nombre}`);
            } else {
                calcularBatalla();
            }
        };

        function calcularBatalla() {
            navegar('ui-juego', 'p-resultado-ronda');
            const cont = document.getElementById('resultado-contenido');
            const titulo = document.getElementById('titulo-resultados');
            const btnNext = document.getElementById('btn-next-ronda');
            
            cont.innerHTML = '';
            titulo.innerText = `‚öîÔ∏è RESULTADOS RONDA ${rondaActual} ‚öîÔ∏è`;

            // Calcular puntajes
            jugadores.forEach(j => {
                let sumaCartas = j.cartas.reduce((acc, c) => acc + c.valor, 0);
                let dado = Math.floor(Math.random() * 6) + 1;
                j.total = sumaCartas + dado;
                j.dado = dado;
            });

            // Ordenar por puntaje
            jugadores.sort((a, b) => b.total - a.total);
            
            // Determinar Ganador Ronda
            const ganador = jugadores[0];
            ganador.victorias++;
            historialGanadores.push({ronda: rondaActual, ganador: ganador.nombre});

            // Renderizar Resultados
            jugadores.forEach((j, i) => {
                const esGanador = (i === 0);
                const usoArtefacto = j.cartas.some(c => c.tipo === "ARTEFACTO");
                const usoBuho = j.cartas.some(c => c.tipo === "BUHO");
                
                let detalleHtml = '<div style="margin-top:5px; padding-top:5px; border-top:1px solid #555;">';
                j.cartas.forEach(c => {
                    let colorVal = c.tipo === "ARTEFACTO" ? "#bf00ff" : (c.tipo === "BUHO" ? "gold" : "#fff"); 
                    detalleHtml += `
                        <div class="detalle-item">
                            <span>${c.carta} (${c.lado})</span>
                            <span style="color:${colorVal}; font-weight:bold;">+${c.valor}</span>
                        </div>
                    `;
                });
                detalleHtml += '</div>';

                const div = document.createElement('div');
                div.className = 'resultado-jugador' + (esGanador ? ' ganador' : '');
                
                let badges = '';
                if(usoArtefacto) badges += '<span style="font-size:10px; color:#bf00ff; border:1px solid #bf00ff; padding:2px 4px; border-radius:4px; margin-left:5px;">ARTEFACTO</span>';
                if(usoBuho) badges += '<span style="font-size:10px; color:gold; border:1px solid gold; padding:2px 4px; border-radius:4px; margin-left:5px;">B√öHO</span>';

                div.innerHTML = `
                    <h3 style="color:${j.color}">
                        ${esGanador ? 'üëë ' : ''}${j.esc} ${j.nombre} 
                        ${badges}
                    </h3>
                    ${detalleHtml}
                    <p style="margin-top:5px; border-top:1px solid #555; padding-top:5px;">Dado: üé≤ ${j.dado}</p>
                    <h2 style="color:gold; margin:5px 0;">TOTAL: ${j.total}</h2>
                    <p style="font-size:12px; color:#aaa;">Victorias acumuladas: ${j.victorias}</p>
                `;
                cont.appendChild(div);
            });

            const listaHist = document.getElementById('historial-lista');
            listaHist.innerHTML = '';
            historialGanadores.forEach(h => {
                const div = document.createElement('div');
                div.className = 'hist-row';
                div.innerHTML = `Ronda ${h.ronda}: <span class="hist-win">${h.ganador}</span>`;
                listaHist.appendChild(div);
            });

            if (rondaActual >= MAX_RONDAS) {
                btnNext.innerText = "üèÜ FINALIZAR TORNEO";
                btnNext.style.background = "gold";
                btnNext.style.color = "black";
                let rankingFinal = [...jugadores].sort((a,b) => b.victorias - a.victorias);
                alert(`¬°TORNEO FINALIZADO!\nCAMPE√ìN: ${rankingFinal[0].nombre} con ${rankingFinal[0].victorias} victorias.`);
            } else {
                btnNext.innerText = "üîÑ SIGUIENTE RONDA";
                btnNext.style.background = "#bf00ff";
                btnNext.style.color = "white";
            }
        }
    </script>
</body>
</html>