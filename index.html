<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: REVELATIONS</title>
    
    <!-- LIBRERÍAS (A-Frame + MindAR) -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        /* --- CORRECCIÓN FINAL: TRANSPARENCIA TOTAL --- */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: transparent !important; /* CLAVE PARA VER CÁMARA */
            overflow: hidden; font-family: 'Segoe UI', sans-serif;
        }

        /* Forzamos que el video de la cámara se vaya al fondo */
        video {
            z-index: -100 !important;
            display: block !important;
        }
        
        /* El lienzo 3D también debe ser transparente */
        canvas {
            background-color: transparent !important;
            z-index: 1 !important;
        }

        /* --- INTERFAZ FLOTANTE --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999; display: flex; flex-direction: column;
            pointer-events: none;
        }

        /* 1. VISOR SUPERIOR */
        #video-visor {
            height: 35%; width: 100%; background: rgba(0,0,0,0.85);
            border-bottom: 2px solid #555; pointer-events: auto;
            display: flex; align-items: center; justify-content: center;
        }
        #video-player { width: 100%; height: 100%; object-fit: contain; display: none; }
        #msg-visor { color: white; text-align: center; font-weight: bold; letter-spacing: 1px; }

        /* 2. ZONA CENTRAL (Guía) */
        #zona-ar { flex-grow: 1; position: relative; display: flex; align-items: center; justify-content: center; }
        
        #guia-roja {
            width: 70vw; height: 95vw; max-width: 280px; max-height: 400px;
            border: 4px solid red; border-radius: 15px;
            box-shadow: 0 0 20px rgba(255,0,0,0.5);
            transition: 0.3s;
        }
        #guia-roja.verde { border-color: #0f0; box-shadow: 0 0 50px #0f0; background: rgba(0,255,0,0.1); }

        /* 3. PANEL INFERIOR */
        #panel-inferior {
            background: #111; border-top: 2px solid #fff;
            padding-bottom: env(safe-area-inset-bottom);
            pointer-events: auto; display: flex; flex-direction: column; gap: 8px; padding: 10px;
        }

        #btn-scan-row { display: flex; justify-content: center; margin-bottom: 5px; }
        #btn-iniciar-scan {
            background: #ffcc00; color: #000; border: none;
            padding: 12px 30px; border-radius: 20px; font-weight: bold; font-size: 16px;
            cursor: pointer; text-transform: uppercase; width: 100%;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.4);
        }

        /* Datos (2 Renglones) */
        .fila-datos { display: flex; gap: 5px; width: 100%; }
        .dato-box { 
            background: #222; border: 1px solid #444; border-radius: 5px; padding: 5px; 
            flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: center;
        }
        .lbl { font-size: 9px; color: #888; display: block; text-transform: uppercase; }
        .val { font-size: 13px; color: #fff; font-weight: bold; }
        .val-big { font-size: 15px; font-weight: bold; }

        /* Botonera */
        #botonera-poderes { display: flex; justify-content: center; gap: 15px; padding-top: 5px; }
        .btn-poder {
            width: 60px; height: 60px; border-radius: 50%;
            background: #222; border: 2px solid #555; color: #555;
            font-size: 20px; font-weight: bold; display: flex; 
            align-items: center; justify-content: center; opacity: 0.4; transition: 0.2s;
        }
        .btn-poder.activo { opacity: 1; cursor: pointer; color: white; border-color: white; transform: scale(1.05); }
        
        #btn-i.activo { background: #900; box-shadow: 0 0 15px #f00; }
        #btn-a.activo { background: #090; box-shadow: 0 0 15px #0f0; }
        #btn-t.activo { background: #555; box-shadow: 0 0 15px #aaa; }
        #btn-m.activo { background: #609; box-shadow: 0 0 15px #d0f; }
    </style>
</head>
<body>

    <!-- UI LAYER -->
    <div id="ui-layer">
        
        <div id="video-visor">
            <div id="msg-visor">SISTEMA APAGADO<br><span style="font-size:10px; color:#aaa">Pulsa el botón Amarillo</span></div>
            <video id="video-player" playsinline webkit-playsinline></video>
        </div>

        <div id="zona-ar">
            <div id="guia-roja"></div>
        </div>

        <div id="panel-inferior">
            <div id="btn-scan-row">
                <button id="btn-iniciar-scan">ACTIVAR CÁMARA</button>
            </div>

            <div class="fila-datos">
                <div class="dato-box"><span class="lbl">CASA</span><span id="d-casa" class="val">---</span></div>
                <div class="dato-box"><span class="lbl">ARMA</span><span id="d-arma" class="val">---</span></div>
            </div>

            <div class="fila-datos">
                <div class="dato-box"><span class="lbl">LADO / ACCIÓN</span><span id="d-lado" class="val-big" style="color:#ff0">---</span></div>
                <div class="dato-box"><span class="lbl">VALOR</span><span id="d-valor" class="val-big" style="color:#0f0">0</span></div>
            </div>

            <div id="botonera-poderes">
                <button id="btn-i" class="btn-poder" data-tipo="IMPETUS">I</button>
                <button id="btn-a" class="btn-poder" data-tipo="AUXILIUM">A</button>
                <button id="btn-t" class="btn-poder" data-tipo="TUTELA">T</button>
                <button id="btn-m" class="btn-poder" data-tipo="MYSTERIUM">M</button>
            </div>
        </div>
    </div>

    <!-- ESCENA MINDAR ARREGLADA -->
    <!-- renderer="alpha: true" HACE TRANSPARENTE EL 3D PARA VER LA CAMARA DETRAS -->
    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind?v=4444; autoStart: false; uiLoading: no; uiScanning: no;" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false"
        renderer="colorManagement: true; alpha: true"
        embedded>
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity id="target-carta" mindar-image-target="targetIndex: 0"></a-entity>
    </a-scene>

    <script>
        // DATOS
        const DATA = {
            casa: "DOMUS DRACO", arma: "SICA",
            stats: {
                IMPETUS:   { v: 6, vid: "ataque.mp4" },
                AUXILIUM:  { v: 1, vid: "cura.mp4" },
                TUTELA:    { v: 2, vid: "defensa.mp4" },
                MYSTERIUM: { v: 1, vid: "magia.mp4" }
            }
        };

        const btnScan = document.getElementById('btn-iniciar-scan');
        const msgVisor = document.getElementById('msg-visor');
        const guiaRoja = document.getElementById('guia-roja');
        const videoPlayer = document.getElementById('video-player');
        
        const uiCasa = document.getElementById('d-casa');
        const uiArma = document.getElementById('d-arma');
        const uiLado = document.getElementById('d-lado');
        const uiValor = document.getElementById('d-valor');
        const botones = document.querySelectorAll('.btn-poder');

        // 1. ARRANCAR
        btnScan.addEventListener('click', async () => {
            btnScan.innerText = "CARGANDO...";
            btnScan.disabled = true;

            // Audio unlock
            videoPlayer.muted = false;
            videoPlayer.play().then(()=>videoPlayer.pause()).catch(()=>{});

            const scene = document.querySelector('a-scene');
            
            try {
                // Iniciar motor AR
                await scene.systems['mindar-image-system'].start();
                
                // Si llegamos aquí, ¡Éxito!
                btnScan.style.display = 'none'; 
                msgVisor.innerHTML = "ESCANEA LA CARTA<br><span style='font-size:10px'>Ahora sí deberías ver la cámara</span>";
            
            } catch(e) {
                alert("Error al iniciar: " + e);
                btnScan.innerText = "REINTENTAR";
                btnScan.disabled = false;
            }
        });

        // 2. DETECTADO
        const target = document.getElementById('target-carta');

        target.addEventListener('targetFound', () => {
            guiaRoja.classList.add('verde');
            msgVisor.innerText = "¡ENLAZADO!";
            msgVisor.style.color = "#0f0";

            uiCasa.innerText = DATA.casa;
            uiArma.innerText = DATA.arma;

            botones.forEach(btn => btn.classList.add('activo'));
        });

        target.addEventListener('targetLost', () => {
            guiaRoja.classList.remove('verde');
            msgVisor.innerText = "BUSCANDO...";
            msgVisor.style.color = "#fff";

            videoPlayer.pause();
            videoPlayer.style.display = 'none';
            msgVisor.style.display = 'block';

            uiLado.innerText = "---";
            uiValor.innerText = "0";

            botones.forEach(btn => btn.classList.remove('activo'));
        });

        // 3. JUGAR
        botones.forEach(btn => {
            btn.addEventListener('click', () => {
                if (!btn.classList.contains('activo')) return;

                const tipo = btn.getAttribute('data-tipo');
                const info = DATA.stats[tipo];

                uiLado.innerText = tipo;
                uiValor.innerText = info.v;

                if(tipo === 'IMPETUS') uiLado.style.color = "#f55";
                else if(tipo === 'AUXILIUM') uiLado.style.color = "#5f5";
                else if(tipo === 'MYSTERIUM') uiLado.style.color = "#d5f";
                else uiLado.style.color = "#fff";

                msgVisor.style.display = 'none';
                videoPlayer.style.display = 'block';
                videoPlayer.src = info.vid;
                videoPlayer.play();
            });
        });

        videoPlayer.addEventListener('ended', () => {
            videoPlayer.style.display = 'none';
            msgVisor.style.display = 'block';
            msgVisor.innerText = "FIN DE TURNO";
        });

    </script>
</body>
</html>