<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI - SISTEMA TÁCTICO</title>
    
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <script type="module">
      import * as THREE from 'three';
      import { MindARThree } from 'mindar-image-three';

      // --- BASE DE DATOS ---
      // Asegúrate de que los nombres de archivo (img y vid) existan en tu carpeta
      const DB_CARTAS = {
        0: { nombre: "DRACO",  arma: "ALIENTO DE FUEGO", img: "draco.png",  vid: "caelum.mp4", i: 6, t: 2, a: 1, m: 1 },
        1: { nombre: "AQUILA", arma: "GARRA CELESTIAL",  img: "aquila.png", vid: "caelum.mp4", i: 4, t: 2, a: 1, m: 3 },
        2: { nombre: "LEO",    arma: "RUGIDO SONICO",    img: "leo.png",    vid: "terra.mp4",  i: 4, t: 4, a: 1, m: 1 },
        3: { nombre: "APER",   arma: "COLMILLO VELOZ",   img: "aper.png",   vid: "terra.mp4",  i: 3, t: 5, a: 1, m: 1 }
      };

      let mindarThree = null;
      let cartaActual = null; // Almacena los datos de la carta detectada

      const init = async () => {
        // El contenedor es el tercio del medio
        const container = document.querySelector("#tercio-scanner");
        
        try {
          mindarThree = new MindARThree({
            container: container,
            imageTargetSrc: "./targets1.mind", // Tu archivo targets
            filterMinCF: 0.0001, 
            filterBeta: 0.001
          });

          const {renderer, scene, camera} = mindarThree;

          // Configurar Anchors (0 a 3)
          for (let i = 0; i < 4; i++) {
            const anchor = mindarThree.addAnchor(i);
            
            // EVENTO: CARTA ENCONTRADA
            anchor.onTargetFound = () => {
              cartaActual = DB_CARTAS[i];
              
              // 1. Preparar Video (Cargar fuente pero NO reproducir aún)
              const video = document.querySelector("#video-player");
              if (video.getAttribute('data-current') !== cartaActual.vid) {
                  video.src = cartaActual.vid;
                  video.setAttribute('data-current', cartaActual.vid);
              }
              video.pause();
              video.currentTime = 0;

              // 2. Actualizar LÍNEA 1: Info General
              document.querySelector("#img-escudo").src = cartaActual.img;
              document.querySelector("#img-escudo").style.display = "block";
              
              document.querySelector("#info-linea1").innerHTML = 
                `<span style="color:gold; font-weight:bold;">${cartaActual.nombre}</span><br>` +
                `<span style="font-size:12px; color:#ccc;">${cartaActual.arma}</span>`;

              // 3. Resetear LÍNEA 2
              document.querySelector("#info-linea2").innerHTML = "SELECCIONE BOTÓN";

              // 4. Habilitar Botones Visualmente
              document.querySelector("#panel-botones").classList.remove("bloqueado");
            };
            
            // Opcional: Si se pierde la carta, mantenemos la info o bloqueamos
            /* anchor.onTargetLost = () => { ... } */
          }

          await mindarThree.start();
          
          renderer.setAnimationLoop(() => {
            renderer.render(scene, camera);
          });

        } catch (err) {
          console.error("Error iniciando AR:", err);
        }
      }

      // --- LÓGICA DE BOTONES ---
      window.botonPresionado = (tipo, etiqueta) => {
        if (!cartaActual) return; // Si no hay carta detectada, no hace nada

        // 1. Obtener valor
        const valor = cartaActual[tipo];

        // 2. Actualizar LÍNEA 2 (Lado y Valor)
        const colores = { i: '#ff4444', t: '#aaaaaa', a: '#44ff44', m: '#aa44ff' };
        
        document.querySelector("#info-linea2").innerHTML = 
          `<span style="color:${colores[tipo]}; font-size:20px; font-weight:bold; letter-spacing:2px;">${etiqueta}: ${valor}</span>`;

        // 3. Ejecutar Video COMPLETO (una vez)
        const video = document.querySelector("#video-player");
        video.currentTime = 0;
        video.play();
      };

      // Inicio del sistema
      document.querySelector("#btn-iniciar").addEventListener("click", () => {
        document.querySelector("#pantalla-carga").style.display = "none";
        init();
      });
    </script>

    <style>
      /* ESTRUCTURA GENERAL */
      body { margin: 0; padding: 0; background: #000; font-family: 'Segoe UI', sans-serif; height: 100vh; width: 100vw; overflow: hidden; color: white; display: flex; flex-direction: column; }

      /* PANTALLA DE CARGA */
      #pantalla-carga { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
      #btn-iniciar { padding: 15px 30px; font-size: 20px; background: gold; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; }

      /* --- 1. TERCIO SUPERIOR: VISOR MP4 (33.33%) --- */
      #tercio-video {
        width: 100%;
        height: 33.33vh;
        background: black;
        border-bottom: 2px solid #333;
        position: relative;
        overflow: hidden;
      }
      #video-player {
        width: 100%; height: 100%; object-fit: cover;
      }

      /* --- 2. TERCIO MEDIO: ESCANER AR (33.33%) --- */
      #tercio-scanner {
        width: 100%;
        height: 33.33vh;
        background: #222; /* Fondo mientras carga cámara */
        position: relative;
        overflow: hidden;
      }

      /* --- 3. TERCIO INFERIOR: INFO + BOTONES (33.33%) --- */
      #tercio-controles {
        width: 100%;
        height: 33.34vh; /* Ajuste decimal */
        background: #111;
        border-top: 2px solid #333;
        display: flex;
        flex-direction: column;
      }

      /* PANEL DE INFO (2 LÍNEAS) - Parte superior del tercio bajo */
      #info-panel {
        flex: 1; /* Ocupa el espacio disponible */
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 0 20px;
        gap: 10px;
      }

      /* Línea 1: Escudo + Texto */
      .fila-datos { display: flex; align-items: center; gap: 15px; }
      #img-escudo { width: 50px; height: 50px; object-fit: contain; display: none; border: 1px solid #444; border-radius: 5px; background: rgba(0,0,0,0.5); }
      #info-linea1 { font-size: 16px; line-height: 1.2; text-transform: uppercase; }

      /* Línea 2: Resultado (Lado y Valor) */
      #info-linea2 {
        background: rgba(255,255,255,0.05);
        padding: 8px;
        text-align: center;
        border-radius: 5px;
        font-family: monospace;
        font-size: 14px;
        color: #888;
        min-height: 24px;
      }

      /* PANEL DE BOTONES - Parte inferior del tercio bajo */
      #panel-botones {
        height: 80px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding-bottom: 10px;
        transition: opacity 0.3s;
      }
      
      /* Estado Bloqueado (Opacidad baja) */
      .bloqueado { opacity: 0.3; pointer-events: none; }

      .btn {
        width: 60px; height: 60px;
        border-radius: 10px;
        font-size: 24px; font-weight: bold;
        color: white;
        background: #222;
        border: 2px solid #555;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0,0,0,0.5);
      }
      .btn:active { transform: scale(0.95); border-color: white; }

      /* Colores Borde Botones */
      .b-i { border-bottom: 4px solid #ff4444; }
      .b-t { border-bottom: 4px solid #aaaaaa; }
      .b-a { border-bottom: 4px solid #44ff44; }
      .b-m { border-bottom: 4px solid #aa44ff; }

    </style>
  </head>
  <body>

    <!-- PANTALLA INICIO -->
    <div id="pantalla-carga">
      <h2 style="color:gold;">DOMUS MAGI</h2>
      <button id="btn-iniciar">ACTIVAR SISTEMA</button>
    </div>

    <!-- TERCIO 1: VIDEO (Sin Loop) -->
    <div id="tercio-video">
      <video id="video-player" playsinline muted></video>
    </div>

    <!-- TERCIO 2: ESCÁNER AR -->
    <div id="tercio-scanner">
      <!-- MindAR inyectará el video aquí -->
    </div>

    <!-- TERCIO 3: INFO + BOTONES -->
    <div id="tercio-controles">
      
      <!-- Información (2 Líneas) -->
      <div id="info-panel">
        <!-- Línea 1 -->
        <div class="fila-datos">
          <img id="img-escudo" src=""> <!-- src se llena al detectar -->
          <div id="info-linea1">ESPERANDO CARTA...</div>
        </div>
        <!-- Línea 2 -->
        <div id="info-linea2"></div>
      </div>

      <!-- 4 Botones de Elección -->
      <div id="panel-botones" class="bloqueado">
        <div class="btn b-i" onclick="botonPresionado('i', 'INT')">I</div>
        <div class="btn b-t" onclick="botonPresionado('t', 'TEC')">T</div>
        <div class="btn b-a" onclick="botonPresionado('a', 'AGI')">A</div>
        <div class="btn b-m" onclick="botonPresionado('m', 'MAG')">M</div>
      </div>

    </div>

  </body>
</html>