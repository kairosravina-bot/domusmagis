<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DIAGNÓSTICO DOMUS MAGI</title>
    
    <!-- LIBRERÍAS -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body { background: #000; color: #fff; font-family: monospace; padding: 20px; }
        
        #console-log {
            background: #111; border: 1px solid #444; 
            padding: 10px; margin-top: 20px; 
            height: 200px; overflow-y: scroll; font-size: 12px;
        }
        
        button {
            background: #00f; color: white; padding: 20px; 
            font-size: 20px; border: none; width: 100%; margin-top: 10px;
        }

        .error { color: #f55; font-weight: bold; }
        .success { color: #0f0; }
        .info { color: #aaa; }
    </style>
</head>
<body>

    <h1>MODO DIAGNÓSTICO</h1>
    <p>Si se traba, lee el registro abajo:</p>
    
    <button id="btn-start" onclick="iniciarDiagnostico()">INICIAR CÁMARA</button>

    <div id="console-log">Esperando usuario...</div>

    <!-- ESCENA MÍNIMA PARA PROBAR -->
    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiLoading: no; uiScanning: no;" 
        embedded
        renderer="colorManagement: true, alpha: true"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity mindar-image-target="targetIndex: 0">
            <a-plane color="blue" opacity="0.5"></a-plane>
        </a-entity>
    </a-scene>

    <script>
        const logger = document.getElementById('console-log');
        
        // Función para escribir en pantalla
        function log(msg, type='info') {
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            div.className = type;
            logger.appendChild(div);
            logger.scrollTop = logger.scrollHeight;
            console.log(msg);
        }

        // 1. VERIFICAR SI EXISTE EL ARCHIVO targets.mind
        async function checkFile() {
            log("Verificando archivo 'targets.mind'...", 'info');
            try {
                const response = await fetch('./targets.mind');
                if (response.ok) {
                    log("Archivo encontrado (OK)", 'success');
                    return true;
                } else {
                    log("ERROR: No se encuentra 'targets.mind'", 'error');
                    return false;
                }
            } catch (e) {
                log("ERROR DE RED: " + e.message, 'error');
                return false;
            }
        }

        // 2. VERIFICAR PERMISOS DE CÁMARA
        async function checkCamera() {
            log("Verificando permisos de cámara...", 'info');
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                log("ERROR CRÍTICO: Tu navegador no soporta acceso a cámara o NO ES SEGURO (HTTPS).", 'error');
                log("Si estás en móvil, usa HTTPS o conecta por USB debugging.", 'error');
                return false;
            }
            return true;
        }

        // 3. INICIAR AR
        async function iniciarDiagnostico() {
            const btn = document.getElementById('btn-start');
            btn.disabled = true;
            btn.style.background = "#555";
            btn.innerText = "PROCESANDO...";

            log("--- INICIO DE DIAGNÓSTICO ---", 'info');

            // Chequeos previos
            if (!await checkCamera()) return;
            if (!await checkFile()) return;

            log("Intentando acceder al sistema MindAR...", 'info');

            const scene = document.querySelector('a-scene');
            
            // Esperar a que la escena cargue
            if (!scene.hasLoaded) {
                log("Esperando carga de A-Frame...", 'info');
                await new Promise(r => scene.addEventListener('loaded', r));
            }

            const arSystem = scene.systems['mindar-image-system'];
            
            if (!arSystem) {
                log("ERROR: El sistema MindAR no se cargó. Revisa tu internet o las librerías.", 'error');
                return;
            }

            log("Iniciando motor de video...", 'info');

            try {
                await arSystem.start();
                log("¡ÉXITO! La cámara debería verse ahora.", 'success');
                btn.style.background = "green";
                btn.innerText = "FUNCIONANDO";
            } catch (error) {
                log("ERROR FATAL AL INICIAR: " + error, 'error');
                
                if (error.name === 'NotAllowedError') {
                    log("CAUSA: Permiso denegado por el usuario.", 'error');
                } else if (error.name === 'NotFoundError') {
                    log("CAUSA: No se encontró ninguna cámara.", 'error');
                } else {
                    log("CAUSA POSIBLE: El navegador bloqueó el acceso o la memoria está llena.", 'error');
                }
            }
        }
    </script>
</body>
</html>