<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: REVELATIONS</title>
    
    <!-- LIBRERÍAS (MindAR + A-Frame) -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', Courier, monospace; }
        
        /* PANTALLA DE INICIO (Cubre todo hasta dar click) */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white;
        }
        #btn-start {
            padding: 15px 40px; font-size: 20px; background: #8a2be2;
            color: white; border: 2px solid white; cursor: pointer; margin-top: 20px;
        }

        /* UI SUPERIOR: HP y VIDEO */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* DEJAR PASAR CLICKS A LA CÁMARA/ESCENA */
            z-index: 10; display: none; flex-direction: column; justify-content: space-between;
        }

        /* 1. Panel Superior: Vida y Video */
        .top-panel {
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            pointer-events: auto;
        }
        
        /* Barras de vida */
        .bars-container { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .hp-box { width: 48%; color: white; font-size: 12px; }
        .bar-bg { width: 100%; height: 10px; background: #333; border: 1px solid white; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        #hp-p { background: #00ff00; width: 100%; }
        #hp-e { background: #ff0000; width: 100%; }

        /* Visor de Video (NORMAL, sin chroma) */
        #video-container {
            width: 100%; height: 180px; 
            background: black; border: 1px solid #555;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }
        video { width: 100%; height: 100%; object-fit: contain; }
        #vid-placeholder { color: gray; }

        /* 2. Panel Inferior: Datos y Botones */
        .bottom-panel {
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            pointer-events: auto;
            text-align: center;
        }

        /* TEXTO CORREGIDO: Nombre y Valor */
        #scan-data {
            color: cyan; margin-bottom: 10px; font-size: 14px; 
            border-bottom: 1px solid #444; padding-bottom: 5px;
        }
        #val-display { color: yellow; font-size: 18px; font-weight: bold; }

        /* Botones */
        .btn-row { display: flex; justify-content: space-around; }
        .action-btn {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid white;
            font-weight: bold; font-size: 18px; cursor: pointer; color: white;
        }
        /* Colores botones */
        .b-red { background: #900; }
        .b-grey { background: #555; }
        .b-green { background: #090; }
        .b-purp { background: #609; }

    </style>
</head>
<body>

    <!-- PANTALLA DE INICIO -->
    <div id="start-screen">
        <h1>DOMUS MAGI</h1>
        <button id="btn-start">INICIAR CÁMARA</button>
    </div>

    <!-- CAPA DE INTERFAZ (UI) -->
    <div id="ui-layer">
        
        <!-- ARRIBA: HP y VIDEO -->
        <div class="top-panel">
            <div class="bars-container">
                <div class="hp-box">MAGUS: <span id="txt-hp-p">100</span>
                    <div class="bar-bg"><div id="hp-p" class="bar-fill"></div></div>
                </div>
                <div class="hp-box" style="text-align: right;">RIVAL: <span id="txt-hp-e">100</span>
                    <div class="bar-bg"><div id="hp-e" class="bar-fill"></div></div>
                </div>
            </div>
            
            <div id="video-container">
                <div id="vid-placeholder">ESCANEA UNA CARTA</div>
                <video id="hud-video" playsinline style="display:none"></video>
            </div>
        </div>

        <!-- ABAJO: DATOS y BOTONES -->
        <div class="bottom-panel">
            <div id="scan-data">
                <div id="card-text">ESPERANDO OBJETIVO...</div>
                <div id="val-text">VALOR: <span id="val-display">--</span></div>
            </div>
            
            <div class="btn-row">
                <button id="btn-I" class="action-btn b-red">I</button>
                <button id="btn-T" class="action-btn b-grey">T</button>
                <button id="btn-A" class="action-btn b-green">A</button>
                <button id="btn-M" class="action-btn b-purp">M</button>
            </div>
        </div>
    </div>

    <!-- ESCENA AR (Ocultamos el anillo de carga default con uiLoading:no) -->
    <a-scene mindar-image="imageTargetSrc: ./targets.mind; uiLoading: no; filterMinCF:0.0001; filterBeta: 0.001;" 
             color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        
        <!-- Entidades generadas por script -->
        <a-entity id="marker-group"></a-entity>

    </a-scene>

    <script>
        // --- VARIABLES ---
        let pHP = 100;
        let eHP = 100;
        
        // Estado de la carta actual
        let currentScan = {
            name: "",       // DRACO SICA
            modeName: "",   // IMPETUS, TUTELA...
            modeCode: "",   // I, T, A, M
            value: 0        // 6, 1, 2...
        };

        // LISTA DE TUS ARCHIVOS (Igual que en targets.mind)
        const markerList = [
            "DRACO_SICA_1_I_6", 
            "DRACO_SICA_1_A_1", 
            "DRACO_SICA_1_T_2", 
            "DRACO_SICA_1_M_1"
        ];

        // --- INICIO ---
        const startBtn = document.getElementById('btn-start');
        startBtn.addEventListener('click', () => {
            // Ocultar pantalla negra de inicio
            document.getElementById('start-screen').style.display = 'none';
            // Mostrar UI del juego
            document.getElementById('ui-layer').style.display = 'flex';
            
            // Arrancar MindAR
            const scene = document.querySelector('a-scene');
            scene.systems["mindar-image-system"].start();
            
            initMarkers();
        });

        // --- GENERAR MARCADORES ---
        function initMarkers() {
            const group = document.getElementById('marker-group');
            
            markerList.forEach((name, idx) => {
                const el = document.createElement('a-entity');
                el.setAttribute('mindar-image-target', `targetIndex: ${idx}`);
                
                el.addEventListener('targetFound', () => {
                    readFileName(name);
                });
                
                group.appendChild(el);
            });
        }

        // --- LÓGICA DE LECTURA (LO QUE PEDISTE) ---
        function readFileName(fullName) {
            // Formato: DRACO_SICA_1_I_6
            const parts = fullName.split('_');
            
            if(parts.length >= 5) {
                // 1. Nombre
                const cardName = parts[0] + " - " + parts[1];
                
                // 2. Modo (Letra a Palabra Completa)
                const code = parts[3];
                let modeFull = "DESCONOCIDO";
                if(code === 'I') modeFull = "IMPETUS";
                if(code === 'T') modeFull = "TUTELA";
                if(code === 'A') modeFull = "AUXILIUM";
                if(code === 'M') modeFull = "MYSTERIUM";

                // 3. Valor Numérico
                const val = parseInt(parts[4]);

                // Guardar en variable global
                currentScan = { 
                    name: cardName, 
                    modeName: modeFull, 
                    modeCode: code, 
                    value: val 
                };

                updateScreenText();
            }
        }

        // --- ACTUALIZAR PANTALLA ---
        function updateScreenText() {
            document.getElementById('card-text').innerText = `${currentScan.name} [${currentScan.modeName}]`;
            document.getElementById('val-display').innerText = currentScan.value;
        }

        // --- BOTONES DE ACCIÓN ---
        document.getElementById('btn-I').addEventListener('click', () => {
            if(currentScan.modeCode === 'I') {
                eHP -= currentScan.value;
                playVideoGeneric(); // Video normal
                refreshHP();
            } else {
                alert("La carta no está en posición IMPETUS (Ataque)");
            }
        });

        document.getElementById('btn-A').addEventListener('click', () => {
            if(currentScan.modeCode === 'A') {
                pHP += (currentScan.value * 5); 
                if(pHP > 100) pHP = 100;
                refreshHP();
            } else {
                alert("La carta no está en posición AUXILIUM (Curar)");
            }
        });

        document.getElementById('btn-T').addEventListener('click', () => {
            if(currentScan.modeCode === 'T') {
                alert(`Defensa activada valor: ${currentScan.value}`);
            } else {
                alert("La carta no está en posición TUTELA (Defensa)");
            }
        });

        document.getElementById('btn-M').addEventListener('click', () => {
            if(currentScan.modeCode === 'M') {
                eHP -= (currentScan.value * 2);
                playVideoGeneric();
                refreshHP();
            } else {
                alert("La carta no está en posición MYSTERIUM (Magia)");
            }
        });

        // --- UTILIDADES ---
        function refreshHP() {
            if(eHP < 0) eHP = 0;
            document.getElementById('txt-hp-p').innerText = Math.floor(pHP);
            document.getElementById('txt-hp-e').innerText = Math.floor(eHP);
            document.getElementById('hp-p').style.width = pHP + "%";
            document.getElementById('hp-e').style.width = eHP + "%";
        }

        function playVideoGeneric() {
            const vid = document.getElementById('hud-video');
            const place = document.getElementById('vid-placeholder');
            
            // Simulación de carga de video (aquí pondrás tu .src real)
            place.style.display = 'none';
            vid.style.display = 'block';
            
            // Como no hay archivo real, simulamos reproducción por 2 seg
            vid.style.background = '#222'; 
            setTimeout(() => {
                vid.style.display = 'none';
                place.style.display = 'block';
            }, 2000);
        }

    </script>
</body>
</html>