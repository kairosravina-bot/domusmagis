<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI V9.9</title>
    
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', Courier, monospace; background: #000; color: white; }
        .pantalla { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; background: #000; }
        .oculto { display: none !important; }
        
        .btn-master {
            padding: 30px 50px; font-size: 24px; background: #bf00ff; color: white;
            border: 4px solid #fff; border-radius: 15px; cursor: pointer;
            box-shadow: 0 0 30px #bf00ff; text-transform: uppercase; font-weight: bold;
        }

        #ui-juego { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; pointer-events: none; z-index: 500; }
        #visor-top { height: 33vh; background: rgba(0,0,0,0.8); border-bottom: 2px solid #bf00ff; pointer-events: auto; position: relative; display: flex; align-items: center; justify-content: center; overflow-y: auto; }
        #zona-ar { height: 40vh; position: relative; background: transparent; }
        #panel-mando { height: 27vh; background: #111; border-top: 2px solid #fff; pointer-events: auto; display: flex; flex-direction: column; align-items: center; justify-content: space-around; }

        #guia-scanner { width: 220px; height: 220px; border: 4px solid red; border-radius: 20px; margin: auto; position: absolute; top:0; bottom:0; left:0; right:0; transition: 0.3s; }
        #guia-scanner.verde { border-color: #0f0; box-shadow: 0 0 50px #0f0; }

        .btn-gema {
            width: 75px; height: 75px; border-radius: 50%; border: 3px solid #555;
            background: #222; color: #555; display: flex; align-items: center;
            justify-content: center; font-size: 26px; font-weight: bold;
            cursor: not-allowed; transition: all 0.3s; opacity: 0.4;
        }
        .btn-gema.activo {
            opacity: 1; cursor: pointer; border-color: white; color: white; transform: scale(1.1);
        }
        #btn-i.activo { box-shadow: 0 0 25px #f00; }
        #btn-a.activo { box-shadow: 0 0 25px #0f0; }
        #btn-t.activo { box-shadow: 0 0 25px #aaa; }
        #btn-m.activo { box-shadow: 0 0 25px #d0f; }

        #container-ar { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .mago-item { font-size: 22px; margin: 10px; padding: 5px; border-radius: 5px; }

        #pressure-panel {
            width: 90%; max-width: 400px; background: rgba(20,20,20,0.95);
            border: 2px solid #bf00ff; border-radius: 15px; padding: 20px; margin: 10px auto;
        }
        #pressure-display {
            font-size: 48px; font-weight: bold; text-align: center;
            margin: 15px 0; color: #0ff; text-shadow: 0 0 20px #0ff;
        }
        #pressure-bar {
            width: 100%; height: 30px; background: #222; border-radius: 15px;
            overflow: hidden; border: 2px solid #444; margin: 10px 0;
        }
        #pressure-fill {
            height: 100%; width: 0%; background: linear-gradient(90deg, #0f0, #ff0, #f00);
            transition: width 0.1s; box-shadow: 0 0 20px currentColor;
        }
        .pressure-label { font-size: 14px; color: #aaa; margin: 5px 0; }
        #pressure-status {
            text-align: center; font-size: 18px; color: #0f0;
            margin: 10px 0; font-weight: bold;
        }
        #debug-log {
            position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8);
            color: #0f0; padding: 10px; font-size: 12px; max-width: 90%;
            max-height: 100px; overflow-y: auto; font-family: monospace;
            border: 1px solid #0f0; border-radius: 5px; z-index: 9999;
        }
    </style>
</head>
<body>

    <div id="p-inicio" class="pantalla">
        <button class="btn-master" onclick="navegar('p-inicio', 'p-setup')">‚ö° INICIAR SISTEMA ‚ö°</button>
        <h2 style="color:#0f0; margin-top:20px;">DOMUS MAGI V9.9</h2>
        <p style="color:#bf00ff; font-size:12px;">Fix Detecci√≥n y Sistema de Presi√≥n</p>
    </div>

    <div id="p-setup" class="pantalla oculto">
        <h2>REGISTRO DE MAGOS</h2>
        <div id="setup-selector">
            <button class="btn-master" style="font-size:16px;" onclick="setModo(2)">DUELO 2 JUGADORES</button>
            <button class="btn-master" style="font-size:16px;" onclick="setModo(4)">DUELO 4 JUGADORES</button>
        </div>
        <div id="registro" class="oculto" style="text-align:center;">
            <input type="text" id="mago-nombre" placeholder="TU NOMBRE" style="padding:15px; font-size:20px; width:80%;"><br><br>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="registrarMago('TERRA','#ff0000','üõ°Ô∏è')" class="btn-master" style="background:#800; font-size:14px;">üõ°Ô∏è TERRA</button>
                <button onclick="registrarMago('CAELUM','#00aaff','‚öîÔ∏è')" class="btn-master" style="background:#005; font-size:14px;">‚öîÔ∏è CAELUM</button>
                <button onclick="registrarMago('AQUA','#00ff88','üíß')" class="btn-master" style="background:#040; font-size:14px;">üíß AQUA</button>
                <button onclick="registrarMago('DIMENSIO','#aa00ff','‚ú®')" class="btn-master" style="background:#404; font-size:14px;">‚ú® DIMENSIO</button>
            </div>
            <p id="reg-status" style="color:gold; margin-top:15px;"></p>
        </div>
    </div>

    <div id="p-resumen" class="pantalla oculto">
        <h2 style="color:gold;">EQUIPOS FORMADOS</h2>
        <div id="lista-resumen"></div>
        <button id="btn-despertar" class="btn-master" style="margin-top:20px; background:gold; color:black;">üîÆ DESPERTAR VISOR AR</button>
    </div>

    <div id="ui-juego" class="oculto">
        <div id="ui-juego-layout">
            <div id="visor-top">
                <div style="width:100%;">
                    <div id="txt-turno" style="position:absolute; top:10px; left:20px; font-weight:bold; z-index:10;">MAGO: ---</div>
                    <div id="status-txt" style="position:absolute; top:10px; right:20px; background:rgba(0,255,0,0.2); padding:5px 15px; border-radius:15px; border:1px solid #0f0; color:#0f0; z-index:10;">AR OK</div>
                    
                    <div id="pressure-panel">
                        <div class="pressure-label">PRESI√ìN DE CONTACTO - V9.9</div>
                        <div id="pressure-display">0.0</div>
                        <div id="pressure-bar">
                            <div id="pressure-fill"></div>
                        </div>
                        <div id="pressure-status">Esperando carta...</div>
                        <div class="pressure-label" style="display:flex; justify-content:space-between;">
                            <span>Min: <span id="min-pressure">0.0</span></span>
                            <span>Max: <span id="max-pressure">0.0</span></span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="zona-ar"><div id="guia-scanner"></div></div>
            <div id="panel-mando">
                <div style="display:flex; gap:20px;">
                    <button id="btn-i" class="btn-gema">I</button>
                    <button id="btn-a" class="btn-gema">A</button>
                    <button id="btn-t" class="btn-gema">T</button>
                    <button id="btn-m" class="btn-gema">M</button>
                </div>
                <p id="hint">ESCANEA CARTA PARA ACTIVAR GEMAS</p>
            </div>
        </div>
    </div>

    <div id="container-ar"></div>
    <div id="debug-log"></div>

    <script>
        let jugadores = [];
        let cant = 0;

        function log(msg) {
            const d = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            d.innerHTML = `[${timestamp}] ${msg}<br>` + d.innerHTML;
            console.log(msg);
        }

        function navegar(oc, mo) {
            document.getElementById(oc).classList.add('oculto');
            document.getElementById(mo).classList.remove('oculto');
            log(`Navegaci√≥n: ${oc} ‚Üí ${mo}`);
        }

        function setModo(n) {
            cant = n;
            document.getElementById('setup-selector').classList.add('oculto');
            document.getElementById('registro').classList.remove('oculto');
            document.getElementById('reg-status').innerText = `Mago 1 de ${n}`;
        }

        function registrarMago(casa, color, esc) {
            let n = document.getElementById('mago-nombre').value || "Mago " + (jugadores.length + 1);
            jugadores.push({nombre: n, casa, color, esc});
            document.getElementById('mago-nombre').value = "";
            
            if(jugadores.length === cant) {
                navegar('p-setup', 'p-resumen');
                const list = document.getElementById('lista-resumen');
                jugadores.forEach(j => {
                    list.innerHTML += `<div class="mago-item" style="color:${j.color}">${j.esc} ${j.nombre} [${j.casa}]</div>`;
                });
            } else {
                document.getElementById('reg-status').innerText = `Mago ${jugadores.length + 1} de ${cant}`;
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        const VERSION = "V9.9";
        console.log(`%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, "color: #bf00ff; font-size: 20px;");
        console.log(`%c  DOMUS MAGI ${VERSION}`, "color: #bf00ff; font-size: 20px; font-weight: bold;");
        console.log(`%c‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, "color: #bf00ff; font-size: 20px;");

        let tIdx = 0;
        let mindarThree = null;
        let cartaDetectada = false;
        let pressureData = { current: 0, min: 0, max: 0 };
        let cartaActual = null;

        const RUTA_BASE = "https://kairosravina-bot.github.io/domusmagis/";

        function log(msg) {
            const d = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            d.innerHTML = `[${timestamp}] ${msg}<br>` + d.innerHTML;
            console.log(msg);
        }

        function actualizarVisualizacionPresion(presion) {
            document.getElementById('pressure-display').innerText = presion.toFixed(1);
            document.getElementById('pressure-fill').style.width = presion + '%';
            document.getElementById('min-pressure').innerText = pressureData.min.toFixed(1);
            document.getElementById('max-pressure').innerText = pressureData.max.toFixed(1);
            
            const display = document.getElementById('pressure-display');
            const status = document.getElementById('pressure-status');
            
            if(presion < 30) {
                display.style.color = '#0ff';
                display.style.textShadow = '0 0 20px #0ff';
                status.innerText = 'Presi√≥n BAJA';
                status.style.color = '#0ff';
            } else if(presion < 70) {
                display.style.color = '#ff0';
                display.style.textShadow = '0 0 20px #ff0';
                status.innerText = 'Presi√≥n MEDIA';
                status.style.color = '#ff0';
            } else {
                display.style.color = '#0f0';
                display.style.textShadow = '0 0 20px #0f0';
                status.innerText = '¬°ACTIVACI√ìN LISTA!';
                status.style.color = '#0f0';
            }
        }

        function resetPresion() {
            pressureData.current = 0;
            actualizarVisualizacionPresion(0);
            document.getElementById('pressure-status').innerText = 'Esperando toque...';
        }

        function activarGemas(bol) {
            log(`activarGemas(${bol}) - Carta: ${cartaActual}`);
            
            const botones = [
                document.getElementById('btn-i'),
                document.getElementById('btn-a'),
                document.getElementById('btn-t'),
                document.getElementById('btn-m')
            ];

            botones.forEach((btn, idx) => {
                if(bol) {
                    btn.classList.add('activo');
                    log(`  ‚úì Bot√≥n ${btn.id} ACTIVADO`);
                } else {
                    btn.classList.remove('activo');
                    log(`  ‚úó Bot√≥n ${btn.id} DESACTIVADO`);
                }
            });
        }

        function sig() {
            if(tIdx < jugadores.length - 1) {
                tIdx++;
                alert("Pasa el dispositivo al siguiente mago.");
                updHUD();
                cartaDetectada = false;
                cartaActual = null;
                pressureData = { current: 0, min: 0, max: 0 };
                resetPresion();
                activarGemas(false);
            } else {
                alert("¬°BATALLA FINAL INICIADA! Tirando dados...");
                location.reload();
            }
        }

        document.getElementById('btn-despertar').onclick = async () => {
            const btn = document.getElementById('btn-despertar');
            btn.innerText = "INICIALIZANDO...";
            btn.disabled = true;

            try {
                log("üöÄ Iniciando MindAR...");

                mindarThree = new MindARThree({
                    container: document.querySelector("#container-ar"),
                    imageTargetSrc: RUTA_BASE + "targets1.mind",
                    maxTrack: 1,
                    filterMinCF: 0.0001,
                    filterBeta: 0.001,
                    warmupTolerance: 5,
                    missTolerance: 5,
                    uiLoading: "no",
                    uiScanning: "no",
                    uiError: "no"
                });

                const {renderer, scene, camera} = mindarThree;

                log("üì¶ Creando anchors (0-4)...");

                for(let i = 0; i < 5; i++) {
                    const anchor = mindarThree.addAnchor(i);
                    
                    const geometry = new THREE.PlaneGeometry(1, 1);
                    const material = new THREE.MeshBasicMaterial({transparent: true, opacity: 0});
                    const plane = new THREE.Mesh(geometry, material);
                    anchor.group.add(plane);

                    anchor.onTargetFound = () => {
                        log(`üéØ CARTA ${i} DETECTADA`);
                        cartaDetectada = true;
                        cartaActual = i;
                        
                        document.getElementById('guia-scanner').classList.add('verde');
                        document.getElementById('hint').innerText = `CARTA ${i} - PRESIONA GEMA`;
                        document.getElementById('pressure-status').innerText = '¬°Carta detectada!';
                        document.getElementById('pressure-status').style.color = '#bf00ff';
                        
                        activarGemas(true);
                    };

                    anchor.onTargetLost = () => {
                        log(`‚ùå CARTA ${i} PERDIDA`);
                        if(cartaActual === i) {
                            cartaDetectada = false;
                            cartaActual = null;
                            
                            document.getElementById('guia-scanner').classList.remove('verde');
                            document.getElementById('hint').innerText = "ESCANEA TU CARTA F√çSICA";
                            document.getElementById('pressure-status').innerText = 'Esperando carta...';
                            document.getElementById('pressure-status').style.color = '#f00';
                            
                            activarGemas(false);
                            resetPresion();
                        }
                    };
                }

                await mindarThree.start();
                log("‚úÖ MindAR INICIADO");
                
                navegar('p-resumen', 'ui-juego');
                document.getElementById('container-ar').style.background = "transparent";
                updHUD();
                configurarEventosGemas();

                renderer.setAnimationLoop(() => renderer.render(scene, camera));

            } catch (err) {
                log(`‚ùå ERROR: ${err.message}`);
                alert("Error de C√°mara: " + err.message);
                btn.innerText = "ERROR - REINTENTAR";
                btn.disabled = false;
            }
        };

        function updHUD() {
            const j = jugadores[tIdx];
            const div = document.getElementById('txt-turno');
            div.innerText = `${j.esc} MAGO: ${j.nombre}`;
            div.style.color = j.color;
            log(`üéÆ Turno: ${j.nombre}`);
        }

        function configurarEventosGemas() {
            log("üîß Configurando eventos de gemas...");
            
            const botones = [
                {id: 'btn-i', letra: 'I'},
                {id: 'btn-a', letra: 'A'},
                {id: 'btn-t', letra: 'T'},
                {id: 'btn-m', letra: 'M'}
            ];

            botones.forEach(({id, letra}) => {
                const btn = document.getElementById(id);
                
                btn.addEventListener('click', (e) => {
                    log(`üñ±Ô∏è Click en ${letra}`);
                    log(`  cartaDetectada: ${cartaDetectada}`);
                    log(`  activo: ${btn.classList.contains('activo')}`);
                    
                    if(!cartaDetectada || !btn.classList.contains('activo')) {
                        log(`  ‚ö†Ô∏è Click rechazado`);
                        return;
                    }
                    
                    log(`  ‚úÖ Click aceptado - Iniciando presi√≥n`);
                    
                    let presion = 0;
                    const interval = setInterval(() => {
                        presion += 20;
                        pressureData.current = presion;
                        if(pressureData.min === 0) pressureData.min = presion;
                        pressureData.max = Math.max(pressureData.max, presion);
                        actualizarVisualizacionPresion(presion);
                        
                        if(presion >= 100) {
                            clearInterval(interval);
                            log(`  üí• Presi√≥n completa - Activando ${letra}`);
                            
                            btn.style.transform = 'scale(1.5)';
                            setTimeout(() => {
                                if(confirm(`¬øConfirmar acci√≥n ${letra}?`)) {
                                    log(`  ‚úì Acci√≥n confirmada`);
                                    sig();
                                } else {
                                    log(`  ‚úó Acci√≥n cancelada`);
                                    btn.style.transform = 'scale(1.1)';
                                    resetPresion();
                                }
                            }, 300);
                        }
                    }, 50);
                });
                
                log(`  ‚úì ${letra} configurado`);
            });
            
            log("‚úÖ Eventos configurados");
        }
    </script>
</body>
</html>