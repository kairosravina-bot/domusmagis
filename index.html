<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOMUS MAGI - SISTEMA ESTABLE</title>
    
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <script type="module">
      import * as THREE from 'three';
      import { MindARThree } from 'mindar-image-three';

      // Base de datos para el HUD
      const CASAS_DB = {
        0: { nombre: "DRACO",  i: 6, t: 2, a: 1, m: 1, vid: "caelum.mp4", img: "draco.png" },
        1: { nombre: "AQUILA", i: 4, t: 2, a: 1, m: 3, vid: "caelum.mp4", img: "aquila.png" },
        2: { nombre: "LEO",    i: 4, t: 4, a: 1, m: 1, vid: "terra.mp4",  img: "leo.png" },
        3: { nombre: "APER",   i: 3, t: 5, a: 1, m: 1, vid: "terra.mp4",  img: "aper.png" }
      };

      let mindarThree = null;

      const init = async () => {
        const container = document.querySelector("#container");
        
        try {
          mindarThree = new MindARThree({
            container: container,
            imageTargetSrc: "./targets1.mind", 
            filterMinCF: 0.0001, 
            filterBeta: 0.001
          });

          const {renderer, scene, camera} = mindarThree;

          // Configurar los 4 Anchors como en la versión que te funcionó
          for (let i = 0; i < 4; i++) {
            const anchor = mindarThree.addAnchor(i);
            
            // Lógica del Layer (HUD) al encontrar carta
            anchor.onTargetFound = () => {
              const data = CASAS_DB[i];
              document.querySelector("#nombre-casa").innerText = "DOMUS " + data.nombre;
              document.querySelector("#val-i").innerText = data.i;
              document.querySelector("#val-t").innerText = data.t;
              document.querySelector("#val-a").innerText = data.a;
              document.querySelector("#val-m").innerText = data.m;
              
              // Actualizar imagen y video del Visor Superior
              const video = document.querySelector("#video-background");
              video.src = data.vid;
              video.play();
              
              const img = document.querySelector("#hud-img-escudo");
              img.src = data.img;
              img.style.display = "block";
            };

            anchor.onTargetLost = () => {
              // Mantenemos los datos visibles para el modo táctico
            };
          }

          await mindarThree.start();

          renderer.setAnimationLoop(() => {
            renderer.render(scene, camera);
          });

        } catch (err) {
          console.error("Error inicializando AR:", err);
        }
      }

      document.querySelector("#startButton").addEventListener("click", () => {
        document.querySelector("#ui-inicio").style.display = "none";
        init();
      });
    </script>

    <style>
      body { margin: 0; background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; color: white; }

      /* PANTALLA DE INICIO (ESTÉTICA VIOLETA SOLICITADA) */
      #ui-inicio {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #1a0033; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center;
      }
      #startButton {
        padding: 25px 50px; font-size: 24px; background: #6a0dad; color: white;
        border: 4px solid #fff; border-radius: 50px; cursor: pointer; font-weight: bold;
        box-shadow: 0 0 30px #6a0dad;
      }

      /* 1. VISOR MÍSTICO (ZONA ALTA 33%) */
      #visor-superior {
        position: absolute; top: 0; width: 100%; height: 33vh;
        background: #000; border-bottom: 2px solid gold; z-index: 100; overflow: hidden;
      }
      #video-background { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }

      /* LAYER DE DATOS SOBRE EL VIDEO */
      #hud-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; justify-content: space-between; padding: 10px; box-sizing: border-box; pointer-events: none;
      }
      .hud-escudo { width: 60px; height: 60px; border: 2px solid white; border-radius: 5px; }
      .hud-stats { text-align: right; font-family: monospace; }
      .stat-line { font-size: 18px; font-weight: bold; text-shadow: 1px 1px 2px #000; }

      /* 2. VENTANA DE REALIDAD (ZONA MEDIA 40%) */
      #container { position: absolute; top: 33vh; width: 100%; height: 40vh; z-index: 1; }

      /* 3. PANEL DE MANDO (ZONA BAJA 27%) */
      #panel-mando {
        position: absolute; bottom: 0; width: 100%; height: 27vh;
        background: #0a0a0a; z-index: 100; display: flex; justify-content: center; align-items: center; gap: 15px; border-top: 2px solid #333;
      }
      .btn {
        width: 55px; height: 55px; border-radius: 10px; border: 2px solid white;
        font-size: 22px; font-weight: bold; display: flex; justify-content: center; align-items: center;
      }
      .btn-i { background: #b00; } .btn-t { background: #555; }
      .btn-a { background: #080; } .btn-m { background: #60a; }
      #btn-combate { width: 80px; height: 80px; border-radius: 50%; background: gold; color: black; border: 4px solid #fff; font-weight: bold; font-size: 12px; }
    </style>
  </head>
  <body>

    <!-- INICIO -->
    <div id="ui-inicio">
      <div style="font-size: 60px; margin-bottom: 10px;">⚡⚡</div>
      <button id="startButton">INICIAR ESCANEO</button>
      <div style="color: #6a0dad; margin-top: 20px; font-weight: bold;">DOMUS MAGI v.4.1</div>
    </div>

    <!-- ZONA 1: VISOR (CON EL LAYER) -->
    <div id="visor-superior">
      <video id="video-background" loop playsinline muted></video>
      <div id="hud-layer">
        <img id="hud-img-escudo" src="" class="hud-escudo" style="display:none;">
        <div class="hud-stats">
          <div id="nombre-casa" style="font-size: 20px; color: gold; margin-bottom: 5px;">BUSCANDO...</div>
          <div class="stat-line" style="color:#ff4444">I: <span id="val-i">0</span></div>
          <div class="stat-line" style="color:#ccc">T: <span id="val-t">0</span></div>
          <div class="stat-line" style="color:#44ff44">A: <span id="val-a">0</span></div>
          <div class="stat-line" style="color:#bb44ff">M: <span id="val-m">0</span></div>
        </div>
      </div>
    </div>

    <!-- ZONA 2: CÁMARA (ESTABLE) -->
    <div id="container"></div>

    <!-- ZONA 3: MANDO -->
    <div id="panel-mando">
      <div class="btn btn-i">I</div>
      <div class="btn btn-t">T</div>
      <button id="btn-combate">COMBATE</button>
      <div class="btn btn-a">A</div>
      <div class="btn btn-m">M</div>
    </div>

  </body>
</html>