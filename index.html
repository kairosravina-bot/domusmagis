<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI - INTERFAZ 1/3</title>
    
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <script type="module">
      import * as THREE from 'three';
      import { MindARThree } from 'mindar-image-three';

      // Base de datos (incluye campo 'arma')
      const CASAS_DB = {
        0: { nombre: "DRACO",  arma: "ALIENTO DE FUEGO", i: 6, t: 2, a: 1, m: 1, vid: "caelum.mp4", img: "draco.png" },
        1: { nombre: "AQUILA", arma: "GARRA CELESTIAL",  i: 4, t: 2, a: 1, m: 3, vid: "caelum.mp4", img: "aquila.png" },
        2: { nombre: "LEO",    arma: "RUGIDO SONICO",    i: 4, t: 4, a: 1, m: 1, vid: "terra.mp4",  img: "leo.png" },
        3: { nombre: "APER",   arma: "COLMILLO VELOZ",   i: 3, t: 5, a: 1, m: 1, vid: "terra.mp4",  img: "aper.png" }
      };

      let mindarThree = null;
      let currentData = null; // Guarda la carta actual

      const init = async () => {
        const container = document.querySelector("#zona-scanner");
        
        try {
          mindarThree = new MindARThree({
            container: container,
            imageTargetSrc: "./targets1.mind", 
            filterMinCF: 0.0001, 
            filterBeta: 0.001
          });

          const {renderer, scene, camera} = mindarThree;

          for (let i = 0; i < 4; i++) {
            const anchor = mindarThree.addAnchor(i);
            
            anchor.onTargetFound = () => {
              currentData = CASAS_DB[i];
              
              // 1. Preparar Video (Pausado al inicio)
              const video = document.querySelector("#video-main");
              if(video.src !== currentData.vid) {
                 video.src = currentData.vid;
              }
              video.pause();

              // 2. Actualizar INFO LÍNEA 1 (Estática)
              document.querySelector("#img-escudo").src = currentData.img;
              document.querySelector("#img-escudo").style.display = "block";
              
              document.querySelector("#txt-linea1").innerHTML = 
                `<span style="color:gold; font-weight:bold;">${currentData.nombre}</span> / ${currentData.arma}`;

              // 3. Limpiar LÍNEA 2 (Dinámica)
              document.querySelector("#txt-linea2").innerHTML = "SELECCIONE ATRIBUTO";

              // 4. Habilitar Botones
              const btnCont = document.querySelector("#contenedor-botones");
              btnCont.classList.remove("disabled");
            };
          }

          await mindarThree.start();
          renderer.setAnimationLoop(() => {
            renderer.render(scene, camera);
          });

        } catch (err) {
          console.error("Error AR:", err);
        }
      }

      // Lógica Global de Botones
      window.activarPoder = (tipo, label) => {
        if (!currentData) return; // Si no hay carta, no hace nada

        // 1. Obtener valor
        const valor = currentData[tipo];

        // 2. Actualizar LÍNEA 2
        const colores = { i: '#f44', t: '#ccc', a: '#4f4', m: '#d4f' };
        document.querySelector("#txt-linea2").innerHTML = 
          `<span style="color:${colores[tipo]}; font-size: 22px; font-weight:bold;">${label}: ${valor}</span>`;

        // 3. Ejecutar Video
        const video = document.querySelector("#video-main");
        video.currentTime = 0;
        video.play();
      };

      document.querySelector("#btn-start").addEventListener("click", () => {
        document.querySelector("#pantalla-inicio").style.display = "none";
        init();
      });
    </script>

    <style>
      /* RESET Y ESTRUCTURA GLOBAL */
      * { box-sizing: border-box; }
      body { 
        margin: 0; padding: 0; 
        background: #000; 
        font-family: 'Segoe UI', sans-serif; 
        overflow: hidden; /* Evita scroll */
        height: 100vh; 
        width: 100vw;
        color: white;
        display: flex;
        flex-direction: column;
      }

      /* PANTALLA DE INICIO */
      #pantalla-inicio {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #1a0033; z-index: 9999; 
        display: flex; flex-direction: column; 
        justify-content: center; align-items: center;
      }
      #btn-start {
        padding: 15px 40px; font-size: 20px; background: gold; color: black;
        border: none; border-radius: 5px; font-weight: bold; cursor: pointer;
      }

      /* --- ZONA 1: VISOR (33.33%) --- */
      #zona-visor {
        height: 33.33vh;
        width: 100%;
        background: #000;
        position: relative;
        border-bottom: 2px solid gold;
      }
      #video-main {
        width: 100%; height: 100%; object-fit: cover;
      }

      /* --- ZONA 2: ESCÁNER (33.33%) --- */
      #zona-scanner {
        height: 33.33vh;
        width: 100%;
        background: #222;
        position: relative;
        overflow: hidden;
      }

      /* --- ZONA 3: INFO Y BOTONES (33.33%) --- */
      #zona-controles {
        height: 33.34vh; /* Ajuste decimal para llenar */
        width: 100%;
        background: #111;
        display: flex;
        flex-direction: column;
        border-top: 2px solid gold;
      }

      /* Parte A: Información (2 líneas) */
      #panel-info {
        flex: 1; /* Ocupa el espacio que sobra arriba de los botones */
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 0 15px;
        background: #1a1a1a;
      }

      .linea-info {
        display: flex; align-items: center; gap: 10px;
        margin-bottom: 5px;
        min-height: 30px;
      }
      
      #img-escudo { width: 40px; height: 40px; object-fit: contain; display: none; }
      
      #txt-linea1 { font-size: 14px; text-transform: uppercase; color: #aaa; }
      #txt-linea2 { font-size: 16px; font-family: monospace; color: white; letter-spacing: 1px; }

      /* Parte B: Botonera (Fija abajo) */
      #contenedor-botones {
        height: 80px; /* Altura fija para botones cómodos */
        display: flex;
        justify-content: space-around;
        align-items: center;
        background: #000;
        padding-bottom: 5px; /* Margen seguridad inferior */
        transition: opacity 0.3s;
      }
      
      /* Estado deshabilitado visualmente */
      #contenedor-botones.disabled {
        opacity: 0.3; pointer-events: none;
      }

      .btn-stat {
        width: 60px; height: 60px;
        border-radius: 10px;
        border: 2px solid #555;
        font-size: 24px; font-weight: bold;
        display: flex; justify-content: center; align-items: center;
        background: #222;
        color: white;
        cursor: pointer;
      }
      
      /* Colores Borde/Estilo Botones */
      .btn-i { border-color: #f44; box-shadow: 0 0 5px #f44 inset; }
      .btn-t { border-color: #ccc; box-shadow: 0 0 5px #ccc inset; }
      .btn-a { border-color: #4f4; box-shadow: 0 0 5px #4f4 inset; }
      .btn-m { border-color: #d4f; box-shadow: 0 0 5px #d4f inset; }

      .btn-stat:active { transform: scale(0.95); background: #333; }

    </style>
  </head>
  <body>

    <!-- PANTALLA CARGA -->
    <div id="pantalla-inicio">
      <h2 style="color:gold; margin-bottom:20px;">DOMUS MAGI</h2>
      <button id="btn-start">INICIAR SISTEMA</button>
    </div>

    <!-- 1/3 ARRIBA: VIDEO -->
    <div id="zona-visor">
      <video id="video-main" loop playsinline muted></video>
    </div>

    <!-- 1/3 MEDIO: CÁMARA AR -->
    <div id="zona-scanner">
      <!-- MindAR inyecta el video aquí -->
    </div>

    <!-- 1/3 ABAJO: INFO + BOTONES -->
    <div id="zona-controles">
      
      <!-- Panel de Texto (Arriba de los botones) -->
      <div id="panel-info">
        <!-- Línea 1: Detección -->
        <div class="linea-info">
          <img id="img-escudo" src="">
          <div id="txt-linea1">ESCANEE UNA CARTA</div>
        </div>
        <!-- Línea 2: Resultado Botón -->
        <div class="linea-info" style="justify-content: center; background: #000; border-radius: 5px;">
          <div id="txt-linea2">...</div>
        </div>
      </div>

      <!-- Los 4 Botones -->
      <div id="contenedor-botones" class="disabled">
        <div class="btn-stat btn-i" onclick="activarPoder('i', 'INT')">I</div>
        <div class="btn-stat btn-t" onclick="activarPoder('t', 'TEC')">T</div>
        <div class="btn-stat btn-a" onclick="activarPoder('a', 'AGI')">A</div>
        <div class="btn-stat btn-m" onclick="activarPoder('m', 'MAG')">M</div>
      </div>

    </div>

  </body>
</html>