<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI V29 - ERGONOMIC UI</title>
    
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Courier New', Courier, monospace; background: #000; color: white; }
        
        #container-ar { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
        video { z-index: -2 !important; display: block !important; }

        .pantalla { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; z-index: 1000; background: #000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .oculto { display: none !important; }
        
        .btn-master {
            padding: 20px 30px; font-size: 20px; background: #bf00ff; color: white;
            border: 3px solid #fff; border-radius: 12px; cursor: pointer;
            box-shadow: 0 0 20px #bf00ff; text-transform: uppercase; font-weight: bold;
            margin: 10px; min-width: 250px;
        }

        /* --- NUEVA DISTRIBUCI√ìN ERGON√ìMICA V29 --- */
        #ui-juego { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; pointer-events: none; z-index: 500; }
        
        /* 1. ZONA AR (ARRIBA) - 45% */
        #zona-ar { 
            height: 45vh; width: 100%; position: relative; 
            background: transparent; /* Deja ver la c√°mara */
            display: flex; justify-content: center; align-items: center;
        }

        /* 2. ZONA INFO/VIDEO (MEDIO) - 25% */
        #zona-medio { 
            height: 25vh; width: 100%; 
            background: rgba(0,0,0,0.85); 
            border-top: 2px solid #bf00ff; border-bottom: 2px solid #bf00ff;
            pointer-events: auto; position: relative; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }

        /* 3. PANEL MANDO (ABAJO) - 30% */
        #panel-mando { 
            height: 30vh; background: rgba(10,10,10,0.98); 
            pointer-events: auto; display: flex; flex-direction: column; 
            align-items: center; justify-content: space-around; padding: 10px;
        }

        /* SCANNER FLOTANTE (Ahora est√° arriba) */
        #guia-scanner { width: 200px; height: 200px; border: 4px solid red; border-radius: 20px; transition: 0.3s; }
        #guia-scanner.verde { border-color: #0f0; box-shadow: 0 0 50px #0f0; }
        #guia-scanner.dorado { border-color: gold; box-shadow: 0 0 60px gold; }
        #guia-scanner.violeta { border-color: #bf00ff; box-shadow: 0 0 60px #bf00ff; }

        .btn-gema {
            width: 70px; height: 70px; border-radius: 12px; border: 2px solid #555;
            background: #222; color: #555; display: flex; flex-direction: column; align-items: center;
            justify-content: center; font-size: 10px; font-weight: bold;
            cursor: pointer; transition: all 0.3s; opacity: 0.5; padding: 2px; text-align: center;
        }
        .letra-grande { font-size: 20px; margin-bottom: 0px; display:block; }
        .label-peq { font-size: 8px; text-transform:uppercase; display:block; max-width: 100%; overflow:hidden; }
        .btn-gema.activo { opacity: 1; border-color: white; transform: scale(1.05); }

        /* VIDEO JUGADOR (En zona medio) */
        #video-player { 
            width: 100%; height: 100%; object-fit: contain; 
            display: none; position: absolute; top: 0; left: 0; 
            z-index: 50; background: black;
        }

        /* PANTALLA CAMBIO DE TURNO (INTERSTITIAL) */
        #pantalla-cambio-turno {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }
        
        /* VIDEO CLASH FINAL */
        #video-clash {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: black; z-index: 3000; object-fit: cover; display: none;
        }

        #info-rival {
            background: rgba(50,0,0,0.6); border: 1px solid red; 
            padding: 5px 10px; border-radius: 5px; font-size: 14px; color: #ffaaaa;
            margin-bottom: 5px; display: none;
        }

        #txt-turno { 
            position: absolute; top: 10px; left: 10px; 
            background: rgba(0,0,0,0.7); padding: 5px 10px; 
            border-radius: 5px; font-weight: bold; font-size: 14px; 
            border: 1px solid white; pointer-events: none;
        }

        #resultado-batalla { 
            background: rgba(10,10,10,0.98); padding: 10px; 
            border: 2px solid gold; border-radius: 15px; width: 100%; height: 90vh; 
            overflow-y: scroll; box-sizing: border-box;
        }
        .resultado-jugador { background: #222; margin: 15px 0; padding: 20px; border-radius: 12px; border-left: 8px solid #555; }
        .ganador { border-color: gold; background: #333; box-shadow: 0 0 25px rgba(255, 215, 0, 0.4); border: 2px solid gold; }
        .total-score { font-size: 50px; color: gold; margin: 10px 0; text-align: right; font-weight: 900; }
        .detalle-clash { font-size: 14px; margin: 5px 0; border-bottom: 1px solid #444; padding: 5px; display:flex; justify-content:space-between; }

    </style>
</head>
<body>

    <div id="container-ar"></div>
    
    <!-- VIDEO CLASH FINAL -->
    <video id="video-clash" playsinline webkit-playsinline></video>

    <!-- PANTALLA INTERMEDIA CAMBIO DE TURNO -->
    <div id="pantalla-cambio-turno">
        <h1 style="color:red; font-size:50px;">üõë</h1>
        <h2 style="color:white;">FIN DEL TURNO</h2>
        <p style="color:#aaa; max-width:80%;">Pasa el dispositivo al siguiente mago.</p>
        <hr style="width:50%; border-color:#333; margin: 20px 0;">
        <h3 style="color:gold;" id="next-player-name">¬øJUGADOR X?</h3>
        <button class="btn-master" onclick="confirmarCambioTurno()">¬°SOY YO, ESTOY LISTO!</button>
    </div>

    <!-- 1. PANTALLA INICIO -->
    <div id="p-inicio" class="pantalla">
        <button class="btn-master" onclick="irMenuPrincipal()">‚ö° INICIAR SISTEMA ‚ö°</button>
        <h2 style="color:#bf00ff; margin-top:20px;">DOMUS MAGI V29</h2>
        <p style="color:white;">ERGONOMIC UI</p>
    </div>

    <!-- 2. MEN√ö -->
    <div id="p-menu-principal" class="pantalla oculto">
        <video id="intro-video" src="https://kairosravina-bot.github.io/domusmagis/presentacion.mp4" playsinline webkit-playsinline muted style="width:100%; max-width:500px; border-radius:15px;"></video>
        <h1 style="color:#bf00ff;">‚öîÔ∏è BATALLA ‚öîÔ∏è</h1>
        <button class="btn-master" style="background:linear-gradient(135deg, #f00, #900);" onclick="seleccionarModo()">‚öîÔ∏è DUELO T√ÅCTICO</button>
    </div>

    <!-- 3. SETUP -->
    <div id="p-setup" class="pantalla oculto">
        <h2>REGISTRO DE MAGOS</h2>
        <div id="setup-selector">
            <button class="btn-master" onclick="setModo(2)">2 JUGADORES (1vs1)</button>
        </div>
        <div id="registro" class="oculto" style="text-align:center; width: 90%;">
            <input type="text" id="mago-nombre" placeholder="NOMBRE DEL MAGO" style="padding:15px; font-size:20px; width:100%; margin-bottom: 15px; color:black;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="registrarMago('TERRA','#ff0000','üõ°Ô∏è')" class="btn-master" style="background:#800; min-width:auto;">üõ°Ô∏è TERRA</button>
                <button onclick="registrarMago('CAELUM','#00aaff','‚öîÔ∏è')" class="btn-master" style="background:#005; min-width:auto;">‚öîÔ∏è CAELUM</button>
                <button onclick="registrarMago('AQUA','#00ff88','üíß')" class="btn-master" style="background:#040; min-width:auto;">üíß AQUA</button>
                <button onclick="registrarMago('DIMENSIO','#aa00ff','‚ú®')" class="btn-master" style="background:#404; min-width:auto;">‚ú® DIMENSIO</button>
            </div>
            <p id="reg-status" style="color:gold; margin-top:15px;"></p>
        </div>
    </div>

    <!-- 4. UI JUEGO AR (REDISE√ëADA) -->
    <div id="ui-juego" class="oculto">
        
        <!-- ZONA SUPERIOR: C√ÅMARA PURA -->
        <div id="zona-ar">
            <div id="txt-turno">TURNO: ---</div>
            <div id="guia-scanner"></div>
        </div>

        <!-- ZONA MEDIA: INFORMACI√ìN Y VIDEO -->
        <div id="zona-medio">
            <div id="info-rival">RIVAL US√ì: <span id="rival-last-move" style="color:white; font-weight:bold;">???</span></div>
            <div id="msg-visor" style="color:white; font-size:18px; font-weight:bold; z-index:10;">ESCANEA CARTA</div>
            <video id="video-player" playsinline webkit-playsinline></video>
        </div>

        <!-- ZONA INFERIOR: BOTONES -->
        <div id="panel-mando">
            <p id="hint" style="color:#aaa; margin:0;">SLOT DE BATALLA: <span id="slot-indicator" style="color:gold; font-size:20px;">1/3</span></p>
            <div style="display:flex; gap:10px; margin: 5px 0;">
                <button id="btn-i" class="btn-gema"><span class="letra-grande">I</span><span class="label-peq"></span></button>
                <button id="btn-a" class="btn-gema"><span class="letra-grande">A</span><span class="label-peq"></span></button>
                <button id="btn-t" class="btn-gema"><span class="letra-grande">T</span><span class="label-peq"></span></button>
                <button id="btn-m" class="btn-gema"><span class="letra-grande">M</span><span class="label-peq"></span></button>
            </div>
            <button id="btn-confirmar" class="btn-master" style="background:#0a0; padding:15px; width:95%; font-size:18px;">‚úÖ CONFIRMAR</button>
        </div>
    </div>

    <!-- 5. RESULTADOS -->
    <div id="p-resultado" class="pantalla oculto">
        <div id="resultado-batalla">
            <h2 style="color:gold; text-align:center;">RESULTADOS</h2>
            <div id="resultado-contenido"></div>
            <button class="btn-master" onclick="location.reload()" style="margin-top:20px; width:90%;">üîÑ NUEVA PARTIDA</button>
        </div>
    </div>

    <!-- LOGICA JS -->
    <script>
        const RUTA_BASE = "https://kairosravina-bot.github.io/domusmagis/";
        
        const VIDEOS_BATALLA = [
            "Explosi√≥n_Elemental.mp4", "El_B√∫ho_Juez.mp4", "Invocaciones_Et√©reas.mp4", "Escudos_vs_Espadas.mp4", "Choque_de_Energ√≠a.mp4"
        ];

        // BASE DE DATOS CARTAS
        const CARTAS = {
            0: { id: 0, nombre: "DRAG√ìN", elemento: "TERRA", imgEscudo: "ESCUDO_DRAGON.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "ATAQUE", valor: 7, video: "CARTA_1_ataque.mp4", color: "#900" }, "btn-a": { texto: "A", label: "CURA", valor: 2, video: "CARTA_1_cura.mp4", color: "#090" }, "btn-t": { texto: "T", label: "DEFENSA", valor: 3, video: "CARTA_1_defensa.mp4", color: "#555" }, "btn-m": { texto: "M", label: "MAGIA", valor: 2, video: "CARTA_1_magia.mp4", color: "#609" } } },
            1: { id: 1, nombre: "√ÅGUILA", elemento: "CAELUM", imgEscudo: "ESCUDO_AGUILA.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "PICADA", valor: 5, video: "ataque.mp4", color: "#900" }, "btn-a": { texto: "A", label: "VIENTO", valor: 4, video: "cura.mp4", color: "#090" }, "btn-t": { texto: "T", label: "ESQUIVA", valor: 2, video: "defensa.mp4", color: "#555" }, "btn-m": { texto: "M", label: "TORNADO", valor: 3, video: "magia.mp4", color: "#609" } } },
            2: { id: 2, nombre: "LE√ìN", elemento: "TERRA", imgEscudo: "ESCUDO_LEON.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "ZARPAZO", valor: 8, video: "ataque.mp4", color: "#900" }, "btn-a": { texto: "A", label: "RUGIDO", valor: 1, video: "cura.mp4", color: "#090" }, "btn-t": { texto: "T", label: "MELENA", valor: 4, video: "defensa.mp4", color: "#555" }, "btn-m": { texto: "M", label: "VALOR", valor: 1, video: "magia.mp4", color: "#609" } } },
            3: { id: 3, nombre: "JABAL√ç", elemento: "AQUA", imgEscudo: "ESCUDO_JABALI.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "EMBESTIDA", valor: 6, video: "ataque.mp4", color: "#900" }, "btn-a": { texto: "A", label: "BARRO", valor: 3, video: "cura.mp4", color: "#090" }, "btn-t": { texto: "T", label: "PIEL DURA", valor: 3, video: "defensa.mp4", color: "#555" }, "btn-m": { texto: "M", label: "PANTANO", valor: 2, video: "magia.mp4", color: "#609" } } },
            4: { id: 4, nombre: "B√öHO MASTER", elemento: "NEUTRO", imgEscudo: "ESCUDO_BUHO.png", tipo: "BUHO", botones: { "btn-i": { texto: "I", label: "MANDATUM", valor: 5, video: "owl_mandatum.mp4", color: "gold" }, "btn-a": { texto: "A", label: "CONSILIUM", valor: 5, video: "owl_consilium.mp4", color: "gold" }, "btn-t": { texto: "T", label: "PRAESAGIUM", valor: 5, video: "owl_praesagium.mp4", color: "gold" }, "btn-m": { texto: "M", label: "ARCANUM", valor: 5, video: "owl_arcanum.mp4", color: "gold" } } },
            5: { id: 5, nombre: "IGNIS PHIALA", elemento: "TERRA", imgEscudo: "ESCUDO_IGNIS.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "LANZAR", valor: 10, video: "ARTEFACTO_1_IMPETUS.mp4", color: "#bf00ff" }, "btn-a": { texto: "A", label: "BEBER", valor: 8, video: "ARTEFACTO_1_AUXILIUM.mp4", color: "#bf00ff" }, "btn-t": { texto: "T", label: "MURO", valor: 8, video: "ARTEFACTO_1_TUTELA.mp4", color: "#bf00ff" }, "btn-m": { texto: "M", label: "CATALIZAR", valor: 12, video: "ARTEFACTO_1_MYSTERIUM.mp4", color: "#bf00ff" } } },
            6: { id: 6, nombre: "SPECULUM AEGIS", elemento: "DIMENSIO", imgEscudo: "ESCUDO_ESPEJO.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "GOLPEAR", valor: 6, video: "ESPEJO_GOLPE.mp4", color: "#bf00ff" }, "btn-a": { texto: "A", label: "EQUIPAR", valor: 9, video: "ESPEJO_EQUIPAR.mp4", color: "#bf00ff" }, "btn-t": { texto: "T", label: "BLOQUEAR", valor: 10, video: "ESPEJO_BLOQUEO.mp4", color: "#bf00ff" }, "btn-m": { texto: "M", label: "INVOCAR", valor: 7, video: "ESPEJO_ILUSION.mp4", color: "#bf00ff" } } },
            7: { id: 7, nombre: "TEMPUS FUGIT", elemento: "DIMENSIO", imgEscudo: "ESCUDO_RELOJ.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "ACELERAR", valor: 8, video: "RELOJ_ACELERAR.mp4", color: "#bf00ff" }, "btn-a": { texto: "A", label: "REVERTIR", valor: 7, video: "RELOJ_REVERTIR.mp4", color: "#bf00ff" }, "btn-t": { texto: "T", label: "CONGELAR", valor: 10, video: "RELOJ_CONGELAR.mp4", color: "#bf00ff" }, "btn-m": { texto: "M", label: "ROMPER", valor: 15, video: "RELOJ_ROMPER.mp4", color: "#bf00ff" } } },
            8: { id: 8, nombre: "GRIMORIUM UMBRA", elemento: "DIMENSIO", imgEscudo: "ESCUDO_LIBRO.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "ABRIR", valor: 9, video: "LIBRO_ABRIR.mp4", color: "#bf00ff" }, "btn-a": { texto: "A", label: "LEER", valor: 8, video: "LIBRO_LEER.mp4", color: "#bf00ff" }, "btn-t": { texto: "T", label: "CERRAR", valor: 7, video: "LIBRO_CERRAR.mp4", color: "#bf00ff" }, "btn-m": { texto: "M", label: "QUEMAR", valor: 12, video: "LIBRO_QUEMAR.mp4", color: "#bf00ff" } } },
            9: { id: 9, nombre: "LAPIS AETHER", elemento: "CAELUM", imgEscudo: "ESCUDO_PIEDRA.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "DISPARAR", valor: 7, video: "PIEDRA_DISPARAR.mp4", color: "#bf00ff" }, "btn-a": { texto: "A", label: "ABSORBER", valor: 6, video: "PIEDRA_ABSORBER.mp4", color: "#bf00ff" }, "btn-t": { texto: "T", label: "CAMPO", valor: 9, video: "PIEDRA_CAMPO.mp4", color: "#bf00ff" }, "btn-m": { texto: "M", label: "ESTALLIDO", valor: 11, video: "PIEDRA_ESTALLIDO.mp4", color: "#bf00ff" } } }
        };

        let jugadores = [];
        let cantJugadores = 0;
        let slotActual = 0; 
        let turnoJugadorIdx = 0; 
        const MAX_SLOTS = 3;
        let jugadaPendiente = null; 

        function navegar(oc, mo) {
            document.getElementById(oc).classList.add('oculto');
            document.getElementById(mo).classList.remove('oculto');
        }

        function irMenuPrincipal() {
            navegar('p-inicio', 'p-menu-principal');
            const v = document.getElementById('intro-video');
            v.muted = false; v.play().catch(()=>{});
        }

        function seleccionarModo() { navegar('p-menu-principal', 'p-setup'); }
        function setModo(n) { cantJugadores = n; document.getElementById('setup-selector').classList.add('oculto'); document.getElementById('registro').classList.remove('oculto'); document.getElementById('reg-status').innerText = `Mago 1 de ${n}`; }

        function registrarMago(casa, color, esc) {
            let n = document.getElementById('mago-nombre').value || "Mago " + (jugadores.length + 1);
            jugadores.push({ nombre: n, casa, color, esc, slots: [null, null, null], puntos: 0 });
            document.getElementById('mago-nombre').value = "";
            if(jugadores.length === cantJugadores) { iniciarJuego(); } else { document.getElementById('reg-status').innerText = `Mago ${jugadores.length + 1} de ${cantJugadores}`; }
        }

        function iniciarJuego() {
            navegar('p-setup', 'ui-juego');
            window.iniciarAR();
            actualizarUI();
        }

        function actualizarUI() {
            const j = jugadores[turnoJugadorIdx];
            document.getElementById('txt-turno').innerText = `TURNO: ${j.nombre} (${j.esc})`;
            document.getElementById('txt-turno').style.color = j.color;
            document.getElementById('slot-indicator').innerText = `${slotActual + 1} / ${MAX_SLOTS}`;
            
            const infoRival = document.getElementById('info-rival');
            const txtRival = document.getElementById('rival-last-move');
            
            // Si es turno del J2, mostramos qu√© tir√≥ J1 en este slot
            if (turnoJugadorIdx === 1 && jugadores[0].slots[slotActual]) {
                infoRival.style.display = 'block';
                const cartaRival = jugadores[0].slots[slotActual];
                txtRival.innerText = `${cartaRival.nombre} (${cartaRival.elemento})`;
            } else {
                infoRival.style.display = 'none';
            }

            document.getElementById('msg-visor').style.display = 'block';
            document.getElementById('guia-scanner').className = '';
            resetBotones();
            jugadaPendiente = null;
        }

        // --- SISTEMA DE CAMBIO DE TURNO VISUAL ---
        function mostrarPantallaCambio() {
            const nextJ = jugadores[turnoJugadorIdx];
            document.getElementById('next-player-name').innerText = `TURNO DE: ${nextJ.nombre}`;
            document.getElementById('next-player-name').style.color = nextJ.color;
            document.getElementById('pantalla-cambio-turno').style.display = 'flex';
        }

        function confirmarCambioTurno() {
            document.getElementById('pantalla-cambio-turno').style.display = 'none';
            actualizarUI();
        }

    </script>

    <!-- MODULE AR -->
    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        let mindarThree = null;
        let cartaDetectada = null;
        
        const ui = {
            scanner: document.getElementById('guia-scanner'),
            msg: document.getElementById('msg-visor'),
            video: document.getElementById('video-player'),
            hint: document.getElementById('hint')
        };

        window.iniciarAR = async function() {
            if(mindarThree) return;
            console.log("üöÄ AR SYSTEM V29 (TOP CAM) ONLINE");
            
            mindarThree = new MindARThree({
                container: document.getElementById('container-ar'),
                imageTargetSrc: RUTA_BASE + 'targets1.mind', 
                maxTrack: 1, filterMinCF: 0.0001, filterBeta: 0.001,   
                uiLoading: "no", uiScanning: "no", uiError: "no"
            });

            const {renderer, scene, camera} = mindarThree;

            for(let i=0; i<10; i++) {
                const anchor = mindarThree.addAnchor(i);
                const plane = new THREE.Mesh(new THREE.PlaneGeometry(1,1), new THREE.MeshBasicMaterial({transparent:true, opacity:0}));
                anchor.group.add(plane);

                anchor.onTargetFound = () => {
                    cartaDetectada = CARTAS[i];
                    if(!cartaDetectada) return;
                    if(cartaDetectada.tipo === "ARTEFACTO") ui.scanner.className = 'violeta';
                    else if(cartaDetectada.tipo === "BUHO") ui.scanner.className = 'dorado';
                    else ui.scanner.className = 'verde';
                    ui.msg.innerText = cartaDetectada.nombre;
                    actualizarBotones(cartaDetectada);
                };
                
                anchor.onTargetLost = () => {
                    cartaDetectada = null;
                    ui.scanner.className = '';
                    ui.msg.innerText = "BUSCANDO CARTA...";
                    resetBotones();
                };
            }

            // EVENTOS BOTONES
            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                document.getElementById(id).onclick = () => {
                    if(!cartaDetectada) return;
                    const conf = cartaDetectada.botones[id];
                    let valNum = (typeof conf.valor === 'number' ? conf.valor : 5);
                    
                    jugadaPendiente = {
                        carta: cartaDetectada, lado: conf.label, valor: valNum, video: conf.video,
                        tipoLado: id.split('-')[1].toUpperCase() 
                    };

                    ui.video.style.display = 'block';
                    ui.video.src = RUTA_BASE + conf.video;
                    ui.msg.style.display = 'none';
                    ui.video.play().catch(e => console.log("Video error", e));
                    
                    ui.video.onended = () => {
                        ui.video.style.display = 'none';
                        ui.msg.style.display = 'block';
                        ui.msg.innerText = "¬°LISTO! CONFIRMA ABAJO";
                    };
                };
            });

            await mindarThree.start();
            renderer.setAnimationLoop(() => { renderer.render(scene, camera); });
        };

        // CONFIRMAR JUGADA -> CAMBIO DE TURNO
        document.getElementById('btn-confirmar').onclick = () => {
            if(!jugadaPendiente) { alert("¬°Primero escanea una carta y elige un lado!"); return; }

            jugadores[turnoJugadorIdx].slots[slotActual] = {
                nombre: jugadaPendiente.carta.nombre,
                elemento: jugadaPendiente.carta.elemento,
                lado: jugadaPendiente.lado,
                valor: jugadaPendiente.valor,
                tipoLado: jugadaPendiente.tipoLado
            };

            turnoJugadorIdx++;
            if(turnoJugadorIdx >= cantJugadores) {
                turnoJugadorIdx = 0;
                slotActual++;
            }

            if(slotActual >= MAX_SLOTS) {
                iniciarBatallaFinal();
            } else {
                // AQU√ç DISPARAMOS LA PANTALLA DE CAMBIO
                mostrarPantallaCambio(); 
            }
        };

        function iniciarBatallaFinal() {
            navegar('ui-juego', 'p-resultado'); 
            const vidRandom = VIDEOS_BATALLA[Math.floor(Math.random() * VIDEOS_BATALLA.length)];
            const vidClash = document.getElementById('video-clash');
            vidClash.style.display = 'block';
            vidClash.src = RUTA_BASE + vidRandom;
            vidClash.play().catch(e => console.error(e));
            vidClash.onended = () => {
                vidClash.style.display = 'none';
                mostrarResultadosComplejos();
            };
        }

        function mostrarResultadosComplejos() {
            navegar('ui-juego', 'p-resultado');
            const cont = document.getElementById('resultado-contenido');
            cont.innerHTML = '';
            let scoreJ1 = 0; let scoreJ2 = 0; let logBatalla = "";
            const j1 = jugadores[0]; const j2 = jugadores[1];

            for(let i=0; i<MAX_SLOTS; i++) {
                const c1 = j1.slots[i]; const c2 = j2.slots[i];
                let pts1 = c1.valor; let pts2 = c2.valor; let notas = "";

                if(c1.elemento === "TERRA" && c2.elemento === "AQUA") { pts1 += 3; notas += "üî• Quema üíß "; }
                if(c1.elemento === "AQUA" && c2.elemento === "CAELUM") { pts1 += 3; notas += "üíß Ahoga üå™Ô∏è "; }
                if(c1.elemento === "CAELUM" && c2.elemento === "TERRA") { pts1 += 3; notas += "üå™Ô∏è Burla üóø "; }
                if(c2.elemento === "TERRA" && c1.elemento === "AQUA") { pts2 += 3; notas += "üî• Quema üíß "; }
                if(c2.elemento === "AQUA" && c1.elemento === "CAELUM") { pts2 += 3; notas += "üíß Ahoga üå™Ô∏è "; }
                if(c2.elemento === "CAELUM" && c1.elemento === "TERRA") { pts2 += 3; notas += "üå™Ô∏è Burla üóø "; }
                if(c1.tipoLado === "I" && c2.tipoLado === "T") { pts2 += 4; notas += "üõ°Ô∏è Bloqueo! "; }
                if(c2.tipoLado === "I" && c1.tipoLado === "T") { pts1 += 4; notas += "üõ°Ô∏è Bloqueo! "; }

                scoreJ1 += pts1; scoreJ2 += pts2;
                logBatalla += `<div class="detalle-clash"><div style="text-align:left"><span style="color:${j1.color}">${c1.nombre}</span><br><small>${c1.lado} (${pts1})</small></div><div style="font-size:20px;">‚öîÔ∏è</div><div style="text-align:right"><span style="color:${j2.color}">${c2.nombre}</span><br><small>${c2.lado} (${pts2})</small></div></div><div style="text-align:center; font-size:10px; color:#aaa; margin-bottom:10px;">${notas}</div>`;
            }

            const d1 = Math.floor(Math.random()*6)+1;
            const d2 = Math.floor(Math.random()*6)+1;
            scoreJ1 += d1; scoreJ2 += d2;

            cont.innerHTML = `<div class="resultado-jugador ${scoreJ1 > scoreJ2 ? 'ganador' : ''}"><h3>${j1.nombre}</h3><div class="total-score">${scoreJ1}</div><small>Dado: +${d1}</small></div><div style="background:#111; padding:5px; border:1px dashed #555; margin:10px 0;">${logBatalla}</div><div class="resultado-jugador ${scoreJ2 > scoreJ1 ? 'ganador' : ''}"><h3>${j2.nombre}</h3><div class="total-score">${scoreJ2}</div><small>Dado: +${d2}</small></div>`;
        }

        function actualizarBotones(carta) {
            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                const b = document.getElementById(id); const conf = carta.botones[id];
                b.innerHTML = `<span class="letra-grande">${conf.texto}</span><span class="label-peq">${conf.label.substring(0,8)}</span>`;
                b.style.backgroundColor = conf.color; b.style.color = "#000"; b.style.fontWeight = "900"; b.classList.add('activo');
            });
        }
        function resetBotones() {
            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                const b = document.getElementById(id); const letra = id.split('-')[1].toUpperCase();
                b.innerHTML = `<span class="letra-grande">${letra}</span><span class="label-peq"></span>`;
                b.style.backgroundColor = '#222'; b.style.color = "#555"; b.classList.remove('activo');
            });
        }
    </script>
</body>
</html>