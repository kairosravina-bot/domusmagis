<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI V52: BATTLE DICE</title>
    
    <!-- LIBRER√çAS AR -->
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <style>
        /* =========================================
           1. FUENTES LOCALES (OFFLINE)
           ========================================= */
        @font-face {
            font-family: 'Cinzel';
            src: url('assets/fonts/Cinzel-Bold.ttf') format('truetype');
            font-weight: 700;
        }
        @font-face {
            font-family: 'Cinzel';
            src: url('assets/fonts/Cinzel-Black.ttf') format('truetype');
            font-weight: 900;
        }

        /* =========================================
           2. VARIABLES GLOBALES
           ========================================= */
        :root {
            /* FONDOS */
            --bg-piedra: linear-gradient(to bottom, #1a0505, #000000); 
            --bg-pergamino: #eecda3; 
            
            /* GEMAS */
            --gema-roja: linear-gradient(135deg, #ff3333 0%, #990000 100%);
            --gema-verde: linear-gradient(135deg, #33ff33 0%, #006600 100%);
            --gema-gris: linear-gradient(135deg, #e0e0e0 0%, #444444 100%);
            --gema-violeta: linear-gradient(135deg, #ff33ff 0%, #660066 100%);
            
            /* COLORES UI */
            --borde-dorado: #d4af37;
            --borde-hierro: #4a4a4a;
            
            /* FUENTES */
            --font-titulo: 'Cinzel', serif;
            --font-texto: 'Cinzel', serif;
        }

        /* ESTILOS GENERALES */
        body { 
            margin: 0; overflow: hidden; 
            font-family: var(--font-texto);
            background: var(--bg-piedra);
            color: #e0e0e0; 
            user-select: none;
            font-weight: 700;
        }
        
        #container-ar { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
        
        #container-ar::after {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 40%, #000 100%);
            pointer-events: none; z-index: 1;
        }

        video { display: block; } 

        .pantalla { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center;
            z-index: 1000; 
            background: rgba(0,0,0,0.92); 
            backdrop-filter: blur(5px);
            overflow-y: auto; padding: 20px; box-sizing: border-box; 
        }
        .oculto { display: none !important; }
        
        /* TIPOGRAF√çA */
        h1, h2, h3 { 
            font-family: var(--font-titulo); 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            text-shadow: 0 3px 6px rgba(0,0,0,1); 
            color: var(--borde-dorado); 
            margin: 15px 0; 
            text-align: center;
        }

        /* BOTONES MASTER */
        .btn-master {
            padding: 22px; 
            font-size: 22px;
            font-family: var(--font-titulo); font-weight: 900;
            background: linear-gradient(to bottom, #2b2b2b, #111);
            color: var(--borde-dorado);
            border: 2px solid var(--borde-dorado);
            border-radius: 8px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.1);
            margin: 12px 0; width: 100%; text-transform: uppercase;
            transition: transform 0.1s;
        }
        .btn-master:active { transform: scale(0.96); border-color: #fff; color: #fff; }

        .fila-juego { display: flex; width: 100%; gap: 15px; margin: 10px 0; }
        
        .btn-jugar { 
            flex: 2; padding: 25px; 
            font-size: 20px;
            font-family: var(--font-titulo); font-weight: 900; 
            background: linear-gradient(180deg, #8b0000, #3a0000);
            border: 2px solid #ffaa00; border-radius: 10px; cursor: pointer; color: white; 
            text-transform: uppercase; box-shadow: 0 5px 15px rgba(0,0,0,0.9);
            text-shadow: 2px 2px 0 #000;
        }
        
        .btn-info { flex: 0.5; font-size: 26px; background: #222; border: 1px solid #555; border-radius: 10px; color: #aaa; }

        .grid-casas { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        .btn-casa { 
            padding: 25px 5px; 
            font-size: 18px;
            font-family: var(--font-titulo); font-weight: 900;
            border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; 
            cursor: pointer; color: white; text-shadow: 2px 2px 0 #000; 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        input[type="text"] {
            background: rgba(0,0,0,0.6); border: 2px solid #555; color: white;
            padding: 20px;
            font-family: var(--font-texto); 
            font-size: 22px;
            font-weight: 700;
            border-radius: 5px; width: 100%; box-sizing: border-box; margin-bottom: 15px;
            text-align: center;
        }
        input[type="text"]:focus { border-color: var(--borde-dorado); outline: none; background: rgba(0,0,0,0.8); }

        /* ESTILOS PARA LOS BOTONES DE DADOS (SELECCI√ìN) */
        .grid-dados {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .btn-dado-sel {
            background: linear-gradient(145deg, #1a0505, #000);
            border: 2px solid #555;
            color: #ccc;
            padding: 20px 10px;
            border-radius: 10px;
            font-family: var(--font-titulo);
            cursor: pointer;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .btn-dado-sel:active { transform: translateY(2px); }
        
        /* ESTILO "TAGEADO" (SELECCIONADO) */
        .btn-dado-sel.tageado {
            border-color: var(--borde-dorado);
            background: linear-gradient(145deg, #500, #200);
            color: #fff;
            box-shadow: 0 0 15px var(--borde-dorado);
        }

        .btn-dado-sel span { font-size: 12px; color: #777; margin-top: 5px; font-weight: 400; }
        .btn-dado-sel.tageado span { color: gold; }
        .btn-dado-sel strong { font-size: 20px; font-weight: 900; }

        /* UI JUEGO */
        #ui-juego { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-start; z-index: 500; pointer-events: none; }
        
        #zona-superior { 
            height: 55%; width: 100%; position: relative; 
            display: flex; justify-content: center; align-items: center;
            border-bottom: 4px solid var(--borde-dorado); 
            box-shadow: 0 5px 20px #000;
        }

        #txt-turno { 
            position: absolute; top: 15px; left: 15px; z-index: 15;
            background: rgba(0,0,0,0.8); color: var(--borde-dorado); padding: 10px 20px; 
            border: 2px solid var(--borde-dorado); font-family: var(--font-titulo); font-weight: 900; 
            font-size: 22px;
            box-shadow: 0 0 15px #000; border-radius: 5px;
        }

        #hud-derecho {
            position: absolute; top: 15px; right: 15px; z-index: 50;
            display: none; flex-direction: column; align-items: flex-end;
            text-align: right; pointer-events: none;
        }
        #hud-img-escudo { width: 80px; height: 80px; object-fit: contain; margin-bottom: 5px; filter: drop-shadow(0 0 5px gold); }
        .hud-fila-datos {
            display: flex; align-items: center; gap: 10px;
            background: linear-gradient(to left, rgba(0,0,0,0.9), transparent); 
            padding: 5px 15px; border-right: 4px solid gold; margin-top: 5px;
        }
        #hud-txt-accion { font-size: 20px; color: white; font-family: var(--font-titulo); text-transform: uppercase; font-weight: 900; }
        #hud-txt-valor { font-size: 50px; color: gold; font-family: var(--font-titulo); line-height: 1; text-shadow: 0 0 10px orange; font-weight: 900; }

        #guia-scanner { width: 220px; height: 220px; border: 4px solid rgba(255,255,255,0.2); border-radius: 20px; transition: 0.3s; z-index: 10; box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative; }
        #guia-scanner::after { content: "+"; position: absolute; top:50%; left:50%; transform:translate(-50%, -50%); color: rgba(255,255,255,0.2); font-size: 40px; }
        #guia-scanner.verde { border-color: #0f0; box-shadow: 0 0 40px #0f0, inset 0 0 20px #0f0; }
        #guia-scanner.dorado { border-color: gold; box-shadow: 0 0 40px gold, inset 0 0 20px gold; }
        #guia-scanner.violeta { border-color: #d0f; box-shadow: 0 0 40px #d0f, inset 0 0 20px #d0f; }

        #video-action { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; background: black; z-index: 20; display: none; }

        #zona-inferior { 
            height: 45%; width: 100%; 
            background: linear-gradient(to bottom, #1a1a1a, #000); 
            border-top: 1px solid #333;
            pointer-events: auto; display: flex; flex-direction: column; 
            align-items: center; justify-content: space-around; padding: 10px 15px;
            box-shadow: inset 0 10px 30px rgba(0,0,0,0.9); box-sizing: border-box;
        }

        #info-rival {
            width: 100%; background: rgba(50,0,0,0.8); padding: 8px; border: 1px solid red; 
            display: none; font-size: 16px; text-align: center; margin-bottom: 5px; 
            font-family: var(--font-titulo); color: #ffaaaa; font-weight: 900;
        }

        #slot-container { font-size: 20px; color: #aaa; margin: 0; font-family: var(--font-titulo); font-weight: 700; }
        #slot-indicator { font-size: 32px; color: var(--borde-dorado); font-weight: 900; }

        .contenedor-gemas { display: flex; gap: 15px; margin: 5px 0; justify-content: center; }
        
        .btn-gema {
            width: 70px; height: 70px; border-radius: 15px; 
            border: 2px solid #555;
            background-color: #222; 
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; cursor: pointer; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 4px 0px #000;
            position: relative; overflow: hidden;
        }
        
        #btn-i { background: var(--gema-roja); border-color: #500; }
        #btn-a { background: var(--gema-verde); border-color: #040; }
        #btn-t { background: var(--gema-gris); border-color: #666; }
        #btn-m { background: var(--gema-violeta); border-color: #400080; }

        .letra-grande { 
            font-size: 28px; font-weight: 900; 
            color: rgba(255,255,255,0.9); 
            text-shadow: 0 2px 4px #000; 
            font-family: var(--font-titulo); z-index: 2; 
        }
        
        .btn-gema:active, .btn-gema.activo { 
            border-color: white; 
            transform: translateY(4px); 
            box-shadow: 0 0 0 #000; 
            filter: brightness(1.2);
        }
        .btn-gema.activo { box-shadow: 0 0 20px currentColor; }

        /* MODALES */
        #modal-dados-fase {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.96); z-index: 9500; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
        }
        .dados-container { 
            position: relative; width: 280px; height: 280px; 
            border: 5px solid var(--borde-dorado); 
            box-shadow: 0 0 60px rgba(212, 175, 55, 0.4); 
            border-radius: 50%; overflow: hidden; margin: 10px 0; background: black; 
        }
        .video-dados { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }
        .layer-valor {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; align-items: center; justify-content: center;
            font-size: 120px; color: white; font-family: var(--font-titulo);
            text-shadow: 0 0 20px #bf00ff, 4px 4px 0 #000;
        }

        #modal-batalla { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: #000; z-index: 9999; 
            display: none; flex-direction: column; 
            align-items: center; justify-content: flex-start; padding-top: 60px; 
        }
        #texto-vs { 
            color: var(--borde-dorado); font-size: 36px; 
            font-family: var(--font-titulo); margin-bottom: 30px; 
            text-align: center; text-shadow: 0 0 30px orange; 
        }
        #video-clash { width: 100%; max-width: 500px; aspect-ratio: 1/1; object-fit: contain; border-top: 4px solid gold; border-bottom: 4px solid gold; }
        
        #pantalla-cambio-turno { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: #000; z-index: 8000; display: none; 
            flex-direction: column; align-items: center; justify-content: center; text-align: center;
            background: var(--bg-piedra);
        }

        /* RESULTADOS */
        #resultado-batalla { 
            width: 100%; flex-grow: 1; overflow-y: auto; padding-bottom: 20px; 
            background: var(--bg-pergamino);
            border-radius: 5px;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.5), 0 0 20px rgba(0,0,0,0.5);
            padding: 20px;
            color: #331a00; 
            position: relative;
        }
        
        .resultado-jugador { 
            background: rgba(255,255,255,0.15); 
            margin: 15px 0; padding: 15px; 
            border-bottom: 2px solid #8b4513; 
        }
        .ganador { 
            border: 4px double #d4af37; 
            background: rgba(255, 215, 0, 0.2); 
            position: relative;
        }
        .ganador::after { content: "üëë"; position: absolute; top: -15px; right: 10px; font-size: 30px; }

        .total-score { font-size: 70px; color: #8b0000; font-family: var(--font-titulo); text-align: right; line-height: 1; margin-top: 10px; }
        
        .fila-res { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-bottom: 1px dashed #8b4513; padding-bottom: 2px; }
        .res-accion { font-size: 18px; font-weight: 900; text-transform: uppercase; }
        .res-valor { font-size: 26px; font-weight: 900; font-family: var(--font-titulo); }
        
        .fila-dado { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; background: rgba(0,0,0,0.05); padding: 5px; border-radius: 5px; }
        .dado-gigante-res { font-size: 40px; color: #333; }

        #seccion-historial { 
            width: 100%; margin-top: 20px; border-top: 4px double var(--borde-dorado); padding-top: 15px; 
            padding-bottom: 50px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 10px;
        }
        .item-historial {
            background: #111; padding: 15px; margin-bottom: 5px; border-radius: 4px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 3px solid #555; color: #aaa; font-size: 16px; font-weight: 700;
        }
        .item-historial strong { color: var(--borde-dorado); }
    </style>
</head>
<body>

    <div id="container-ar"></div>

    <!-- MODAL FASE DE DADOS (AHORA CON BOTONES DE SELECCION) -->
    <div id="modal-dados-fase">
        <h2 style="color:#aaa; margin:0;">DESTINO</h2>
        <h1 id="dados-player-name" style="font-size:36px; margin:5px 0;">JUGADOR 1</h1>
        
        <div class="dados-container">
            <video id="video-dados-batalla" class="video-dados" src="https://kairosravina-bot.github.io/domusmagis/Dados.mp4" playsinline webkit-playsinline muted></video>
            <div id="layer-valor-batalla" class="layer-valor">0</div>
        </div>

        <h3 style="margin: 0; margin-top:5px; color:#888; font-size:14px;">SELECCIONA TUS DADOS:</h3>
        
        <!-- GRID DE DADOS EN BATALLA (SE MANTIENE TAGEADO) -->
        <div class="grid-dados" id="grid-dados-batalla">
            <div class="btn-dado-sel" id="btn-batalla-2" onclick="ejecutarLanzamientoBatalla(2)">
                <strong>2</strong><span>(12)</span>
            </div>
            <div class="btn-dado-sel" id="btn-batalla-3" onclick="ejecutarLanzamientoBatalla(3)">
                <strong>3</strong><span>(18)</span>
            </div>
            <div class="btn-dado-sel" id="btn-batalla-4" onclick="ejecutarLanzamientoBatalla(4)">
                <strong>4</strong><span>(24)</span>
            </div>
            <div class="btn-dado-sel" id="btn-batalla-5" onclick="ejecutarLanzamientoBatalla(5)">
                <strong>5</strong><span>(30)</span>
            </div>
        </div>
    </div>
    
    <!-- MODAL BATALLA FINAL -->
    <div id="modal-batalla">
        <div id="texto-vs">BATALLA FINAL</div>
        <video id="video-clash" playsinline webkit-playsinline></video>
    </div>

    <!-- PANTALLA CAMBIO TURNO -->
    <div id="pantalla-cambio-turno">
        <h1 style="font-size:50px; color: #ff4444; text-shadow:0 0 20px red;">üõë ALTO üõë</h1>
        <p style="font-size:22px; color:#aaa;">ES EL TURNO DE:</p>
        <h2 style="color:var(--borde-dorado); font-size:50px;" id="next-player-name">JUGADOR</h2>
        <button class="btn-master" style="margin-top:30px; width:80%;" onclick="confirmarCambioTurno()">TOMAR EL MANDO</button>
    </div>

    <!-- 1. INICIO -->
    <div id="p-inicio" class="pantalla">
        <div style="display:flex; flex-direction:column; align-items:center; gap: 30px;">
            <div>
                <h1 style="font-size: 60px; line-height:1; text-align:center; color: var(--borde-dorado); margin-bottom: 5px;">DOMUS<br><span style="color:#fff;">MAGI</span></h1>
                <p style="letter-spacing:5px; color:#888; text-align:center; margin:0; font-size: 18px;">REVELATIONS V52</p>
            </div>
            
            <button class="btn-master" style="width: 280px; border-color: #fff; background: linear-gradient(to bottom, #500, #200);" onclick="irMenuPrincipal()">ENTRAR AL GRIMORIO</button>
        </div>
    </div>

    <!-- 2. MEN√ö PRINCIPAL -->
    <div id="p-menu-principal" class="pantalla oculto">
        <video id="intro-video" src="https://kairosravina-bot.github.io/domusmagis/presentacion.mp4" playsinline webkit-playsinline muted style="width:100%; border:2px solid var(--borde-dorado); border-radius:10px; margin-bottom:20px; opacity:0.8;"></video>
        
        <div class="fila-juego">
            <button class="btn-jugar" onclick="seleccionarModo()">‚öîÔ∏è DUELO T√ÅCTICO</button>
            <button class="btn-info" onclick="alert('Modo Estandar: 3 Cartas + Dados Selectivos')">?</button>
        </div>
        <div class="fila-juego">
            <button class="btn-jugar" style="background:#222; border-color:#555;" onclick="alert('Requiere Expansi√≥n B√∫ho')">ü¶â MISIONES (WIP)</button>
        </div>
        <div class="fila-juego">
            <button class="btn-jugar" style="background:#333; border-color:#555;" onclick="irDados()">üé≤ OR√ÅCULO (SOLO)</button>
        </div>
    </div>

    <!-- 3. PANTALLA DADOS (MODO OR√ÅCULO - HERRAMIENTA) -->
    <div id="p-dados" class="pantalla oculto">
        <h1 style="margin-bottom: 10px;">OR√ÅCULO</h1>
        
        <!-- VIDEO ARRIBA -->
        <div class="dados-container">
            <video id="video-dados-solo" class="video-dados" src="https://kairosravina-bot.github.io/domusmagis/Dados.mp4" playsinline webkit-playsinline muted></video>
            <div id="layer-valor-solo" class="layer-valor">?</div>
        </div>
        
        <!-- 4 BOTONES ABAJO -->
        <h3 style="margin: 0; margin-top:10px; color:#888; font-size:14px;">SELECCIONA PODER:</h3>
        
        <div class="grid-dados">
            <div class="btn-dado-sel" onclick="tirarDadosCustom(2)">
                <strong>2</strong><span>(12)</span>
            </div>
            <div class="btn-dado-sel" onclick="tirarDadosCustom(3)">
                <strong>3</strong><span>(18)</span>
            </div>
            <div class="btn-dado-sel" onclick="tirarDadosCustom(4)">
                <strong>4</strong><span>(24)</span>
            </div>
            <div class="btn-dado-sel" onclick="tirarDadosCustom(5)">
                <strong>5</strong><span>(30)</span>
            </div>
        </div>

        <button class="btn-master" onclick="navegar('p-dados','p-menu-principal')" style="background:#333; border-color:#555;">VOLVER</button>
    </div>

    <!-- 4. SETUP -->
    <div id="p-setup" class="pantalla oculto">
        <h2>INSCRIPCI√ìN</h2>
        <div id="setup-selector" style="display:flex; gap:10px; width:100%;">
            <button class="btn-master" onclick="setModo(2)">2 MAGOS</button>
            <button class="btn-master" onclick="setModo(4)">4 MAGOS</button>
        </div>
        <div id="registro" class="oculto" style="width:100%;">
            <input type="text" id="mago-nombre" placeholder="NOMBRE DEL MAGO">
            <div class="grid-casas">
                <button onclick="registrarMago('TERRA','#ff0000','ESCUDO_DRAGON.png')" class="btn-casa" style="background:#500; border-color:#f00;">üõ°Ô∏è TERRA</button>
                <button onclick="registrarMago('CAELUM','#00aaff','ESCUDO_AGUILA.png')" class="btn-casa" style="background:#003; border-color:#0af;">‚öîÔ∏è CAELUM</button>
                <button onclick="registrarMago('AQUA','#00ff88','ESCUDO_JABALI.png')" class="btn-casa" style="background:#030; border-color:#0f8;">üíß AQUA</button>
                <button onclick="registrarMago('DIMENSIO','#aa00ff','ESCUDO_ESPEJO.png')" class="btn-casa" style="background:#303; border-color:#d0f;">‚ú® DIMENSIO</button>
            </div>
            <p id="reg-status" style="color:var(--borde-dorado); text-align:center; font-size:24px; margin-top:20px; font-weight:900;"></p>
        </div>
    </div>

    <!-- 5. UI JUEGO -->
    <div id="ui-juego" class="oculto">
        <div id="zona-superior">
            <div id="txt-turno">TURNO: ---</div>
            <div id="hud-derecho">
                <img id="hud-img-escudo" src="" alt="Escudo">
                <div class="hud-fila-datos">
                    <span id="hud-txt-accion">ACCION</span>
                    <span id="hud-txt-valor">00</span>
                </div>
            </div>
            <div id="guia-scanner"></div>
            <video id="video-action" playsinline webkit-playsinline></video>
        </div>

        <div id="zona-inferior">
            <div id="info-rival">
                RIVAL JUG√ì: <span id="rival-last-move" style="font-weight:900; color:white; font-size:20px;">???</span>
            </div>
            <div id="msg-visor" style="font-size:26px; color:var(--borde-dorado); font-weight:900; font-family:var(--font-titulo); text-shadow:0 0 10px #000;">ESCANEA CARTA</div>
            <p id="slot-container">SLOT: <span id="slot-indicator">1/3</span></p>
            
            <div class="contenedor-gemas">
                <button id="btn-i" class="btn-gema"><span class="letra-grande">I</span></button>
                <button id="btn-a" class="btn-gema"><span class="letra-grande">A</span></button>
                <button id="btn-t" class="btn-gema"><span class="letra-grande">T</span></button>
                <button id="btn-m" class="btn-gema"><span class="letra-grande">M</span></button>
            </div>
            
            <div style="display:flex; gap:10px; width:100%;">
                <button id="btn-confirmar" class="btn-master" style="background:#050; border-color:#0f0; padding:15px; margin:0; flex:2;">‚úÖ CONFIRMAR</button>
                <button id="btn-forzar" class="btn-master" style="background:#500; padding:15px; margin:0; font-size:14px;" onclick="forzarBatalla()">‚öîÔ∏è YA</button>
            </div>
        </div>
    </div>

    <!-- 6. RESULTADOS -->
    <div id="p-resultado" class="pantalla oculto">
        <h2 style="color:#331a00; font-size:40px; text-shadow:none; border-bottom:2px solid #8b4513; padding-bottom:10px; width:100%; text-align:center;">DECRETO FINAL</h2>
        
        <div id="resultado-batalla">
            <div id="resultado-contenido"></div>
        </div>

        <div style="width:100%; display:flex; gap:10px; margin:20px 0;">
            <button class="btn-master" style="background:#111; border-color:#0f0;" onclick="continuarContienda()">‚öîÔ∏è NUEVA RONDA</button>
            <button class="btn-master" style="background:#111; border-color:#f00;" onclick="salirTotal()">üö™ SALIR</button>
        </div>

        <div id="seccion-historial">
            <h3 style="color:#aaa; font-size:20px;">CR√ìNICAS DE BATALLA</h3>
            <div id="lista-historial"></div>
        </div>
    </div>

    <!-- L√ìGICA JAVASCRIPT COMPLETA V52 -->
    <script>
        const RUTA_BASE = "https://kairosravina-bot.github.io/domusmagis/";
        const VIDEOS_BATALLA = ["Explosi√≥n_Elemental.mp4", "El_B√∫ho_Juez.mp4", "Invocaciones_Et√©reas.mp4", "Escudos_vs_Espadas.mp4", "Choque_de_Energ√≠a.mp4"];
        
        // BASE DE DATOS
        const CARTAS = {
            0: { id: 0, nombre: "DRAG√ìN", elemento: "TERRA", imgEscudo: "ESCUDO_DRAGON.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 7, video: "CARTA_1_ataque.mp4", color: "#900" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 2, video: "CARTA_1_cura.mp4", color: "#090" }, "btn-t": { texto: "T", label: "TUTELA", valor: 3, video: "CARTA_1_defensa.mp4", color: "#555" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 2, video: "CARTA_1_magia.mp4", color: "#609" } } },
            1: { id: 1, nombre: "√ÅGUILA", elemento: "CAELUM", imgEscudo: "ESCUDO_AGUILA.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 5, video: "ataque.mp4", color: "#900" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 4, video: "cura.mp4", color: "#090" }, "btn-t": { texto: "T", label: "TUTELA", valor: 2, video: "defensa.mp4", color: "#555" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 3, video: "magia.mp4", color: "#609" } } },
            2: { id: 2, nombre: "LE√ìN", elemento: "TERRA", imgEscudo: "ESCUDO_LEON.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 8, video: "ataque.mp4", color: "#900" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 1, video: "cura.mp4", color: "#090" }, "btn-t": { texto: "T", label: "TUTELA", valor: 4, video: "defensa.mp4", color: "#555" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 1, video: "magia.mp4", color: "#609" } } },
            3: { id: 3, nombre: "JABAL√ç", elemento: "AQUA", imgEscudo: "ESCUDO_JABALI.png", tipo: "CASA", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 6, video: "ataque.mp4", color: "#900" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 3, video: "cura.mp4", color: "#090" }, "btn-t": { texto: "T", label: "TUTELA", valor: 3, video: "defensa.mp4", color: "#555" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 2, video: "magia.mp4", color: "#609" } } },
            4: { id: 4, nombre: "B√öHO MASTER", elemento: "NEUTRO", imgEscudo: "ESCUDO_BUHO.png", tipo: "BUHO", botones: { "btn-i": { texto: "I", label: "MANDATUM", valor: 5, video: "owl_mandatum.mp4", color: "gold" }, "btn-a": { texto: "A", label: "CONSILIUM", valor: 5, video: "owl_consilium.mp4", color: "gold" }, "btn-t": { texto: "T", label: "PRAESAGIUM", valor: 5, video: "owl_praesagium.mp4", color: "gold" }, "btn-m": { texto: "M", label: "ARCANUM", valor: 5, video: "owl_arcanum.mp4", color: "gold" } } },
            5: { id: 5, nombre: "IGNIS PHIALA", elemento: "TERRA", imgEscudo: "ESCUDO_IGNIS.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 10, video: "ARTEFACTO_1_IMPETUS.mp4", color: "#bf00ff" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 8, video: "ARTEFACTO_1_AUXILIUM.mp4", color: "#bf00ff" }, "btn-t": { texto: "T", label: "TUTELA", valor: 8, video: "ARTEFACTO_1_TUTELA.mp4", color: "#bf00ff" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 12, video: "ARTEFACTO_1_MYSTERIUM.mp4", color: "#bf00ff" } } },
            6: { id: 6, nombre: "SPECULUM AEGIS", elemento: "DIMENSIO", imgEscudo: "ESCUDO_ESPEJO.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 6, video: "ESPEJO_GOLPE.mp4", color: "#bf00ff" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 9, video: "ESPEJO_EQUIPAR.mp4", color: "#bf00ff" }, "btn-t": { texto: "T", label: "TUTELA", valor: 10, video: "ESPEJO_BLOQUEO.mp4", color: "#bf00ff" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 7, video: "ESPEJO_ILUSION.mp4", color: "#bf00ff" } } },
            7: { id: 7, nombre: "TEMPUS FUGIT", elemento: "DIMENSIO", imgEscudo: "ESCUDO_RELOJ.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 8, video: "RELOJ_ACELERAR.mp4", color: "#bf00ff" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 7, video: "RELOJ_REVERTIR.mp4", color: "#bf00ff" }, "btn-t": { texto: "T", label: "TUTELA", valor: 10, video: "RELOJ_CONGELAR.mp4", color: "#bf00ff" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 15, video: "RELOJ_ROMPER.mp4", color: "#bf00ff" } } },
            8: { id: 8, nombre: "GRIMORIUM UMBRA", elemento: "DIMENSIO", imgEscudo: "ESCUDO_LIBRO.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 9, video: "LIBRO_ABRIR.mp4", color: "#bf00ff" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 8, video: "LIBRO_LEER.mp4", color: "#bf00ff" }, "btn-t": { texto: "T", label: "TUTELA", valor: 7, video: "LIBRO_CERRAR.mp4", color: "#bf00ff" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 12, video: "LIBRO_QUEMAR.mp4", color: "#bf00ff" } } },
            9: { id: 9, nombre: "LAPIS AETHER", elemento: "CAELUM", imgEscudo: "ESCUDO_PIEDRA.png", tipo: "ARTEFACTO", botones: { "btn-i": { texto: "I", label: "IMPETUS", valor: 7, video: "PIEDRA_DISPARAR.mp4", color: "#bf00ff" }, "btn-a": { texto: "A", label: "AUXILIUM", valor: 6, video: "PIEDRA_ABSORBER.mp4", color: "#bf00ff" }, "btn-t": { texto: "T", label: "TUTELA", valor: 9, video: "PIEDRA_CAMPO.mp4", color: "#bf00ff" }, "btn-m": { texto: "M", label: "MYSTERIUM", valor: 11, video: "PIEDRA_ESTALLIDO.mp4", color: "#bf00ff" } } }
        };

        // VARIABLES DE ESTADO
        let jugadores = []; let cantJugadores = 0; let slotActual = 0; let turnoJugadorIdx = 0; const MAX_SLOTS = 3; let jugadaPendiente = null;
        let historialPartidas = []; let contadorPartidas = 0;
        
        // V52: VARIABLES GLOBALES NUEVAS
        let ultimaJugada = null; // Para mostrar info al rival sea cual sea
        let dadosSeleccionadosBatalla = 2; // Default, persiste y se "taggea"

        // NAVEGACI√ìN
        function navegar(oc, mo) { 
            document.getElementById(oc).classList.add('oculto'); 
            document.getElementById(mo).classList.remove('oculto'); 
        }
        function irMenuPrincipal() { 
            navegar('p-inicio', 'p-menu-principal'); 
            const v = document.getElementById('intro-video'); 
            if(v) { v.muted = false; v.play().catch(e => console.log("Auto-play blocked")); }
        }
        function irDados() { navegar('p-menu-principal', 'p-dados'); }

        // MODO OR√ÅCULO (HERRAMIENTA)
        function tirarDadosCustom(cantidad) {
            const vid = document.getElementById('video-dados-solo');
            const layer = document.getElementById('layer-valor-solo');
            layer.style.display = 'none'; vid.currentTime = 0; vid.play();
            vid.onended = () => {
                let total = 0; for(let i=0; i<cantidad; i++) total += Math.floor(Math.random()*6)+1;
                layer.innerText = total; layer.style.display = 'flex';
            };
        }

        // SETUP
        function seleccionarModo() { navegar('p-menu-principal', 'p-setup'); }
        function setModo(n) { 
            cantJugadores = n; 
            document.getElementById('setup-selector').classList.add('oculto'); 
            document.getElementById('registro').classList.remove('oculto'); 
            document.getElementById('reg-status').innerText = `Mago 1 de ${n}`; 
        }
        function registrarMago(casa, color, esc) {
            let n = document.getElementById('mago-nombre').value || "Mago " + (jugadores.length + 1);
            jugadores.push({ nombre: n, casa, color, esc, slots: [null, null, null], dado: 0 });
            document.getElementById('mago-nombre').value = "";
            if(jugadores.length === cantJugadores) { iniciarJuego(); } else { document.getElementById('reg-status').innerText = `Mago ${jugadores.length + 1} de ${cantJugadores}`; }
        }
        function iniciarJuego() { navegar('p-setup', 'ui-juego'); window.iniciarAR(); actualizarUI(); }

        // ACTUALIZACI√ìN UI (V52: Info Rival corregida)
        function actualizarUI() {
            const j = jugadores[turnoJugadorIdx];
            const txt = document.getElementById('txt-turno');
            txt.innerText = `TURNO: ${j.nombre}`; txt.style.color = j.color; txt.style.borderColor = j.color;
            
            document.getElementById('slot-indicator').innerText = `${slotActual + 1} / ${MAX_SLOTS}`;
            
            // LOGICA RIVAL UNIVERSAL (V52)
            const infoRival = document.getElementById('info-rival');
            if (ultimaJugada) {
                infoRival.style.display = 'block';
                document.getElementById('rival-last-move').innerText = `${ultimaJugada.nombre} (${ultimaJugada.accion})`;
            } else { 
                infoRival.style.display = 'none'; 
            }

            document.getElementById('msg-visor').style.display = 'block';
            document.getElementById('guia-scanner').className = '';
            document.getElementById('hud-derecho').style.display = 'none'; 
            resetBotones(); jugadaPendiente = null;
        }

        function mostrarPantallaCambio() {
            const nextJ = jugadores[turnoJugadorIdx];
            const pantalla = document.getElementById('pantalla-cambio-turno');
            document.getElementById('next-player-name').innerText = nextJ.nombre;
            document.getElementById('next-player-name').style.color = nextJ.color;
            pantalla.style.display = 'flex';
        }
        function confirmarCambioTurno() { document.getElementById('pantalla-cambio-turno').style.display = 'none'; actualizarUI(); }

        function forzarBatalla() {
            if(slotActual === 0 && turnoJugadorIdx < cantJugadores) { alert("¬°Todos deben jugar al menos 1 carta!"); return; }
            if(confirm("¬øSeguro que quieres forzar la batalla?")) { iniciarFaseDadosBatalla(); }
        }

        function continuarContienda() {
            slotActual = 0; turnoJugadorIdx = 0; ultimaJugada = null;
            jugadores.forEach(j => { j.slots = [null, null, null]; j.dado = 0; });
            navegar('p-resultado', 'ui-juego'); actualizarUI();
        }
        function salirTotal() { if(confirm("¬øSeguro que deseas salir?")) location.reload(); }

        // --- L√ìGICA DE DADOS EN BATALLA (V52 REVISADA) ---
        let idxDado = 0;
        
        function iniciarFaseDadosBatalla() {
            idxDado = 0;
            document.getElementById('modal-dados-fase').style.display = 'flex';
            prepararDadoJugador();
        }

        function prepararDadoJugador() {
            // Si ya pasaron todos, vamos al clash
            if(idxDado >= cantJugadores) {
                document.getElementById('modal-dados-fase').style.display = 'none';
                iniciarClashFinal();
                return;
            }

            const jug = jugadores[idxDado];
            // Texto del jugador
            const nameEl = document.getElementById('dados-player-name');
            nameEl.innerText = jug.nombre;
            nameEl.style.color = jug.color;

            // Resetear video y capa de valor
            const vid = document.getElementById('video-dados-batalla');
            const layer = document.getElementById('layer-valor-batalla');
            layer.style.display = 'none';
            // No reproducimos video autom√°tico a√∫n, esperamos click en bot√≥n

            // V52: MARCAR (TAG) EL BOT√ìN SELECCIONADO ACTUALMENTE
            actualizarBotonesDadosVisual();
        }

        function actualizarBotonesDadosVisual() {
            // Remover clase tageado de todos
            for(let i=2; i<=5; i++) {
                document.getElementById('btn-batalla-'+i).classList.remove('tageado');
            }
            // Agregar al actual
            document.getElementById('btn-batalla-'+dadosSeleccionadosBatalla).classList.add('tageado');
        }

        // Funci√≥n que se llama al pulsar un bot√≥n de dados en la batalla
        function ejecutarLanzamientoBatalla(cantidad) {
            // Actualizamos la variable global (PERSISTENCIA)
            dadosSeleccionadosBatalla = cantidad;
            actualizarBotonesDadosVisual(); // Visual feedback

            const vid = document.getElementById('video-dados-batalla');
            const layer = document.getElementById('layer-valor-batalla');
            
            // Reproducir
            vid.currentTime = 0;
            vid.play();

            vid.onended = () => {
                let total = 0;
                for(let i=0; i<cantidad; i++) total += Math.floor(Math.random()*6)+1;
                
                // Guardar valor en el jugador actual
                jugadores[idxDado].dado = total;

                // Mostrar
                layer.innerText = total;
                layer.style.display = 'flex';

                // Esperar 2 segundos y pasar al siguiente
                setTimeout(() => {
                    idxDado++;
                    prepararDadoJugador();
                }, 2000);
            };
        }

        function iniciarClashFinal() {
            document.getElementById('modal-batalla').style.display = 'flex';
            const txtVs = document.getElementById('texto-vs');
            if(cantJugadores === 2) { txtVs.innerHTML = `<span style="color:${jugadores[0].color}">${jugadores[0].nombre}</span> <br>VS<br> <span style="color:${jugadores[1].color}">${jugadores[1].nombre}</span>`; } else { txtVs.innerHTML = "BATALLA REAL"; }
            const vidClash = document.getElementById('video-clash');
            vidClash.src = RUTA_BASE + VIDEOS_BATALLA[Math.floor(Math.random() * VIDEOS_BATALLA.length)];
            vidClash.play().catch(e => console.error(e));
            vidClash.onended = () => { document.getElementById('modal-batalla').style.display = 'none'; mostrarResultadosComplejos(); };
        }

        function mostrarResultadosComplejos() {
            navegar('ui-juego', 'p-resultado');
            const cont = document.getElementById('resultado-contenido'); cont.innerHTML = '';
            let resultados = jugadores.map(j => { let total = 0; j.slots.forEach(s => { if(s) total += s.valor; }); return { ...j, total: total }; });
            resultados.forEach(r => r.total += r.dado);
            resultados.sort((a,b) => b.total - a.total);
            contadorPartidas++; const ganador = resultados[0];
            historialPartidas.push({ id: contadorPartidas, nombre: ganador.nombre, pts: ganador.total });
            actualizarListaHistorial();
            resultados.forEach((r, i) => {
                let htmlSlots = "";
                r.slots.forEach(s => { if(s) htmlSlots += `<div class="fila-res"><div class="res-accion">${s.lado}</div><div class="res-valor">${s.valor}</div></div>`; });
                cont.innerHTML += `<div class="resultado-jugador ${i===0 ? 'ganador' : ''}"><h3 style="color:${r.color}; margin:0;">${r.nombre}</h3>${htmlSlots}<div class="fila-dado"><span style="color:#555; font-weight:bold;">DESTINO (${dadosSeleccionadosBatalla}D):</span><span class="dado-gigante-res">+${r.dado}</span></div><div class="total-score">${r.total}</div></div>`;
            });
        }
        function actualizarListaHistorial() { const lista = document.getElementById('lista-historial'); lista.innerHTML = ""; [...historialPartidas].reverse().forEach(h => { lista.innerHTML += `<div class="item-historial"><span>CONTIENDA #${h.id}</span><strong>${h.nombre} (${h.pts} pts)</strong></div>`; }); }
    </script>

    <!-- LOGICA AR (MINDAR) -->
    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        let mindarThree = null; let cartaDetectada = null;
        const ui = { scanner: document.getElementById('guia-scanner'), msg: document.getElementById('msg-visor'), videoAction: document.getElementById('video-action') };

        window.iniciarAR = async function() {
            if(mindarThree) return;
            mindarThree = new MindARThree({ container: document.getElementById('container-ar'), imageTargetSrc: RUTA_BASE + 'targets1.mind', maxTrack: 1, filterMinCF: 0.0001, filterBeta: 0.001, uiLoading: "no", uiScanning: "no", uiError: "no" });
            const {renderer, scene, camera} = mindarThree;

            for(let i=0; i<10; i++) {
                const anchor = mindarThree.addAnchor(i); 
                anchor.group.add(new THREE.Mesh(new THREE.PlaneGeometry(1,1), new THREE.MeshBasicMaterial({transparent:true, opacity:0})));
                
                anchor.onTargetFound = () => {
                    cartaDetectada = CARTAS[i]; if(!cartaDetectada) return;
                    if(cartaDetectada.tipo === "ARTEFACTO") ui.scanner.className = 'violeta'; 
                    else if(cartaDetectada.tipo === "BUHO") ui.scanner.className = 'dorado'; 
                    else ui.scanner.className = 'verde';
                    ui.msg.innerText = cartaDetectada.nombre; actualizarBotones(cartaDetectada);
                };
                anchor.onTargetLost = () => { 
                    cartaDetectada = null; ui.scanner.className = ''; ui.msg.innerText = "BUSCANDO..."; resetBotones(); 
                    document.getElementById('hud-derecho').style.display = 'none'; 
                };
            }

            ['btn-i', 'btn-a', 'btn-t', 'btn-m'].forEach(id => {
                document.getElementById(id).onclick = () => {
                    if(!cartaDetectada) return;
                    const conf = cartaDetectada.botones[id];
                    jugadaPendiente = { 
                        carta: cartaDetectada, 
                        lado: conf.label, 
                        valor: (typeof conf.valor==='number'?conf.valor:5), 
                        video: conf.video, 
                        tipoLado: id.split('-')[1].toUpperCase() 
                    };
                    
                    ui.videoAction.style.display = 'block';
                    ui.videoAction.src = RUTA_BASE + conf.video;
                    ui.msg.style.display = 'none';

                    const hud = document.getElementById('hud-derecho');
                    hud.style.display = 'flex';
                    document.getElementById('hud-img-escudo').src = RUTA_BASE + cartaDetectada.imgEscudo;
                    document.getElementById('hud-txt-accion').innerText = conf.label;
                    document.getElementById('hud-txt-valor').innerText = conf.valor;

                    const playPromise = ui.videoAction.play();
                    if(playPromise !== undefined) playPromise.catch(e => { console.error("Error video:", e); });

                    ui.videoAction.onended = () => { 
                        ui.videoAction.style.display = 'none'; 
                        ui.msg.style.display = 'block'; 
                        ui.msg.innerText = "LISTO: CONFIRMA ABAJO"; 
                    };
                };
            });

            await mindarThree.start(); 
            renderer.setAnimationLoop(() => { renderer.render(scene, camera); });
        };

        document.getElementById('btn-confirmar').onclick = () => {
            if(!jugadaPendiente) { alert("¬°Escanea una carta primero y elige una Gema!"); return; }
            
            // GUARDAR MOVIMIENTO (V52: PARA QUE EL RIVAL LO VEA)
            ultimaJugada = {
                nombre: jugadaPendiente.carta.nombre,
                accion: jugadaPendiente.lado
            };

            jugadores[turnoJugadorIdx].slots[slotActual] = { 
                nombre: jugadaPendiente.carta.nombre, 
                elemento: jugadaPendiente.carta.elemento, 
                lado: jugadaPendiente.lado, 
                valor: jugadaPendiente.valor, 
                tipoLado: jugadaPendiente.tipoLado 
            };
            
            turnoJugadorIdx++;
            if(turnoJugadorIdx >= cantJugadores) { turnoJugadorIdx = 0; slotActual++; }
            if(slotActual >= MAX_SLOTS) { iniciarFaseDadosBatalla(); } else { mostrarPantallaCambio(); } 
        };

        function actualizarBotones(c) { 
            ['btn-i','btn-a','btn-t','btn-m'].forEach(id=>{ 
                const b=document.getElementById(id); 
                const cf=c.botones[id]; 
                b.innerHTML=`<span class="letra-grande">${cf.texto}</span>`; 
                b.classList.add('activo'); 
            }); 
        }
        function resetBotones() { 
            ['btn-i','btn-a','btn-t','btn-m'].forEach(id=>{ 
                const b=document.getElementById(id); 
                b.innerHTML=`<span class="letra-grande">${id.split('-')[1].toUpperCase()}</span>`; 
                b.classList.remove('activo'); 
            }); 
        }
    </script>
</body>
</html>