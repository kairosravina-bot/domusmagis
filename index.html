<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: REVELATIONS</title>
    
    <!-- LIBRERÍAS ESTABLES -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        /* --- CORRECCIÓN PANTALLA BLANCA --- */
        html, body {
            background-color: transparent !important;
            background: none !important;
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
        }
        
        /* Asegura que el video de la cámara se vea detrás de todo */
        video { z-index: -10 !important; }

        /* --- UI GENERAL --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; z-index: 100;
            pointer-events: none; /* Deja pasar clicks a lo que no sea botón */
        }

        /* 1. VISOR SUPERIOR */
        #video-visor {
            width: 100%; height: 35%; background: rgba(0,0,0,0.8);
            border-bottom: 2px solid #555; pointer-events: auto;
            display: flex; align-items: center; justify-content: center;
        }
        #video-player { width: 100%; height: 100%; object-fit: contain; display: none; }
        #msg-visor { color: white; text-align: center; font-weight: bold; letter-spacing: 1px; }

        /* 2. ZONA CENTRAL (GUÍA ROJA) */
        #zona-ar { 
            flex-grow: 1; position: relative; 
            display: flex; align-items: center; justify-content: center;
        }
        
        #guia-roja {
            width: 70vw; height: 95vw; max-width: 280px; max-height: 400px;
            border: 4px solid red; border-radius: 15px;
            box-shadow: 0 0 20px rgba(255,0,0,0.5);
            transition: all 0.3s;
        }
        #guia-roja.verde {
            border-color: #0f0; box-shadow: 0 0 50px #0f0; background: rgba(0,255,0,0.1);
        }

        /* 3. PANEL INFERIOR (CONTROLES) */
        #panel-inferior {
            background: #111; border-top: 2px solid white;
            padding-bottom: env(safe-area-inset-bottom);
            pointer-events: auto;
            display: flex; flex-direction: column; gap: 10px; padding: 10px;
        }

        /* BOTÓN DE ESCANEO (EL QUE PEDISTE) */
        #btn-scan-row {
            display: flex; justify-content: center;
        }
        #btn-iniciar-scan {
            background: #0066cc; color: white; border: 2px solid #4da6ff;
            padding: 10px 30px; border-radius: 20px; font-weight: bold; font-size: 16px;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 0 10px #0066cc; width: 100%;
        }
        #btn-iniciar-scan:active { transform: scale(0.95); }
        
        /* DATOS */
        #datos-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;
            text-align: center;
        }
        .dato-box { background: #222; border: 1px solid #444; border-radius: 5px; padding: 5px; }
        .lbl { font-size: 9px; color: #888; display: block; }
        .val { font-size: 12px; color: #fff; font-weight: bold; }
        .val-big { font-size: 14px; color: #ff0; font-weight: bold; }

        /* BOTONES DE PODER */
        #botonera-poderes {
            display: flex; justify-content: center; gap: 15px; padding-top: 5px;
        }
        .btn-poder {
            width: 60px; height: 60px; border-radius: 50%;
            background: #222; border: 2px solid #555; color: #555;
            font-size: 20px; font-weight: bold; display: flex; 
            flex-direction: column; align-items: center; justify-content: center;
            opacity: 0.4; transition: 0.2s;
        }
        .btn-poder.activo {
            opacity: 1; cursor: pointer; color: white; border-color: white; transform: scale(1.05);
        }
        
        /* Colores específicos */
        #btn-i.activo { background: #900; box-shadow: 0 0 15px #f00; }
        #btn-a.activo { background: #090; box-shadow: 0 0 15px #0f0; }
        #btn-t.activo { background: #555; box-shadow: 0 0 15px #aaa; }
        #btn-m.activo { background: #609; box-shadow: 0 0 15px #d0f; }

    </style>
</head>
<body>

    <!-- INTERFAZ (UI LAYER) -->
    <div id="ui-layer">
        
        <!-- PARTE SUPERIOR: VIDEO -->
        <div id="video-visor">
            <div id="msg-visor">SISTEMA APAGADO<br><span style="font-size:10px; color:#aaa">Pulsa ESCANEAR abajo</span></div>
            <video id="video-player" playsinline webkit-playsinline></video>
        </div>

        <!-- CENTRO: GUÍA ROJA -->
        <div id="zona-ar">
            <div id="guia-roja"></div>
        </div>

        <!-- PARTE INFERIOR: BOTONES Y DATOS -->
        <div id="panel-inferior">
            
            <!-- FILA 1: BOTÓN DE INICIO DE ESCANEO -->
            <div id="btn-scan-row">
                <button id="btn-iniciar-scan">INICIAR CÁMARA</button>
            </div>

            <!-- FILA 2: DATOS -->
            <div id="datos-grid">
                <div class="dato-box"><span class="lbl">CASA</span><span id="d-casa" class="val">---</span></div>
                <div class="dato-box"><span class="lbl">ARMA</span><span id="d-arma" class="val">---</span></div>
                <div class="dato-box"><span class="lbl">ACCIÓN</span><span id="d-accion" class="val-big">---</span></div>
            </div>

            <!-- FILA 3: BOTONES DE PODER (I A T M) -->
            <div id="botonera-poderes">
                <button id="btn-i" class="btn-poder" data-tipo="IMPETUS">I <span style="font-size:10px">0</span></button>
                <button id="btn-a" class="btn-poder" data-tipo="AUXILIUM">A <span style="font-size:10px">0</span></button>
                <button id="btn-t" class="btn-poder" data-tipo="TUTELA">T <span style="font-size:10px">0</span></button>
                <button id="btn-m" class="btn-poder" data-tipo="MYSTERIUM">M <span style="font-size:10px">0</span></button>
            </div>
        </div>
    </div>

    <!-- ESCENA A-FRAME (FONDO) -->
    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiLoading: no; uiScanning: no;" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false"
        renderer="colorManagement: true; alpha: true"
        embedded>
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity id="target-carta" mindar-image-target="targetIndex: 0"></a-entity>
    </a-scene>

    <script>
        // CONFIGURACIÓN CARTA
        const DATA = {
            casa: "DOMUS DRACO", arma: "SICA",
            stats: {
                IMPETUS:   { v: 6, vid: "ataque.mp4" },
                AUXILIUM:  { v: 1, vid: "cura.mp4" },
                TUTELA:    { v: 2, vid: "defensa.mp4" },
                MYSTERIUM: { v: 1, vid: "magia.mp4" }
            }
        };

        // REFERENCIAS
        const btnScan = document.getElementById('btn-iniciar-scan');
        const msgVisor = document.getElementById('msg-visor');
        const guiaRoja = document.getElementById('guia-roja');
        const videoPlayer = document.getElementById('video-player');
        
        const uiCasa = document.getElementById('d-casa');
        const uiArma = document.getElementById('d-arma');
        const uiAccion = document.getElementById('d-accion');
        const botones = document.querySelectorAll('.btn-poder');

        // 1. BOTÓN DE INICIO / REINICIO (LA CLAVE)
        btnScan.addEventListener('click', async () => {
            btnScan.disabled = true;
            btnScan.innerText = "CARGANDO...";
            msgVisor.innerHTML = "INICIANDO CÁMARA...";

            const scene = document.querySelector('a-scene');
            const arSystem = scene.systems['mindar-image-system'];

            try {
                await arSystem.start(); // Forzamos inicio
                btnScan.style.display = 'none'; // Se oculta al tener éxito
                msgVisor.innerHTML = "ESCANEA LA CARTA<br><span style='font-size:10px'>Centra el rombo</span>";
            } catch (e) {
                alert("Error de cámara: " + e);
                btnScan.innerText = "REINTENTAR";
                btnScan.disabled = false;
            }
        });

        // 2. DETECCIÓN
        const target = document.getElementById('target-carta');

        target.addEventListener('targetFound', () => {
            guiaRoja.classList.add('verde'); // Se pone verde
            msgVisor.innerText = "¡CARTA DETECTADA!";
            msgVisor.style.color = "#0f0";

            // Datos
            uiCasa.innerText = DATA.casa;
            uiArma.innerText = DATA.arma;

            // Desbloquear botones
            botones.forEach(btn => {
                const tipo = btn.getAttribute('data-tipo');
                btn.querySelector('span').innerText = DATA.stats[tipo].v;
                btn.classList.add('activo');
            });
        });

        target.addEventListener('targetLost', () => {
            guiaRoja.classList.remove('verde'); // Vuelve a rojo
            msgVisor.innerText = "BUSCANDO...";
            msgVisor.style.color = "#fff";
            
            // RESETEAR UI
            videoPlayer.style.display = 'none';
            videoPlayer.pause();
            msgVisor.style.display = 'block';
            
            uiAccion.innerText = "---";
            uiAccion.style.color = "#ff0";

            botones.forEach(btn => btn.classList.remove('activo'));
        });

        // 3. BOTONES DE ACCIÓN
        botones.forEach(btn => {
            btn.addEventListener('click', () => {
                if (!btn.classList.contains('activo')) return;

                const tipo = btn.getAttribute('data-tipo');
                const info = DATA.stats[tipo];

                // Mostrar Acción
                uiAccion.innerText = `${tipo} [${info.v}]`;
                
                // Color Acción
                if(tipo === 'IMPETUS') uiAccion.style.color = "#f55";
                else if(tipo === 'AUXILIUM') uiAccion.style.color = "#5f5";
                else if(tipo === 'MYSTERIUM') uiAccion.style.color = "#d5f";
                else uiAccion.style.color = "#fff";

                // Video
                msgVisor.style.display = 'none';
                videoPlayer.style.display = 'block';
                videoPlayer.src = info.vid;
                videoPlayer.play();
            });
        });

        videoPlayer.addEventListener('ended', () => {
            videoPlayer.style.display = 'none';
            msgVisor.style.display = 'block';
            msgVisor.innerText = "TURNO FINALIZADO";
        });

    </script>
</body>
</html>