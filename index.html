<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: REVELATIONS</title>
    
    <!-- LIBRERÍAS -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: black; }
        
        /* 1. PANTALLA DE INICIO */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: gold;
        }
        #btn-start {
            padding: 15px 40px; font-size: 20px; background: #440066;
            color: white; border: 2px solid gold; cursor: pointer; margin-top: 20px;
            text-transform: uppercase; font-weight: bold;
        }

        /* 2. HUD SUPERIOR */
        #top-hud {
            position: absolute; top: 0; width: 100%; height: 40%;
            background: rgba(0, 0, 0, 0.6); z-index: 10;
            display: none; flex-direction: column;
        }

        /* Barras de Vida */
        #hp-panel {
            width: 100%; height: 25px; display: flex; justify-content: space-between;
            padding: 2px 5px; box-sizing: border-box; background: #111;
        }
        .hp-bar-container { width: 48%; height: 100%; border: 1px solid #777; position: relative; background: #222; }
        .hp-fill { height: 100%; transition: width 0.3s; }
        #player-hp { background: linear-gradient(90deg, #00ff00, #005500); width: 100%; }
        #enemy-hp { background: linear-gradient(90deg, #ff0000, #550000); width: 100%; }
        .hp-text { position: absolute; top: 0; left: 5px; color: white; font-size: 11px; line-height: 20px; font-weight: bold; text-shadow: 1px 1px 0 #000; z-index: 2; }

        /* Visor de Video (Sin fondo verde, video estándar) */
        #video-visor {
            flex-grow: 1; position: relative; 
            display: flex; justify-content: center; align-items: center;
            background: #000; border-bottom: 2px solid gold;
        }
        
        /* Etiqueta de video real */
        #main-video {
            width: 100%; height: 100%; 
            object-fit: contain; /* Mantiene la proporción sin recortar */
            display: none;
        }
        
        #video-placeholder-text {
            color: #666; font-size: 14px; letter-spacing: 2px;
            position: absolute;
        }

        /* 3. ZONA INFERIOR (DATOS Y BOTONES) */
        #bottom-panel {
            position: absolute; bottom: 0; width: 100%; height: 20%;
            background: rgba(10, 10, 10, 0.95); z-index: 10;
            display: none; flex-direction: column;
            border-top: 2px solid #444;
        }
        
        #data-display {
            height: 35%; color: white; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            text-align: center;
            font-family: monospace;
            padding-top: 5px;
        }
        
        #card-name { font-size: 14px; color: gold; text-transform: uppercase; }
        #card-stats { font-size: 16px; font-weight: bold; margin-top: 2px; }
        .stat-highlight { color: cyan; font-size: 18px; }

        #tactical-buttons {
            height: 65%; display: flex; justify-content: space-evenly; align-items: center;
            padding-bottom: 10px;
        }

        .tac-btn {
            width: 55px; height: 55px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5); font-weight: bold; font-size: 20px;
            cursor: pointer; color: white; transition: transform 0.1s;
            text-shadow: 0 0 5px black;
        }
        .tac-btn:active { transform: scale(0.9); border-color: white; }

        /* Colores Botones */
        #btn-I { background: radial-gradient(circle, #ff4444, #880000); }
        #btn-T { background: radial-gradient(circle, #888888, #444444); }
        #btn-A { background: radial-gradient(circle, #44ff44, #005500); }
        #btn-M { background: radial-gradient(circle, #aa44ff, #440088); }

    </style>
</head>
<body>

    <!-- PANTALLA INICIO -->
    <div id="start-screen">
        <h1>DOMUS MAGI</h1>
        <h3>REVELATIONS</h3>
        <button id="btn-start">INICIAR SISTEMA</button>
    </div>

    <!-- HUD SUPERIOR -->
    <div id="top-hud">
        <div id="hp-panel">
            <div class="hp-bar-container">
                <div id="player-hp" class="hp-fill"></div>
                <span class="hp-text">MAGUS HP: <span id="p-val">100</span></span>
            </div>
            <div class="hp-bar-container">
                <div id="enemy-hp" class="hp-fill"></div>
                <span class="hp-text" style="right: 5px; left: auto;">ENEMIGO HP: <span id="e-val">100</span></span>
            </div>
        </div>
        
        <div id="video-visor">
            <div id="video-placeholder-text">ESPERANDO SEÑAL DE CARTA...</div>
            <!-- Video estándar MP4 sin fondo verde -->
            <video id="main-video" playsinline muted></video>
        </div>
    </div>

    <!-- PANEL INFERIOR -->
    <div id="bottom-panel">
        <div id="data-display">
            <div id="card-name">BUSCANDO OBJETIVO...</div>
            <div id="card-stats">--</div>
        </div>
        <div id="tactical-buttons">
            <button id="btn-I" class="tac-btn">I</button>
            <button id="btn-T" class="tac-btn">T</button>
            <button id="btn-A" class="tac-btn">A</button>
            <button id="btn-M" class="tac-btn">M</button>
        </div>
    </div>

    <!-- ESCENA AR -->
    <a-scene mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001;" 
             color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity id="targets-wrapper"></a-entity>
    </a-scene>

    <script>
        // --- 1. VARIABLES DE JUEGO ---
        let playerLife = 100;
        let enemyLife = 100;
        
        // Diccionario para traducir letras a nombres completos
        const typeNames = {
            'I': 'IMPETUS',
            'T': 'TUTELA',
            'A': 'AUXILIUM',
            'M': 'MYSTERIUM'
        };

        // Estado actual
        let currentCard = {
            house: "",
            weapon: "",
            modeFull: "ESPERANDO", // El nombre completo (ej: IMPETUS)
            modeCode: "",          // La letra (ej: I)
            value: 0
        };

        // --- 2. LISTA DE MARCADORES ---
        // Deben coincidir con tu archivo .mind
        const markerNames = [
            "DRACO_SICA_1_I_6",  
            "DRACO_SICA_1_A_1",  
            "DRACO_SICA_1_T_2",  
            "DRACO_SICA_1_M_1"   
        ];

        // --- 3. INICIO ---
        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('top-hud').style.display = 'flex';
            document.getElementById('bottom-panel').style.display = 'flex';
            
            document.querySelector('a-scene').systems["mindar-image-system"].start();
            setupMarkers();
        });

        function setupMarkers() {
            const wrapper = document.getElementById('targets-wrapper');
            markerNames.forEach((name, index) => {
                const el = document.createElement('a-entity');
                el.setAttribute('mindar-image-target', `targetIndex: ${index}`);
                el.addEventListener('targetFound', () => { parseCardData(name); });
                wrapper.appendChild(el);
            });
        }

        // --- 4. PARSEO DE DATOS (FIX SOLICITADO) ---
        function parseCardData(filename) {
            // filename ej: DRACO_SICA_1_I_6
            const parts = filename.split('_'); 
            
            if (parts.length >= 5) {
                const house = parts[0];   // DRACO
                const weapon = parts[1];  // SICA
                const modeLet = parts[3]; // I
                const val = parseInt(parts[4]); // 6

                // Guardamos datos
                currentCard.house = house;
                currentCard.weapon = weapon;
                currentCard.modeCode = modeLet;
                currentCard.modeFull = typeNames[modeLet] || "DESCONOCIDO";
                currentCard.value = val;

                updateDisplay();
            }
        }

        function updateDisplay() {
            // Actualizar textos HTML
            const nameDiv = document.getElementById('card-name');
            const statsDiv = document.getElementById('card-stats');
            
            // Texto superior: DRACO - SICA - IMPETUS
            nameDiv.innerText = `${currentCard.house} - ${currentCard.weapon} - ${currentCard.modeFull}`;
            
            // Texto inferior: VALOR 6
            statsDiv.innerHTML = `POTENCIA: <span class="stat-highlight">${currentCard.value}</span>`;
            
            // Feedback en consola
            console.log(`Detectado: ${currentCard.house} ${currentCard.modeFull} con valor ${currentCard.value}`);
        }

        // --- 5. LOGICA DE BOTONES ---
        // Solo funcionan si la carta está en la posición correcta (ej: Carta rotada en I para usar Botón I)
        
        document.getElementById('btn-I').addEventListener('click', () => {
            if (currentCard.modeCode === 'I') {
                performAttack(currentCard.value);
            } else {
                alert("¡GIRA LA CARTA A POSICIÓN DE ATAQUE (IMPETUS)!");
            }
        });

        document.getElementById('btn-T').addEventListener('click', () => {
            if (currentCard.modeCode === 'T') {
                alert(`DEFENSA ${currentCard.modeFull} ACTIVA: +${currentCard.value}`);
            } else {
                alert("¡GIRA LA CARTA A TUTELA!");
            }
        });

        document.getElementById('btn-A').addEventListener('click', () => {
            if (currentCard.modeCode === 'A') {
                healPlayer(currentCard.value);
            } else {
                alert("¡GIRA LA CARTA A AUXILIUM!");
            }
        });

        document.getElementById('btn-M').addEventListener('click', () => {
            if (currentCard.modeCode === 'M') {
                performMagic(currentCard.value);
            } else {
                alert("¡GIRA LA CARTA A MYSTERIUM!");
            }
        });

        // --- 6. FUNCIONES DE COMBATE Y VIDEO ---

        function performAttack(dmg) {
            enemyLife = Math.max(0, enemyLife - dmg);
            updateBars();
            playVideo(`${currentCard.house}_ATK`); // Nombre genérico de video
        }

        function performMagic(dmg) {
            enemyLife = Math.max(0, enemyLife - (dmg * 2));
            updateBars();
            playVideo(`${currentCard.house}_MAG`);
        }

        function healPlayer(amount) {
            playerLife = Math.min(100, playerLife + (amount * 5));
            updateBars();
        }

        function updateBars() {
            document.getElementById('player-hp').style.width = playerLife + '%';
            document.getElementById('enemy-hp').style.width = enemyLife + '%';
            document.getElementById('p-val').innerText = Math.floor(playerLife);
            document.getElementById('e-val').innerText = Math.floor(enemyLife);
            
            if (enemyLife <= 0) alert("VICTORIA - ENEMIGO ABATIDO");
        }

        // --- REPRODUCTOR DE VIDEO ---
        function playVideo(videoName) {
            const videoEl = document.getElementById('main-video');
            const placeholder = document.getElementById('video-placeholder-text');
            
            // Ocultar texto, mostrar video
            placeholder.style.display = 'none';
            videoEl.style.display = 'block';

            // AQUÍ: Como no tienes los archivos aún, he puesto una ruta de ejemplo.
            // Cuando tengas los mp4, guárdalos en una carpeta 'videos' y usa:
            // videoEl.src = `videos/${videoName}.mp4`;
            
            // Por ahora, simulamos que carga algo para que no de error 404
            console.log(`Intentando reproducir: videos/${videoName}.mp4`);
            
            // Si tuvieras el archivo, descomenta esto:
            // videoEl.play();

            // Simulación visual (borrar cuando tengas videos reales)
            videoEl.style.backgroundColor = getFactionColor(currentCard.house);
            setTimeout(() => {
                videoEl.style.display = 'none';
                placeholder.style.display = 'block';
                videoEl.style.backgroundColor = 'transparent';
            }, 2000);
        }

        function getFactionColor(house) {
            if (house === 'DRACO') return '#990000';
            if (house === 'CAELUM') return '#000099';
            return '#333';
        }

    </script>
</body>
</html>