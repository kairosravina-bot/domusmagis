<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: REVELATIONS</title>
    
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        /* 1. ARREGLO DE PANTALLA BLANCA: Fondo NEGRO por defecto */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000000; /* Fondo negro siempre */
            overflow: hidden; font-family: sans-serif;
        }

        /* 2. INTERFAZ FLOTANTE (Por encima de la cámara) */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999; /* Siempre arriba */
            display: flex; flex-direction: column;
            pointer-events: none; /* Deja pasar clicks en zonas vacías */
        }

        /* PARTE SUPERIOR: VISOR DE VIDEO */
        #top-visor {
            height: 30%; width: 100%; background: #000;
            border-bottom: 2px solid #555; pointer-events: auto;
            position: relative; display: flex; align-items: center; justify-content: center;
        }
        #video-player { width: 100%; height: 100%; object-fit: contain; display: none; }
        #msg-visor { color: white; text-align: center; }

        /* PARTE CENTRAL: CÁMARA Y GUÍA */
        #middle-cam {
            flex-grow: 1; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        /* El recuadro rojo */
        #guia-box {
            width: 250px; height: 350px;
            border: 4px solid red; border-radius: 10px;
            box-shadow: 0 0 20px rgba(255,0,0,0.5);
            transition: 0.3s;
        }
        #guia-box.ok { border-color: #0f0; box-shadow: 0 0 50px #0f0; }

        /* PARTE INFERIOR: CONTROLES (SOLIDO NEGRO) */
        #bottom-panel {
            height: auto; background: #111;
            border-top: 2px solid #fff; pointer-events: auto;
            display: flex; flex-direction: column; gap: 10px; padding: 10px;
            padding-bottom: 30px; /* Espacio extra abajo */
        }

        /* --- AQUÍ ESTÁ EL BOTÓN QUE PEDISTE --- */
        #btn-scan-container {
            width: 100%; display: flex; justify-content: center;
        }
        #btn-scan {
            background: #ffcc00; color: #000; /* Amarillo y Negro */
            border: none; padding: 12px 0; width: 80%;
            font-size: 16px; font-weight: bold; border-radius: 5px;
            cursor: pointer; text-transform: uppercase;
        }
        #btn-scan:active { transform: scale(0.95); background: #fff; }

        /* DATOS */
        #info-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;
        }
        .info-box { background: #222; border: 1px solid #444; text-align: center; padding: 5px; }
        .lbl { font-size: 10px; color: #aaa; display: block; }
        .val { font-size: 12px; color: #fff; font-weight: bold; }

        /* BOTONES DE PODER */
        #powers-grid {
            display: flex; justify-content: center; gap: 15px; margin-top: 5px;
        }
        .pwr-btn {
            width: 60px; height: 60px; border-radius: 50%;
            background: #333; border: 2px solid #555; color: #777;
            font-size: 20px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            opacity: 0.5;
        }
        .pwr-btn.active {
            opacity: 1; color: #fff; border-color: #fff; cursor: pointer;
        }
        /* Colores */
        #btn-i.active { background: #800; box-shadow: 0 0 10px red; }
        #btn-a.active { background: #080; box-shadow: 0 0 10px lime; }
        #btn-t.active { background: #555; box-shadow: 0 0 10px gray; }
        #btn-m.active { background: #508; box-shadow: 0 0 10px purple; }

    </style>
</head>
<body>

    <!-- UI LAYER (ENCIMA DE TODO) -->
    <div id="ui-layer">
        
        <!-- 1. VIDEO SUPERIOR -->
        <div id="top-visor">
            <div id="msg-visor">SISTEMA VISUAL<br><span style="font-size:10px; color:#f90">Presiona ACTIVAR CÁMARA abajo</span></div>
            <video id="video-player" playsinline webkit-playsinline></video>
        </div>

        <!-- 2. ZONA CENTRAL (GUIA) -->
        <div id="middle-cam">
            <div id="guia-box"></div>
        </div>

        <!-- 3. PANEL INFERIOR -->
        <div id="bottom-panel">
            
            <!-- EL BOTÓN DE SCAN (PRIMERO EN LA LISTA) -->
            <div id="btn-scan-container">
                <button id="btn-scan">ACTIVAR CÁMARA</button>
            </div>

            <!-- DATOS -->
            <div id="info-grid">
                <div class="info-box"><span class="lbl">CASA</span><span id="txt-casa" class="val">---</span></div>
                <div class="info-box"><span class="lbl">ARMA</span><span id="txt-arma" class="val">---</span></div>
                <div class="info-box"><span class="lbl">ACCIÓN</span><span id="txt-accion" class="val" style="color:yellow">---</span></div>
            </div>

            <!-- BOTONES -->
            <div id="powers-grid">
                <div id="btn-i" class="pwr-btn" data-id="IMPETUS">I</div>
                <div id="btn-a" class="pwr-btn" data-id="AUXILIUM">A</div>
                <div id="btn-t" class="pwr-btn" data-id="TUTELA">T</div>
                <div id="btn-m" class="pwr-btn" data-id="MYSTERIUM">M</div>
            </div>
        </div>
    </div>

    <!-- SCENE AR (FONDO) -->
    <a-scene 
        mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiLoading: no; uiScanning: no;" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false"
        renderer="colorManagement: true; alpha: true">
        
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity id="target-carta" mindar-image-target="targetIndex: 0"></a-entity>
    </a-scene>

    <script>
        // DATOS
        const DB = {
            casa: "DOMUS DRACO", arma: "SICA",
            movs: {
                IMPETUS: { v: 6, mp4: "ataque.mp4" },
                AUXILIUM: { v: 1, mp4: "cura.mp4" },
                TUTELA: { v: 2, mp4: "defensa.mp4" },
                MYSTERIUM: { v: 1, mp4: "magia.mp4" }
            }
        };

        // UI
        const btnScan = document.getElementById('btn-scan');
        const msgVisor = document.getElementById('msg-visor');
        const guiaBox = document.getElementById('guia-box');
        const videoPlayer = document.getElementById('video-player');
        
        const txtCasa = document.getElementById('txt-casa');
        const txtArma = document.getElementById('txt-arma');
        const txtAccion = document.getElementById('txt-accion');
        const btns = document.querySelectorAll('.pwr-btn');

        // 1. INICIAR CÁMARA (MANUALMENTE)
        btnScan.addEventListener('click', async () => {
            btnScan.innerText = "INICIANDO...";
            btnScan.disabled = true;
            
            try {
                const scene = document.querySelector('a-scene');
                await scene.systems['mindar-image-system'].start();
                
                // Si llegamos aquí, funcionó
                btnScan.style.display = 'none'; // OCULTAR BOTÓN AL ÉXITO
                msgVisor.innerHTML = "ESCANEA LA CARTA<br><span style='font-size:10px'>Usa el recuadro rojo</span>";
            } catch (err) {
                console.error(err);
                alert("Error: " + err);
                btnScan.innerText = "REINTENTAR";
                btnScan.disabled = false;
            }
        });

        // 2. DETECCIÓN
        const target = document.getElementById('target-carta');

        target.addEventListener('targetFound', () => {
            guiaBox.classList.add('ok'); // VERDE
            msgVisor.innerText = "CARTA ENLAZADA";
            msgVisor.style.color = "#0f0";

            txtCasa.innerText = DB.casa;
            txtArma.innerText = DB.arma;

            // Activar botones
            btns.forEach(b => b.classList.add('active'));
        });

        target.addEventListener('targetLost', () => {
            guiaBox.classList.remove('ok'); // ROJO
            msgVisor.innerText = "BUSCANDO...";
            msgVisor.style.color = "#fff";

            // Reset video
            videoPlayer.pause();
            videoPlayer.style.display = 'none';
            msgVisor.style.display = 'block';

            // Desactivar botones
            btns.forEach(b => b.classList.remove('active'));
        });

        // 3. CLICS EN PODERES
        btns.forEach(btn => {
            btn.addEventListener('click', () => {
                if(!btn.classList.contains('active')) return;

                const id = btn.getAttribute('data-id');
                const data = DB.movs[id];

                // UI Text
                txtAccion.innerText = `${id} [${data.v}]`;
                
                if(id == 'IMPETUS') txtAccion.style.color = 'red';
                else if(id == 'AUXILIUM') txtAccion.style.color = 'lime';
                else if(id == 'MYSTERIUM') txtAccion.style.color = 'magenta';
                else txtAccion.style.color = 'white';

                // Video
                msgVisor.style.display = 'none';
                videoPlayer.style.display = 'block';
                videoPlayer.src = data.mp4;
                videoPlayer.play();
            });
        });

        videoPlayer.addEventListener('ended', () => {
            videoPlayer.style.display = 'none';
            msgVisor.style.display = 'block';
        });

    </script>
</body>
</html>