<!-- 
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  DOMUS MAGI: REVELATIONS                                   â•‘
â•‘  VERSIÃ“N 7.1 - CORRECCIÃ“N DETECCIÃ“N BÃšHO Y VIDEOS         â•‘
â•‘  Fix: DetecciÃ³n bÃºho + estabilidad reproducciÃ³n            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOMUS MAGI: REVELATIONS - VERSIÃ“N 7.1</title>

    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; }

        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: radial-gradient(circle, #1a001a, #000);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity 0.5s;
        }
        #splash-screen.oculto { opacity: 0; pointer-events: none; }

        #btn-inicio {
            padding: 25px 50px; font-size: 24px; font-weight: bold; color: #000;
            background: #bf00ff; border: none; border-radius: 15px; cursor: pointer;
            text-transform: uppercase; box-shadow: 0 0 30px #bf00ff;
            animation: pulso 2s infinite; z-index: 10;
        }
        @keyframes pulso { 50% { box-shadow: 0 0 60px #bf00ff; } }
        
        #version-display {
            margin-top: 20px;
            color: #00ff00;
            font-family: monospace;
            font-size: 14px;
            text-shadow: 0 0 5px #00ff00;
            z-index: 11;
        }

        #intro-layer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center;
        }
        #intro-layer.oculto { display: none; }
        #intro-video { width: 100%; height: 100%; object-fit: contain; }

        #container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 0; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: none; display: flex; flex-direction: column; }

        #video-visor {
            width: 100%; height: 100vw; max-height: 65vh; background: rgba(0,0,0,0.9);
            border-bottom: 2px solid #555; pointer-events: auto; display: flex;
            align-items: center; justify-content: center; position: relative;
        }
        #video-player { width: 100%; height: 100%; object-fit: contain; display: none; z-index: 10; }
        #msg-visor { color: white; text-align: center; font-weight: bold; letter-spacing: 1px; z-index: 20; }

        #video-overlay {
            position: absolute; top: 20px; right: 20px; display: none;
            flex-direction: column; align-items: center; z-index: 500; pointer-events: none;
        }
        #overlay-img { width: 75px; height: auto; filter: drop-shadow(0 0 8px rgba(255,255,255,0.9)); margin-bottom: 5px; }
        #overlay-text {
            color: #fff; font-weight: 800; font-size: 22px; background: rgba(0,0,0,0.7);
            padding: 4px 10px; border-radius: 8px; border: 2px solid #aaa; text-align: center; min-width: 45px;
        }

        #zona-ar { flex-grow: 1; position: relative; display: flex; align-items: center; justify-content: center; }
        #guia-scanner {
            width: 60vw; height: 60vw; max-width: 250px; max-height: 250px;
            border: 4px solid red; border-radius: 15px; box-shadow: 0 0 20px rgba(255,0,0,0.5); transition: 0.3s;
        }
        #guia-scanner.verde { border-color: #0f0; box-shadow: 0 0 50px #0f0; background: rgba(0,255,0,0.1); }

        #panel-inferior {
            background: #111; border-top: 2px solid #fff; padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom)); pointer-events: auto;
            display: flex; flex-direction: column; gap: 10px;
        }
        #selectores { display: flex; justify-content: space-around; padding-top: 5px; gap: 15px; }
        
        .btn-selector {
            width: 75px; height: 75px; border-radius: 50%; background: #222; border: 3px solid #555;
            color: #555; font-size: 26px; font-weight: bold; display: flex; align-items: center; justify-content: center;
            opacity: 0.4; transition: all 0.3s; cursor: not-allowed;
        }
        .btn-selector.activo { opacity: 1; cursor: pointer; color: white; border-color: white; transform: scale(1.1); }
        
        #btn-i.activo { box-shadow: 0 0 25px #f00; }
        #btn-a.activo { box-shadow: 0 0 25px #0f0; }
        #btn-t.activo { box-shadow: 0 0 25px #aaa; }
        #btn-m.activo { box-shadow: 0 0 25px #d0f; }
    </style>
</head>
<body>

    <div id="intro-layer" class="oculto"><video id="intro-video" playsinline webkit-playsinline></video></div>
    
    <div id="splash-screen">
        <button id="btn-inicio">âš¡ INICIAR SISTEMA âš¡</button>
        <div id="version-display">VERSIÃ“N 7.1 - CORRECCIÃ“N DETECCIÃ“N BÃšHO Y VIDEOS</div>
    </div>

    <div id="container"></div>

    <div id="ui-layer">
        <div id="video-visor">
            <div id="msg-visor">INICIANDO...</div>
            <video id="video-player" playsinline webkit-playsinline></video>
            <div id="video-overlay">
                <img id="overlay-img" src="" alt="Escudo">
                <div id="overlay-text"></div>
            </div>
        </div>
        <div id="zona-ar"><div id="guia-scanner"></div></div>
        <div id="panel-inferior">
            <div id="selectores">
                <button id="btn-i" class="btn-selector" data-lado="IMPETUS">I</button>
                <button id="btn-a" class="btn-selector" data-lado="AUXILIUM">A</button>
                <button id="btn-t" class="btn-selector" data-lado="TUTELA">T</button>
                <button id="btn-m" class="btn-selector" data-lado="MYSTERIUM">M</button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { MindARThree } from 'mindar-image-three';

        // ==========================================
        // VERSIÃ“N 7.1 - CORRECCIÃ“N DETECCIÃ“N BÃšHO Y VIDEOS
        // ==========================================
        const VERSION = "VERSIÃ“N 7.1 - CORRECCIÃ“N DETECCIÃ“N BÃšHO Y VIDEOS";
        console.log("%c" + VERSION, "color: #0f0; font-size: 20px; font-weight: bold;");

        const RUTA_BASE = "https://kairosravina-bot.github.io/domusmagis/";
        
        const CARTAS = {
            0: {
                nombre: "DRAGÃ“N",
                imgEscudo: "ESCUDO_DRAGON.png",
                botones: {
                    "btn-i": { texto: "I", valor: 7, video: "ataque.mp4", color: "#900" },
                    "btn-a": { texto: "A", valor: 2, video: "cura.mp4", color: "#090" },
                    "btn-t": { texto: "T", valor: 3, video: "defensa.mp4", color: "#555" },
                    "btn-m": { texto: "M", valor: 2, video: "magia.mp4", color: "#609" }
                }
            },
            1: {
                nombre: "ÃGUILA",
                imgEscudo: "ESCUDO_AGUILA.png",
                botones: {
                    "btn-i": { texto: "I", valor: 5, video: "ataque.mp4", color: "#900" },
                    "btn-a": { texto: "A", valor: 4, video: "cura.mp4", color: "#090" },
                    "btn-t": { texto: "T", valor: 2, video: "defensa.mp4", color: "#555" },
                    "btn-m": { texto: "M", valor: 3, video: "magia.mp4", color: "#609" }
                }
            },
            2: {
                nombre: "LEÃ“N",
                imgEscudo: "ESCUDO_LEON.png",
                botones: {
                    "btn-i": { texto: "I", valor: 8, video: "ataque.mp4", color: "#900" },
                    "btn-a": { texto: "A", valor: 1, video: "cura.mp4", color: "#090" },
                    "btn-t": { texto: "T", valor: 4, video: "defensa.mp4", color: "#555" },
                    "btn-m": { texto: "M", valor: 1, video: "magia.mp4", color: "#609" }
                }
            },
            3: {
                nombre: "JABALÃ",
                imgEscudo: "ESCUDO_JABALI.png",
                botones: {
                    "btn-i": { texto: "I", valor: 6, video: "ataque.mp4", color: "#900" },
                    "btn-a": { texto: "A", valor: 3, video: "cura.mp4", color: "#090" },
                    "btn-t": { texto: "T", valor: 3, video: "defensa.mp4", color: "#555" },
                    "btn-m": { texto: "M", valor: 2, video: "magia.mp4", color: "#609" }
                }
            },
            4: {
                nombre: "BÃšHO",
                imgEscudo: "ESCUDO_BUHO.png",
                botones: {
                    "btn-i": { texto: "M", valor: "MANDATUM", video: "owl_mandatum.mp4", color: "#4a148c" },
                    "btn-a": { texto: "P", valor: "PRAESAGIUM", video: "owl_praesagium.mp4", color: "#6a1b9a" },
                    "btn-t": { texto: "C", valor: "CONSILIUM", video: "owl_consilium.mp4", color: "#7b1fa2" },
                    "btn-m": { texto: "S", valor: "ARCANUM", video: "owl_arcanum.mp4", color: "#8e24aa" }
                }
            }
        };

        let cartaActual = null;
        let reproduciendo = false; // Evita clicks mÃºltiples durante reproducciÃ³n

        const ui = {
            btnI: document.getElementById('btn-i'),
            btnA: document.getElementById('btn-a'),
            btnT: document.getElementById('btn-t'),
            btnM: document.getElementById('btn-m'),
            scanner: document.getElementById('guia-scanner'),
            msg: document.getElementById('msg-visor'),
            overlay: document.getElementById('video-overlay'),
            ovImg: document.getElementById('overlay-img'),
            ovTxt: document.getElementById('overlay-text'),
            videoPlayer: document.getElementById('video-player')
        };

        function actualizarBotones(carta) {
            console.log(`%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, "color: #ff0;");
            console.log(`%cðŸ”„ ACTUALIZANDO BOTONES PARA: ${carta.nombre}`, "color: #ff0; font-size: 16px; font-weight: bold; background: #222200; padding: 5px;");
            console.log(`%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, "color: #ff0;");
            
            const botones = [
                { elem: ui.btnI, id: "btn-i" },
                { elem: ui.btnA, id: "btn-a" },
                { elem: ui.btnT, id: "btn-t" },
                { elem: ui.btnM, id: "btn-m" }
            ];

            botones.forEach(({elem, id}) => {
                const config = carta.botones[id];
                
                console.log(`  ðŸ”˜ ${id}:`);
                console.log(`     Texto anterior: "${elem.innerText}"`);
                console.log(`     Texto nuevo: "${config.texto}"`);
                console.log(`     Color: ${config.color}`);
                console.log(`     Valor: ${config.valor}`);
                console.log(`     Video: ${config.video}`);
                
                elem.innerText = config.texto;
                elem.style.backgroundColor = config.color;
                elem.classList.add('activo');
                
                console.log(`     âœ“ Actualizado`);
            });
            
            console.log(`%câœ… TODOS LOS BOTONES ACTUALIZADOS`, "color: #0f0; font-size: 14px; font-weight: bold;");
        }

        function resetearBotones() {
            console.log(`ðŸ”„ Reseteando botones a valores por defecto`);
            const botones = [ui.btnI, ui.btnA, ui.btnT, ui.btnM];
            botones.forEach(btn => {
                btn.classList.remove('activo');
                btn.style.backgroundColor = '#222';
            });
            ui.btnI.innerText = "I";
            ui.btnA.innerText = "A";
            ui.btnT.innerText = "T";
            ui.btnM.innerText = "M";
            console.log(`  âœ“ Botones: I, A, T, M (color #222)`);
        }

        document.getElementById('btn-inicio').addEventListener('click', () => {
            const splash = document.getElementById('splash-screen');
            const intro = document.getElementById('intro-layer');
            const vid = document.getElementById('intro-video');

            splash.classList.add('oculto');
            intro.classList.remove('oculto');
            
            vid.src = RUTA_BASE + "presentacion.mp4";
            vid.play().catch(() => {
                intro.classList.add('oculto');
                iniciarAR();
            });

            vid.addEventListener('ended', () => {
                intro.classList.add('oculto');
                iniciarAR();
            });
        });

        async function iniciarAR() {
            console.log("ðŸš€ Iniciando sistema AR...");
            
            const mindarThree = new MindARThree({
                container: document.querySelector("#container"),
                imageTargetSrc: RUTA_BASE + "targets1.mind",
                maxTrack: 1,
                filterMinCF: 0.0001,
                filterBeta: 0.001,
                warmupTolerance: 5,
                missTolerance: 5,
                uiLoading: "no",
                uiScanning: "no",
                uiError: "no"
            });

            const {renderer, scene, camera} = mindarThree;

            console.log("ðŸ“¦ Creando anchors para 5 cartas (0-4)...");

            for(let i = 0; i < 5; i++) {
                const anchor = mindarThree.addAnchor(i);
                console.log(`  âœ“ Anchor ${i} creado`);
                
                const geometry = new THREE.PlaneGeometry(1, 1);
                const material = new THREE.MeshBasicMaterial({transparent: true, opacity: 0});
                const plane = new THREE.Mesh(geometry, material);
                anchor.group.add(plane);

                anchor.onTargetFound = () => {
                    console.log(`%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, "color: #0f0;");
                    console.log(`%cðŸŽ¯ CARTA DETECTADA: ${i} - ${CARTAS[i].nombre}`, "color: #0f0; font-size: 18px; font-weight: bold; background: #002200; padding: 5px;");
                    console.log(`%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, "color: #0f0;");
                    
                    // Detener video si estÃ¡ reproduciendo al cambiar de carta
                    if(reproduciendo) {
                        ui.videoPlayer.pause();
                        ui.videoPlayer.style.display = 'none';
                        ui.overlay.style.display = 'none';
                        reproduciendo = false;
                    }
                    
                    cartaActual = CARTAS[i];
                    
                    console.log(`ðŸ”§ Ejecutando actualizarBotones()...`);
                    actualizarBotones(cartaActual);
                    
                    ui.scanner.classList.add('verde');
                    ui.msg.style.display = 'block';
                    ui.msg.innerText = "CONECTADO - " + CARTAS[i].nombre;
                    ui.msg.style.color = "#0f0";
                    
                    console.log(`âœ… UI actualizada correctamente`);
                };

                anchor.onTargetLost = () => {
                    console.log(`%câŒ CARTA ${i} PERDIDA`, "color: #f00; font-size: 14px;");
                    if(cartaActual === CARTAS[i]) {
                        cartaActual = null;
                        
                        // Detener video si se pierde la carta
                        if(reproduciendo) {
                            ui.videoPlayer.pause();
                            ui.videoPlayer.style.display = 'none';
                            ui.overlay.style.display = 'none';
                            reproduciendo = false;
                        }
                        
                        resetearBotones();
                        ui.scanner.classList.remove('verde');
                        ui.msg.innerText = "ESCANEAR...";
                        ui.msg.style.color = "#fff";
                        ui.overlay.style.display = 'none';
                        ui.videoPlayer.style.display = 'none';
                    }
                };
            }

            console.log("â³ Iniciando MindAR...");
            await mindarThree.start();
            console.log("âœ… MindAR iniciado correctamente");
            console.log("ðŸ“· CÃ¡mara lista - Enfoca una carta");
            console.log("ðŸ’¡ NOTA BÃšHO: Si detecta mal, intenta enfocar desde mÃ¡s lejos o centrar mejor la imagen");
            
            renderer.setAnimationLoop(() => {
                renderer.render(scene, camera);
            });
        }

        [ui.btnI, ui.btnA, ui.btnT, ui.btnM].forEach(btn => {
            btn.addEventListener('click', () => {
                if(!btn.classList.contains('activo') || !cartaActual || reproduciendo) {
                    if(reproduciendo) console.warn("âš ï¸ Video en reproducciÃ³n - click ignorado");
                    else console.warn("âš ï¸ Click ignorado - botÃ³n inactivo o sin carta");
                    return;
                }

                reproduciendo = true; // Bloquea nuevos clicks
                
                const config = cartaActual.botones[btn.id];
                
                console.log(`%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`, "color: #0ff;");
                console.log(`%câ–¶ï¸ REPRODUCIENDO VIDEO`, "color: #0ff; font-size: 16px; font-weight: bold; background: #002222; padding: 5px;");
                console.log(`   Carta: ${cartaActual.nombre}`);
                console.log(`   BotÃ³n: ${btn.id} (${config.texto})`);
                console.log(`   Video: ${config.video}`);
                console.log(`   Valor: ${config.valor}`);
                console.log(`   URL completa: ${RUTA_BASE + config.video}`);

                // Detener y limpiar cualquier reproducciÃ³n previa
                ui.videoPlayer.pause();
                ui.videoPlayer.currentTime = 0;
                ui.videoPlayer.src = '';
                
                // Configurar overlay
                ui.ovImg.src = RUTA_BASE + cartaActual.imgEscudo;
                ui.ovTxt.innerText = config.valor;
                ui.ovTxt.style.borderColor = config.color;
                ui.overlay.style.display = 'flex';

                // Configurar y reproducir video
                ui.msg.style.display = 'none';
                ui.videoPlayer.style.display = 'block';
                
                // PequeÃ±o delay para asegurar que el DOM se actualizÃ³
                setTimeout(() => {
                    ui.videoPlayer.src = RUTA_BASE + config.video;
                    ui.videoPlayer.muted = false;
                    ui.videoPlayer.volume = 1.0;
                    ui.videoPlayer.load(); // Forzar carga del video
                    
                    ui.videoPlayer.play()
                        .then(() => {
                            console.log("âœ… Video iniciado correctamente");
                        })
                        .catch(err => {
                            console.error("âŒ Error al reproducir:", err);
                            reproduciendo = false;
                        });
                }, 100);
            });
        });

        ui.videoPlayer.addEventListener('ended', () => {
            ui.videoPlayer.style.display = 'none';
            ui.overlay.style.display = 'none';
            ui.msg.style.display = 'block';
            ui.msg.innerText = "LISTO";
        });

    </script>
</body>
</html>